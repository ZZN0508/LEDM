"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5353],{5353:function(e,n,t){t.r(n),t.d(n,{default:function(){return W}});var i=t(47568),r=t(14924),s=t(26042),a=t(69396),o=t(10253),l=t(70655),c=t(85893),u=t(50852),d=t(88380),f=t(19060),h=t(80142),v=t(77252),m=t(42264),p=t(39660),_=t(17129),w=t(67294),g=t(55703);var Z=t(10124),j=t(49003),x=t(51283),y=t(22638),A=t(32808),E=t(94184),L=t.n(E),N=t(41664),T=t.n(N),S=t(11163),D=t(38122),k=t(64246),I=t(83244),O=t(68972);function C(e){var n=e.pinId,t=e.children,i=e.urlParams,r=void 0===i?"":i,s=(0,S.useRouter)(),a=(0,y.Z)((function(){b({pinId:n,urlParams:r,router:s})}));return(0,c.jsx)("div",{onClick:a,children:t})}function b(e){var n=e.pinId,t=e.urlParams,i=void 0===t?"":t,r=e.router,o=!!document.querySelector(".pinDetailModal"),l="/pins/".concat(n)+(i?"?".concat(i):""),c=(0,O.Z)();if(o){var u="object"===typeof(null===history||void 0===history?void 0:history.state)?null===history||void 0===history?void 0:history.state:{};window.history.pushState((0,a.Z)((0,s.Z)({},u),{detailsSetp:c}),null,l),h.Z.setState({currentPin:{pinId:n}})}else r.push(l)}var R=t(50197),M=t.n(R);function W(){var e=(0,S.useRouter)(),n=(0,o.Z)((0,x.Z)(d.Jr.HB_DOWNLOAD_LIST,{defaultValue:{}}),2),t=n[0],E=t.isClose,N=t.autoClose,O=t.collapsed,R=n[1],W=(0,y.Z)((function(e){R({autoClose:e,isClose:E,collapsed:O})})),P=(0,y.Z)((function(e){R({autoClose:N,isClose:e,collapsed:O})})),F=(0,y.Z)((function(e){R({autoClose:N,isClose:E,collapsed:e})})),B=(0,w.useState)(!1),U=B[0],V=B[1],H=(0,w.useState)([]),J=H[0],K=H[1],$=(0,h.Z)((function(e){return{user:e.user,vips:e.vips}})),q=$.user,z=$.vips,G=!q||!(null===z||void 0===z?void 0:z.length)||0===J.length||E,Q=(0,y.Z)(function(){var e=(0,i.Z)((function(e,n){var t,i,r,s,a,o;return(0,l.__generator)(this,(function(l){switch(l.label){case 0:return[4,(0,v.HhB)({pin_id:n,ignoreMessage:!0})];case 1:return i=l.sent(),r=i.pin,s=i.err,a=i.msg,404===s?(k.Z.error("\u7d20\u6750\u5df2\u4e0b\u67b6"),[2]):s||!r?(k.Z.error(a||"\u7d20\u6750\u83b7\u53d6\u5931\u8d25"),[2]):(o=(0,_.PS)(r),[4,(0,v.kmm)({material_id:e,download_type:1,filename:(0,_.FF)(r,o[0]),type:(0,_.F$)(null===r||void 0===r||null===(t=r.file_material)||void 0===t?void 0:t.material_category),system_code:z[0].system_code})]);case 2:return[2,l.sent().url]}}))}));return function(n,t){return e.apply(this,arguments)}}()),X=(0,y.Z)((function(e,n){e.filter((function(e){return e.download_status===f.oh.pending})).forEach((function(e){var t=n.find((function(n){return n.id===e.id}));t&&t.download_status!==e.download_status&&t.download_status===f.oh.completed&&oe(t)}))})),Y=(0,y.Z)((0,i.Z)((function(){var e;return(0,l.__generator)(this,(function(n){switch(n.label){case 0:return[4,(0,v.KBc)({created_at_start:(new Date).getTime()/1e3-86400,created_at_end:(new Date).getTime()/1e3})];case 1:return(e=n.sent())&&e.list&&(X(J,e.list),K(e.list)),[2]}}))}))),ee=(0,w.useRef)(!1),ne=(0,w.useRef)([]),te=(0,o.Z)(function(e,n){var t=n.defaultValue,i=void 0===t?null:t,r=(0,w.useState)(i),s=r[0],a=r[1];return(0,w.useEffect)((function(){s&&localStorage.setItem(e,JSON.stringify(s))}),[e,s]),(0,w.useEffect)((function(){var n=localStorage.getItem(e);n&&a((0,g.A)(n))}),[e]),(0,w.useEffect)((function(){var n=function(n){n.key===e&&a((0,g.A)(n.newValue))};return window.addEventListener("storage",n),function(){window.removeEventListener("storage",n)}}),[e]),[s,a]}(d.Jr.HB_DOWNLOADED_RECORD,{defaultValue:{}}),2),ie=te[0],re=te[1],se=(0,y.Z)((function(){J.every((function(e){return e.download_status===f.oh.completed}))&&!ne.current.length&&(V(!0),N&&setTimeout((function(){P(!0)}),3e3))})),ae=(0,y.Z)((function(e){var n=J.map((function(e){return e.id}));Object.keys(ie).forEach((function(e){n.includes(+e)||delete ie[e]})),re((0,s.Z)((0,r.Z)({},e,!0),ie))})),oe=(0,y.Z)(function(){var e=(0,i.Z)((function(e){var n,t,i=arguments;return(0,l.__generator)(this,(function(r){switch(r.label){case 0:return n=i.length>1&&void 0!==i[1]&&i[1],ie[e.id]&&!n?[2]:ee.current?(ne.current.push(e),[2]):(ee.current=!0,[4,Q(e.material_id,e.pin_id)]);case 1:return(t=r.sent())&&((0,_.hF)(t),ae(e.id),se()),document.addEventListener("click",(function(){if(ee.current=!1,ne.current.length){var e=ne.current.shift();oe(e)}}),{once:!0}),[2]}}))}));return function(n){return e.apply(this,arguments)}}()),le=(0,y.Z)((function(){G||"visible"!==document.visibilityState||Y()}));(0,w.useEffect)((function(){if(q&&(null===z||void 0===z?void 0:z.length))return!E&&Y(),document.addEventListener("visibilitychange",le),function(){document.removeEventListener("visibilitychange",le)};K([])}),[null===q||void 0===q?void 0:q.user_id,z]),(0,w.useEffect)((function(){var e=function(e){var n;(null===(n=e.detail)||void 0===n?void 0:n.url)&&(0,_.hF)(e.detail.url),Y(),V(!1),F(!1),P(!1)};window.addEventListener(u.Ks.MATERIAL_DOWNLOAD,e);var n=function(){F(!0)};return window.addEventListener("scroll",n,{passive:!0}),m.x.on(p.r,n),function(){window.removeEventListener(u.Ks.MATERIAL_DOWNLOAD,e),window.removeEventListener("scroll",n),m.x.off(p.r,n)}}),[se,P,F,Y]),(0,w.useEffect)((function(){if(0!==J.length){var e=J.some((function(e){return e.download_status===f.oh.pending})),n=J.some((function(e){return e.download_status===f.oh.failure}));if((e||n)&&V(!1),e&&"visible"===document.visibilityState){var t=setTimeout((function(){Y()}),2e3);return function(){clearTimeout(t)}}se()}}),[oe,se,J,Y]);var ce=(0,y.Z)((function(n){var t;window.location.pathname==="/pins/".concat(n.pin_id)?null===(t=document.getElementById("material_download_btn"))||void 0===t||t.click():b({pinId:n.pin_id,urlParams:"clickDownload=0",router:e})}));if(G)return null;var ue=J.filter((function(e){return e.download_status===f.oh.completed})).length;return(0,c.jsxs)("div",{className:L()(M().downloadList,(0,r.Z)({},M().collapsed,O)),onClick:function(){return O&&F(!1)},children:[(0,c.jsx)(D.Z,{className:M().close,type:"ic_clear2",onClick:function(e){e.stopPropagation(),P(!0)}}),(0,c.jsxs)("div",{className:M().head,children:[U&&O?(0,c.jsxs)("span",{children:["\u5df2\u5b8c\u6210",(0,c.jsx)("span",{className:M().num,children:ue+"/"+J.length})]}):(0,c.jsxs)("span",{children:["\u7d20\u6750\u4e0b\u8f7d",(0,c.jsx)("span",{className:M().num,children:ue+"/"+J.length})]}),(0,c.jsx)(D.Z,{className:M().collapseIcon,type:O?"arrow_up":"ic_arrow_down",onClick:function(){return F(!O)}})]}),(0,c.jsx)("div",{className:M().list,children:J.map((function(e){return(0,c.jsxs)("div",{className:M().item,children:[(0,c.jsx)(C,{pinId:e.pin_id,children:(0,c.jsx)("div",{className:M().preview,children:(0,c.jsx)(I.Z,(0,a.Z)((0,s.Z)({},(0,Z.L5)(e.material_preview.url,{displayWidth:60})),{alt:"\u7d20\u6750\u9884\u89c8",height:50,width:50}))})}),(0,c.jsxs)("div",{className:M().info,children:[(0,c.jsx)(C,{pinId:e.pin_id,children:(0,c.jsx)("div",{className:M().materialTitle,title:e.material_title,children:e.material_title})}),(0,c.jsx)("div",{className:M().status,children:e.download_status===f.oh.pending?(0,c.jsx)("span",{className:M().downloading,children:"\u6587\u4ef6\u83b7\u53d6\u4e2d"}):e.download_status===f.oh.failure?(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("span",{className:M().failure,children:"\u6587\u4ef6\u83b7\u53d6\u5931\u8d25"}),(0,c.jsx)("a",{onClick:function(){return ce(e)},children:"\u91cd\u8bd5"}),"\u6216",(0,c.jsx)("a",{onClick:j.$,children:"\u8054\u7cfb\u5ba2\u670d"})]}):(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("span",{className:M().completed,children:"\u5df2\u5b8c\u6210"}),(0,c.jsx)("a",{onClick:function(){return oe(e,!0)},children:"\u518d\u6b21\u4e0b\u8f7d"})]})})]})]},e.id)}))}),(0,c.jsxs)("div",{className:M().footer,children:[(0,c.jsx)("span",{children:(0,c.jsx)(A.Z,{checked:N,onChange:function(e){W(e.target.checked)},children:"\u5b8c\u6210\u540e\u81ea\u52a8\u5173\u95ed"})}),(0,c.jsx)(T(),{href:"/me/download",children:(0,c.jsxs)("a",{target:"_blank",children:["\u5168\u90e8\u4e0b\u8f7d\u8bb0\u5f55 ",(0,c.jsx)(D.Z,{type:"ic_chevron_right"})]})})]})]})}},19060:function(e,n,t){t.d(n,{ms:function(){return a},oh:function(){return s}});var i=t(21658),r=t.n(i)()("MATERIAL_DOWNLOAD_STATUS",[{key:"pending",label:"\u6587\u4ef6\u83b7\u53d6\u4e2d...",value:1},{key:"completed",label:"\u5df2\u5b8c\u6210",value:2},{key:"failure",label:"\u6587\u4ef6\u83b7\u53d6\u5931\u8d25",value:3}]),s=r.MATERIAL_DOWNLOAD_STATUS,a=(r.MATERIAL_DOWNLOAD_STATUS_LIST,r.MATERIAL_DOWNLOAD_STATUS_MAP);r.MATERIAL_DOWNLOAD_STATUS_ITEM_MAP}}]);
//# sourceMappingURL=5353.57aa3be336bdab04.js.map