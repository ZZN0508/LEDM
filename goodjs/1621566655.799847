define("OK/messages/BrowserNotifications",["PTS/messaging.client","OK/logger","OK/utils/dom","OK/utils/vanilla","OK/WebPush","OK/NotificationPermissionPopup"],(function(e,t,n,s,i,r){"use strict";var a,o,u,c="notification_enabled_messenger",l="notification_enabled_messenger_pro",d="notification_enabled_messenger_pro_hidden_till",g="1",f="js-notifications-on",h="js-notifications-off",v="__hidden",m=[],p=!1,y=!1;function b(){return window.Notification&&"granted"===window.Notification.permission}function w(){return b()&&window.localStorage&&"0"!==window.localStorage.getItem(c)}function O(){return window.Notification&&"denied"===window.Notification.permission}function C(e,t,n){e&&e.classList.toggle("invisible",n),t&&t.classList.toggle("invisible",!n)}function k(){return OK.cnst.staticUrl+"res/i/html5_notif_icon.png"}function K(e,n,s,i,r){s=s||k();var a=new Notification(e,{body:n,icon:s,tag:i});return function(e,n){e.onshow=function(){t.success("html5.ntf.shown"),setTimeout(e.close.bind(e),7e3)},e.onclose=function(){m.some((function(t,n){if(t===e)return m.splice(n,1),!0}))},e.onclick=function(){t.success("html5.ntf.click"),n&&n.call()}}(a,r),m.push(a),a}function M(t,n){C(t,n,w());return K(e["html5.notification.enabled.title"],e["html5.notification.enabled.body"],k(),"messenger-enabled")}function L(e,n){return!(!localStorage||!Notification)&&("default"===Notification.permission?Notification.requestPermission((function(s){"granted"===s?(t.success("html5.ntf.granted"),localStorage.setItem(c,"1"),i.subscribe("messages").then((function(e){y&&e===i.STATUS_SUBSCRIBED&&A(!0)}),S),M(e,n)):"denied"===s&&t.success("html5.ntf.denied")})):"denied"===Notification.permission?p&&r.open((function(){"denied"!==Notification.permission&&L(e,n)})):(t.success("html5.ntf.enabled"),localStorage.setItem(c,"1"),i.subscribe("messages").then((function(e){y&&e===i.STATUS_SUBSCRIBED&&A(!0)}),S),M(e,n)),!1)}function T(e,t){return e.parentNode.getElementsByClassName(t)[0].parentNode}function S(){OK.fn.isDebug()&&console.error.apply(console,arguments)}function I(e){localStorage.setItem(l,g),e.classList.add(v)}function A(e){i.isEnabled()&&s.ajax({method:"POST",url:"/web-api/webpush/messages?enabled="+(e?"true":"false")})}return{activate:function(e){y="true"===e.getAttribute("data-web-push-extended-settings-enabled"),p="true"===e.getAttribute("data-web-push-interop-enabled");var n=T(e,f),s=T(e,h);!O()||p?(n.notifClickListener=function(e,t){return function(n){L(e,t),C(e,t,w()),n.stopPropagation(),n.preventDefault()}}(n,s),s.notifClickListener=function(e,n){return function(s){window.localStorage&&window.localStorage.setItem(c,"0"),C(e,n,w()),s.stopPropagation(),s.preventDefault(),t.success("html5.ntf.disable"),y?A(!1):i.unsubscribe("messages").catch(S)}}(n,s),C(n,s,w()),n.addEventListener("click",n.notifClickListener),s.addEventListener("click",s.notifClickListener)):function(e,t){e.classList.add("invisible"),t.classList.add("invisible")}(n,s)},deactivate:function(e){var t=T(e,f),n=T(e,h);t.notifClickListener&&(t.removeEventListener("click",t.notifClickListener),t.notifClickListener=null),n.notifClickListener&&(n.removeEventListener("click",n.notifClickListener),n.notifClickListener=null)},activatePro:function(e){if(!(w()||window.localStorage&&window.localStorage.getItem(l)===g||function(){if(window.localStorage){var e=window.localStorage.getItem(d),t=new Date;if(e)return t<new Date(e)}return!1}())&&(y="true"===e.getAttribute("data-web-push-extended-settings-enabled"),p="true"===e.getAttribute("data-web-push-interop-enabled"),!O()||p)){if(a=n.firstByClass(e,"js-browser-notif-pro_enable"),o=n.firstByClass(e,"js-browser-notif-pro_delay"),u=n.firstByClass(e,"js-browser-notif-pro_close"),a.notifProClickListener=function(e){return function(t){var s=n.firstByClass(document,f),i=n.firstByClass(document,h);s&&(s=s.parentNode),i&&(i=i.parentNode),L(s,i),I(e)}}(e),a.addEventListener("click",a.notifProClickListener),o){var t=parseInt(o.getAttribute("data-delay"),10);o.notifProDelayListener=function(){!function(e,t){var n=new Date;n.setSeconds(n.getSeconds()+t),localStorage.setItem(d,n),e.classList.add(v)}(e,t)},o.addEventListener("click",o.notifProDelayListener)}u&&(u.notifProCloseListener=function(){I(e)},u.addEventListener("click",u.notifProCloseListener)),setTimeout((function(){e.classList.remove(v)}),1e3)}},deactivatePro:function(e){a&&a.notifProClickListener&&(a.removeEventListener("click",a.notifProClickListener),a.notifProClickListener=null,a=null),o&&o.notifProDelayListener&&(o.removeEventListener("click",o.notifProDelayListener),o.notifProDelayListener=null,a=null),u&&u.notifProCloseListener&&(u.removeEventListener("click",u.notifProCloseListener),u.notifProClickListener=null,u=null)},show:K,closeAll:function(){m.forEach((function(e){e.close()})),m=[]},isEnabled:w,isPermitionGranted:b,toggle:function(e){localStorage&&localStorage.setItem(c,e?"1":"0")}}})),define("OK/messages/WindowVisibility",[],(function(){"use strict";var e="hasFocus"in document,t=!0,n=[];function s(e){e=e||window.event,t="focus"===e.type,n.forEach((function(e){t&&e.onWindowFocus&&e.onWindowFocus(),!t&&e.onWindowBlur&&e.onWindowBlur()}))}return window.addEventListener("focus",s),window.addEventListener("blur",s),{hasFocus:function(){return e?document.hasFocus():t},addListener:function(e){n.push(e)},removeListener:function(e){var t=n.indexOf(e);t>-1&&n.splice(t,1)}}})),define("OK/ToolbarGrowl",["OK/logger","OK/utils/dom"],(function(e,t){"use strict";var n="CallApplication",s="appMain",i=".discovery-menu.with-search.__search-wide",r=function(){var t,n,s=document.createElement("bootstrap"),i={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(n in i)if(i.hasOwnProperty(n)&&void 0!==s.style[n]){t=i[n];break}return e.success("growl","transition",t),t}(),a=null,o={},u=document.getElementById("msg_toolbar_button"),c=!(!u||!u.getAttribute("data-growl-add-log")),l=!!document.querySelector(".js-msg-ok"),d=!!document.querySelector(".js-msg-tt");function g(e){return e&&parseInt(e.getAttribute("data-time"),10)||0}function f(){return!(OK.Layers&&OK.Layers.isAnyLayerOpened()||document.getElementById(n)||document.querySelector(i)||OK.getCurrentDesktopModelId()===s)}function h(e){return t.firstByClass(e,"growl_close")}function v(e){this.hookId=e,this.hidden=!0,this.stash=null}return v.showAny=function(){var e,t;if(!a)for(e in o)if(o.hasOwnProperty(e)&&(t=o[e]).hidden&&(t.show(),!t.hidden))break},v.hideAll=function(){a&&a.hide()},v.destroyByLayerId=function(e){var t=o[e];t&&t.destroy()},v.getByLayerId=function(e){return o[e]},v.prototype={activate:function(e){this.hook=this.getContentHook(),this.layerId=e.getAttribute("data-layer"),this.exclusive="true"===e.getAttribute("data-exclusive"),this.priority=parseInt(e.getAttribute("data-priority"),10)||0,o[this.layerId]=this,this.hook&&(this.elem=this.hook.element.firstChild,this.elem&&(this.activateGrowl(),this.id=this.elem.getAttribute("data-id"),this.time=g(this.elem))),this.show()},activateGrowl:function(){var e=h(this.elem);e&&e.addEventListener("click",this)},deactivateGrowl:function(){var e=h(this.elem);e&&e.removeEventListener("click",this)},show:function(){if(this.id&&f.call(this)){if(a){if(this.priority<=a.priority)return;e.success("growl","replace",this.layerId),a.hide()}if(this.elem.classList.add("__active"),this.hidden=!1,a=this,e.success("growl","show","music_app"===this.layerId?this.layerId+"-"+this.id:this.layerId),"messages"===this.layerId&&c){var t=d?"tt":l?"ok":"unknown";return e.success("messagesLayer","growl",t)}}},hide:function(){this.elem&&(this.elem.classList.remove("__active"),this.hidden=!0,this===a&&(a=null))},destroy:function(){this.elem&&(this.deactivateGrowl(),this.hide(),this.id=null,this.time=null,this.elem=null)},setNewContent:function(t){var n,s,i=function(e){var t=document.createElement("div");return t.innerHTML=e,t.children.length?t.children[0]:null}(t);if(OK.Layers&&OK.Layers.isLayerOpened(this.layerId))e.success("growl","ignore");else if(i){if(n=i.getAttribute("data-id"),s=g(i),this.exclusive&&this.id&&this.id!==n)return;if(this.id===n&&this.time===s)return void e.success("growl","equal",1);this.hidden?this.setNewGrowl(t,n,s):(this.stash={html:t,id:n,time:s},this.elem.addEventListener(r,this,!1),this.destroy())}else this.destroy(),v.showAny()},applyNewContent:function(){this.hidden=!0,null===this.stash?OK.hookModel.setHookContent(this.getContentHookId(),""):(this.setNewGrowl(this.stash.html,this.stash.id,this.stash.time),e.success("growl","replace"),this.stash=null)},setNewGrowl:function(t,n,s){if(this.id!==n||this.time!==s){var i=this.getContentHook();OK.hookModel.setHookContent(i.id,t),this.elem=i.element.firstChild,this.id=n,this.time=s,this.activateGrowl(),setTimeout(this.show.bind(this),30)}else e.success("growl","equal",2)},handleEvent:function(e){var t=e.type;"click"===t?(this.time>this.crossTime&&(this.crossTime=this.time),this.destroy(),v.showAny()):t===r&&"opacity"===e.propertyName&&(e.target.removeEventListener(r,this),this.applyNewContent())},getContentHookId:function(){return this.hookId+"_Content"},getContentHook:function(){return this.hook||(this.hook=OK.hookModel.getHookById(this.getContentHookId())),this.hook}},v})),define("OK/messages/Helper",["OK/messages/WindowVisibility","OK/utils/dom","OK/ToolbarBubble","OK/ToolbarGrowl","OK/logger","OK/utils/vanilla"],(function(e,t,n,s,i,r){"use strict";var a="ConversationsList",o="counter_ToolbarMessages",u="counter_UserMessages",c="counter_GroupMessages",l=n.wrap("counter_ToolbarMessages"),d=!!document.getElementById("msg_toolbar_button").getAttribute("data-button-add-log");function g(){return n.create(c)}function f(){return document.getElementById("js-chats_type")}function h(){var e=f();return e?e.getAttribute("data-filterTab"):null}function v(){var e=f();return e?e.getAttribute("data-filterGroupId"):null}return{isLayerOpenedAndActive:function(){return this.isWindowHasFocus()&&this.isMessageLayerOpened()},isMessageLayerOpened:function(){return OK.Layers&&OK.Layers.isLayerOpened("messages")},isWindowHasFocus:function(){return e.hasFocus()},updateToolbarBubbleFromServer:function(e){if(e)try{var t=n.wrap(o),s=t.getCount(),r=e.conv;if(s!=r&&(t.resolveCustomIcon(r,e.hasReply),require(["OK/messages/MessagesAlert"],(function(e){e.updateUnread(r)}))),"GROUP"==h()&&!v()){var a=g();a&&a.resolveCustomIcon(e.group)}require.defined("OK/GroupMessagesBubbleEventBus")&&require("OK/GroupMessagesBubbleEventBus").triggerAllMessages(e.group)}catch(e){i.error("messagesLayer.error","helper_updateToolbarBubbleFromServer"),i.clob("error",e.stack,"messagesLayer","helper_updateToolbarBubbleFromServer")}},getFilterTab:h,getFilterGroupId:v,getFilterUnanswered:function(){var e=f();return e?e.getAttribute("data-filterUnanswered"):null},newMessageNotify:function(e){var t=l.getCount(),a=l.hasBubble();if(e){if(t!==e.conv){l.resolveCustomIcon(e.conv,e.hasReply);var o=e.updateFaviconIfNeeded;d&&i.success("messagesLayer","bubble",o?"tt":"ok"),require(["OK/messages/MessagesAlert"],(function(t){t.updateUnread(e.conv,o)})),t>e.conv&&(s.destroyByLayerId("messages"),e.showGrowlTT&&r.ajax({url:"/dk?cmd=MessagesGrowl"}).then((function(e){r.updateBlockModelCallback(e)})))}else a||l.resolveCustomIcon(0,!1);var c=n.create(u);c&&c.resolveCustomIcon(e.conv-e.group);var f=g();f&&f.resolveCustomIcon(e.group)}else a||l.resolveCustomIcon(0,!1)},getConvLastMsgId:function(e){var n,s=(n=OK.hookModel.getHookById(a))?n.element:document.getElementById("hook_Block_"+a);if(s){var i=t.firstByClass(s,"js-lastMsg_"+e);if(i&&i.firstChild)return i.firstChild.getAttribute("data-id")}return null}}})),define("OK/messages/MessagesConfig",["OK/logger","OK/utils/utils"],(function(e,t){"use strict";var n={initialConvCount:0,initialMsgCount:0,saveUnsentMessages:!1,ajaxRetryCount:3,ajaxTimeout:1e4,lastMsgSyncFix:!1,cacheTimeout:0,poorPasteClean:!1,addCardOnRestore:!1,focusSearchOnOpen:!1,messagesCountForReset:-1,messagesCountForDisablePush:-1,hideTimestampOnVideoStart:!1,sendDeliveredToClient:!1,historyFix:!1,searchTouch:!1,newTyping:!1,copyMsgText:!1,myUnreadLeftColumn:!1,typingShowTimeout:6e3,chatListDrafts:!1,fancyScroll:!1,convDeactivateEnabled:!1,convListDuplicatesFix:!1,allowedTags:"p, br, div, img.emoji, img.usmile, img[alt^='#u'][alt$='s#']",user:{id:0,isPlaySound:!1,isStar:!1,isSendOnCtrlEnter:!1},retrySend:{timeout:0,retriesCount:0,retryDelay:0,increaseBy:1e3},attachItemVersions:{},asyncUploadEnabled:!1,sendStickerAsAttach:!1};return{activate:function(s){var i=function(t){var n=t&&t.innerHTML,s={};if(n)try{s=OK.util.parseJSON(n)}catch(t){e.error("messagesLayer.error","confParse")}return s}(s);return t.extendDeep(n,i),n},update:function(e){return t.extendDeep(n,e),n},get:function(){return n},toggleSendOnEnter:function(e){n.user.isSendOnCtrlEnter=!e}}})),define("OK/messages/SoundPlayer",[],(function(){var e="messages.nmst",t="messages.pnms",n=null,s=null;function i(t){if(null==n||t!==s){var i=new Audio,r=function(t){var n=t.canPlayType("audio/mp3"),s=t.canPlayType("audio/wav");return"probably"===n?(OK.logging.logger.success(e,"mp3.pb"),".mp3"):"probably"===s?(OK.logging.logger.success(e,"wav.pb"),".wav"):"maybe"===n?(OK.logging.logger.success(e,"mp3.mb"),".mp3"):"maybe"===s?(OK.logging.logger.success(e,"wav.mb"),".wav"):(OK.logging.logger.success(e,"err"),null)}(i);r&&(i.src=t+r,i.volume=0,i.play(),s=t,n=i)}}return{initAndPlay:function(s){window.HTMLAudioElement?(i(s),n.pause(),n.src=n.src,n.volume=1,n.play(),OK.logging.logger.success(t)):OK.logging.logger.success(e,"ns")}}})),define("OK/messages/MessagesPushController",["OK/logger","OK/NewsFetchCoordinator"],(function(e,t){"use strict";var n="PRIVATE",s=[],i={count:0,privateConv:0,chatConv:0,privateMessages:0,chatMessages:0,updateMessagesTime:0,readMarksTime:0,typingStatusesTime:0};function r(e){var t=e.unreadCount;t&&t.time&&i.count&&t.time<=i.count&&(e.unreadCount=void 0);var s=e.updatedConversations;if(s&&(i.privateConv||i.chatConv)){var r=[];Object.keys(s).forEach((function(e){var t=s[e];t.time&&t.time<=(t.type===n?i.privateConv:i.chatConv)&&r.push(e)})),r.forEach((function(t){delete e.updatedConversations[t]}))}var a=e.newMessages;a&&(i.privateMessages||i.chatMessages)&&Object.keys(a).forEach((function(e){var t=a[e],s=[];t.forEach((function(e){e.time&&e.time<=(e.type===n?i.privateMessages:i.chatMessages)||s.push(e)})),a[e]=s}));var o=e.updatedMessages;o&&i.updateMessagesTime&&Object.keys(o).forEach((function(e){var t=o[e],n=[];t.forEach((function(e){e.time&&e.time<=i.updateMessagesTime||n.push(e)})),o[e]=n}));var u=e.readMarks;u&&i.readMarksTime&&Object.keys(u).forEach((function(e){var t=u[e].list,n=[];t.forEach((function(e){e.time&&e.time<=i.readMarksTime||n.push(e)})),u[e].list=n}));var c=e.typingStatuses;c&&i.typingStatusesTime&&Object.keys(c).forEach((function(e){var t=c[e].list,n=[];t.forEach((function(e){e.time&&e.time<=i.typingStatusesTime||n.push(e)})),c[e].list=n}))}function a(e){return parseInt(e,10)||0}function o(e,t){return e+(e.length?":":"")+t}return{priority:{very_high:4,high:3,medium:2,low:1},activate:function(){t.addBlock("MPC")},register:function(e){return s.push(e),s.sort((function(e,t){return t.priority-e.priority})),function(){var t=s.indexOf(e);t>=0&&s.splice(t,1)}},applyNews:function(t){if(t){var n={};s.forEach((function(s){if(s.applyNews){if(s.dependsOn&&n.hasOwnProperty(s.dependsOn)&&!n[s.dependsOn])return void(n[s.name]=!1);try{n[s.name]=s.applyNews(t)}catch(t){n[s.name]=!1,e.error("messagesLayer","pushCtrl_"+s.name),e.clob("error",t.toString(),"messagesLayer","pushListener_applyNews")}}}))}},setNewContent:function(n){try{if(n){var s=OK.util.parseJSON(n);s&&(r(s),this.applyNews(s),function(e){var n=e.unreadCount;n&&n.time&&(v=a(n.time))>i.count&&(i.count=v);var s=e.checkTime;if(s){var r="",u=s.privateConvTime;if(u)(v=a(u))>i.privateConv&&(i.privateConv=v);r=o(r,i.privateConv);var c=s.chatConvTime;if(c)(v=a(c))>i.chatConv&&(i.chatConv=v);r=o(r,i.chatConv);var l=s.privateMessagesTime;if(l)(v=a(l))>i.privateMessages&&(i.privateMessages=v);r=o(r,i.privateMessages);var d=s.chatMessagesTime;if(d)(v=a(d))>i.chatMessages&&(i.chatMessages=v);r=o(r,i.chatMessages);var g=s.updateMessagesTime;if(g)(v=a(g))>i.updateMessagesTime&&(i.updateMessagesTime=v);var f=s.readMarksTime;if(f)(v=a(f))>i.readMarksTime&&(i.readMarksTime=v);var h=s.typingStatusesTime;if(h){var v=a(h);i.typingStatusesTime=v}r.length>0&&t.updateParam("st.mpCheckTime",r)}}(s))}}catch(t){e.error("messagesLayer.error","pushSetNewCnt"),e.clob("error",t.stack,"messagesLayer","processPush")}},getCheckTime:function(){return i}}})),define("OK/messages/WindowTitleChanger",["PTS/messaging.client"],(function(e){"use strict";var t,n=document.title;function s(e){document.title=e}function i(e){var n,i=arguments.length,r=0;t&&clearInterval(t),i>1?(n=arguments,t=setInterval((function(){s(n[r]),++r>=i&&(r=0)}),700)):s(e)}return{setTitle:i,resetTitle:function(){i(n)},setNewMessagesTitle:function(t){var n=OK.util.plurals(t);i(t+" "+e["new.message.count."+n])}}})),define("OK/messages/MessagesAlert",["OK/messages/MessagesConfig","OK/messages/SoundPlayer","OK/messages/BrowserNotifications","OK/messages/MessagesPushController","OK/messages/WindowTitleChanger","OK/FaviconManager","PTS/messaging.client","OK/messages/Helper","OK/NewsFetchCoordinator","OK/logger"],(function(e,t,n,s,i,r,a,o,u,c){"use strict";var l,d,g,f=!1,h=[],v=3e3;function m(){return e.get()}function p(){return OK.lss&&OK.lss.isMaster()}function y(){var e=performance.now();d&&e-d<v||(d=e,t.initAndPlay(OK.cnst.staticUrl+"res/default/sound/newMessageSound15"))}function b(){f||(l>0?i.setNewMessagesTitle(l):(r.removeFavicon(0),i.resetTitle()))}function w(){f=!0,r.registerFavicon(0),i.setTitle(a["new.message.title"],"* * * * * * * * * * * *"),g&&clearTimeout(g),g=setTimeout((function(){f=!1,b()}),5e3)}function O(e,t){e.forEach((function(e){!function(e){var t=Date.now(),n=h.some((function(n,s){return t-e.time>6e4&&h.splice(s,1),e.msgId===n.msgId}));return n||(e.time=t,h.push(e)),n}(e)?n.show(e.title,e.body,e.icon,e.convId,(function(){n.closeAll(),window.focus(),t?require(["OK/messages2/layer"],(function(t){t&&t.open(e.url)})):require(["OK/messages/MessagesLayer"],(function(t){t.open({conversationId:e.convId})}))})):c.success("html5.ntf.filter")}))}return{activate:function(t){e.activate(t);var n,i=this;s.register({name:"alert",priority:s.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(e){return i.applyNews(e)}}),n=m(),l=n.initialConvCount,n.initialMsgCount>0&&l>0&&!n.user.isStar&&w()},applyNews:function(e){var t=e&&e.alerts;if(!t)return!1;var s=t.notifications,i=function(e){if(!o.isLayerOpenedAndActive())return!0;if(require.defined("OK/messages/ConversationsManager")){var t,n,s=require("OK/messages/ConversationsManager");for(t=0;t<e.length;t++)if(!(n=s.getById(e[t]))||!n.selected)return!0;return!1}return!0}(t.subscribedConvIds),r=s&&s.length&&i;try{!function(e){var t=m().user,n=!e&&o.isLayerOpenedAndActive();t.isPlaySound&&p()&&!n&&y()}(i)}catch(e){c.error("messagesLayer.error","playSound")}return r&&(l=e.unreadCount?e.unreadCount.conv:0,w()),function(e){e.length>0&&!o.isWindowHasFocus()&&n.isEnabled()&&u.isMaster()&&O(e)}(s),!0},updateUnread:function(e,t){l=e,t&&l>0&&w(),b()},playSoundTT:function(){p()&&y()},showNotificationsTT:function(e){!o.isWindowHasFocus()&&n.isPermitionGranted()&&p()&&O(e,!0)},toggleSound:function(e){m().user.isPlaySound=e,e&&y()}}})),define("OK/messages/Timing",["OK/logger"],(function(e){"use strict";var t="OK/messages2/timing",n=require.defined(t),s={};return{log:function(i){if(!s.hasOwnProperty(i)){var r;if("start"==i)r=performance.now();else{var a=s.start;if(!a)return void e.success("messagesLayer","loading.ok.error");r=performance.now()-a}s[i]=r,e.durationScalar("messagesLayer","loading.ok."+i,r),function(e){n&&require([t],(function(t){t.log("flback-"+e)}))}(i)}}}})),define("OK/messages/MessagesToggleButton",["OK/logger","OK/messages/Timing","OK/ToolbarBubble"],(function(e,t,n){"use strict";var s=n.wrap("counter_ToolbarMessages");function i(n){var i=this;n.preventDefault(),n.stopPropagation(),t.log("start"),OK.loader.execRequire("OK/messages/MessagesLayer",(function(t){if("msg_toolbar_button"===i.id&&!t.isOpen()){var n=s.hasReply()?"reply":s.getCount();e.success("messagesLayer","open",n)}t.toggle()}))}return{activate:function(e){e.addEventListener("click",i)},deactivate:function(e){e.removeEventListener("click",i)}}})),define("OK/AttachPicker",["jquery","OK/utils/utils"],(function(e,t){"use strict";var n,s={},i="localStorage"in window&&null!==window.localStorage,r={},a={},o="OK/messages2/app",u=e({});function c(e){return e&&0===e.indexOf("tt_")}function l(e,t){c(e)&&require.defined(o)&&require(o).attachesSelected({objectId:e,attaches:t})}var d=function(){};function g(e,t,n){var s=a[e.id];return!!s&&(d.get(n).sendUploadedAttachesCb(s,t),delete a[e.id],!0)}function f(e){var t;if(d.get(e).supportsLs){var n="AttachPicker."+e;return(t=JSON.parse(localStorage.getItem(n)))||[]}return(t=r[e])||(r[e]=t=[]),t}function h(e,t){if(d.get(e).supportsLs){var n="AttachPicker."+e;0==t.length?localStorage.removeItem(n):localStorage.setItem(n,JSON.stringify(t))}else r[e]=t}function v(e){e.warningContainer.addClass("__active"),setTimeout((function(){e.warningContainer&&e.warningContainer.removeClass("__active")}),3e3)}function m(e,t,n){var s=n&&n.files,i=s?n.files:f(e.objectId),r=JSON.stringify(i);if(s){if(n.callback){var o=n.callback;n.callback=null,o(r),d.destroy(e.objectId)}}else r=function(e,t,n){var s=[];return e.forEach((function(e){if(t.separateUploadTypes.indexOf(e.type)>-1){var n=e.id;n<0&&!a[n]&&(a[n]=t.serializeAttachesCb(e)),s.push(e)}})),s.length>0&&(s.forEach((function(t){var n=e.indexOf(t);n>-1&&e.splice(n,1)})),n=JSON.stringify(e)),n}(i,e,r),e.button&&(i.length>=e.maxCount?e.button.removeClass("invisible"):e.button.addClass("invisible")),e.attachedInput&&e.attachedInput.length>0&&e.attachedInput.val(r),e.previewUrl&&require(["OK/AttachPreview"],(function(t){t.update(e,r).done((function(){e.trigger("update")}))}))}return d.serialize=function(e,t,n,s){var i={type:t.toString(),id:e};return s?i.token=s:((n||0==n)&&"PHOTOERROR"===i.type&&(i.error=n.toString()),"VIDEOERROR"===i.type&&(i.error=n?n.toString():"video_default")),i},d.addRecentGif=function(e,n){var s=n.attr("data-token");n[0].hasAttribute("data-close-smiles")&&OK.Layers.unregisterLast(),t.ajax({type:"POST",url:"/web-api/photo/upload/attach/fixToken",data:{tokenTemplate:s}}).done((function(t,n,s){if(t){var i=t.photoId,r=t.token,a=d.serialize(i,"RECENTGIF",void 0,r);d.add(e,[a])}}))},d.get=function(t,n){var r=s[t];return r||(s[t]=r=e.extend(e({}),{_counter:0,objectId:t,maxCount:8,single:!1,supportsLs:i,warningContainer:e(),attachedInput:e(),place:null,sessions:{},activeSession:null,edited:!1,separateUploadTypes:[],serializeAttachesCb:function(){},sendUploadedAttachesCb:function(){}})),n&&r._counter++,r},d.startSession=function(e){var t=d.get(e);if(t.activeSession)return t.activeSession;var n=OK.util.nextId(),s={sessionId:n,previewContainer:t.previewContainer,files:null,callback:null,data:null};return t.sessions[n]=s,t.activeSession=s,s},d.detachSession=function(e,t,n){var s=d.get(e,!0).activeSession;return s.callback=t,s.files=f(e),s.data=n,d.clear(e),s},d.findSession=function(e,t){var n=d.get(e,!0);if(n.sessions)for(var s in n.sessions)if(n.sessions.hasOwnProperty(s)&&n.sessions[s].data===t)return n.sessions[s];return null},d.updatePreviewContainer=function(t,n){var s=d.get(t,!0),i=e(n);for(var r in s.sessions)s.sessions.hasOwnProperty(r)&&(s.sessions[r].previewContainer=i)},d.getRemainingCount=function(e){return d.get(e).maxCount-f(e).length},d.getCount=function(e){return f(e).length||0},d.add=function(e,t,n){for(var s=d.get(e),i=f(e),r=0,a=0,o=0;o<t.length;++o){var u=t[o];if(!(i.indexOf(u)>=0))if(s.single)++a,i.length?i[0]=u:i.push(u);else{if(i.length>=s.maxCount){++r;continue}++a,i.push(u)}}return h(e,i),!n&&r>0&&v(s),a>0&&m(s,!1),0===r},d.isEdited=function(e){var t=d.get(e);if(t)return t.edited},d.edit=function(e){var t=d.get(e);t&&(t.edited=!0)},d.remove=function(t,n,s){if(s)return s.callback=null,delete d.get(t).sessions[s.sessionId],void u.triggerHandler("remove.session."+t,[s]);var i=f(t),r=n.split(":")[0].split("_"),a="null"===r[1];e.each(i,(function(e,n){n&&n.type==r[0]&&(a||n.id==r[1])&&(i.splice(e,1),h(t,i),m(d.get(t),!0),u.triggerHandler("remove."+t,[r[0],r[1]]))}))},d.removeMultiple=function(t,n,s){var i=f(t),r=i.length,a=[];n=n.replace(/&quot;/gi,'"'),(n=JSON.parse(n)).forEach((function(t){var n,r=t.split(":")[0].split("_"),o="null"===r[1];e.each(i,(function(e,t){t&&t.type==r[0]&&(o||t.id==r[1])&&(n=i.splice(e,1),s&&a.push(n[0]))}))})),i.length!=r&&(s&&d.saveUnsent(t,a),h(t,i),m(d.get(t),!0))},d.saveUnsent=function(e,t){n={objectId:e,ids:t}},d.restoreUnsent=function(){n&&(d.add(n.objectId,n.ids),n=null)},d.replace=function(t,n,s,i){for(var r=i&&i.files,a=r?i.files:f(t),o=0;o<n.length;o++){var u=n[o].id,c=n[o].type,l=s[o];e.each(a,(function(e,n){if(n.type===c&&n.id===(-0===u?0:u))return g(n,l,t)?a.splice(e,1):a[e]=l,!1}))}var v=d.get(t);r?i.files=a:h(t,a),i&&delete v.sessions[i.sessionId],m(v,!0,i)},d.clear=function(e){n=null;var t=d.get(e);t&&(t.activeSession=null,t.edited=!1),0!=f(e).length&&(h(e,[]),m(d.get(e),!1))},d.subscribe=function(e,t,n){u.on(t+"."+e,n)},d.unsubscribe=function(e,t,n){u.off(t+"."+e,n)},d.getFiles=function(e){return f(e)},d.callGifPaymentWizard=function(){t.ajax({url:"/dk?cmd=PopLayer",data:{"st.layer.cmd":"PopLayerPaymentWizardOuter","st.layer.srv":"46","st.layer.t2nd":"off","st.layer.redirect":"","st.layer.stJsCb":"attachGifCb"}}).done((function(e,n,s){t.updateBlockModelCallback(e,n,s)}))},d.destroy=function(e){var t=s[e];if(t._counter--,t._counter<=0){if(t.button&&(t.button.off(),t.button.removeData(),t.button=null),t.previewContainer&&(t.previewContainer.off(),t.previewContainer.removeData(),t.previewContainer=null),t.warningContainer&&(t.warningContainer.off(),t.warningContainer.removeData(),t.warningContainer=null),t.attachedInput&&(t.attachedInput.off(),t.attachedInput.removeData(),t.attachedInput=null),t.sessions){for(var n in t.sessions)t.sessions.hasOwnProperty(n)&&delete t.sessions[n];t.sessions=null,t.activeSession=null}t.off(),s[t.objectId]=void 0}},d.prototype={activate:function(t){var n=e(t),s=this.objectId=n.data("object-id")||e(".js-chat").attr("data-object-id"),r=d.get(s,!0),a=n.data("preview-url");a&&(r.previewUrl=a,r.previewContainer=e("#"+n.data("preview-id"))),n.data("single")&&(r.single=!0);var o=n.data("use-local-storage");r.supportsLs=i&&(void 0===o||o);var u=n.data("attached-ids");if(u&&h(s,u),!r.single){var g=n.data("max-count");g&&(r.maxCount=parseInt(g,10))}var p=n.attr("data-separate-types");p&&(r.separateUploadTypes=p.replace(/^\[/,"").replace(/]$/,"").split(","));var y=n.data("button-id");y&&(r.button=e("#"+y),r.button.click((function(e){return v(r),e.stopPropagation(),!1})));var b=n.attr("data-attach-type"),w="true"===n.attr("data-instant");r.warningContainer=r.warningContainer.add(".tipAttachPicker",n);var O=e(".attachedInput",n);r.attachedInput=r.attachedInput.add(O);var C=n.attr("data-place");C&&(r.place=C);var k=e(".attachButton",n);k.length>0?k.click((function(){var e=c(s),t=[];n.find("input:hidden").each((function(){var n=this.value;if(n&&!isNaN(parseInt(n,10))){var s=!1;if(t.every((function(e){return!e.id||!e.type||e.id!==n||e.type!==b||(s=!0,!1)})),s)return;if(e){"MUSIC"===b?t.push({type:"MUSIC",trackId:Number(n),title:this.getAttribute("data-name"),artistName:this.getAttribute("data-artist"),imageUrl:this.getAttribute("data-cover"),duration:this.getAttribute("data-duration"),context:this.getAttribute("data-ctx")}):t.push({id:n,type:String(b),url:this.getAttribute("data-url"),previewUrl:this.getAttribute("data-preview"),width:this.getAttribute("data-width"),height:this.getAttribute("data-height")})}else t.push(d.serialize(n,b))}})),w?r.trigger("instantSendAttaches",[t]):d.add(s,t),l(s,t),this.classList.add("__disabled")})):e(".attachInput",n).click((function(){var t=e(this),n=t.data("id");if(t.data("add"))if("RECENTGIF"===b)d.addRecentGif(s,t);else{var i=this.querySelector("img");c(s)?l(s,[{id:n,type:b,preview:i&&i.src,width:this.getAttribute("data-width"),height:this.getAttribute("data-height")}]):d.add(s,[d.serialize(n,b)])}else d.remove(s,n)})),(a||O.length)&&f(s).length>0&&m(r,!1)},deactivate:function(t){var n=e(t);s[this.objectId];e(".attachButton, .attachInput",n).off("click"),n.removeData(),d.destroy(this.objectId)}},d})),define("OK/messages/UnsentMessages",["require","OK/utils/dom","OK/utils/utils","OK/logger","OK/AttachPicker"],(function(e){"use strict";var t,n,s=e("OK/utils/dom"),i=e("OK/utils/utils"),r=e("OK/logger"),a=e("OK/AttachPicker"),o=s.firstByClass(document,"js-unsent-msg-marker"),u=o&&o.getAttribute("data-store-key"),c="localStorage"in window&&null!==window.localStorage,l=!!u&&c,d=l&&JSON.parse(localStorage.getItem(u))||{},g=[],f={},h=function(){clearTimeout(t),t=setTimeout((function(){localStorage.setItem(u,JSON.stringify(d))}),10)},v=function(e){return e&&0===Object.keys(e).length&&e.constructor===Object},m=function(){g.forEach((function(e){e.call()}))},p=function(e){return 0===e.lastIndexOf("msg_found_",0)&&(e=e.substring(10)),e};return n=!1,Object.keys(d).forEach((function(e){0===e.lastIndexOf("msg_found_",0)&&(delete d[e],r.success("messagesLayer","unsentFix"),n=!0)})),n&&h(),{registerAndCheck:function(e){l&&(g.push(e),this.hasUnsentMessages()&&e(d))},addMessage:function(e,t,n,s){if(l){e=p(e);var r={},a={};a[t]=n,r[e]=a,s?i.extendDeep(f,r):(i.extendDeep(f,r),i.extendDeep(d,r),h())}},removeAsync:function(e,t){if(l){e=p(e);var n=f[e];n&&(delete n[t],v(n)&&delete f[e])}},removeMessage:function(e,t){this.removeAsync(e,t);var n=d[e];n&&(delete n[t],v(n)&&(delete d[e],m())),h()},removeConv:function(e){if(l){var t=f[e];t&&delete f[e],(t=d[e])&&(delete d[e],m()),h()}},hasUnsentMessages:function(){return!v(d)&&(!!v(f)||Object.keys(d).some((function(e){if(f[e]){var t=d[e],n=f[e];return Object.keys(t).some((function(e){return!n[e]}))}return!0})))},getUnsentMessages:function(e){return this.hasUnsentMessages()&&d[e]||{}},getAsyncMessages:function(e){return f[e]||{}},getUnsentConversations:function(){return Object.keys(d)},onAsycContinue:function(e,t,n){this.onSendRetry(e,t,"asyncUpload",(function(){if(n&&n.sessions&&Object.keys(n.sessions).length>0){var e=a.findSession(n.objectId,t);a.remove(n.objectId,void 0,e)}}))},onSendRetry:function(e,t,n,i){var a=0;try{var o,u,c,l=this,d=e.getStubEl(t),g=function(){},f=function(e){u.classList.toggle("invisible",!e)},h=function(e){c.classList.toggle("invisible",!e),o.classList.toggle("invisible",e),d.classList.toggle("__error",!e)},v=function(){a=71,u=s.removeAllListeners(u),a=72,u.addEventListener("click",(function(){a=73,g.call(),a=74,l.removeMessage(e.conversation.id,t),a=75,e.removeStub(t)})),a=76,f(!0)},m=function(){o=s.removeAllListeners(o),s.one(o,"click",(function(){h(!0),i.call()}))};if(a=1,!d)return;switch(a=2,o=s.firstByClass(d,"js-retry-button"),a=3,u=s.firstByClass(d,"js-stub-delete-button"),a=4,c=s.firstByClass(d,"js-retry-spinner"),a=5,n){case"onError":v();break;case"asyncUpload":g=i,v(),h(!0);break;case"autoRetry":a=6,g=i,a=7,v(),a=8,h(!0);break;case"manualRetry":a=9,m(),a=10,v(),a=11,h(!1);break;case"onConvActivate":a=111,o&&!o.classList.contains("invisible")?(a=12,m(),a=13,v()):(a=14,f(!1))}}catch(e){r.success("messagesLayer","e.onSendRetry_"+a)}}}})),define("OK/messages/MessageDelivery",["require","OK/messages/MessagesPushController","OK/utils/utils","OK/logger","OK/messages/MessagesConfig"],(function(e){"use strict";var t=e("OK/messages/MessagesPushController"),n=e("OK/utils/utils"),s=e("OK/logger"),i=e("OK/messages/MessagesConfig");function r(e){if(!e)return!0;var t,r,a,o=e.updatedConversations,u=e.unreadCount?e.unreadCount.conv:0,c=0;if(!o||!u)return!0;try{var l=[];Object.keys(o).forEach((function(e){c=1,(t=o[e])&&t.groupId&&(c=2,l.push(e))})),l.length&&(c=3,r=l,(a=i.get()).sendDeliveredToClient&&n.ajax({url:"/web-api/messages/conversation/markAsDelivered",data:{cid:r},timeout:a.ajaxTimeout},a.ajaxRetryCount).fail((function(){s.error("messagesLayer.error","markAsDelivered")})))}catch(e){s.success("sendDeliveredToClient","e.send_"+c)}return!0}return{activate:function(e){t.register({name:"sendDeliveredToClient",priority:t.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(e){return r(e)}})}}})),define("OK/messages/MessagesToolbarButton",["module","OK/logger","OK/messages/MessagesToggleButton","OK/messages/MessagesPushController","OK/ToolbarBubble","OK/messages/Helper","OK/messages/UnsentMessages","OK/utils/dom","OK/utils/utils","OK/ToolbarGrowl","OK/messages/MessageDelivery"],(function(e,t,n,s,i,r,a,o,u,c,l){"use strict";var d=i.wrap("counter_ToolbarMessages");return s.register({name:"toolbarBtn",priority:s.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(e){r.newMessageNotify(e.unreadCount)}}),{activate:function(e){n.activate(e),l.activate(e),a.registerAndCheck((function(){e.classList.toggle("__unsent-warn",a.hasUnsentMessages())})),"1"===e.getAttribute("data-growl")&&d.hasBubble()&&("1"===e.getAttribute("data-growl-add-log")&&t.success("messagesLayer","messageGrowlLoad","ok"),u.ajax({url:"/dk?cmd=MessagesGrowl"}).done((function(e,t,n){u.updateBlockModelCallback(e,t,n)}))),"true"===e.getAttribute("data-ws")&&require(["OK/WSConnectionCheck"],(function(e){e.check()}))},deactivate:function(e){n.deactivate(e)}}})),define("b/messagesButton",["OK/messages/BrowserNotifications","OK/messages/Helper","OK/messages/MessagesAlert","OK/messages/MessagesConfig","OK/messages/MessagesPushController","OK/messages/MessagesToggleButton","OK/messages/MessagesToolbarButton","OK/messages/UnsentMessages","OK/messages/WindowTitleChanger","OK/messages/WindowVisibility","OK/messages/SoundPlayer","OK/messages/MessageDelivery","OK/messages/Timing"],{});