/*! Copyright © 2013 - 2023 Tencent Cloud. All Rights Reserved. 腾讯云 版权所有 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.HLSP2P=t():e.HLSP2P=t()}(self,(()=>(()=>{var e={114:function(e){e.exports=function(){"use strict";var e,t;function r(t){this.name="__st"+(1e9*Math.random()>>>0)+e+"__",null!=t&&t.forEach(this.add,this),e+=1}Array.prototype.find||Object.defineProperty(Array.prototype,"find",{configurable:!0,writable:!0,value:function(e){if(null===this)throw new TypeError('"this" is null or not defined');var t=Object(this),r=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var n=arguments[1],s=0;s<r;){var i=t[s];if(e.call(n,i,s,t))return i;s+=1}}}),window.WeakSet||(e=Date.now()%1e9,r.prototype.add=function(e){var t=this.name;return e[t]||Object.defineProperty(e,t,{value:!0,writable:!0}),this},r.prototype.delete=function(e){return!!e[this.name]&&!(e[this.name]=void 0)},r.prototype.has=function(e){return!!e[this.name]},t=r,Object.defineProperty(window,"WeakSet",{value:function(e){return new t(e)}})),Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(null==e)throw new TypeError("Cannot convert first argument to object");for(var t=Object(e),r=1;r<arguments.length;r++)if(null!=(n=arguments[r]))for(var n=Object(n),s=Object.keys(Object(n)),i=0,a=s.length;i<a;i++){var o=s[i],l=Object.getOwnPropertyDescriptor(n,o);null!=l&&l.enumerable&&(t[o]=n[o])}return t}});var n=function(e,t){return(n=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}))(e,t)},s=function(){return(s=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};function i(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),s=0;for(t=0;t<r;t++)for(var i=arguments[t],a=0,o=i.length;a<o;a++,s++)n[s]=i[a];return n}var a,o=/_?t(\d)?(imestamp)?=\d+&?/g,l=["aegis.qq.com","tamaegis.com","/aegis-sdk","rumt-","/flog.core.min.js","pingfore.qq.com","pingfore.tencent.com","zhiyan.tencent-cloud.net","h.trace.qq.com","btrace.qq.com","beacon.qq.com","dmplog.qq.com","qq.com/report","svibeacon.onezapp.com","cube.weixinbridge.com","doubleclick.net","pcmgrmonitor.3g.qq.com","tdm.qq.com","report.qqweb.qq.com","tpstelemetry.tencent.com","insight.cloud.tencent.com","facebook.com","facebook.net","google","yahoo.com","twitter.com","ga-audiences","report.idqqimg.com","arms-retcode.aliyuncs.com","px.effirst.com","sentry","baidu.com","hot-update.json","u.c.b.r.o.w.s.e.r","report.url.cn","sockjs-node","m3u8"],h=["ResizeObserver loop limit exceeded","ResizeObserver loop completed","Failed to execute 'transaction'","window.indexedDB.deleteDatabase is not a function"],c=["ext1","ext2","ext3","level","trace","tag","seq","code"],u=["static","fetch"],d=(f.prototype.indexOf=function(e,t){for(var r=0;r<e.length;r++)if(e[r].callback===t)return r;return-1},f.prototype.on=function(e,t,r){var n;if(void 0===r&&(r=0),this)return(n=this.eventsList[e])||(this.eventsList[e]=[],n=this.eventsList[e]),-1===this.indexOf(n,t)&&n.push({name:e,type:r||0,callback:t}),this},f.prototype.one=function(e,t){this.on(e,t,1)},f.prototype.remove=function(e,t){if(this){var r=this.eventsList[e];if(r){if(t)return r.length&&(t=this.indexOf(r,t),r.splice(t,1)),this;try{delete this.eventsList[e]}catch(e){}}return null}},f.prototype.clear=function(){this.eventsList={}},f),p=function(e){if(!e||0===e.length)return"{}";e=Array.isArray(e)?e:[e];var t=Object.keys(e[0]),r={};return t.forEach((function(t){r[t]=e.map((function(e){return e[t]}))})),r.count=e.length,$(r)};function f(){var e=this;this.emit=function(t,r){if(e){var n;if(null!=(s=e.eventsList[t])&&s.length)for(var s=s.slice(),i=0;i<s.length;i++){n=s[i];try{var a=n.callback.apply(e,[r]);if(1===n.type&&e.remove(t,n.callback),!1===a)break}catch(t){throw t}}return e}},this.eventsList={}}function g(e,t){return"number"==typeof e||"string"==typeof e?e:t?a.string:a.number}function v(e,t){return"string"==typeof e?e.split("?")[t?1:0]||"":e}function m(e,t){return void 0===t&&(t=2048),String(e).replace(o,"").slice(0,t)}function _(e){return"string"==typeof e&&/^\//.test(e)?"https:"===(null===location||void 0===location?void 0:location.protocol):/^https/.test(e)}function y(e,t,r){var n,s;try{if("function"==typeof(null==t?void 0:t.retCodeHandler))return{code:void 0===(i=(s=t.retCodeHandler(e,null==r?void 0:r.url,null==r?void 0:r.ctx,null==r?void 0:r.payload)||{}).code)?"unknown":i,isErr:s.isErr};if(!(e="string"==typeof e?JSON.parse(e):e))return{code:"unknown",isErr:!1};"function"==typeof(null==(n=null==t?void 0:t.ret)?void 0:n.join)&&(B=[].concat(t.ret.map((function(e){return e.toLowerCase()}))));var i,a=Object.getOwnPropertyNames(e).filter((function(e){return-1!==B.indexOf(e.toLowerCase())}));return a.length?{code:""+(i="未知"!==(i=e[a[0]])&&""!==i?i:"unknown"),isErr:0!==i&&"0"!==i&&"unknown"!==i}:{code:"unknown",isErr:!1}}catch(e){return{code:"unknown",isErr:!1}}}function b(e,t,r){try{var n="function"==typeof t?t(e,null==r?void 0:r.url)||"":e;return j(n).slice(0,102400)}catch(e){return""}}function w(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function R(e,t){return"string"!=typeof e||!e||t&&-1<e.indexOf(t)||V.test(e)||l.some((function(t){return-1<e.indexOf(t)}))}function T(e,t){var r,n=[],s=e.config;return e.lifeCycle.on("destroy",(function(){n.length=0})),function(i,a){Array.isArray(i)?n=n.concat(i):n.push(i),t&&n.length>=t||e.sendNow&&0<n.length?(n=z(n),a(n.splice(0,n.length)),r&&clearTimeout(r)):(r&&clearTimeout(r),r=setTimeout((function(){r=null,0<(n=z(n)).length&&a(n.splice(0,n.length))}),s.delay))}}function C(e,t){return Array.isArray(e)?t(e.map((function(e){return t=s(s({},e),{msg:"string"==typeof e.msg?e.msg:[].concat(e.msg).map(F).join(" ")}),c.forEach((function(e){t[e]||delete t[e]})),t;var t}))):t([s(s({},e),{msg:"string"==typeof e.msg?e.msg:F(e.msg)})])}function S(e,t){return function(r,n){var i,a,o,l=Array.isArray(r),h=l?r:[r],u=(e.lifeCycle.emit("beforeRequest",r),e.config.beforeRequest);(h="function"==typeof u?h.map((function(e){try{var r=u({logs:e,logType:t});return(null==r?void 0:r.logType)===t&&null!=r&&r.logs?r.logs:!1!==r&&e}catch(r){return e}})).filter((function(e){return!1!==e})):h).length&&(i=h,r=c,!Array.isArray(i)||i.length<=1||(a=[],o=[],!(o="string"==typeof r?[r]:r))||o.length<=0||(o.forEach((function(e){i.forEach((function(t){null!=t&&t[e]&&a.push(e)}))})),0<a.length&&(i=i.map((function(e){var t={};return a.forEach((function(e){t[e]=""})),s(s({},t),e)})))),h=i,n(l?h:h[0]))}}function I(e){return function(t,r){e.lifeCycle.emit("modifyRequest",t);var n=e.config.modifyRequest;if("function"==typeof n)try{var s=n(t);"object"==typeof s&&"url"in s&&(t=s)}catch(t){}r(t)}}function k(e){return function(t,r){null!=(n=e.lifeCycle)&&n.emit("afterRequest",t);var n=(e.config||{}).afterRequest;"function"==typeof n&&!1===n(t)||r(t)}}function E(e){if(e&&e.reduce&&e.length)return 1===e.length?function(t,r){e[0](t,r||Z)}:e.reduce((function(e,t){return function(r,n){return void 0===n&&(n=Z),e(r,(function(e){return null==t?void 0:t(e,n)}))}}));throw new TypeError("createPipeline need at least one function param")}function P(e,t){Object.getOwnPropertyNames(e).forEach((function(r){"function"==typeof e[r]&&"constructor"!==r&&(t?t[r]="sendPipeline"===r?function(){return function(){}}:function(){}:e[r]=function(){})}))}function x(){return void 0!==window.performance&&"function"==typeof performance.getEntriesByType&&"function"==typeof performance.now}function L(e,t){function r(e,t,r,n){function s(i){"visibilitychange"===e&&"hidden"!==document.visibilityState||(n?setTimeout((function(){return t(i)}),n):t(i),r&&removeEventListener(e,s,!0))}addEventListener(e,s,!0)}var n;r("visibilitychange",e,null==t?void 0:t.once,null==(n=null==t?void 0:t.delay)?void 0:n.visibilitychange),r("pagehide",e,null==t?void 0:t.once,null==(n=null==t?void 0:t.delay)?void 0:n.pagehide)}function A(e){return-1!==ae.indexOf(e)}(ee=a=a||{})[ee.number=-1]="number",ee.string="";var D,M,O,q=["application/xhtml+xml","application/xml","application/pdf","application/pkcs12","application/javascript","application/x-javascript","application/ecmascript","application/vnd.mspowerpoint","application/vnd.apple.mpegurl","application/ogg","text/css","text/javascript","image","audio","video","video/mp2t"],U=/\.(json|js|css|jpg|jpeg|png|svg|apng|webp|gif|bmp|mp4|mp3|ts|mpeg|wav|webm|ogg|flv|m3u8|ttf|woff2|otf|eot|woff|html|htm|shtml|shtm|)$/gi,B=["ret","retcode","code","errcode"],N=function(){var e=new WeakSet;return function(t,r){if(r instanceof Error)return"Error.message: "+r.message+" \n  Error.stack: "+r.stack;if("object"==typeof r&&null!==r){if(e.has(r))return"[Circular "+(t||"root")+"]";e.add(r)}return r}},F=function(e){if("string"==typeof e)return e;try{return e instanceof Error?(JSON.stringify(e,N(),4)||"undefined").replace(/"/gim,""):JSON.stringify(e,N(),4)||"undefined"}catch(e){return"error happen when aegis stringify: \n "+e.message+" \n "+e.stack}},$=function(e){if("string"==typeof e)return e;try{return JSON.stringify(e,N())||"undefined"}catch(e){return"error happen when aegis stringify: \n "+e.message+" \n "+e.stack}},j=function(e,t){void 0===t&&(t=3);var r,n,s,i="";return Array.isArray(e)?(i+="[",r=e.length,e.forEach((function(e,n){i=(i+="object"==typeof e&&1<t?j(e,t-1):G(e))+(n===r-1?"":",")})),i+="]"):e instanceof Object?(i="{",n=Object.keys(e),s=n.length,n.forEach((function(r,a){"object"==typeof e[r]&&1<t?i+='"'+r+'":'+j(e[r],t-1):i+=H(r,e[r]),i+=a===s-1||a<s-1&&void 0===e[n[a+1]]?"":","})),i+="}"):i+=e,i},H=function(e,t){var r=typeof t,n="";return"string"==r||"object"==r?n+='"'+e+'":"'+t+'"':"function"==typeof t?n+='"'+e+'":"function '+t.name+'"':"symbol"==typeof t?n+='"'+e+'":"symbol"':"number"!=typeof t&&"boolean"!=r||(n+='"'+e+'": '+t),n},G=function(e){var t=typeof e;return""+("undefined"==t||"symbol"==t||"function"==t?"null":"string"==t||"object"==t?'"'+e+'"':e)},V=/data:(image|text|application|font)\/.*;base64/,z=((ee=D=D||{}).INFO_ALL="-1",ee.API_RESPONSE="1",ee.INFO="2",ee.ERROR="4",ee.PROMISE_ERROR="8",ee.AJAX_ERROR="16",ee.SCRIPT_ERROR="32",ee.IMAGE_ERROR="64",ee.CSS_ERROR="128",ee.CONSOLE_ERROR="256",ee.MEDIA_ERROR="512",ee.RET_ERROR="1024",ee.REPORT="2048",ee.PV="4096",ee.EVENT="8192",ee.PAGE_NOT_FOUND_ERROR="16384",ee.WEBSOCKET_ERROR="32768",ee.BRIDGE_ERROR="65536",ee.LAZY_LOAD_ERROR="131072",(ee=M=M||{}).LOG="log",ee.SPEED="speed",ee.PERFORMANCE="performance",ee.OFFLINE="offline",ee.WHITE_LIST="whiteList",ee.VITALS="vitals",ee.PV="pv",ee.CUSTOM_PV="customPV",ee.EVENT="event",ee.CUSTOM="custom",ee.SDK_ERROR="sdkError",ee.SET_DATA="setData",ee.LOAD_PACKAGE="loadPackage",(ee=O=O||{}).production="production",ee.development="development",ee.gray="gray",ee.pre="pre",ee.daily="daily",ee.local="local",ee.test="test",ee.others="others",function(e){return e.filter((function(t,r){return"static"!==t.type||!e.find((function(e,n){return t.url===e.url&&200===t.status&&r<n}))}))}),W=function(e){e.level===D.INFO_ALL&&(e.level=D.INFO)},X={},K={},Y=function(e){return X[e]||(X[e]=setTimeout((function(){K[e]={},X[e]=null}),6e4)),X[e]},J=function(e){return(Array.isArray(e)?e:[e]).map((function(e){return Object.getOwnPropertyNames(e).reduce((function(t,r){return"ctx"!==r&&(t[r]=e[r]),t}),{level:D.INFO,msg:""})}))},Q=function(e){return function(t){return e.sendPipeline([function(t,r){return r({url:e.config.url||"",data:p(J(t)),method:"post",contentType:"application/json",type:M.LOG,log:t,requestConfig:{timeout:5e3},success:function(){var n=e.config.onReport;"function"==typeof n&&t.forEach((function(e){n(e)})),"function"==typeof r&&r([])}})}],M.LOG)(t)}},Z=function(){},ee=(Object.defineProperty(he.prototype,"__version__",{get:function(){return"1.41.9"},enumerable:!1,configurable:!0}),Object.defineProperty(he.prototype,"LogType",{get:function(){return D},enumerable:!1,configurable:!0}),he.prototype.init=function(e){this.setConfig(e);for(var t=0;t<he.installedPlugins.length;t++)try{he.installedPlugins[t].patch(this)}catch(e){this.sendSDKError(e)}this.lifeCycle.emit("onInited")},he.prototype.setConfig=function(e){Object.assign(this.config,e);var t=(e=this.config).id,r=e.uin,n=e.version,s=e.ext1,i=e.ext2,a=e.ext3,o=e.aid,l=void 0===(h=e.env)?"production":h,h=e.pageUrl;return e=this.bean.id!==t||this.bean.uin!==r||this.bean.aid!==o,this.bean.id=t||"",this.bean.uin=r||"",this.bean.version=n||"1.41.9",this.bean.aid=o||"",this.bean.env=function(){switch(l){case O.production:case O.development:case O.gray:case O.pre:case O.daily:case O.local:case O.test:case O.others:return 1;default:return}}()?l:O.others,h&&this.extendBean("from",encodeURIComponent(h.slice(0,2048))),s&&this.extendBean("ext1",encodeURIComponent(s)),i&&this.extendBean("ext2",encodeURIComponent(i)),a&&this.extendBean("ext3",encodeURIComponent(a)),e&&this.lifeCycle.emit("onConfigChange",this.config),this.config},he.use=function(e){-1===he.installedPlugins.indexOf(e)&&e.aegisPlugin&&he.installedPlugins.push(e)},he.unuse=function(e){-1!==(e=he.installedPlugins.indexOf(e))&&he.installedPlugins.splice(e,1)},he.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r={level:D.INFO,msg:e};1===e.length&&e[0].msg&&Object.assign(r,s({},e[0]),{level:D.INFO}),this.normalLogPipeline(r)},he.prototype.infoAll=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r={level:D.INFO_ALL,msg:e};1===e.length&&e[0].msg&&Object.assign(r,s({},e[0]),{level:D.INFO_ALL}),this.normalLogPipeline(r)},he.prototype.report=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r={level:D.REPORT,msg:e};1===e.length&&e[0].msg&&Object.assign(r,s({},e[0])),this.normalLogPipeline(r)},he.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r={level:D.ERROR,msg:e};1===e.length&&e[0].msg&&Object.assign(r,s({},e[0]),{level:D.ERROR}),this.normalLogPipeline(r)},he.prototype.speedLogPipeline=function(e){throw new Error('You need to override "speedLogPipeline" method')},he.prototype.reportPv=function(e){var t,r=this;e&&(t=""+Object.getOwnPropertyNames(this.bean).filter((function(e){return"id"!==e})).map((function(e){return e+"="+r.bean[e]})).join("&"),this.sendPipeline([function(n,s){s({url:r.config.url+"/"+e+"?"+t,addBean:!1,type:M.CUSTOM_PV})}],M.CUSTOM_PV)(null))},he.prototype.reportEvent=function(e){e&&(e="string"==typeof e?{name:e,ext1:this.config.ext1||"",ext2:this.config.ext2||"",ext3:this.config.ext3||""}:e).name&&("string"!=typeof e.name&&(e.name=String(e.name)),this.eventPipeline(e))},he.prototype.reportTime=function(e,t){if("object"==typeof e)return this.reportT(e);"string"==typeof e&&"number"==typeof t&&(t<0||6e4<t||this.submitCustomTime(e,t))},he.prototype.reportT=function(e){var t=e.name,r=e.duration,n=void 0===(n=e.ext1)?"":n,s=void 0===(s=e.ext2)?"":s,i=void 0===(i=e.ext3)?"":i;if(e=e.from,"string"==typeof t&&"number"==typeof r&&"string"==typeof n&&"string"==typeof s&&"string"==typeof i&&!(r<0||6e4<r))return this.submitCustomTime(t,r,n,s,i,void 0===e?"":e)},he.prototype.time=function(e){"string"==typeof e&&(this.timeMap[e]||(this.timeMap[e]=Date.now()))},he.prototype.timeEnd=function(e){"string"==typeof e&&this.timeMap[e]&&(this.submitCustomTime(e,Date.now()-this.timeMap[e]),delete this.timeMap[e])},he.prototype.submitCustomTime=function(e,t,r,n,s,i){this.customTimePipeline({name:e,duration:t,ext1:r||this.config.ext1,ext2:n||this.config.ext2,ext3:s||this.config.ext3,from:i||void 0})},he.prototype.extendBean=function(e,t){this.bean[e]=t},he.prototype.sendPipeline=function(e,t){var r,n=this;return E(i([function(e,t){if("number"!=typeof r.config.random&&(r.config.random=1),!r.isHidden||!r.isGetSample)if(r.isGetSample)r.isHidden||t(e);else{if(r.isGetSample=!0,Math.random()<r.config.random)return r.isHidden=!1,t(e);r.isHidden=!0}},S(r=this,t)],e,[I(this),function(e,t){n.request(e,(function(){for(var r=[],s=0;s<arguments.length;s++)r[s]=arguments[s];var a=!1;-1<(""+r[n.failRequestCount=0]).indexOf("403 forbidden")&&(a=!0,n.destroy()),t({isErr:a,result:r,logType:null==e?void 0:e.type,logs:null==e?void 0:e.log}),null!=(a=null==e?void 0:e.success)&&a.call.apply(a,i([e],r))}),(function(){for(var r,s=[],a=0;a<arguments.length;a++)s[a]=arguments[a];60<=++n.failRequestCount&&n.destroy(),-1<(""+s[0]).indexOf("403 forbidden")&&n.destroy(),t({isErr:!0,result:s,logType:null==e?void 0:e.type,logs:null==e?void 0:e.log}),null!=(r=null==e?void 0:e.fail)&&r.call.apply(r,i([e],s))}))},k(this)]))},he.prototype.send=function(e,t,r){var n=this;return E([I(this),function(e,s){n.request(e,(function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];s({isErr:!1,result:r,logType:e.type,logs:e.log}),null!=t&&t.apply(void 0,r)}),(function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];s({isErr:!0,result:t,logType:e.type,logs:e.log}),null!=r&&r.apply(void 0,t)}))},k(this)])(e)},he.prototype.ready=function(e,t,r){throw new Error('You need to override "ready" method')},he.prototype.request=function(e,t,r){throw new Error('You need to override "request" method')},he.prototype.sendSDKError=function(e){var t=this;this.sendPipeline([function(e,r){r({url:t.config.url+"?id=1085&msg[0]="+encodeURIComponent(F(e))+"&level[0]=2&from="+t.config.id+"&count=1&version="+t.config.id+"(1.41.9)",addBean:!1,method:"get",type:M.SDK_ERROR,log:e})}],M.SDK_ERROR)(e)},he.prototype.destroy=function(e){void 0===e&&(e=!1);var t,r,n=he.instances.indexOf(this);-1!==n&&he.instances.splice(n,1);for(var s=he.installedPlugins.length-1;0<=s;s--)try{he.installedPlugins[s].unpatch(this)}catch(e){this.sendSDKError(e)}if(this.lifeCycle.emit("destroy"),this.lifeCycle.clear(),e)t=this,r=Object.getOwnPropertyDescriptors(t),Object.keys(r).forEach((function(e){r[e].writable&&(t[e]=null)})),Object.setPrototypeOf(this,null);else{for(var i=this;i.constructor!==Object&&P(i,this),i=Object.getPrototypeOf(i););0===he.instances.length&&(P(n=Object.getPrototypeOf(this).constructor),P(he))}},he.version="1.41.9",he.instances=[],he.logType=D,he.environment=O,he.installedPlugins=[],he),te=(le.prototype.patch=function(e){this.canUse(e)&&this.exist(e)&&(this.instances.push(e),this.triggerInit(e),this.triggerOnNewAegis(e))},le.prototype.unpatch=function(e){var t=this.instances.indexOf(e);-1!==t&&(this.instances.splice(t,1),0===this.instances.length)&&this.uninstall(e)},le.prototype.countInstance=function(){return this.instances.length},le.prototype.uninstall=function(e){var t;null!=(t=null==(t=this.option)?void 0:t.destroy)&&t.apply(this,[e])},le.prototype.walk=function(e){var t=this;this.instances.forEach((function(r){var n=t.canUse(r);n&&e(r,n)}))},le.prototype.canUse=function(e){return!(!(e=this.getConfig(e))||"object"!=typeof e)||!!e},le.prototype.getConfig=function(e){return null==(e=e.config)?void 0:e[this.name]},le.prototype.exist=function(e){return-1===this.instances.indexOf(e)},le.prototype.triggerInit=function(e){var t;this.inited||(this.inited=!0,null==(t=null==(t=this.option)?void 0:t.init))||t.call(this.option,this.getConfig(e))},le.prototype.triggerOnNewAegis=function(e){var t;null!=(t=null==(t=this.option)?void 0:t.onNewAegis)&&t.call(this.option,e,this.getConfig(e))},le),re=new te({name:"aid",aid:"",init:function(e){try{var t=!0!==e&&e||window.localStorage.getItem("AEGIS_ID");t||(t=w(),window.localStorage.setItem("AEGIS_ID",t)),this.aid=t}catch(e){}},onNewAegis:function(e){e.bean.aid=this.aid,e.config.aid=this.aid}}),ne=function(e){var t;return e.payload?(t={},Object.keys(e).forEach((function(r){"payload"!==r&&(t[r]=e[r])})),t):e},se=new te({name:"reportAssetSpeed"}),ie=se=new te({name:"reportAssetSpeed",collectCur:0,collectEntryType:"resource",ASSETS_INITIATOR_TYPE:["img","css","script","link","audio","video"],onNewAegis:function(e){var t=this;x()&&(this.collectSuccessLog(e),this.collectFailLog(e),performance.onresourcetimingbufferfull=function(){"function"==typeof performance.clearResourceTimings&&(t.collectCur=0,performance.clearResourceTimings())})},publish:function(e,t){this.$walk((function(r){r===t&&r.speedLogPipeline(e)}))},publishMany:function(e,t){for(var r=t.config,n=0,s=e.length;n<s;n++){var i=e[n];-1===this.ASSETS_INITIATOR_TYPE.indexOf(i.initiatorType)||R(i.name,r.hostUrl)||this.publish(this.generateLog(i,r),t)}},collectSuccessLog:function(e){var t,r,n=this;"function"==typeof window.PerformanceObserver?(this.publishMany(performance.getEntriesByType(this.collectEntryType),e),(t=new window.PerformanceObserver((function(t){n.publishMany(t.getEntries(),e)}))).observe({entryTypes:[this.collectEntryType]}),e.lifeCycle.on("destroy",(function(){0===se.countInstance()&&t.disconnect()}))):(r=setInterval((function(){var t=performance.getEntriesByType(n.collectEntryType),r=t.slice(n.collectCur);n.collectCur=t.length,n.publishMany(r,e)}),3e3),e.lifeCycle.on("destroy",(function(){0===se.countInstance()&&clearInterval(r)})))},collectFailLog:function(e){function t(t){var s,i;t&&(t=t.target||t.srcElement,!(s=(null==t?void 0:t.src)||(null==t?void 0:t.href))||"string"!=typeof s||-1<window.location.href.indexOf(s)||(t="function"==typeof(null==(t=n.api)?void 0:t.resourceTypeHandler)?null==(t=n.api)?void 0:t.resourceTypeHandler(s):"",i=performance.getEntriesByType(r.collectEntryType).find((function(e){return e.name===s})),R(s,n.hostUrl))||(i={url:m(s),status:400,duration:Number(((null==i?void 0:i.duration)||0).toFixed(2)),method:"get",type:t||"static",isHttps:_(s),urlQuery:v(s,!0),nextHopProtocol:"",domainLookup:0,connectTime:0},r.publish(i,e)))}var r=this,n=e.config;window.document.addEventListener("error",t,!0),e.lifeCycle.on("destroy",(function(){0===se.countInstance()&&window.document.removeEventListener("error",t,!0)}))},generateLog:function(e,t){t="function"==typeof(null==(r=t.api)?void 0:r.resourceTypeHandler)?null==(r=t.api)?void 0:r.resourceTypeHandler(e.name):"";var r=e.transferSize;return{url:m(e.name),method:"get",duration:Number(e.duration.toFixed(2)),status:200,type:t||"static",isHttps:_(e.name),nextHopProtocol:e.nextHopProtocol||"",urlQuery:v(e.name,!0),domainLookup:g(e.domainLookupEnd-e.domainLookupStart),connectTime:g(e.connectEnd-e.connectStart),transferSize:0<r?r:-1}},collectNotReportedLog:function(e){var t,r;x()&&(t=(r=performance.getEntriesByType(this.collectEntryType)).length,"function"!=typeof window.PerformanceObserver)&&this.collectCur!==t&&(r=r.slice(this.collectCur),this.collectCur=t,this.publishMany(r,e,!0))},destroy:function(){this.option.publish=function(){}}}),ae=window.navigator.userAgent.toLowerCase(),oe={};function le(e){this.aegisPlugin=!0,this.name="",this.instances=[],this.inited=!1,e.$walk=this.walk.bind(this),e.$getConfig=this.getConfig.bind(this),this.option=e,this.name=e.name}function he(e){var t,r,n,s,i,a,o,l,h,c,u,p,f,g,v=this;this.isGetSample=!1,this.isHidden=!1,this.config={version:0,delay:1e3,onError:!0,repeat:60,random:1,aid:!0,device:!0,pagePerformance:!0,webVitals:!0,speedSample:!0,onClose:!0,reportLoadPackageSpeed:!0,hostUrl:"https://aegis.qq.com",env:"production",url:"",offlineUrl:"",whiteListUrl:"",pvUrl:"",speedUrl:"",customTimeUrl:"",performanceUrl:"",webVitalsUrl:"",eventUrl:"",setDataReportUrl:"",reportImmediately:!0},this.isWhiteList=!1,this.lifeCycle=new d,this.bean={},this.normalLogPipeline=E([T(this,5),C,function(e,r){var n=t.config;r(e=e.map((function(e){var t,r=n.maxLength||102400;try{if(!e.msg||e.msg.length<=r)return e;e.msg=null==(t=e.msg)?void 0:t.substring(0,r)}catch(t){e.msg=F(e.msg).substring(0,n.maxLength)}return e})))},(g=(t=this).config,function(e,t){var r="number"==typeof g.repeat?g.repeat:60;if(r<=0)return t(e);var n=(null==g?void 0:g.id)+"_error",s=K[n]||{};t(e.filter((function(e){if(e.level===D.ERROR||e.level===D.PROMISE_ERROR||e.level===D.AJAX_ERROR||e.level===D.SCRIPT_ERROR||e.level===D.IMAGE_ERROR||e.level===D.CSS_ERROR||e.level===D.MEDIA_ERROR||e.level===D.RET_ERROR||e.level===D.BRIDGE_ERROR||e.level===D.PAGE_NOT_FOUND_ERROR||e.level===D.WEBSOCKET_ERROR||e.level===D.LAZY_LOAD_ERROR){if(e=e.msg.slice(0,200),s[e]>r)return X[n]||Y(n),!1;s[e]=1+~~s[e],K[n]=s}return!0})))}),(p=this.lifeCycle.emit,f=this.config,function(e,t){var r,n=f.logCreated;return"function"==typeof n?(r=e.filter((function(e){return!1!==n(e)})),p("beforeWrite",r),t(r)):(p("beforeWrite",e),t(e))}),(u=this,setTimeout((function(){var e=void 0===(t=(r=u.config).pvUrl)?"":t,t=r.spa,r=-1<["web-sdk","mp-sdk"].indexOf("web-sdk");e&&(r&&!t||!r)&&u.sendPipeline([function(t,r){r({url:e,type:M.PV})}],M.PV)(null)}),100),function(e,t){t(e)}),(h=l=o=!1,c=[],(i=this).lifeCycle.on("onConfigChange",(function(){a&&clearTimeout(a),a=setTimeout((function(){var e,t;!h&&i.config&&(h=!0,e=i.config.whiteListUrl,(t=void 0===e?"":e)&&i.sendPipeline([function(e,r){r({url:t,type:M.WHITE_LIST,success:function(e){l=!0;try{var t=e.data||JSON.parse(e),r=t.retcode,n=t.result,s=void 0===n?{}:n,a=(0===r&&(o=s.is_in_white_list,i.isWhiteList=o,0<=s.rate)&&s.rate<=1&&(i.config.random=s.rate,i.isGetSample=!1),i.isWhiteList&&c.length?Q(i)(c.splice(0),(function(){})):!i.isWhiteList&&c.length&&(c.length=0),i.config.onWhitelist);"function"==typeof a&&a(o)}catch(e){}},fail:function(){l=!0}})}],M.WHITE_LIST)(null),h=!1)}),i.config.uin?50:500)})),i.lifeCycle.on("destroy",(function(){c.length=0})),function(e,t){var r;o||null!=(r=null==(r=i.config)?void 0:r.api)&&r.reportRequest?t(e.concat(c.splice(0)).map((function(e){return W(e),e}))):(r=e.filter((function(e){return e.level!==D.INFO&&e.level!==D.API_RESPONSE?(W(e),!0):(l||(c.push(e),200<=c.length&&(c.length=200)),!1)}))).length&&t(r)}),function(e,t){try{var r=JSON.parse(JSON.stringify(e)),n=(v.lifeCycle.emit("beforeReport",r),v.config.beforeReport);(e="function"==typeof n?e.filter((function(e){return!1!==n(e)})):e).length&&t(e)}catch(e){}},Q(this)]),this.eventPipeline=E([T(this,10),(s=this,function(e){s.sendPipeline([function(e,t){var r=e.map((function(e){return{name:e.name,ext1:e.ext1||s.config.ext1||"",ext2:e.ext2||s.config.ext2||"",ext3:e.ext3||s.config.ext3||""}}));t({url:s.config.eventUrl+"?payload="+encodeURIComponent(JSON.stringify(r)),type:M.EVENT,log:e})}],M.EVENT)(e)})]),this.timeMap={},this.failRequestCount=0,this.customTimePipeline=E([T(this,10),(n=this,function(e){return n.sendPipeline([function(e,t){t({url:n.config.customTimeUrl+"?payload="+encodeURIComponent(JSON.stringify({custom:e})),type:M.CUSTOM,log:e})}],M.CUSTOM)(e)})]),this.config=(r=this.config,void 0===(e=e.hostUrl)&&(e="https://aegis.qq.com"),r.url=r.url||e+"/collect",r.offlineUrl=r.offlineUrl||e+"/offline",r.whiteListUrl=r.whiteListUrl||e+"/collect/whitelist",r.pvUrl=r.pvUrl||e+"/collect/pv",r.eventUrl=r.eventUrl||e+"/collect/events",r.speedUrl=r.speedUrl||e+"/speed",r.customTimeUrl=r.customTimeUrl||e+"/speed/custom",r.performanceUrl=r.performanceUrl||e+"/speed/performance",r.webVitalsUrl=r.webVitalsUrl||e+"/speed/webvitals",r.setDataReportUrl=r.SetDataReportUrl||e+"/speed/miniProgramData",r),he.instances.push(this)}function ce(){return([1e7]+1e3+4e3+8e3+1e11).replace(/[018]/g,(function(e){return(e^(16*Math.random()&15)>>e/4).toString(16)}))}oe.macos=function(){return A("mac")},oe.ios=function(){return oe.iphone()||oe.ipod()||oe.ipad()},oe.iphone=function(){return!oe.windows()&&A("iphone")},oe.ipod=function(){return A("ipod")},oe.ipad=function(){var e="MacIntel"===navigator.platform&&1<navigator.maxTouchPoints;return A("ipad")||e},oe.android=function(){return!oe.windows()&&A("android")},oe.androidPhone=function(){return oe.android()&&A("mobile")},oe.androidTablet=function(){return oe.android()&&!A("mobile")},oe.blackberry=function(){return A("blackberry")||A("bb10")},oe.blackberryPhone=function(){return oe.blackberry()&&!A("tablet")},oe.blackberryTablet=function(){return oe.blackberry()&&A("tablet")},oe.windows=function(){return A("windows")},oe.windowsPhone=function(){return oe.windows()&&A("phone")},oe.windowsTablet=function(){return oe.windows()&&A("touch")&&!oe.windowsPhone()},oe.fxos=function(){return(A("(mobile")||A("(tablet"))&&A(" rv:")},oe.fxosPhone=function(){return oe.fxos()&&A("mobile")},oe.fxosTablet=function(){return oe.fxos()&&A("tablet")},oe.meego=function(){return A("meego")},oe.cordova=function(){return window.cordova&&"file:"===location.protocol},oe.nodeWebkit=function(){return"object"==typeof window.process},oe.mobile=function(){return oe.androidPhone()||oe.iphone()||oe.ipod()||oe.windowsPhone()||oe.blackberryPhone()||oe.fxosPhone()||oe.meego()},oe.tablet=function(){return oe.ipad()||oe.androidTablet()||oe.blackberryTablet()||oe.windowsTablet()||oe.fxosTablet()},oe.desktop=function(){return!oe.tablet()&&!oe.mobile()},oe.isIE=function(){return"ActiveXObject"in window};var ue={generateTraceId:pe(16),generateSpanId:pe(8)},de=Array(32);function pe(e){return function(){for(var t=0;t<2*e;t++)de[t]=Math.floor(16*Math.random())+48,58<=de[t]&&(de[t]+=39);return String.fromCharCode.apply(null,de.slice(0,2*e))}}function fe(e){var t,r="";return"object"==typeof e&&(t=(e=function(e,t){for(var r=0;r<t.length;r++){var n=t[r],s=e[n]||"function"==typeof e.get&&e.get(n);if(s)return[n,s]}return["",""]}(e,Object.keys(Ce)))[0],e=e[1],t)?Ce[t](e):r}function ge(e,t,r){return null!=t&&t.length&&"object"==typeof e?t.reduce((function(t,n){var s=window.Headers&&e instanceof Headers?e.get(n):e[n];return s?t+(""===t?"":"\n\n")+r+" header "+n+": "+s:t}),""):""}function ve(e,t){return e&&-1===["null","undefined"].indexOf(e)?t+": "+e:""}var me,_e,ye,be,we,Re,Te,Ce={sw8:function(e){return(e=e.split("-")[1])?atob(e):""},traceparent:function(e){return e.split("-")[1]},b3:function(e){return e.split("-")[0]},"sentry-trace":function(e){return e.split("-")[0]}},Se=(Me.prototype.generate=function(e,t){if(void 0===t&&(t={}),this.url=e,!this.isUrlIgnored()&&this.isUrlInTraceUrls()&&this.traceType){switch(this.traceType){case"traceparent":this.traceId=this.createTraceparent();break;case"b3":this.traceId=this.createB3();break;case"sw8":this.traceId=this.createSw8();break;case"sentry-trace":this.traceId=this.createSentryTrace();break;default:return void(this.traceId="")}return t[this.traceType]&&(this.traceId=t[this.traceType]),{name:this.traceType,value:this.traceId}}},Me.prototype.createTraceparent=function(){var e=ue.generateSpanId();return"00-"+ue.generateTraceId()+"-"+e+"-0"+Number(1).toString(16)},Me.prototype.createB3=function(){var e=ue.generateSpanId();return ue.generateTraceId()+"-"+e+"-1"},Me.prototype.createSw8=function(){var e=new URL(location.href),t=w(),r=w();return"1-"+String(btoa(r))+"-"+String(btoa(t))+"-1-"+String(btoa("aegis"))+"-"+String(btoa("1.41.9"))+"-"+String(btoa(encodeURI(location.pathname)))+"-"+String(btoa(e.host))},Me.prototype.createSentryTrace=function(){var e=ce().substring(16);return ce()+"-"+e+"-1"},Me.prototype.isUrlIgnored=function(){if(Array.isArray(this.ignoreUrls)&&0!==this.ignoreUrls.length)for(var e=0,t=this.ignoreUrls;e<t.length;e++){var r=t[e];if(this.urlMatches(this.url,r))return!0}return!1},Me.prototype.isUrlInTraceUrls=function(){if(!this.urls)return!0;if(Array.isArray(this.urls)){if(0===this.urls.length)return!1;for(var e=0,t=this.urls;e<t.length;e++){var r=t[e];if(this.urlMatches(this.url,r))return!0}}return!1},Me.prototype.urlMatches=function(e,t){return"string"==typeof t?e===t:!!e.match(t)},Me),Ie=!1,ke=[],Ee=/^\/[^/]/,Pe=!1,xe=[],Le=(new te({name:"reportApiSpeed"}),new te({name:"reportApiSpeed",override:!1,onNewAegis:function(e){var t,r;this.override||(null!=(r=e.config.api)&&r.injectTraceHeader&&(this.traceRequestHeader=new Se(r.injectTraceHeader,null!=(t=null==r?void 0:r.injectTraceIgnoreUrls)?t:[],null==r?void 0:r.injectTraceUrls)),this.override=!0,this.overrideFetch(e.config,e),this.overrideXhr(e.config,e))},getRequestType:function(e,t,r){var n,s;return void 0===t&&(t=""),e="function"==typeof(null==(s=e.api)?void 0:s.resourceTypeHandler)?null==(s=e.api)?void 0:s.resourceTypeHandler(r):"",-1===u.indexOf(e)&&(n=void 0===t?"":t,s=(void 0===r?"":r).split("?")[0],e=U.test(s)||q.some((function(e){return-1!==String(n).indexOf(e)}))?"static":"fetch"),e},overrideFetch:function(e,t){var r=this,n=e.api,s=(n={name:this.name,traceRequestHeader:null!=n&&n.injectTraceHeader?this.traceRequestHeader:null,then:function(n,s,i,a){var o,l;R(i,e.hostUrl)||(o=n.headers?n.headers.get("content-type"):"","fetch"===(l=r.getRequestType(e,o,i))?n.clone().text().then((function(o){var h,c=n.status<=0||400<=n.status,u=(null==(u=e.api)?void 0:u.reqHeaders)||[],d=ge(null==a?void 0:a.headers,u,"req"),p=(u=(null==(u=e.api)?void 0:u.resHeaders)||[],ge(n.headers,u,"res")),f=fe(null==a?void 0:a.headers),g=(u=y(o,e.api,{url:i,ctx:n,payload:null==a?void 0:a.body})).code,v=u.isErr,m=(u=null==(u=e.api)?void 0:u.apiDetail)?b(null==a?void 0:a.body,null==(h=e.api)?void 0:h.reqParamHandler,{url:i}):"",_=u?b(o,null==(h=e.api)?void 0:h.resBodyHandler,{url:i,ctx:n}):"";setTimeout((function(){var h=r.getPerformanceEntryByUrl(e,{url:i,duration:s,type:l,status:n.status||0,method:(null==a?void 0:a.method)||"get"}),u=[c?"FETCH_ERROR: "+o:"","fetch req url: "+i,"res status: "+(h.status||0),"res duration: "+h.duration+"ms",d,p,"req method: "+(h.method||"GET"),"res retcode: "+g,ve(m,"req param"),ve(_,"res data")].filter((function(e){return e})).join("\n\n");h.payload=null==a?void 0:a.body,h.ret=g,h.isErr=+v,r.publishNormalLog({msg:u,level:c?D.AJAX_ERROR:v?D.RET_ERROR:D.API_RESPONSE,code:g,trace:f},t),r.publishSpeed(h,t)}),0)})):setTimeout((function(){var o=r.getPerformanceEntryByUrl(e,{url:i,duration:s,type:l,status:n.status||0,method:(null==a?void 0:a.method)||"get"});o.type="static",o.urlQuery=v(i,!0),r.publishSpeed(o,t)}),0))},catch:function(n,s,i,a){var o,l,h,c,u;throw R(i,e.hostUrl)||(o=r.getRequestType(e,"",i),l=(null==(l=e.api)?void 0:l.reqHeaders)||[],h=ge(null==a?void 0:a.headers,l,"req"),c=fe(null==a?void 0:a.headers),u=null!=(l=e.api)&&l.apiDetail?b(null==a?void 0:a.body,null==(l=e.api)?void 0:l.reqParamHandler,{url:i}):"",setTimeout((function(){var l=r.getPerformanceEntryByUrl(e,{url:i,duration:s,type:o,status:0,method:(null==a?void 0:a.method)||"get"});r.publishSpeed(l,t),l="AJAX_ERROR: "+n+"\n                          \nreq url: "+i+"\n                          \nres status: 0\n                          \nres duration: "+l.duration+"ms\n                          \nreq method: "+((null==a?void 0:a.method)||"get")+"\n                          \nreq param: "+u+"\n                          \n"+h,r.publishNormalLog({msg:l,level:D.AJAX_ERROR,code:-400,trace:c},t)}),0)),n}},this.hackFetchOptions=n,this.hackFetchOptions),i=null==(n=e.api)?void 0:n.ignoreHackReg;if(void 0===i&&(i=/\.flv(\?|$)/gi),xe.find((function(e){return e.name===s.name})))throw new Error("name '"+s.name+"' is already in hackFetch option list");xe.push(s),!Pe&&window.fetch&&(Pe=!0,be=window.fetch,window.fetch=function(e,t){void 0===t&&(t={});var r="string"==typeof e?e:null==e?void 0:e.url;if(null!=(o=null==i?void 0:i.test)&&o.call(i,r))return be(r,t);Ee.test(r)&&(r=""+location.origin+r);var n,a,o=(s||{}).traceRequestHeader;o&&(a=(t||{}).headers,n=(a=o.generate(r,o=void 0===a?{}:a)||{}).name,a=a.value)&&n&&(t.headers=Object.assign(o,((o={})[n]=a,o)));for(var l=0;l<xe.length;l++){var h=xe[l];try{"function"==typeof h.beforeFetch&&h.beforeFetch(r,t)}catch(e){}}var c=Date.now();return be(e,t).then((function(e){for(var n=e.clone(),s=0;s<xe.length;s++){var i=xe[s];try{"function"==typeof i.then&&i.then(n,Date.now()-c,r,t)}catch(e){}}return n})).catch((function(e){for(var n=0;n<xe.length;n++){var s=xe[n];try{"function"==typeof s.catch&&s.catch(e,Date.now()-c,r,t)}catch(e){}}throw e}))})},overrideXhr:function(e,t){var r,n=this,s={name:this.name,send:function(r,s){var i,a,o=Date.now(),l=(((null==e?void 0:e.api)||{}).injectTraceHeader&&(i=(a=n.traceRequestHeader.generate(r.aegisUrl)||{}).name,a=a.value,i)&&a&&r.setRequestHeader(i,a),r.addEventListener("loadend",(function(){var i,a,u,d,p=r.aegisUrl||"";R(p,e.hostUrl)||"abort"===r.failType||(i="",(r.failType||!r.status||400<=r.status)&&(i=r.failType||"failed"),a=Date.now()-o,u=r.getResponseHeader("content-type"),d=n.getRequestType(e,u,p),setTimeout((function(){var o=n.getPerformanceEntryByUrl(e,{url:p,duration:a,type:d,status:r.status,method:r.aegisMethod||"get"});if("fetch"===d){var u=(null==(u=e.api)?void 0:u.reqHeaders)||[],f=ge(r.aegisXhrReqHeader,u,"req"),g=(u=(null==(u=e.api)?void 0:u.resHeaders)||[],r.getAllResponseHeaders().split("\r\n").reduce((function(e,t){return(t=t.split(": "))[0]&&t[1]&&(e[t[0]]=t[1]),e}),{})),m=ge(g,u,"res"),_=fe(r.aegisXhrReqHeader),y=(u=null==(g=e.api)?void 0:g.apiDetail)?b(s,null==(g=e.api)?void 0:g.reqParamHandler,{url:p}):"",w=u?b(r.response,null==(g=e.api)?void 0:g.resBodyHandler,{url:p}):"";try{!function(e,t,r,n){var s,i,a,o;try{if("function"==typeof(null==t?void 0:t.retCodeHandlerAsync))return t.retCodeHandlerAsync(e,null==r?void 0:r.url,null==r?void 0:r.ctx,(function(e){var t=e.code;e=e.isErr,null!=n&&n({code:void 0===t?"unknown":t,isErr:e})}));if("function"==typeof(null==t?void 0:t.retCodeHandler))return a=(i=t.retCodeHandler(e,null==r?void 0:r.url,null==r?void 0:r.ctx,null==r?void 0:r.payload)||{}).code,o=i.isErr,null!=n&&n({code:void 0===a?"unknown":a,isErr:o});if(!(e="string"==typeof e?JSON.parse(e):e))return null!=n&&n({code:"unknown",isErr:!1});"function"==typeof(null==(s=null==t?void 0:t.ret)?void 0:s.join)&&(B=[].concat(t.ret.map((function(e){return e.toLowerCase()}))));var l=Object.getOwnPropertyNames(e).filter((function(e){return-1!==B.indexOf(e.toLowerCase())}));if(l.length)return"未知"!==(a=e[l[0]])&&""!==a||(a="unknown"),null!=n&&n({code:""+a,isErr:0!==a&&"0"!==a&&"unknown"!==a});null!=n&&n({code:"unknown",isErr:!1})}catch(e){null!=n&&n({code:"unknown",isErr:!1})}}(r.response,e.api,{url:p,ctx:r,payload:s},(function(e){var r=e.code,a=(e=e.isErr,[i?"AJAX_ERROR: request "+i:"","fetch req url: "+p,"res status: "+(o.status||0),"res duration: "+o.duration+"ms",f,m,"req method: "+(o.method||"GET"),"res retcode: "+r,ve(y,"req param"),ve(w,"res data")].filter((function(e){return e})).join("\n\n"));o.ret=r,o.isErr=+e,o.payload=s,n.publishNormalLog({msg:a,level:i?D.AJAX_ERROR:e?D.RET_ERROR:D.API_RESPONSE,code:r,trace:_},t),n.publishSpeed(o,t)}))}catch(u){o.ret="unknown",n.publishSpeed(o,t)}}else o.type="static",o.urlQuery=v(p,!0),n.publishSpeed(o,t);r.removeEventListener("abort",l),r.removeEventListener("error",h),r.removeEventListener("timeout",c)}),0))})),function(){r.failType="abort"}),h=function(){r.failType="error"},c=function(){r.failType="timeout"};r.addEventListener("abort",l),r.addEventListener("error",h),r.addEventListener("timeout",c)}};this.hackXHROptions=s,r=this.hackXHROptions,ke.find((function(e){return e.name===r.name}))||(ke.push(r),!Ie&&window.XMLHttpRequest&&(me=window.XMLHttpRequest.prototype.send,_e=window.XMLHttpRequest.prototype.open,ye=window.XMLHttpRequest.prototype.setRequestHeader,Ie=!0,window.XMLHttpRequest.prototype.open=function(){this.aegisMethod=arguments[0];var e=arguments[1];if(Ee.test(e)&&(e=""+location.origin+e),this.aegisUrl=e,this.aegisXhrStartTime=Date.now(),this.sendByAegis)oe.isIE()||(this.timeout=5e3);else for(var t=0;t<ke.length;t++){var r=ke[t];try{"function"==typeof r.open&&r.open(this)}catch(e){}}return _e.apply(this,arguments)},window.XMLHttpRequest.prototype.setRequestHeader=function(){var e,t=arguments[0],r=arguments[1];if(this.aegisXhrReqHeader=null!=(e=this.aegisXhrReqHeader)?e:{},!(-1<["traceparent","b3","sw8","sentry-trace"].indexOf(t)&&(this.aegisXhrReqHeader[t]||(arguments[1]=r),this.aegisXhrReqHeader[t])))return this.aegisXhrReqHeader[t]=arguments[1],ye.apply(this,arguments)},window.XMLHttpRequest.prototype.send=function(){if(!this.sendByAegis)for(var e=0;e<ke.length;e++){var t=ke[e];try{"function"==typeof t.send&&t.send(this,arguments[0])}catch(e){}}return me.apply(this,arguments)}))},getPerformanceEntryByUrl:function(e,t){return null!=(e=e.api)&&e.usePerformanceTiming&&"string"==typeof t.url&&(e=null==(e=performance.getEntriesByName(t.url))?void 0:e.pop())?{url:t.url,isHttps:_(t.url),method:t.method,type:t.type,status:t.status,duration:Number(e.duration.toFixed(2)),nextHopProtocol:e.nextHopProtocol||"",domainLookup:g(e.domainLookupEnd-e.domainLookupStart),connectTime:g(e.connectEnd-e.connectStart)}:{url:t.url,isHttps:_(t.url),method:t.method,type:t.type,status:t.status,duration:Number(t.duration.toFixed(2)),nextHopProtocol:"",domainLookup:a.number,connectTime:a.number}},publishSpeed:function(e){var t=this;this.$walk((function(r){var n=t.$getConfig(r);"fetch"===e.type&&n&&"function"==typeof n.urlHandler?r.speedLogPipeline(s(s({},e),{url:v(n.urlHandler(e.url,e.payload))})):(e.url=v(e.url),r.speedLogPipeline(e))}))},publishNormalLog:function(e){this.$walk((function(t){t.normalLogPipeline(e)}))},destroy:function(){var e,t,r;this.option.publishSpeed=function(){},this.option.publishNormalLog=function(){},this.option.hackXHROptions&&(e=this.option.hackXHROptions,-1!==(r=ke.findIndex((function(t){return t.name===e.name}))))&&ke.splice(r,1),this.option.hackFetchOptions&&(t=this.option.hackFetchOptions,-1!==(r=xe.findIndex((function(e){return e.name===t.name}))))&&xe.splice(r,1),this.option.override=!1}})),Ae={},De=new te({name:"reportBridgeSpeed",override:!1,onNewAegis:function(e){this.override||(this.override=!0,this.overrideBridge(e))},publishSpeed:function(e,t){this.$walk((function(r){r===t&&r.speedLogPipeline(e)}))},overrideBridge:function(e){var t=this,r=e.config;r.reportBridgeSpeed&&r.h5Bridge&&r.h5BridgeFunc.length&&r.h5BridgeFunc.forEach((function(n){var s=r.h5Bridge[n];Ae[n]=s,r.h5Bridge[n]=function(){for(var n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var a=n[0],o=n[1],l=n[2],h=n[3],c=Date.now();s(a,o,l,(function(n){var s=(i=y(n,r.api)).code,i=i.isErr;s={url:a+"-"+o,name:a+"-"+o,duration:Date.now()-c,type:"bridge",ret:s,isErr:+i},t.publishSpeed(s,e),h(n)}))}}))},unHackBridge:function(e){Object.keys(Ae).forEach((function(t){Ae[t]&&(e.config.h5Bridge[t]=Ae[t])})),Ae={}},destroy:function(e){this.option.publishSpeed=function(){},this.option.unHackBridge(e),this.option.override=!1}});function Me(e,t,r){void 0===r&&(r=null),this.traceType=e,this.ignoreUrls=t,this.urls=r}function Oe(e,t,r,n){return void 0===r&&(r=15e3),void 0===n&&(n=0),(t=void 0===t?0:t)<=e&&e<=r?e:n}(Ve=we=we||{})[Ve.unknown=100]="unknown",Ve[Ve.wifi=1]="wifi",Ve[Ve.net2g=2]="net2g",Ve[Ve.net3g=3]="net3g",Ve[Ve.net4g=4]="net4g",Ve[Ve.net5g=5]="net5g",Ve[Ve.net6g=6]="net6g",(Ve=Re=Re||{})[Ve.android=1]="android",Ve[Ve.ios=2]="ios",Ve[Ve.windows=3]="windows",Ve[Ve.macos=4]="macos",Ve[Ve.linux=5]="linux",Ve[Ve.other=100]="other",(Ve=Te=Te||{})[Ve.unknown=100]="unknown",Ve[Ve.normal=0]="normal",Ve[Ve.weak=1]="weak",Ve[Ve.disconnected=2]="disconnected";var qe,Ue,Be,Ne,Fe,$e,je,He,Ge,Ve=new te({name:"device",onNewAegis:function(e){e.extendBean("platform",this.getPlatform()),e.extendBean("netType",we.unknown),this.getDpi(e),this.refreshNetworkTypeToBean(e),this.refreshNetworkStatusToBean(e)},getDpi:function(e){e.extendBean("vp",Math.round(window.innerWidth)+" * "+Math.round(window.innerHeight)),window.screen&&e.extendBean("sr",Math.round(window.screen.width)+" * "+Math.round(window.screen.height))},getPlatform:function(){var e={android:/\bAndroid\s*([^;]+)/,ios:/\b(iPad|iPhone|iPod)\b.*? OS ([\d_]+)/,windows:/\b(Windows NT)/,macos:/\b(Mac OS)/,linux:/\b(Linux)/i},t=Object.keys(e).find((function(t){return e[t].test(navigator.userAgent)}));return t?Re[t]:Re.other},refreshNetworkTypeToBean:function(e){var t=this,r=e.config;r&&("function"==typeof r.getNetworkType?r.getNetworkType:ze)((function(r){we[r]||(r=we.unknown),e.extendBean("netType",r),t.NetworkRefreshTimer=setTimeout((function(){t.refreshNetworkTypeToBean(e),clearTimeout(t.NetworkRefreshTimer)}),1e4)}))},refreshNetworkStatusToBean:function(e){var t,r=this,n=e.config;n&&null!=(t="function"==typeof n.getNetworkStatus?n.getNetworkStatus:t)&&t((function(t){void 0===Te[t]&&(t=Te.unknown),e.extendBean("netStatus",t),r.NetworkStatusRefreshTimer=setTimeout((function(){r.refreshNetworkStatusToBean(e),clearTimeout(r.NetworkStatusRefreshTimer)}),1e4)}))}}),ze=function(e){var t="",r=navigator.userAgent.match(/NetType\/(\w+)/);r?t=r[1]:navigator.connection&&(t=navigator.connection.effectiveType||navigator.connection.type),e((r=t=t||"unknown",0<=(r=String(r).toLowerCase()).indexOf("4g")?we.net4g:0<=r.indexOf("wifi")?we.wifi:0<=r.indexOf("5g")?we.net5g:0<=r.indexOf("6g")?we.net6g:0<=r.indexOf("3g")?we.net3g:0<=r.indexOf("2g")?we.net2g:we.unknown))},We=window.WebSocket,Xe=[],Ke={construct:function(e,t){var r=new e(t[0],t[1]);return r.originSend=r.send,r.addEventListener("error",(function(e){var t=(e=(null==e?void 0:e.currentTarget)||{}).url,r=e.readyState;null!=Xe&&Xe.forEach((function(e){null!=(e=e.onErr)&&e({msg:"无法获知具体错误信息，需在浏览器控制台查看！",readyState:r,connectUrl:t})}))})),Object.defineProperty(r,"send",{get:function(){return function(e){null!=(t=r.originSend)&&t.call(r,e);var t=r.readyState,n=(e=WebSocket.OPEN,WebSocket.CLOSED),i=WebSocket.CONNECTING,a=WebSocket.CLOSING;if(t!==e){var o={readyState:t,connectUrl:r.url};switch(t){case n:Xe.forEach((function(e){null!=(e=e.sendErr)&&e(s({msg:"消息发送失败，连接已关闭！"},o))}));break;case i:Xe.forEach((function(e){(0,e.sendErr)(s({msg:"消息发送失败，正在连接中！"},o))}));break;case a:Xe.forEach((function(e){(0,e.sendErr)(s({msg:"消息发送失败，连接正在关闭！"},o))}))}}}}}),r}},Ye=new te({name:"onError"}),Je=Ye=new te({name:"onError",onNewAegis:function(e){this.startListen(e)},startListen:function(e){function t(t){(t=t&&F(t.reason))&&c.publishErrorLog({msg:"PROMISE_ERROR: "+t,level:D.PROMISE_ERROR},e)}function r(t){var r;if(t=(null==t?void 0:t.target)||(null==t?void 0:t.srcElement)){var n=t.src||t.href||"";if(t=void 0===(t=t.tagName)?"script":t,!(R(r=n,e.config.hostUrl)||-1<window.location.href.indexOf(r))){var s={msg:t+" load fail: "+n,level:D.INFO};if(/\.js$/.test(n))s.level=D.SCRIPT_ERROR;else if(/\.css$/.test(n))s.level=D.CSS_ERROR;else switch(t.toLowerCase()){case"script":s.level=D.SCRIPT_ERROR;break;case"link":s.level=D.CSS_ERROR;break;case"img":s.level=D.IMAGE_ERROR;break;case"audio":case"video":s.level=D.MEDIA_ERROR;break;default:return}c.publishErrorLog(s,e)}}}var n,s,a,o,c=this,u=window.onerror;window.onerror=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n,s=F(t[0]);"string"!=typeof(n=s)||!n||h.some((function(e){return-1<n.indexOf(e)}))||l.some((function(e){return-1<n.indexOf(e)}))||c.publishErrorLog({msg:(s||"")+" @ ("+(F(t[1])||"")+":"+(t[2]||0)+":"+(t[3]||0)+")\n          \n"+F(t[4]||""),level:D.ERROR},e),null!=u&&u.call.apply(u,i([window],t))},window.addEventListener("unhandledrejection",t),window.document.addEventListener("error",r,!0),e.lifeCycle.on("destroy",(function(){0===Ye.countInstance()&&(window.document.removeEventListener("unhandledrejection",t),window.document.removeEventListener("error",r,!0))})),e.config.websocketHack&&(n={key:e.config.id+"-"+this.name,onErr:function(t){var r;null!=(r=c.publishWsErrorLog)&&r.call(c,t,e)},sendErr:function(t){var r;null!=(r=c.publishWsErrorLog)&&r.call(c,t,e)}},this.hackWebsocketConfig=n,n=this.hackWebsocketConfig,window.Proxy)&&window.WebSocket&&(s=window.WebSocket,window&&!s.isHack&&(a=new Proxy(WebSocket,Ke),s.isHack=!0,window.WebSocket=a),o=n,Xe.find((function(e){return e.key===o.key}))||o&&Xe.push(o))},publishErrorLog:function(e,t){this.$walk((function(r){r===t&&r.normalLogPipeline(e)}))},publishWsErrorLog:function(e,t){var r=e.connectUrl,n=e.msg;e=e.readyState,this.publishErrorLog({msg:"WEBSOCKET_ERROR: \n              connect: "+r+"\n              readyState: "+e+"\n              msg: "+n,level:D.WEBSOCKET_ERROR},t)},destroy:function(){var e,t;this.option.publishErrorLog=function(){},this.option.hackWebsocketConfig&&(e=this.option.hackWebsocketConfig,window.WebSocket=We,-1!==(t=Xe.findIndex((function(t){return t.key===e.key}))))&&Xe.splice(t,1)}}),Qe=(new te({name:"pagePerformance"}),3),Ze=new te({name:"pagePerformance",performanceMap:{},onNewAegis:function(e){x()&&(qe?this.publish(qe,e):this.startCalcPerformance(e))},publish:function(e,t){var r=this;this.$walk((function(n){n===t&&n.sendPipeline([function(e,t){var s,i=[];for(s in qe)i.push(s+"="+qe[s]);var a,o=r.$getConfig(n);if(o)return a=-1===(null==(a=n.config.performanceUrl)?void 0:a.indexOf("?"))?"?":"&","function"==typeof o.urlHandler?t({url:n.config.performanceUrl+a+i.join("&")+"&from="+(encodeURIComponent(o.urlHandler())||window.location.href),beanFilter:["from"],type:M.PERFORMANCE,log:e}):t({url:n.config.performanceUrl+a+i.join("&"),type:M.PERFORMANCE,log:e})}],M.PERFORMANCE)(s({},e))}))},startCalcPerformance:function(e){var t=this;try{this.getFirstScreenTiming(e,(function(r){var n=performance.timing;n&&(qe={dnsLookup:Oe(n.domainLookupEnd-n.domainLookupStart),tcp:Oe(n.connectEnd-n.connectStart),ssl:Oe(0===n.secureConnectionStart?0:n.requestStart-n.secureConnectionStart),ttfb:Oe(n.responseStart-n.requestStart),contentDownload:Oe(n.responseEnd-n.responseStart),domParse:Oe(n.domInteractive-n.domLoading,0,15e3,1070),resourceDownload:Oe(n.loadEventStart-n.domInteractive,0,15e3,1070),firstScreenTiming:Oe(Math.floor(r),0,15e3,15e3)},(n=e.config).extraPerformanceData&&"{}"!==JSON.stringify(n.extraPerformanceData)&&(n=(r=n.extraPerformanceData).engineInit,r=r.bundleLoad,qe=s(s({},qe),{engineInit:Oe(n,0,1e4),bundleLoad:Oe(r,0,1e4)})),t.publish(qe,e))}))}catch(e){}},getFirstScreenTiming:function(e,t){var r=this;e.lifeCycle.on("destroy",(function(){u&&clearTimeout(u)}));var n,s=this,i=["script","style","link","br"],a=[],o={},l=(-1<(null==(h=null==(h=window.PerformanceObserver)?void 0:h.supportedEntryTypes)?void 0:h.indexOf("paint"))&&(n=new PerformanceObserver((function(s){s.getEntries().forEach((function(s){var i;"paint"===s.entryType&&"first-contentful-paint"===s.name&&0<(i=document.querySelectorAll("[AEGIS-FIRST-SCREEN-TIMING]")).length&&(r.setFirstScreenInfo(e,s.startTime,i[0],i),null!=t&&t(s.startTime),l.disconnect(),n.disconnect())}))}))).observe({entryTypes:["paint"]}),new MutationObserver((function(e){var t={roots:[],ignores:[],rootsDomNum:[],time:performance.now()};e.forEach((function(e){e&&e.addedNodes&&Array.prototype.slice.call(e.addedNodes).forEach((function(e){s.isEleInArray(e,t.ignores)?t.ignores.push(e):1===e.nodeType&&e.hasAttribute("AEGIS-FIRST-SCREEN-TIMING")?(Object.prototype.hasOwnProperty.apply(o,[t.time])||(o[t.time]=[]),o[t.time].push(e)):1===e.nodeType&&(s.hasAncestorOrSelfWithAttribute(e,"AEGIS-IGNORE-FIRST-SCREEN-TIMING")?t.ignores.push(e):-1!==i.indexOf(e.nodeName.toLocaleLowerCase())||s.isEleInArray(e,t.roots)||(t.roots.push(e),t.rootsDomNum.push(s.walkAndCount(e)||0)))}))})),t.roots.length&&a.push(t)})));l.observe(document,{childList:!0,subtree:!0});var h,c=function(i){(i=void 0===i?0:i)||(h=0,(p=Object.keys(o)).length?(i=Math.max.apply(null,p),r.setFirstScreenInfo(e,i,null==(p=o[i])?void 0:p[0],o)):a.forEach((function(t){for(var n=0;n<t.roots.length;n++)t.rootsDomNum[n]>h&&s.isInFirstScreen(t.roots[n])&&(h=t.rootsDomNum[n],i=t.time,r.setFirstScreenInfo(e,i,t.roots[n]))})),a.length=0,Object.keys(o).forEach((function(e){o[e]=o[e].map((function(e){var t={tagName:e.tagName},r=e.attributes;if(!r)return e;for(var n=0;n<r.length;n++){var s=r[n];s.name&&(t[s.name]=e.getAttribute(s.name))}return t}))})));var h,d=(p=performance.timing).domInteractive-p.domLoading,p=p.loadEventStart-p.domInteractive,f=i;u=null;for(var g=0,v=[d,p,f];g<v.length;g++)if(v[g]<=0&&0<Qe){u=setTimeout((function(){return c(f)}),3e3);break}u?--Qe:(l.disconnect(),null!=n&&n.disconnect(),null!=t&&t(i))},u=setTimeout((function(){return c()}),3e3)},setFirstScreenInfo:function(e,t,r,n){var s;e.config.id&&this.performanceMap[e.config.id]||(e.config.id&&(this.performanceMap[e.config.id]=!0),("object"!=typeof(null==(s=e.config)?void 0:s.pagePerformance)||null!=(s=e.config.pagePerformance)&&s.firstScreenInfo)&&(e.firstScreenInfo={element:r,timing:t,markDoms:n}))},isEleInArray:function(e,t){return!(!e||e===document.documentElement)&&(-1!==t.indexOf(e)||this.isEleInArray(e.parentElement,t))},isInFirstScreen:function(e){var t,r;return!(!e||"function"!=typeof e.getBoundingClientRect)&&(e=e.getBoundingClientRect(),t=window.innerHeight,r=window.innerWidth,0<=e.left)&&e.left<r&&0<=e.top&&e.top<t&&0<e.width&&0<e.height},walkAndCount:function(e){var t=0;if(e&&1===e.nodeType){t+=1;var r=e.children;if(null!=r&&r.length)for(var n=0;n<r.length;n++)1===r[n].nodeType&&r[n].hasAttribute("AEGIS-IGNORE-FIRST-SCREEN-TIMING")||(t+=this.walkAndCount(r[n]))}return t},hasAncestorOrSelfWithAttribute:function(e,t){for(var r=e;r&&r!==document.body;){if(r.hasAttribute(t))return!0;r=r.parentElement}return!1}});function et(){Fe=[],Be=-1,Ue=null,nt(addEventListener)}function tt(e,t){Ue||(Ue=t,Be=e,Ne=new Date,nt(removeEventListener),rt())}function rt(){var e;0<=Be&&Be<Ne-je&&(e={entryType:"first-input",name:Ue.type,target:Ue.target,cancelable:Ue.cancelable,startTime:Ue.timeStamp,processingStart:Ue.timeStamp+Be},Fe.forEach((function(t){t(e)})),Fe=[])}function nt(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(t){return e(t,He,$e)}))}function st(e,t){var r=St(),n="navigate";return 0<=Tt?n="back-forward-cache":r&&(document.prerendering||0<It()?n="prerender":document.wasDiscarded?n="restore":r.type&&(n=r.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:n}}function it(e,t,r){try{var n;if(PerformanceObserver.supportedEntryTypes.includes(e))return(n=new PerformanceObserver((function(e){Promise.resolve().then((function(){t(e.getEntries())}))}))).observe(Object.assign({type:e,buffered:!0},r||{})),n}catch(e){}}function at(e,t,r,n){var s,i;return function(a){0<=t.value&&(a||n)&&((i=t.value-(s||0))||void 0===s)&&(s=t.value,t.delta=i,t.rating=(a=t.value)>r[1]?"poor":a>r[0]?"needs-improvement":"good",e(t))}}function ot(e){requestAnimationFrame((function(){return requestAnimationFrame((function(){return e()}))}))}function lt(e){function t(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)}addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)}function ht(e){var t=!1;return function(r){t||(e(r),t=!0)}}function ct(){return kt<0&&(kt=Et(),xt(),Ct((function(){setTimeout((function(){kt=Et(),xt()}),0)}))),{get firstHiddenTime(){return kt}}}function ut(e){document.prerendering?addEventListener("prerenderingchange",(function(){return e()}),!0):e()}function dt(e,t){t=t||{},ut((function(){var r,n=ct(),s=st("FCP"),i=it("paint",(function(e){e.forEach((function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<n.firstHiddenTime)&&(s.value=Math.max(e.startTime-It(),0),s.entries.push(e),r(!0))}))}));i&&(r=at(e,s,Lt,t.reportAllChanges),Ct((function(n){s=st("FCP"),r=at(e,s,Lt,t.reportAllChanges),ot((function(){s.value=performance.now()-n.timeStamp,r(!0)}))})))}))}function pt(){var e;0<=_t&&_t<yt-Mt&&(e={entryType:"first-input",name:mt.type,target:mt.target,cancelable:mt.cancelable,startTime:mt.timeStamp,processingStart:mt.timeStamp+_t},bt.forEach((function(t){t(e)})),bt=[])}function ft(e){var t,r,n,s;function i(){Ot(r,n),s()}function a(){s()}e.cancelable&&(t=(1e12<e.timeStamp?new Date:performance.now())-e.timeStamp,"pointerdown"==e.type?(r=t,n=e,s=function(){removeEventListener("pointerup",i,Dt),removeEventListener("pointercancel",a,Dt)},addEventListener("pointerup",i,Dt),addEventListener("pointercancel",a,Dt)):Ot(t,e))}function gt(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(t){return e(t,ft,Dt)}))}function vt(e){var t=e.name;0<(e=e.value)&&(Nt[t]=e)}$e={passive:!0,capture:!0},je=new Date,He=function(e){var t,r,n,s;function i(){tt(r,n),s()}function a(){s()}e.cancelable&&(t=(1e12<e.timeStamp?new Date:performance.now())-e.timeStamp,"pointerdown"==e.type?(r=t,n=e,s=function(){removeEventListener("pointerup",i,$e),removeEventListener("pointercancel",a,$e)},addEventListener("pointerup",i,$e),addEventListener("pointercancel",a,$e)):tt(t,e))},Ge="hidden"===document.visibilityState?0:1/0,addEventListener("visibilitychange",(function e(t){"hidden"===document.visibilityState&&(Ge=t.timeStamp,removeEventListener("visibilitychange",e,!0))}),!0),et(),self.webVitals={firstInputPolyfill:function(e){Fe.push(e),rt()},resetFirstInputPolyfill:et,get firstHiddenTime(){return Ge}};var mt,_t,yt,bt,wt,Rt,Tt=-1,Ct=function(e){addEventListener("pageshow",(function(t){t.persisted&&(Tt=t.timeStamp,e(t))}),!0)},St=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},It=function(){var e=St();return e&&e.activationStart||0},kt=-1,Et=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},Pt=function(e){"hidden"===document.visibilityState&&-1<kt&&(kt="visibilitychange"===e.type?e.timeStamp:0,removeEventListener("visibilitychange",Pt,!0),removeEventListener("prerenderingchange",Pt,!0))},xt=function(){addEventListener("visibilitychange",Pt,!0),addEventListener("prerenderingchange",Pt,!0)},Lt=[1800,3e3],At=[.1,.25],Dt={passive:!0,capture:!0},Mt=new Date,Ot=function(e,t){mt||(mt=t,_t=e,yt=new Date,gt(removeEventListener),pt())},qt=[100,300],Ut=[2500,4e3],Bt={},Nt=(new te({name:"webVitals"}),{FCP:-1,LCP:-1,FID:-1,CLS:-1}),Ft=new te({name:"webVitals",onNewAegis:function(e){if(x()&&"function"==typeof window.PerformanceObserver&&"function"==typeof performance.getEntriesByName)try{dt(vt),i=vt,a={},ut((function(){function e(e){(e=e[e.length-1])&&e.startTime<n.firstHiddenTime&&(s.value=Math.max(e.startTime-It(),0),s.entries=[e],t())}var t,r,n=ct(),s=st("LCP"),o=it("largest-contentful-paint",e);o&&(t=at(i,s,Ut,a.reportAllChanges),r=ht((function(){Bt[s.id]||(e(o.takeRecords()),o.disconnect(),Bt[s.id]=!0,t(!0))})),["keydown","click"].forEach((function(e){addEventListener(e,r,!0)})),lt(r),Ct((function(e){s=st("LCP"),t=at(i,s,Ut,a.reportAllChanges),ot((function(){s.value=performance.now()-e.timeStamp,Bt[s.id]=!0,t(!0)}))})))})),n=vt,s={},ut((function(){function e(e){e.startTime<r.firstHiddenTime&&(i.value=e.processingStart-e.startTime,i.entries.push(e),o(!0))}function t(t){t.forEach(e)}var r=ct(),i=st("FID"),a=it("first-input",t),o=at(n,i,qt,s.reportAllChanges);a&&lt(ht((function(){t(a.takeRecords()),a.disconnect()}))),a&&Ct((function(){i=st("FID"),o=at(n,i,qt,s.reportAllChanges),bt=[],_t=-1,mt=null,gt(addEventListener),bt.push(e),pt()}))})),t=vt,r={},dt(ht((function(){function e(e){e.forEach((function(e){var t,r;e.hadRecentInput||(t=a[0],r=a[a.length-1],i&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(i+=e.value,a.push(e)):(i=e.value,a=[e]))})),i>s.value&&(s.value=i,s.entries=a,n())}var n,s=st("CLS",0),i=0,a=[],o=it("layout-shift",e);o&&(n=at(t,s,At,r.reportAllChanges),lt((function(){e(o.takeRecords()),n(!0)})),Ct((function(){s=st("CLS",i=0),n=at(t,s,At,r.reportAllChanges),ot((function(){return n()}))})),setTimeout(n,0))}))),L(this.publish.bind(this,e),{once:!0,delay:{visibilitychange:10}})}catch(e){}var t,r,n,s,i,a},publish:function(e){this.$walk((function(t){var r;t===e&&null!=(r=t.sendPipeline)&&r.call(t,[function(e,r){var n,s=[];for(n in Nt)s.push(n+"="+Nt[n]);var i=-1===(null==(i=null==(i=t.config)?void 0:i.performanceUrl)?void 0:i.indexOf("?"))?"?":"&";r({url:t.config.webVitalsUrl+i+s.join("&"),type:M.VITALS,log:e,sendBeacon:!0})}],M.VITALS)(s({},Nt))}))},destroy:function(){this.option.publish=function(){}}}),$t=(new te({name:"spa"}),["replaceState","pushState","popstate","hashchange"]),jt=new te({name:"spa",originFireUrl:"",onNewAegis:function(e){var t=this;history.pushState=this.wr("pushState")||history.pushState,history.replaceState=this.wr("replaceState")||history.replaceState,this.sendPv=this.sendPv.bind(this),e.config.spa&&this.sendPv(e),$t.forEach((function(r){return window.addEventListener(r,(function(){return t.sendPv.call(t,e)}))}))},wr:function(e){var t=history[e],r="__"+e+"__hasWrittenByTamSpa";return"function"==typeof t&&!history[r]&&(Object.defineProperty(history,r,{value:!0,enumerable:!1}),function(){var r=t.apply(this,arguments),n=null;return"function"==typeof Event?n=new Event(e):(n=document.createEvent("HTMLEvents")).initEvent(e,!1,!0),window.dispatchEvent(n),r})},sendPv:function(e){var t=this;setTimeout((function(){var r=location.href,n=location.pathname+location.hash+e.config.id;t.$walk((function(s){var i;s===e&&(i=s.config.pvUrl)&&n&&n!==t.originFireUrl&&(s.sendPipeline([function(e,t){t({url:i+"?from="+encodeURIComponent(r),beanFilter:["from"],type:M.PV})}],M.PV)(null),t.originFireUrl=n)}))}),0)},destroy:function(){this.option.sendPv=function(){}}});function Ht(e){var t,r,n,i,a=wt.call(this,e)||this;a.sendNow=!1,a.isReportReady=!1,a.reportRequestQueue=[],a.speedLogPipeline=E([T(a),(i=a.config,function(e,t){var r,n,s,a="number"==typeof i.repeat?i.repeat:60;!i.speedSample||a<=0?t(e):(r=(null==i?void 0:i.id)||"0",n=K[r]||{},Array.isArray(e)?(s=e.filter((function(e){var t=!n[e.url]||n[e.url]<a;return t?(n[e.url]=1+~~n[e.url],K[r]=n):X[r]||Y(r),t}))).length&&t(s):!n[e.url]||n[e.url]<a?(n[e.url]=1+~~n[e.url],K[r]=n,t(e)):X[r]||Y(r))}),(n=a,function(e,t){ze((function(r){n.extendBean("netType",r),t(e)}))}),function(e,t){null!=(r=a.lifeCycle)&&r.emit("beforeReportSpeed",e);var r,n=a.config.beforeReportSpeed;if((e="function"==typeof n?e.filter((function(e){return!1!==n(e)})):e).length)return t(e)},function(e,t){t(e.map((function(e){return void 0!==e.payload&&delete e.payload,e})))},function(e){return a.sendPipeline([function(e,t){var r,n,i,o;t({type:M.SPEED,url:""+a.config.speedUrl,method:"post",data:(t=e,r=s(s({},a.bean),{from:a.getCurrentPageUrl()}),i={fetch:[],static:[],bridge:[]},o=new FormData,Array.isArray(t)?t.forEach((function(e){var t=ne(e);i[e.type].push(t)})):(n=ne(t),i[t.type].push(n)),o.append("payload",$(s({duration:i},r))),o),log:e})}],M.SPEED)(e)}]),e.asyncPlugin=!0;try{"undefined"!=typeof document&&(e.uin=e.uin||(null!=(t=document.cookie.match(/\buin=\D+(\d*)/))?t:[])[1]||(null!=(r=document.cookie.match(/\bilive_uin=\D*(\d+)/))?r:[])[1]||""),a.init(e),a.extendBean("sessionId",Ht.sessionID),a.extendBean("from",a.getCurrentPageUrl()),"undefined"!=typeof document&&a.extendBean("referer",encodeURIComponent(document.referrer||"")),e.ext1&&a.extendBean("ext1",encodeURIComponent(e.ext1)),e.ext2&&a.extendBean("ext2",encodeURIComponent(e.ext2)),e.ext3&&a.extendBean("ext3",encodeURIComponent(e.ext3))}catch(e){a.sendSDKError(e)}return a}function Gt(){this.constructor=Rt}n(Rt=Ht,ee=wt=ee),Rt.prototype=null===ee?Object.create(ee):(Gt.prototype=ee.prototype,new Gt),Ht.prototype.getBean=function(e){var t=this;return void 0===e&&(e=[]),""+Object.getOwnPropertyNames(this.bean).filter((function(t){return-1===e.indexOf(t)})).map((function(e){return"from"===e?"from="+t.getCurrentPageUrl():e+"="+t.bean[e]})).join("&")},Ht.prototype.getCurrentPageUrl=function(){var e=this.config.pageUrl||location.href;return e=(e="function"==typeof this.config.urlHandler?this.config.urlHandler():e).slice(0,2048),encodeURIComponent(e)},Ht.prototype.ready=function(){function e(){var r,n,s,i;t.reportRequestQueue.length&&(r=t.reportRequestQueue.splice(0,1)[0],n=r.options,s=r.success,i=r.fail,t.$request(n,(function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];try{return null==s?void 0:s.apply(n,t)}finally{e()}}),(function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];try{return null==i?void 0:i.apply(n,t)}finally{e()}})))}var t=this;e(),this.isReportReady=!0},Ht.prototype.request=function(e,t,r){this.config.reportImmediately||this.isReportReady?this.$request(e,t,r):this.reportRequestQueue.push({options:e,success:t,fail:r})},Ht.prototype.$request=function(e,t,r){var n,s,i,a;if(e&&"string"==typeof e.url&&""!==e.url&&this.bean.id)return a=e.url,!1!==e.addBean&&(a=a+(-1===a.indexOf("?")?"?":"&")+this.getBean(e.beanFilter)),e.url=a,a=e.method||"get",(e=(s=this.config.onBeforeRequest)?s(e,this):e)&&e.url?void((null!=e&&e.sendBeacon||this.sendNow)&&"function"==typeof(null===navigator||void 0===navigator?void 0:navigator.sendBeacon)?navigator.sendBeacon(e.url,e.data):((n=new XMLHttpRequest).sendByAegis=!0,n.addEventListener("readystatechange",(function(){4===n.readyState&&(400<=n.status||0===n.status?null!=r&&r(n.response):null!=t&&t(n.response))})),"get"===a.toLocaleLowerCase()?(n.open("get",(s=e.url,i=e.data,"string"!=typeof s?"":"object"==typeof i&&i?(a=Object.getOwnPropertyNames(i).map((function(e){var t=i[e];return e+"="+("string"==typeof t?encodeURIComponent(t):encodeURIComponent(JSON.stringify(t)))})).join("&").replace(/eval/gi,"evaI"),s+(-1===s.indexOf("?")?"?":"&")+a):s)),n.send()):(n.open("post",e.url),e.contentType&&n.setRequestHeader("Content-Type",e.contentType),"string"==typeof e.data&&(e.data=e.data.replace(/eval/gi,"evaI")),n.send(e.data)))):void 0},Ht.prototype.publishPluginsLogs=function(){var e=Ht.installedPlugins.find((function(e){return"reportAssetSpeed"===e.name}));null!=e&&e.option.collectNotReportedLog(this)},Ht.prototype.uploadLogs=function(e,t){var r;void 0===e&&(e={}),void 0===t&&(t={}),null!=(r=this.lifeCycle)&&r.emit("uploadLogs",e,t)},Ht.sessionID="session-"+Date.now(),ee=Ht,new te({name:"ie"}),new te({name:"onClose"});var Vt=new te({name:"onClose",onNewAegis:function(e){var t,r=this;oe.desktop()?(t=window.onunload,window.onunload=function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];r.publishNotReportedLog(e),null!=t&&t.call.apply(t,i([window],n))}):L(this.publishNotReportedLog.bind(this,e),{once:!0})},publishNotReportedLog:function(e){var t=this;this.$walk((function(r){r===e&&(r.sendNow=!0,r.publishPluginsLogs(),t.publishThrottlePipeLogs(r))}))},publishThrottlePipeLogs:function(e){null!=e&&e.speedLogPipeline([]),null!=e&&e.eventPipeline([]),null!=e&&e.customTimePipeline([]),null!=e&&e.normalLogPipeline([])}});return new te({name:"aid"}),ee.use(Je),ee.use(Le),ee.use(ie),ee.use(Ze),ee.use(Ft),ee.use(re),ee.use(Ve),ee.use(jt),ee.use(Vt),ee.use(De),ee}()},249:function(e,t,r){var n;e.exports=(n=n||function(e,t){var n;if("undefined"!=typeof window&&window.crypto&&(n=window.crypto),"undefined"!=typeof self&&self.crypto&&(n=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(n=globalThis.crypto),!n&&"undefined"!=typeof window&&window.msCrypto&&(n=window.msCrypto),!n&&void 0!==r.g&&r.g.crypto&&(n=r.g.crypto),!n)try{n=r(480)}catch(e){}var s=function(){if(n){if("function"==typeof n.getRandomValues)try{return n.getRandomValues(new Uint32Array(1))[0]}catch(e){}if("function"==typeof n.randomBytes)try{return n.randomBytes(4).readInt32LE()}catch(e){}}throw new Error("Native crypto module could not be used to get secure random number.")},i=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),a={},o=a.lib={},l=o.Base={extend:function(e){var t=i(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},h=o.WordArray=l.extend({init:function(e,r){e=this.words=e||[],this.sigBytes=r!=t?r:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,s=e.sigBytes;if(this.clamp(),n%4)for(var i=0;i<s;i++){var a=r[i>>>2]>>>24-i%4*8&255;t[n+i>>>2]|=a<<24-(n+i)%4*8}else for(var o=0;o<s;o+=4)t[n+o>>>2]=r[o>>>2];return this.sigBytes+=s,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=l.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],r=0;r<e;r+=4)t.push(s());return new h.init(t,e)}}),c=a.enc={},u=c.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s++){var i=t[s>>>2]>>>24-s%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new h.init(r,t/2)}},d=c.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s++){var i=t[s>>>2]>>>24-s%4*8&255;n.push(String.fromCharCode(i))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new h.init(r,t)}},p=c.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},f=o.BufferedBlockAlgorithm=l.extend({reset:function(){this._data=new h.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=p.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r,n=this._data,s=n.words,i=n.sigBytes,a=this.blockSize,o=i/(4*a),l=(o=t?e.ceil(o):e.max((0|o)-this._minBufferSize,0))*a,c=e.min(4*l,i);if(l){for(var u=0;u<l;u+=a)this._doProcessBlock(s,u);r=s.splice(0,l),n.sigBytes-=c}return new h.init(r,c)},clone:function(){var e=l.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),g=(o.Hasher=f.extend({cfg:l.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){f.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new g.HMAC.init(e,r).finalize(t)}}}),a.algo={});return a}(Math),n)},269:function(e,t,r){var n;e.exports=(n=r(249),function(){var e=n,t=e.lib.WordArray;function r(e,r,n){for(var s=[],i=0,a=0;a<r;a++)if(a%4){var o=n[e.charCodeAt(a-1)]<<a%4*2|n[e.charCodeAt(a)]>>>6-a%4*2;s[i>>>2]|=o<<24-i%4*8,i++}return t.create(s,i)}e.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var s=[],i=0;i<r;i+=3)for(var a=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,o=0;o<4&&i+.75*o<r;o++)s.push(n.charAt(a>>>6*(3-o)&63));var l=n.charAt(64);if(l)for(;s.length%4;)s.push(l);return s.join("")},parse:function(e){var t=e.length,n=this._map,s=this._reverseMap;if(!s){s=this._reverseMap=[];for(var i=0;i<n.length;i++)s[n.charCodeAt(i)]=i}var a=n.charAt(64);if(a){var o=e.indexOf(a);-1!==o&&(t=o)}return r(e,t,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),n.enc.Base64)},10:function(e,t,r){var n;e.exports=(n=r(249),r(153),r(824),n.HmacSHA256)},824:function(e,t,r){var n,s,i,a;e.exports=(n=r(249),i=(s=n).lib.Base,a=s.enc.Utf8,void(s.algo.HMAC=i.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=a.parse(t));var r=e.blockSize,n=4*r;t.sigBytes>n&&(t=e.finalize(t)),t.clamp();for(var s=this._oKey=t.clone(),i=this._iKey=t.clone(),o=s.words,l=i.words,h=0;h<r;h++)o[h]^=1549556828,l[h]^=909522486;s.sigBytes=i.sigBytes=n,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})))},153:function(e,t,r){var n;e.exports=(n=r(249),function(e){var t=n,r=t.lib,s=r.WordArray,i=r.Hasher,a=t.algo,o=[],l=[];!function(){function t(t){for(var r=e.sqrt(t),n=2;n<=r;n++)if(!(t%n))return!1;return!0}function r(e){return 4294967296*(e-(0|e))|0}for(var n=2,s=0;s<64;)t(n)&&(s<8&&(o[s]=r(e.pow(n,.5))),l[s]=r(e.pow(n,1/3)),s++),n++}();var h=[],c=a.SHA256=i.extend({_doReset:function(){this._hash=new s.init(o.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],a=r[3],o=r[4],c=r[5],u=r[6],d=r[7],p=0;p<64;p++){if(p<16)h[p]=0|e[t+p];else{var f=h[p-15],g=(f<<25|f>>>7)^(f<<14|f>>>18)^f>>>3,v=h[p-2],m=(v<<15|v>>>17)^(v<<13|v>>>19)^v>>>10;h[p]=g+h[p-7]+m+h[p-16]}var _=n&s^n&i^s&i,y=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),b=d+((o<<26|o>>>6)^(o<<21|o>>>11)^(o<<7|o>>>25))+(o&c^~o&u)+l[p]+h[p];d=u,u=c,c=o,o=a+b|0,a=i,i=s,s=n,n=b+(y+_)|0}r[0]=r[0]+n|0,r[1]=r[1]+s|0,r[2]=r[2]+i|0,r[3]=r[3]+a|0,r[4]=r[4]+o|0,r[5]=r[5]+c|0,r[6]=r[6]+u|0,r[7]=r[7]+d|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,s=8*t.sigBytes;return r[s>>>5]|=128<<24-s%32,r[14+(s+64>>>9<<4)]=e.floor(n/4294967296),r[15+(s+64>>>9<<4)]=n,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=i._createHelper(c),t.HmacSHA256=i._createHmacHelper(c)}(Math),n.SHA256)},729:e=>{"use strict";var t=Object.prototype.hasOwnProperty,r="~";function n(){}function s(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,n,i,a){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new s(n,i||e,a),l=r?r+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function o(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,n,s=[];if(0===this._eventsCount)return s;for(n in e=this._events)t.call(e,n)&&s.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,i=n.length,a=new Array(i);s<i;s++)a[s]=n[s].fn;return a},o.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},o.prototype.emit=function(e,t,n,s,i,a){var o=r?r+e:e;if(!this._events[o])return!1;var l,h,c=this._events[o],u=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),u){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,s),!0;case 5:return c.fn.call(c.context,t,n,s,i),!0;case 6:return c.fn.call(c.context,t,n,s,i,a),!0}for(h=1,l=new Array(u-1);h<u;h++)l[h-1]=arguments[h];c.fn.apply(c.context,l)}else{var d,p=c.length;for(h=0;h<p;h++)switch(c[h].once&&this.removeListener(e,c[h].fn,void 0,!0),u){case 1:c[h].fn.call(c[h].context);break;case 2:c[h].fn.call(c[h].context,t);break;case 3:c[h].fn.call(c[h].context,t,n);break;case 4:c[h].fn.call(c[h].context,t,n,s);break;default:if(!l)for(d=1,l=new Array(u-1);d<u;d++)l[d-1]=arguments[d];c[h].fn.apply(c[h].context,l)}}return!0},o.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,n,s){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||s&&!o.once||n&&o.context!==n||a(this,i);else{for(var l=0,h=[],c=o.length;l<c;l++)(o[l].fn!==t||s&&!o[l].once||n&&o[l].context!==n)&&h.push(o[l]);h.length?this._events[i]=1===h.length?h[0]:h:a(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&a(this,t)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o},908:(e,t,r)=>{var n;n="undefined"!=typeof window?window:void 0!==r.g?r.g:"undefined"!=typeof self?self:{},e.exports=n},43:function(e,t,r){var n,s;!function(i,a){"use strict";n=function(){var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"];function s(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function i(){console.log&&(console.log.apply||Function.prototype.apply.apply(console.log,[console,arguments])),console.trace}function a(n){return"debug"===n&&(n="log"),typeof console!==t&&("trace"===n&&r?i:void 0!==console[n]?s(console,n):void 0!==console.log?s(console,"log"):e)}function o(t,r){for(var s=0;s<n.length;s++){var i=n[s];this[i]=s<t?e:this.methodFactory(i,t,r)}this.log=this.debug}function l(e,r,n){return function(){typeof console!==t&&(o.call(this,r,n),this[e].apply(this,arguments))}}function h(e,t,r){return a(e)||l.apply(this,arguments)}function c(e,r,s){var i,a=this;r=null==r?"WARN":r;var l="loglevel";function c(e){var r=(n[e]||"silent").toUpperCase();if(typeof window!==t&&l){try{return void(window.localStorage[l]=r)}catch(e){}try{window.document.cookie=encodeURIComponent(l)+"="+r+";"}catch(e){}}}function u(){var e;if(typeof window!==t&&l){try{e=window.localStorage[l]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=r.indexOf(encodeURIComponent(l)+"=");-1!==n&&(e=/^([^;]+)/.exec(r.slice(n))[1])}catch(e){}return void 0===a.levels[e]&&(e=void 0),e}}function d(){if(typeof window!==t&&l){try{return void window.localStorage.removeItem(l)}catch(e){}try{window.document.cookie=encodeURIComponent(l)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}"string"==typeof e?l+=":"+e:"symbol"==typeof e&&(l=void 0),a.name=e,a.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},a.methodFactory=s||h,a.getLevel=function(){return i},a.setLevel=function(r,n){if("string"==typeof r&&void 0!==a.levels[r.toUpperCase()]&&(r=a.levels[r.toUpperCase()]),!("number"==typeof r&&r>=0&&r<=a.levels.SILENT))throw"log.setLevel() called with invalid level: "+r;if(i=r,!1!==n&&c(r),o.call(a,r,e),typeof console===t&&r<a.levels.SILENT)return"No console available for logging"},a.setDefaultLevel=function(e){r=e,u()||a.setLevel(e,!1)},a.resetLevel=function(){a.setLevel(r,!1),d()},a.enableAll=function(e){a.setLevel(a.levels.TRACE,e)},a.disableAll=function(e){a.setLevel(a.levels.SILENT,e)};var p=u();null==p&&(p=r),a.setLevel(p,!1)}var u=new c,d={};u.getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=d[e];return t||(t=d[e]=new c(e,u.getLevel(),u.methodFactory)),t};var p=typeof window!==t?window.log:void 0;return u.noConflict=function(){return typeof window!==t&&window.log===u&&(window.log=p),u},u.getLoggers=function(){return d},u.default=u,u},void 0===(s="function"==typeof n?n.call(t,r,t,e):n)||(e.exports=s)}()},238:function(e,t,r){var n;!function(s,i){"use strict";var a="function",o="undefined",l="object",h="string",c="major",u="model",d="name",p="type",f="vendor",g="version",v="architecture",m="console",_="mobile",y="tablet",b="smarttv",w="wearable",R="embedded",T="Amazon",C="Apple",S="ASUS",I="BlackBerry",k="Browser",E="Chrome",P="Firefox",x="Google",L="Huawei",A="LG",D="Microsoft",M="Motorola",O="Opera",q="Samsung",U="Sharp",B="Sony",N="Xiaomi",F="Zebra",$="Facebook",j="Chromium OS",H="Mac OS",G=function(e){for(var t={},r=0;r<e.length;r++)t[e[r].toUpperCase()]=e[r];return t},V=function(e,t){return typeof e===h&&-1!==z(t).indexOf(z(e))},z=function(e){return e.toLowerCase()},W=function(e,t){if(typeof e===h)return e=e.replace(/^\s\s*/,""),typeof t===o?e:e.substring(0,350)},X=function(e,t){for(var r,n,s,o,h,c,u=0;u<t.length&&!h;){var d=t[u],p=t[u+1];for(r=n=0;r<d.length&&!h&&d[r];)if(h=d[r++].exec(e))for(s=0;s<p.length;s++)c=h[++n],typeof(o=p[s])===l&&o.length>0?2===o.length?typeof o[1]==a?this[o[0]]=o[1].call(this,c):this[o[0]]=o[1]:3===o.length?typeof o[1]!==a||o[1].exec&&o[1].test?this[o[0]]=c?c.replace(o[1],o[2]):i:this[o[0]]=c?o[1].call(this,c,o[2]):i:4===o.length&&(this[o[0]]=c?o[3].call(this,c.replace(o[1],o[2])):i):this[o]=c||i;u+=2}},K=function(e,t){for(var r in t)if(typeof t[r]===l&&t[r].length>0){for(var n=0;n<t[r].length;n++)if(V(t[r][n],e))return"?"===r?i:r}else if(V(t[r],e))return"?"===r?i:r;return e},Y={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},J={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[g,[d,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[g,[d,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[d,g],[/opios[\/ ]+([\w\.]+)/i],[g,[d,O+" Mini"]],[/\bopr\/([\w\.]+)/i],[g,[d,O]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[d,g],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[g,[d,"UC"+k]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[g,[d,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[g,[d,"WeChat"]],[/konqueror\/([\w\.]+)/i],[g,[d,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[g,[d,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[g,[d,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[d,/(.+)/,"$1 Secure "+k],g],[/\bfocus\/([\w\.]+)/i],[g,[d,P+" Focus"]],[/\bopt\/([\w\.]+)/i],[g,[d,O+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[g,[d,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[g,[d,"Dolphin"]],[/coast\/([\w\.]+)/i],[g,[d,O+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[g,[d,"MIUI "+k]],[/fxios\/([-\w\.]+)/i],[g,[d,P]],[/\bqihu|(qi?ho?o?|360)browser/i],[[d,"360 "+k]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[d,/(.+)/,"$1 "+k],g],[/(comodo_dragon)\/([\w\.]+)/i],[[d,/_/g," "],g],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[d,g],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[d],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[d,$],g],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[d,g],[/\bgsa\/([\w\.]+) .*safari\//i],[g,[d,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[g,[d,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[g,[d,E+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[d,E+" WebView"],g],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[g,[d,"Android "+k]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[d,g],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[g,[d,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[g,d],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[d,[g,K,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[d,g],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[d,"Netscape"],g],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[g,[d,P+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[d,g],[/(cobalt)\/([\w\.]+)/i],[d,[g,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[v,"amd64"]],[/(ia32(?=;))/i],[[v,z]],[/((?:i[346]|x)86)[;\)]/i],[[v,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[v,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[v,"armhf"]],[/windows (ce|mobile); ppc;/i],[[v,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[v,/ower/,"",z]],[/(sun4\w)[;\)]/i],[[v,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[v,z]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[u,[f,q],[p,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[u,[f,q],[p,_]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[u,[f,C],[p,_]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[u,[f,C],[p,y]],[/(macintosh);/i],[u,[f,C]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[u,[f,U],[p,_]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[u,[f,L],[p,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[u,[f,L],[p,_]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[u,/_/g," "],[f,N],[p,_]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[u,/_/g," "],[f,N],[p,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[u,[f,"OPPO"],[p,_]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[u,[f,"Vivo"],[p,_]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[u,[f,"Realme"],[p,_]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[u,[f,M],[p,_]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[u,[f,M],[p,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[u,[f,A],[p,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[u,[f,A],[p,_]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[u,[f,"Lenovo"],[p,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[u,/_/g," "],[f,"Nokia"],[p,_]],[/(pixel c)\b/i],[u,[f,x],[p,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[u,[f,x],[p,_]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[u,[f,B],[p,_]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[u,"Xperia Tablet"],[f,B],[p,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[u,[f,"OnePlus"],[p,_]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[u,[f,T],[p,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[u,/(.+)/g,"Fire Phone $1"],[f,T],[p,_]],[/(playbook);[-\w\),; ]+(rim)/i],[u,f,[p,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[u,[f,I],[p,_]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[u,[f,S],[p,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[u,[f,S],[p,_]],[/(nexus 9)/i],[u,[f,"HTC"],[p,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[f,[u,/_/g," "],[p,_]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[u,[f,"Acer"],[p,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[u,[f,"Meizu"],[p,_]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[f,u,[p,_]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[f,u,[p,y]],[/(surface duo)/i],[u,[f,D],[p,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[u,[f,"Fairphone"],[p,_]],[/(u304aa)/i],[u,[f,"AT&T"],[p,_]],[/\bsie-(\w*)/i],[u,[f,"Siemens"],[p,_]],[/\b(rct\w+) b/i],[u,[f,"RCA"],[p,y]],[/\b(venue[\d ]{2,7}) b/i],[u,[f,"Dell"],[p,y]],[/\b(q(?:mv|ta)\w+) b/i],[u,[f,"Verizon"],[p,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[u,[f,"Barnes & Noble"],[p,y]],[/\b(tm\d{3}\w+) b/i],[u,[f,"NuVision"],[p,y]],[/\b(k88) b/i],[u,[f,"ZTE"],[p,y]],[/\b(nx\d{3}j) b/i],[u,[f,"ZTE"],[p,_]],[/\b(gen\d{3}) b.+49h/i],[u,[f,"Swiss"],[p,_]],[/\b(zur\d{3}) b/i],[u,[f,"Swiss"],[p,y]],[/\b((zeki)?tb.*\b) b/i],[u,[f,"Zeki"],[p,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[f,"Dragon Touch"],u,[p,y]],[/\b(ns-?\w{0,9}) b/i],[u,[f,"Insignia"],[p,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[u,[f,"NextBook"],[p,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[f,"Voice"],u,[p,_]],[/\b(lvtel\-)?(v1[12]) b/i],[[f,"LvTel"],u,[p,_]],[/\b(ph-1) /i],[u,[f,"Essential"],[p,_]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[u,[f,"Envizen"],[p,y]],[/\b(trio[-\w\. ]+) b/i],[u,[f,"MachSpeed"],[p,y]],[/\btu_(1491) b/i],[u,[f,"Rotor"],[p,y]],[/(shield[\w ]+) b/i],[u,[f,"Nvidia"],[p,y]],[/(sprint) (\w+)/i],[f,u,[p,_]],[/(kin\.[onetw]{3})/i],[[u,/\./g," "],[f,D],[p,_]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[u,[f,F],[p,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[u,[f,F],[p,_]],[/smart-tv.+(samsung)/i],[f,[p,b]],[/hbbtv.+maple;(\d+)/i],[[u,/^/,"SmartTV"],[f,q],[p,b]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[f,A],[p,b]],[/(apple) ?tv/i],[f,[u,C+" TV"],[p,b]],[/crkey/i],[[u,E+"cast"],[f,x],[p,b]],[/droid.+aft(\w+)( bui|\))/i],[u,[f,T],[p,b]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[u,[f,U],[p,b]],[/(bravia[\w ]+)( bui|\))/i],[u,[f,B],[p,b]],[/(mitv-\w{5}) bui/i],[u,[f,N],[p,b]],[/Hbbtv.*(technisat) (.*);/i],[f,u,[p,b]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[f,W],[u,W],[p,b]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[p,b]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[f,u,[p,m]],[/droid.+; (shield) bui/i],[u,[f,"Nvidia"],[p,m]],[/(playstation [345portablevi]+)/i],[u,[f,B],[p,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[u,[f,D],[p,m]],[/((pebble))app/i],[f,u,[p,w]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[u,[f,C],[p,w]],[/droid.+; (glass) \d/i],[u,[f,x],[p,w]],[/droid.+; (wt63?0{2,3})\)/i],[u,[f,F],[p,w]],[/(quest( 2| pro)?)/i],[u,[f,$],[p,w]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[f,[p,R]],[/(aeobc)\b/i],[u,[f,T],[p,R]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[u,[p,_]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[u,[p,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[p,y]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[p,_]],[/(android[-\w\. ]{0,9});.+buil/i],[u,[f,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[g,[d,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[g,[d,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[d,g],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[g,d]],os:[[/microsoft (windows) (vista|xp)/i],[d,g],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[d,[g,K,Y]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[d,"Windows"],[g,K,Y]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[g,/_/g,"."],[d,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[d,H],[g,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[g,d],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[d,g],[/\(bb(10);/i],[g,[d,I]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[g,[d,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[g,[d,P+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[g,[d,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[g,[d,"watchOS"]],[/crkey\/([\d\.]+)/i],[g,[d,E+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[d,j],g],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[d,g],[/(sunos) ?([\w\.\d]*)/i],[[d,"Solaris"],g],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[d,g]]},Q=function(e,t){if(typeof e===l&&(t=e,e=i),!(this instanceof Q))return new Q(e,t).getResult();var r=typeof s!==o&&s.navigator?s.navigator:i,n=e||(r&&r.userAgent?r.userAgent:""),m=r&&r.userAgentData?r.userAgentData:i,b=t?function(e,t){var r={};for(var n in e)t[n]&&t[n].length%2==0?r[n]=t[n].concat(e[n]):r[n]=e[n];return r}(J,t):J,w=r&&r.userAgent==n;return this.getBrowser=function(){var e,t={};return t[d]=i,t[g]=i,X.call(t,n,b.browser),t[c]=typeof(e=t[g])===h?e.replace(/[^\d\.]/g,"").split(".")[0]:i,w&&r&&r.brave&&typeof r.brave.isBrave==a&&(t[d]="Brave"),t},this.getCPU=function(){var e={};return e[v]=i,X.call(e,n,b.cpu),e},this.getDevice=function(){var e={};return e[f]=i,e[u]=i,e[p]=i,X.call(e,n,b.device),w&&!e[p]&&m&&m.mobile&&(e[p]=_),w&&"Macintosh"==e[u]&&r&&typeof r.standalone!==o&&r.maxTouchPoints&&r.maxTouchPoints>2&&(e[u]="iPad",e[p]=y),e},this.getEngine=function(){var e={};return e[d]=i,e[g]=i,X.call(e,n,b.engine),e},this.getOS=function(){var e={};return e[d]=i,e[g]=i,X.call(e,n,b.os),w&&!e[d]&&m&&"Unknown"!=m.platform&&(e[d]=m.platform.replace(/chrome os/i,j).replace(/macos/i,H)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return n},this.setUA=function(e){return n=typeof e===h&&e.length>350?W(e,350):e,this},this.setUA(n),this};Q.VERSION="1.0.36",Q.BROWSER=G([d,g,c]),Q.CPU=G([v]),Q.DEVICE=G([u,f,p,m,_,b,y,w,R]),Q.ENGINE=Q.OS=G([d,g]),typeof t!==o?(e.exports&&(t=e.exports=Q),t.UAParser=Q):r.amdO?(n=function(){return Q}.call(t,r,t,e))===i||(e.exports=n):typeof s!==o&&(s.UAParser=Q);var Z=typeof s!==o&&(s.jQuery||s.Zepto);if(Z&&!Z.ua){var ee=new Q;Z.ua=ee.getResult(),Z.ua.get=function(){return ee.getUA()},Z.ua.set=function(e){ee.setUA(e);var t=ee.getResult();for(var r in t)Z.ua[r]=t[r]}}}("object"==typeof window?window:this)},945:function(e){var t,r,n,s,i;t=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,r=/^(?=([^\/?#]*))\1([^]*)$/,n=/(?:\/|^)\.(?=\/)/g,s=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,i={buildAbsoluteURL:function(e,t,n){if(n=n||{},e=e.trim(),!(t=t.trim())){if(!n.alwaysNormalize)return e;var s=i.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");return s.path=i.normalizePath(s.path),i.buildURLFromParts(s)}var a=i.parseURL(t);if(!a)throw new Error("Error trying to parse relative URL.");if(a.scheme)return n.alwaysNormalize?(a.path=i.normalizePath(a.path),i.buildURLFromParts(a)):t;var o=i.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var l=r.exec(o.path);o.netLoc=l[1],o.path=l[2]}o.netLoc&&!o.path&&(o.path="/");var h={scheme:o.scheme,netLoc:a.netLoc,path:null,params:a.params,query:a.query,fragment:a.fragment};if(!a.netLoc&&(h.netLoc=o.netLoc,"/"!==a.path[0]))if(a.path){var c=o.path,u=c.substring(0,c.lastIndexOf("/")+1)+a.path;h.path=i.normalizePath(u)}else h.path=o.path,a.params||(h.params=o.params,a.query||(h.query=o.query));return null===h.path&&(h.path=n.alwaysNormalize?i.normalizePath(a.path):a.path),i.buildURLFromParts(h)},parseURL:function(e){var r=t.exec(e);return r?{scheme:r[1]||"",netLoc:r[2]||"",path:r[3]||"",params:r[4]||"",query:r[5]||"",fragment:r[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(n,"");e.length!==(e=e.replace(s,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=i},480:()=>{},61:(e,t,r)=>{var n=r(698).default;function s(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */e.exports=s=function(){return r},e.exports.__esModule=!0,e.exports.default=e.exports;var t,r={},i=Object.prototype,a=i.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},l="function"==typeof Symbol?Symbol:{},h=l.iterator||"@@iterator",c=l.asyncIterator||"@@asyncIterator",u=l.toStringTag||"@@toStringTag";function d(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{d({},"")}catch(t){d=function(e,t,r){return e[t]=r}}function p(e,t,r,n){var s=t&&t.prototype instanceof b?t:b,i=Object.create(s.prototype),a=new D(n||[]);return o(i,"_invoke",{value:P(e,r,a)}),i}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}r.wrap=p;var g="suspendedStart",v="suspendedYield",m="executing",_="completed",y={};function b(){}function w(){}function R(){}var T={};d(T,h,(function(){return this}));var C=Object.getPrototypeOf,S=C&&C(C(M([])));S&&S!==i&&a.call(S,h)&&(T=S);var I=R.prototype=b.prototype=Object.create(T);function k(e){["next","throw","return"].forEach((function(t){d(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function r(s,i,o,l){var h=f(e[s],e,i);if("throw"!==h.type){var c=h.arg,u=c.value;return u&&"object"==n(u)&&a.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,o,l)}),(function(e){r("throw",e,o,l)})):t.resolve(u).then((function(e){c.value=e,o(c)}),(function(e){return r("throw",e,o,l)}))}l(h.arg)}var s;o(this,"_invoke",{value:function(e,n){function i(){return new t((function(t,s){r(e,n,t,s)}))}return s=s?s.then(i,i):i()}})}function P(e,r,n){var s=g;return function(i,a){if(s===m)throw new Error("Generator is already running");if(s===_){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var o=n.delegate;if(o){var l=x(o,n);if(l){if(l===y)continue;return l}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(s===g)throw s=_,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);s=m;var h=f(e,r,n);if("normal"===h.type){if(s=n.done?_:v,h.arg===y)continue;return{value:h.arg,done:n.done}}"throw"===h.type&&(s=_,n.method="throw",n.arg=h.arg)}}}function x(e,r){var n=r.method,s=e.iterator[n];if(s===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,x(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var i=f(s,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function D(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function M(e){if(e||""===e){var r=e[h];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var s=-1,i=function r(){for(;++s<e.length;)if(a.call(e,s))return r.value=e[s],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(n(e)+" is not iterable")}return w.prototype=R,o(I,"constructor",{value:R,configurable:!0}),o(R,"constructor",{value:w,configurable:!0}),w.displayName=d(R,u,"GeneratorFunction"),r.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},r.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,R):(e.__proto__=R,d(e,u,"GeneratorFunction")),e.prototype=Object.create(I),e},r.awrap=function(e){return{__await:e}},k(E.prototype),d(E.prototype,c,(function(){return this})),r.AsyncIterator=E,r.async=function(e,t,n,s,i){void 0===i&&(i=Promise);var a=new E(p(e,t,n,s),i);return r.isGeneratorFunction(t)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(I),d(I,u,"Generator"),d(I,h,(function(){return this})),d(I,"toString",(function(){return"[object Generator]"})),r.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},r.values=M,D.prototype={constructor:D,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(A),!e)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(n,s){return o.type="throw",o.arg=e,r.next=n,s&&(r.method="next",r.arg=t),!!s}for(var s=this.tryEntries.length-1;s>=0;--s){var i=this.tryEntries[s],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var l=a.call(i,"catchLoc"),h=a.call(i,"finallyLoc");if(l&&h){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(l){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!h)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&a.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var s=n;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var i=s?s.completion:{};return i.type=e,i.arg=t,s?(this.method="next",this.next=s.finallyLoc,y):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),A(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var s=n.arg;A(r)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:M(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},r}e.exports=s,e.exports.__esModule=!0,e.exports.default=e.exports},698:e=>{function t(r){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},687:(e,t,r)=>{var n=r(61)();e.exports=n;try{regeneratorRuntime=n}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=n:Function("r","regeneratorRuntime = r")(n)}}},t={};function r(n){var s=t[n];if(void 0!==s)return s.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}r.amdO={},r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var n={};return(()=>{"use strict";r.d(n,{default:()=>Zl});var e=r(729),t=r.n(e);const s=class{constructor(){this.TAG="Observer",this.observer=new(t())}destroy(){this.observer.removeAllListeners()}on(e,t){this.observer.on(e,t)}once(e,t){this.observer.once(e,t)}trigger(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.observer.emit(e,...r)}off(e,t){this.observer.off(e,t)}eventNames(){var e=this.observer._events;return e?Object.keys(e):[]}};function i(){return{publicIP:"",randomPlayId:`${Date.now()}-${Math.floor(Math.random()*(Math.floor(999999999)-Math.ceil(1)))+Math.ceil(1)}`,loadTime:Date.now(),channelId:"",originalUrl:"",cdnDomain:"",startTime:Date.now(),videoId:"video",isLive:!1,signalServer:"signal.qvb.qcloud.com",vodTrackerServer:"https://tracker-00.qvb.qcloud.com/api/tracker-flash/v1",liveTrackerServer:"https://tracker-00.qvb.qcloud.com/api/tracker/v2",reportServer:"https://log.qvb.qcloud.com/reporter/vlive",stunServer:"",PCHeartInterval:6e3,maxPeerCache:20,maxPCConnecting:10,maxPCConnected:12,minPCConnected:10,maxConnectRequestEachPeriod:2,checkPeerInterval:8e3,bufferCount:10,sliceCount:1,DCChunkSize:64512,videoType:"VOD",peerConnWaWeight:.75,bitmapInterval:12e3,channelIdIncludeHost:!0,channelIdIncludeSearch:!1,enableServiceWorker:!1,confInterval:0,enableRTLog:!1,rtLogLevel:3,enableAutoConfig:!0,targetDurationTemplate:[1,2,3,4,5,6,7,8,9,10],enableLLS:!1,p2pReqTimeout:3e3,maxP2PDepth:6,streamP2PChunkLength:61440,maxSubscribeSize:5,syncNodeInterval:1e3,levelForTracker:"default",lowBufferThreshold:0,maxP2PRetryTimes:20,llsAutoConfig:{p2pReqTimeout:[500,1e3,2e3,3e3,4e3,5e3,6e3,7e3,8e3,9e3,1e4]},enableP2pAutoTimeout:!0,cdnEstimateRatio:1.5,enableRange:!0,enableLLSMinCircle:!0,enableLocalNetworkShare:!1,enableMultiArea:!0,LNSRttThreshold:40,bucketCount:6,clearBucketInterval:6e4,enableExtraPCCnt:0,bbsP2PReqTimeout:1e4,bbsP2PMaxRetry:3,enableLRS:!1,lrsMaxPCConnected:4,lrsMaxPCConnecting:1,lrsServeResCnt:4,enableStoreRes:!1,maxStoreResCnt:3,enableStoreTinyRes:!1,enableStoreAllTinyRes:!0,tinyResMaxDuration:120,resModBase:1,newResEvictProWindow:864e5,coldResEvictThreshold:1728e5,maxIndexeddbStoreSize:524288e3,maxStorageAvailableRatio:.9,enableValidateTS:!1,metaServerUrl:"https://meta.qvb.qcloud.com/api/v3/info",metaRetryDelay:9e4,p2pStartDelay:15e3,enableCDNDetailReport:!1,p2pLimit:20,cdnBWRatio:.9,cdnCostRatio:.5,liveMaxBuffer:16,vodMaxBuffer:30,p2pEstimateExtra:1e3,checkBufferInterval:1e3,p2pSliceRequestCount:2,peerConnWaInitSendBytes:0,peerConnWaInitReceiveBytes:0,PCCheckAliveInterval:1e3,PCHeartTimeout:1e4,initConnTimeout:1e4,fixPCConflict:!1,trackerInterval:16e3,liveTrackerVersion:"v4",liveModel:"",vodTrackerVersion:"v2",bufferedAmountLimit:209715200,preloadProbability:.2,cdnNodeRatio:.02,confBaseUrl:"https://conf.qvb.qcloud.com/api/v1/vod/h5/",sourceUrl:"",liveDelayPreset:0,enableAegis:!1,service:1,platform:39,moduleId:1080,command:81e4,reportInterval:6e4,domain:"",cloudAppId:0,xp2pAppId:"",aegisId:""}}var a=i();function o(){Object.keys(a).forEach((e=>{delete a[e]})),Object.assign(a,i())}o();const l=a;var h=r(43),c=r.n(h);function u(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return d(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return d(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw i}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}class p extends Error{constructor(e){super(`[HLSP2P] [字段检查错误] ${e}`),c().error(this.message)}}var f=(e,t)=>{var r,n=u(t);try{for(n.s();!(r=n.n()).done;){var s=r.value;if(!(s in e))throw new p(`${s} 未传入`)}}catch(e){n.e(e)}finally{n.f()}},g=(e,t)=>{var r,n=u(t);try{for(n.s();!(r=n.n()).done;){var s=r.value;if(s in e&&!e[s])throw new p(`字段为空 ${s}`)}}catch(e){n.e(e)}finally{n.f()}},v=[{name:"checkVideoType",matchRule:()=>!0,check(e){var t=["videoType"];if(f(e,t),g(e,t),-1===["LIVE","VOD"].indexOf(e.videoType))throw new p("字段取值不对 videoType取值为LIVE / VOD")}},{name:"checkChannelId",matchRule:()=>!0,check(e){var t=["channelId"];f(e,t),g(e,t)}},{name:"checkPlayConfig",matchRule:()=>!0,check(e,t){var r=["videoId","url"];f(t,r),g(t,r)}},{name:"checkLiveServiceId",matchRule:e=>"LIVE"===e.videoType,check(e,t){var r=["domain","xp2pAppId"];g(t,r),f(t,r)}},{name:"checkVodServiceId",matchRule:e=>"VOD"===e.videoType,check(e,t){var r=["domain","xp2pAppId"];g(t,r),f(t,r)}},{name:"checkCloudAppId",matchRule:()=>!0,check(e,t){f(t,["cloudAppId"])}}];class m{constructor(){this._dataLength=0,this._bufferLength=0,this._state=new Int32Array(4),this._buffer=new ArrayBuffer(68),this._buffer8=new Uint8Array(this._buffer,0,68),this._buffer32=new Uint32Array(this._buffer,0,17),this.start()}static hashStr(e,t=!1){return this.onePassHasher.start().appendStr(e).end(t)}static hashAsciiStr(e,t=!1){return this.onePassHasher.start().appendAsciiStr(e).end(t)}static _hex(e){const t=m.hexChars,r=m.hexOut;let n,s,i,a;for(a=0;a<4;a+=1)for(s=8*a,n=e[a],i=0;i<8;i+=2)r[s+1+i]=t.charAt(15&n),n>>>=4,r[s+0+i]=t.charAt(15&n),n>>>=4;return r.join("")}static _md5cycle(e,t){let r=e[0],n=e[1],s=e[2],i=e[3];r+=(n&s|~n&i)+t[0]-680876936|0,r=(r<<7|r>>>25)+n|0,i+=(r&n|~r&s)+t[1]-389564586|0,i=(i<<12|i>>>20)+r|0,s+=(i&r|~i&n)+t[2]+606105819|0,s=(s<<17|s>>>15)+i|0,n+=(s&i|~s&r)+t[3]-1044525330|0,n=(n<<22|n>>>10)+s|0,r+=(n&s|~n&i)+t[4]-176418897|0,r=(r<<7|r>>>25)+n|0,i+=(r&n|~r&s)+t[5]+1200080426|0,i=(i<<12|i>>>20)+r|0,s+=(i&r|~i&n)+t[6]-1473231341|0,s=(s<<17|s>>>15)+i|0,n+=(s&i|~s&r)+t[7]-45705983|0,n=(n<<22|n>>>10)+s|0,r+=(n&s|~n&i)+t[8]+1770035416|0,r=(r<<7|r>>>25)+n|0,i+=(r&n|~r&s)+t[9]-1958414417|0,i=(i<<12|i>>>20)+r|0,s+=(i&r|~i&n)+t[10]-42063|0,s=(s<<17|s>>>15)+i|0,n+=(s&i|~s&r)+t[11]-1990404162|0,n=(n<<22|n>>>10)+s|0,r+=(n&s|~n&i)+t[12]+1804603682|0,r=(r<<7|r>>>25)+n|0,i+=(r&n|~r&s)+t[13]-40341101|0,i=(i<<12|i>>>20)+r|0,s+=(i&r|~i&n)+t[14]-1502002290|0,s=(s<<17|s>>>15)+i|0,n+=(s&i|~s&r)+t[15]+1236535329|0,n=(n<<22|n>>>10)+s|0,r+=(n&i|s&~i)+t[1]-165796510|0,r=(r<<5|r>>>27)+n|0,i+=(r&s|n&~s)+t[6]-1069501632|0,i=(i<<9|i>>>23)+r|0,s+=(i&n|r&~n)+t[11]+643717713|0,s=(s<<14|s>>>18)+i|0,n+=(s&r|i&~r)+t[0]-373897302|0,n=(n<<20|n>>>12)+s|0,r+=(n&i|s&~i)+t[5]-701558691|0,r=(r<<5|r>>>27)+n|0,i+=(r&s|n&~s)+t[10]+38016083|0,i=(i<<9|i>>>23)+r|0,s+=(i&n|r&~n)+t[15]-660478335|0,s=(s<<14|s>>>18)+i|0,n+=(s&r|i&~r)+t[4]-405537848|0,n=(n<<20|n>>>12)+s|0,r+=(n&i|s&~i)+t[9]+568446438|0,r=(r<<5|r>>>27)+n|0,i+=(r&s|n&~s)+t[14]-1019803690|0,i=(i<<9|i>>>23)+r|0,s+=(i&n|r&~n)+t[3]-187363961|0,s=(s<<14|s>>>18)+i|0,n+=(s&r|i&~r)+t[8]+1163531501|0,n=(n<<20|n>>>12)+s|0,r+=(n&i|s&~i)+t[13]-1444681467|0,r=(r<<5|r>>>27)+n|0,i+=(r&s|n&~s)+t[2]-51403784|0,i=(i<<9|i>>>23)+r|0,s+=(i&n|r&~n)+t[7]+1735328473|0,s=(s<<14|s>>>18)+i|0,n+=(s&r|i&~r)+t[12]-1926607734|0,n=(n<<20|n>>>12)+s|0,r+=(n^s^i)+t[5]-378558|0,r=(r<<4|r>>>28)+n|0,i+=(r^n^s)+t[8]-2022574463|0,i=(i<<11|i>>>21)+r|0,s+=(i^r^n)+t[11]+1839030562|0,s=(s<<16|s>>>16)+i|0,n+=(s^i^r)+t[14]-35309556|0,n=(n<<23|n>>>9)+s|0,r+=(n^s^i)+t[1]-1530992060|0,r=(r<<4|r>>>28)+n|0,i+=(r^n^s)+t[4]+1272893353|0,i=(i<<11|i>>>21)+r|0,s+=(i^r^n)+t[7]-155497632|0,s=(s<<16|s>>>16)+i|0,n+=(s^i^r)+t[10]-1094730640|0,n=(n<<23|n>>>9)+s|0,r+=(n^s^i)+t[13]+681279174|0,r=(r<<4|r>>>28)+n|0,i+=(r^n^s)+t[0]-358537222|0,i=(i<<11|i>>>21)+r|0,s+=(i^r^n)+t[3]-722521979|0,s=(s<<16|s>>>16)+i|0,n+=(s^i^r)+t[6]+76029189|0,n=(n<<23|n>>>9)+s|0,r+=(n^s^i)+t[9]-640364487|0,r=(r<<4|r>>>28)+n|0,i+=(r^n^s)+t[12]-421815835|0,i=(i<<11|i>>>21)+r|0,s+=(i^r^n)+t[15]+530742520|0,s=(s<<16|s>>>16)+i|0,n+=(s^i^r)+t[2]-995338651|0,n=(n<<23|n>>>9)+s|0,r+=(s^(n|~i))+t[0]-198630844|0,r=(r<<6|r>>>26)+n|0,i+=(n^(r|~s))+t[7]+1126891415|0,i=(i<<10|i>>>22)+r|0,s+=(r^(i|~n))+t[14]-1416354905|0,s=(s<<15|s>>>17)+i|0,n+=(i^(s|~r))+t[5]-57434055|0,n=(n<<21|n>>>11)+s|0,r+=(s^(n|~i))+t[12]+1700485571|0,r=(r<<6|r>>>26)+n|0,i+=(n^(r|~s))+t[3]-1894986606|0,i=(i<<10|i>>>22)+r|0,s+=(r^(i|~n))+t[10]-1051523|0,s=(s<<15|s>>>17)+i|0,n+=(i^(s|~r))+t[1]-2054922799|0,n=(n<<21|n>>>11)+s|0,r+=(s^(n|~i))+t[8]+1873313359|0,r=(r<<6|r>>>26)+n|0,i+=(n^(r|~s))+t[15]-30611744|0,i=(i<<10|i>>>22)+r|0,s+=(r^(i|~n))+t[6]-1560198380|0,s=(s<<15|s>>>17)+i|0,n+=(i^(s|~r))+t[13]+1309151649|0,n=(n<<21|n>>>11)+s|0,r+=(s^(n|~i))+t[4]-145523070|0,r=(r<<6|r>>>26)+n|0,i+=(n^(r|~s))+t[11]-1120210379|0,i=(i<<10|i>>>22)+r|0,s+=(r^(i|~n))+t[2]+718787259|0,s=(s<<15|s>>>17)+i|0,n+=(i^(s|~r))+t[9]-343485551|0,n=(n<<21|n>>>11)+s|0,e[0]=r+e[0]|0,e[1]=n+e[1]|0,e[2]=s+e[2]|0,e[3]=i+e[3]|0}start(){return this._dataLength=0,this._bufferLength=0,this._state.set(m.stateIdentity),this}appendStr(e){const t=this._buffer8,r=this._buffer32;let n,s,i=this._bufferLength;for(s=0;s<e.length;s+=1){if(n=e.charCodeAt(s),n<128)t[i++]=n;else if(n<2048)t[i++]=192+(n>>>6),t[i++]=63&n|128;else if(n<55296||n>56319)t[i++]=224+(n>>>12),t[i++]=n>>>6&63|128,t[i++]=63&n|128;else{if(n=1024*(n-55296)+(e.charCodeAt(++s)-56320)+65536,n>1114111)throw new Error("Unicode standard supports code points up to U+10FFFF");t[i++]=240+(n>>>18),t[i++]=n>>>12&63|128,t[i++]=n>>>6&63|128,t[i++]=63&n|128}i>=64&&(this._dataLength+=64,m._md5cycle(this._state,r),i-=64,r[0]=r[16])}return this._bufferLength=i,this}appendAsciiStr(e){const t=this._buffer8,r=this._buffer32;let n,s=this._bufferLength,i=0;for(;;){for(n=Math.min(e.length-i,64-s);n--;)t[s++]=e.charCodeAt(i++);if(s<64)break;this._dataLength+=64,m._md5cycle(this._state,r),s=0}return this._bufferLength=s,this}appendByteArray(e){const t=this._buffer8,r=this._buffer32;let n,s=this._bufferLength,i=0;for(;;){for(n=Math.min(e.length-i,64-s);n--;)t[s++]=e[i++];if(s<64)break;this._dataLength+=64,m._md5cycle(this._state,r),s=0}return this._bufferLength=s,this}getState(){const e=this._state;return{buffer:String.fromCharCode.apply(null,Array.from(this._buffer8)),buflen:this._bufferLength,length:this._dataLength,state:[e[0],e[1],e[2],e[3]]}}setState(e){const t=e.buffer,r=e.state,n=this._state;let s;for(this._dataLength=e.length,this._bufferLength=e.buflen,n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],s=0;s<t.length;s+=1)this._buffer8[s]=t.charCodeAt(s)}end(e=!1){const t=this._bufferLength,r=this._buffer8,n=this._buffer32,s=1+(t>>2);this._dataLength+=t;const i=8*this._dataLength;if(r[t]=128,r[t+1]=r[t+2]=r[t+3]=0,n.set(m.buffer32Identity.subarray(s),s),t>55&&(m._md5cycle(this._state,n),n.set(m.buffer32Identity)),i<=4294967295)n[14]=i;else{const e=i.toString(16).match(/(.*?)(.{0,8})$/);if(null===e)return;const t=parseInt(e[2],16),r=parseInt(e[1],16)||0;n[14]=t,n[15]=r}return m._md5cycle(this._state,n),e?this._state:m._hex(this._state)}}if(m.stateIdentity=new Int32Array([1732584193,-271733879,-1732584194,271733878]),m.buffer32Identity=new Int32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),m.hexChars="0123456789abcdef",m.hexOut=[],m.onePassHasher=new m,"5d41402abc4b2a76b9719d911017c592"!==m.hashStr("hello"))throw new Error("Md5 self test failed.");function _(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{channelIdIncludeHost:!1,channelIdIncludeSearch:!1},r=t.channelIdIncludeHost,n=t.channelIdIncludeSearch;if(!e)return null;var s=new URL(e),i="";return r&&(i+=s.host),i+=s.pathname,n&&(i+=s.search),m.hashStr(i)}class y{constructor(e){this.TAG="ConfigParser",this.userConfig=e;var t=e.url,r=e.videoType;l.originalUrl=t,l.videoType=r||"VOD";var n=l.channelIdIncludeHost,s=l.channelIdIncludeSearch,i=e.channelId||_(t,{channelIdIncludeHost:n,channelIdIncludeSearch:s});e.channelId=i,l.channelId=i,l.cdnDomain=y.cdnDomain(t)}static cdnDomain(e){return new URL(e).host}static check(e){((e,t)=>{for(var r=0,n=v;r<n.length;r++){var s=n[r];s.matchRule(e,t)&&s.check(e,t)}})(l,e)}static merge(e){Object.assign(l,e)}process(){y.check(this.userConfig),y.merge(this.userConfig)}}const b=y;var w={ERROR:"error",LEVEL_LOADED:"hlsLevelLoaded",SIGNAL_SENDING:"signalSending",SIGNAL_RECEIVING:"signalReceiving",SIGNAL_DISPATCHING:"signalDispatching",SIGNAL_READY:"signalReady",HlsManifestParsed:"hlsManifestParsed",TRACKER_LOADED:"trackerLoader",TRACKER_STARTING:"trackerStarting",TRACKER_LOADING:"trackerLoading",PEER_REMOVED:"peerRemoved",PEER_CONNECTED:"peerConnected",FRAG_LOADED:"10001",FRAG_LOADED_P2P:"10002",REPORT_START:"reportStart",REPORT_LOADED:"reportLoaded",REPORT_LOADING:"reportLoading",CONF_STARTING:"confStaring",CONF_LOADING:"confLoading",CONF_LOADED:"confLoaded",CONF_PARSED:"confParsed",ABNORMAL_REPORT:"abnormalRequest",NOR_REPORT_START:"norReportStart",FRAGMENT_UPDATED:"fragmentUpdated",LOCK_RESP:"lockRes",LOCK_TO_PEER:"lockToPeer",P2P_FRAG_REQ:"p2pFragReq",RTT_GOT:"rtt_got",PEER_FILTER_PASSED:"peerFilterPassed",PEER_FILTER_BLOCKED:"peerFilterBlocked",PEER_BLACKLIST:"peerBlacklist",BEFORE_CDN_REQUEST:"beforeCdnRequest",BEFORE_M3U8_REQUEST:"beforeM3u8Request"};const R=w;var T=w,C=r(945);const S=class{constructor(){this.sn=0,this.level=0,this.uri="",this.baseUrl="",this.duration=0}get url(){return this._url||(this._url=(0,C.buildAbsoluteURL)(this.baseUrl,this.uri,{alwaysNormalize:!0})),this._url}get originalUrl(){return this.uri}};class I{static GetResTemplate(){return{url:"",data:"",statusText:"",dataLen:0,timeRequestPerformance:0,timeRequest:0,TTFBPerformance:0,TTFB:0,timeLoadedPerformance:0,timeLoaded:0,retry:0,httpCode:0,responseURL:"",responseType:"",aborted:!1,__type:"CDN",config:{}}}static GetRequestConfig(){return{timeout:0,maxRetry:0,retryDelay:0,maxRetryDelay:0,url:"",responseType:"",headers:{},useFetch:!1,useRange:!1,range:{start:0,end:0}}}}var k={SUCCESS:1,ERROR:2,TIMEOUT:3,PROGRESS:4,STATUS_CODE:5};const E=class{constructor(e,t,r){this.id="",this.url="",this.sequenceNumber=0,this.level=0,this.loaderConfig=I.GetRequestConfig(),this.parseConfig(e,t,r)}parseConfig(e,t,r){this.url=e.url;var n=e.frag;this.sequenceNumber=n.sn,this.level=n.level,this.id=e.id||`${this.sequenceNumber}-${this.level}`,this.loaderConfig.url=e.url,this.loaderConfig.responseType=e.responseType,Object.assign(this.loaderConfig,t)}genRequestLoaderConfig(){return this.loaderConfig}};const P=new class{constructor(){this.TAG="TsReqMgr",this._reqMap=new Map,this._respMap=new Map}init(){this.reset()}destroy(){this.reset()}reset(){this._reqMap.clear(),this._respMap.clear()}addReq(e,t,r){this._reqMap.set(e,t),this._respMap.set(e,r)}getReq(e){return this._reqMap.get(e)}getResp(e){return this._respMap.get(e)}has(e){return this._reqMap.has(e)}getRespMap(){return this._respMap}delete(e){this._reqMap.delete(e),this._respMap.delete(e)}size(){return this._reqMap.size}};var x={curReqSn:void 0,curReqLevel:void 0,hlsjs:void 0,exitReason:void 0,hlsp2p:void 0,cdnEstimate:void 0,p2pEstimate:void 0,curPlayerAdapter:void 0,targetDuration:0,totalDuration:0},L={};function A(){Object.keys(L).forEach((e=>{delete L[e]})),Object.assign(L,x)}A();const D=L;const M=new class{constructor(){this.TAG="TaskScheduler",this.map=new Map,this.curTaskId=null,this.p2pReqRef=0,this.p2pTimers=new Set}init(){this.reset()}destroy(){this.reset()}has(e){return this.map.has(e)}abort(e){var t=this.get(e);t&&t.abort()}add(e,t){this.map.set(e,t);var r=D.p2pEstimate.estimateTimeNeeded(`${e}-0`);if(r>1e4&&(r=0),r){this.p2pReqRef+=1;var n=setTimeout((()=>{this.p2pReqRef-=1,this.p2pTimers.delete(n),this.tick()}),r+l.p2pEstimateExtra)}this.tick()}tick(){this.curTaskId||(this.curTaskId=this.pickNextTask(),this.curTaskId&&this.map.get(this.curTaskId).load())}pickNextTask(){var e=null;if(0!==this.p2pReqRef)return e;var t=[...this.map.keys()];return t.length&&(e=t[0]),e}get(e){return this.map.get(e)}reset(){this.map.forEach((e=>{e.destroy()})),this.map.clear(),this.p2pTimers.forEach((e=>{clearTimeout(e)})),this.p2pTimers.clear(),this.p2pReqRef=0,this.curTaskId=null}delete(e){var t=this.map.get(e);t&&(t.destroy(),this.map.delete(e)),e===this.curTaskId&&(this.curTaskId=null),D.p2pEstimate&&D.p2pEstimate.delete(`${e}-0`),this.tick()}size(){return this.map.size}};const O=class{constructor(e,t,r){this.TAG="XHRLoader",this.context={url:e.url,method:e.method||"GET",async:e.async||!0,responseType:e.responseType||"text",postData:e.postData||"",headers:e.headers||[]},r.timeRequestPerformance=performance.now(),this.callbacks=t;var n=this.context,s=n.url,i=n.method,a=n.async,o=n.responseType,l=n.postData,h=n.headers,c=new XMLHttpRequest;this.loader=c,c.open(i,s,a),h.length&&h.forEach((e=>{c.setRequestHeader(e.header,e.value)})),c.responseType=o,c.onreadystatechange=this.readyStateChange.bind(this),"POST"===i&&l?c.send(l):c.send(),this.response=r,this.response.responseType=o}readyStateChange(e){var t=e.currentTarget,r=this.response,n=t.readyState;if(!r.aborted&&n>=2&&(0===r.TTFBPerformance&&(r.TTFBPerformance=performance.now()),4===n)){var s=t.status;r.httpCode=s,s>=200&&s<300?(r.responseURL=t.responseURL,r.timeLoadedPerformance=performance.now(),"arraybuffer"===this.context.responseType?(r.data=t.response,r.dataLen=r.data.byteLength):(r.data=t.responseText,r.dataLen=r.data.length),this.callbacks.onSuccess(r)):(r.statusText=t.statusText,this.callbacks.onError(r))}}abort(){var e=this.loader;e&&4!==e.readyState&&(this.response.aborted=!0,e.abort(),this.loader=null)}};class q{constructor(e,t,r){this.TAG="FetchStreamLoader",this.config=e,this.callbacks=t,this.response=r,this._abort=!1,this._abortController=null,this._loadedBytelength=0,this._buffers=[],this._done=!1,this._counter=0,this._open(e.url)}abort(){this._abort||(this._done||(this.response.aborted=!0),this._abort=!0,this._abortController&&this._abortController.abort(),this._readerInstance&&(this._readerInstance.cancel().catch((e=>{})),this._readerInstance=null),this.callbacks={onStatus:()=>{},onError:()=>{},onSuccess:()=>{},onProgress:()=>{}},this._buffers=[])}_open(e){if(!this._readerInstance){var t=this.response;t.timeRequestPerformance=performance.now(),t.responseType=this.config.responseType;var r={method:"GET",mode:"cors",referrerPolicy:"no-referrer-when-downgrade",headers:this.config.headers};self.AbortController&&(this._abortController=new self.AbortController,r.signal=this._abortController.signal),self.fetch(e,r).then((e=>{this._abort||(this.response.httpCode=e.status,this.response.statusText=e.statusText,this.callbacks.onStatus({statusCode:e.status,config:this.config}),e.ok&&e.status>=200&&e.status<=209?(this._readerInstance=e.body.getReader(),this._pump(this._readerInstance),this.response.responseURL=e.url,this.response.TTFBPerformance=performance.now()):404===e.status&&this.callbacks.onError(this.response))})).catch((e=>{this._abort||(this.response.statusText=e.message,this.callbacks.onError(this.response))}))}}_pump(e){this._abort||e.read().then((t=>{var r=t.done,n=t.value;this._abort||(r?this._done||(this._done=!0,this.response.timeLoadedPerformance=performance.now(),this.response.dataLen=this._loadedBytelength,this.response.data=q.combine(this._buffers,this._loadedBytelength),this.callbacks.onSuccess(this.response)):(this._loadedBytelength+=n.byteLength,this._buffers.push(n.slice()),this.callbacks.onProgress({value:n,cnt:this._counter}),this._counter+=1,this._pump(e)))})).catch((e=>{this._abort||(this.response.statusText=e.message,this.callbacks.onError(this.response))}))}static combine(e,t){var r=new Uint8Array(t),n=0;return e.forEach((e=>{r.set(e,n),n+=e.byteLength})),r.buffer}}var U=(e,t)=>{return`[${r=new Date,n=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return`${e}`.padStart(t,"0")},`${r.getFullYear()}-${n(r.getMonth()+1)}-${n(r.getDate())} ${n(r.getHours())}:${n(r.getMinutes())}:${n(r.getSeconds())}.${n(r.getMilliseconds(),3)}`}] [${e}] [${t}]`;var r,n},B="trace",N="log",F="info",$="warn",j="error",H={[B]:0,[N]:1,[F]:2,[$]:3,[j]:4};class G{constructor(){this._enable=!1,this._config=null,this._nextLogger=null,this._logLevel=H[j]}configure(e){return this._config=e,this}destroy(){this.disable(),this._nextLogger=null}setLevel(e){return e&&(this._logLevel=H[e]),this}enable(){this._enable=!0}disable(){this._enable=!1}setNext(e){this._nextLogger=e}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[B]>=this._logLevel){var n=`${U(this._config.logPrefix,"TRC")}${[...t].join(" ")}`;this.traceCb(n)}this._nextLogger&&this._nextLogger.trace(...t)}log(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[N]>=this._logLevel){var n=`${U(this._config.logPrefix,"LOG")}${[...t].join(" ")}`;this.logCb(n)}this._nextLogger&&this._nextLogger.log(...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[F]>=this._logLevel){var n=`${U(this._config.logPrefix,"INF")}${[...t].join(" ")}`;this.infoCb(n)}this._nextLogger&&this._nextLogger.info(...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[$]>=this._logLevel){var n=`${U(this._config.logPrefix,"WRN")}${[...t].join(" ")}`;this.warnCb(n)}this._nextLogger&&this._nextLogger.warn(...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[j]>=this._logLevel){var n=`${U(this._config.logPrefix,"ERR")}${[...t].join(" ")}`;this.errorCb(n)}this._nextLogger&&this._nextLogger.error(...t)}traceCb(e){self.console.trace(e)}logCb(e){self.console.log(e)}infoCb(e){self.console.info(e)}warnCb(e){self.console.warn(e)}errorCb(e){self.console.error(e)}}var V="log";class z{constructor(e,t){this.level=e,this.message=t}}var W=new class extends G{init(e){return this.hlsp2p=e,this.configure({logPrefix:"HLSP2P"}),this}destroy(){super.destroy(),this.hlsp2p=null}logCb(e){this.hlsp2p.trigger(V,new z(N,e))}infoCb(e){this.hlsp2p.trigger(V,new z(N,e))}warnCb(e){this.hlsp2p.trigger(V,new z(N,e))}errorCb(e){this.hlsp2p.trigger(V,new z(N,e))}};const X=W;const K=class{constructor(e,t,r){this.TAG="RequestLoader",this.id=e,this.config=t,this.cb=r,this.timeout=t.timeout||16e3,this.retryTimes=t.maxRetry||1,this._retryCounter=0,this.response=I.GetResTemplate(),this.response.config=t,this.response.url=this.config.url}load(){this._load()}destroy(){this.cb=()=>{},this.abort()}abort(){clearTimeout(this.timeoutTimer),this.xhrLoader&&this.xhrLoader.abort()}_load(){var e=`[http] 开始请求 ${this.id} ${this.config.url}`;this.config.useRange&&(e+=` useRange, rangeHeader: ${this.config.headers.Range}`),X.info(e);var t=O;this.config.useFetch&&(t=q),this.xhrLoader=new t(this.config,{onStatus:this._status.bind(this),onSuccess:this._success.bind(this),onError:this._error.bind(this),onProgress:this._progress.bind(this)},this.response),this.timeoutTimer=setTimeout(this._timeout.bind(this),this.timeout)}_retry(){return this._retryCounter<this.retryTimes&&(this._retryCounter+=1,X.info(`[http] 请求重试 ${this.id} ${this.config.url}, 重试次数 ${this._retryCounter}`),this.xhrLoader.abort(),this._load(),!0)}_status(e){this.cb(this.id,k.STATUS_CODE,e)}_timeout(){var e=(this.response.timeLoadedPerformance-this.response.timeRequestPerformance).toFixed(3),t=(this.response.TTFBPerformance-this.response.timeRequestPerformance).toFixed(3);X.error(`[http] 请求超时 ${this.id} ${this.config.url} 总耗时: ${e} ms, 首字节耗时: ${t} ms,`),this.xhrLoader.abort(),this._retry()||(this.response.retry=this._retryCounter,this.cb(this.id,k.TIMEOUT,this.response))}_error(){X.error(`[http] 请求失败 ${this.id} ${this.config.url}. statusCode: ${this.response.httpCode}, statusText: ${this.response.statusText}`),this._retry()||(clearTimeout(this.timeoutTimer),this.response.retry=this._retryCounter,this.cb(this.id,k.ERROR,this.response))}_success(){var e=(this.response.timeLoadedPerformance-this.response.timeRequestPerformance).toFixed(3),t=(this.response.TTFBPerformance-this.response.timeRequestPerformance).toFixed(3);X.info(`[http] 请求成功 ${this.id} ${this.config.url}, 总耗时: ${e} ms, 首字节耗时: ${t} ms, bytesLen: ${this.response.dataLen}`),clearTimeout(this.timeoutTimer),this.response.retry=this._retryCounter,this.cb(this.id,k.SUCCESS,this.response)}_progress(e){this.cb(this.id,k.PROGRESS,e)}};function Y(e,t,r,n,s,i,a){try{var o=e[i](a),l=o.value}catch(e){return void r(e)}o.done?t(l):Promise.resolve(l).then(n,s)}function J(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var i=e.apply(t,r);function a(e){Y(i,n,s,a,o,"next",e)}function o(e){Y(i,n,s,a,o,"throw",e)}a(void 0)}))}}var Q=r(687),Z=r.n(Q);const ee={BITMAP:1,SLICE:2,PACKET:3,PING:4,PONG:41,BUFFER_INFO:5,SLICE_REQUEST:6,LOCK_REQ:7,LOCK_RES:8,RTT_REQ:9,RTT_RES:10,P2P_REQ_CHUNK:11,P2P_RES_ERR:12,P2P_RES_CHUNK:13,P2P_REQ_CANCEL:14,P2P_RES_PARENT:15,P2P_REQ_ACCEPT:16,NODE_SYNC:17,P2P_UPWARD:18,SYNC_INFO:19};const te=class{constructor(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.hasHeader=e,this.segments=[],this.data=null,this.totalLen=0,this.uri=0,this.hasHeader&&(this.pushUInt32(10),this.pushUInt32(this.uri),this.pushUInt16(200))}marshall(){if(0===this.segments.length)return null;this.data=new Uint8Array(this.totalLen);var e=0;return this.segments.forEach((t=>{this.data.set(t,e),e+=t.length})),this.hasHeader&&(this.replaceUInt32(0,this.totalLen),this.replaceUInt32(4,this.uri)),this.data}setUri(e){this.uri=e}replaceUInt32(e,t){new DataView(this.data.buffer).setUint32(e,t,!0)}pushBool(e){this.pushUInt8(e?1:0)}pushUInt8(e){var t=new Uint8Array(1);new DataView(t.buffer).setUint8(0,e),this.segments.push(t),this.totalLen+=1}pushUInt16(e){var t=new Uint8Array(2);new DataView(t.buffer).setUint16(0,e,!0),this.segments.push(t),this.totalLen+=2}pushUInt32(e){var t=new Uint8Array(4);new DataView(t.buffer).setUint32(0,e,!0),this.segments.push(t),this.totalLen+=4}pushUInt64(e){var t=new Uint8Array(8),r=new DataView(t.buffer),n=e%4294967296,s=e/4294967296>>0;r.setUint32(0,n,!0),r.setUint32(4,s,!0),this.segments.push(t),this.totalLen+=8}pushUint8Array(e){this.pushUInt16(e.length),this.segments.push(e),this.totalLen+=e.length}pushUint8ArrayWithoutLen(e){this.segments.push(e),this.totalLen+=e.length}pushUint8Array32(e){this.pushUInt32(e.length),this.segments.push(e),this.totalLen+=e.length}pushUInt32Vector(e){this.pushUInt32(e.length),e.forEach((e=>{this.pushUInt32(e)}))}pushUInt16Vector(e){this.pushUInt32(e.length),e.forEach((e=>{this.pushUInt16(e)}))}pushString(e){var t=e.length;this.pushUInt16(t);for(var r=new Uint8Array(t),n=new DataView(r.buffer),s=0;s<t;s++)n.setUint8(s,e.charCodeAt(s));this.segments.push(r),this.totalLen+=t}pushString32(e){var t=e.length;this.pushUInt32(t);for(var r=new Uint8Array(t),n=new DataView(r.buffer),s=0;s<t;s++)n.setUint8(s,e.charCodeAt(s));this.segments.push(r),this.totalLen+=t}};var re=1,ne=2;const se=class{constructor(){this.uri=ee.PACKET,this.sn=0,this.level=0,this.sliceIndex=0,this.packetIndex=0,this.p2pStorageType=re,this.totalPacket=0,this.payloadLength=0,this.uint8ArrayPayload=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.sliceIndex),e.pushUInt8(this.packetIndex),e.pushUInt8(this.p2pStorageType),e.pushUInt8(this.totalPacket),e.pushUInt32(this.payloadLength),e.pushUint8Array(this.uint8ArrayPayload),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.sliceIndex=e.popUInt8(),this.packetIndex=e.popUInt8(),this.p2pStorageType=e.popUInt8(),this.totalPacket=e.popUInt8(),this.payloadLength=e.popUInt32(),this.uint8ArrayPayload=e.popUint8Array()}};const ie=class{constructor(e,t,r,n){this.sn=e,this.level=t,this.id="",this.index=r,this.arrayBufferData=n,this.dataByteLength=n?n.byteLength:0,this.uri=ee.SLICE,this.packetAmount=-1,this.packetArray=[],this.receivedPacketCount=0,this.reveivedPacketBytes=0,this.combineCallback=void 0,this.calledCallback=!1,this.createTime=Date.now(),this.p2pStoragTypeFlag=re}addPacket(e){if(!this.calledCallback){var t=e.uint8ArrayPayload.length,r=e.packetIndex;this.packetArray[r]||t!==e.payloadLength||(this.packetArray[r]=e,this.receivedPacketCount+=1,this.reveivedPacketBytes+=t),e.p2pStorageType&&(this.p2pStoragTypeFlag=e.p2pStorageType),this._ensureReceiveAllPacket()&&this._combinePacketToSlice()}}_ensureReceiveAllPacket(){if(this.packetAmount>this.receivedPacketCount)return!1;for(var e=0;e<this.packetAmount;e++)if(!this.packetArray[e])return!1;return!0}_combinePacketToSlice(){var e=new Uint8Array(this.reveivedPacketBytes),t=0;this.packetArray.forEach((r=>{e.set(r.uint8ArrayPayload,t),t+=r.payloadLength})),this.packetArray=[],this.arrayBufferData=e.buffer,this.dataByteLength=this.reveivedPacketBytes,this.calledCallback=!0,this.combineCallback(this.id)}segmentSliceToPacket(){for(var e=[],t=l.DCChunkSize,r=Math.ceil(this.dataByteLength/t),n=this.dataByteLength,s=this.arrayBufferData,i=0;i<r;i+=1){var a=i*t,o=n-i*t>t?(i+1)*t:n,h=s.slice(a,o),c=new se;c.p2pStorageType=this.p2pStoragTypeFlag,c.sn=this.sn,c.level=this.level,c.sliceIndex=this.index,c.packetIndex=i,c.totalPacket=r,c.uint8ArrayPayload=new Uint8Array(h),c.payloadLength=c.uint8ArrayPayload.length,e.push(c.marshall())}return e}getP2PStorageType(){return this.p2pStoragTypeFlag}};const ae=class{constructor(){this.sn=0,this.level=0,this.uri=ee.BUFFER_INFO,this.subIndexes=[]}marshall(e){e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.subIndexes.length),this.subIndexes.forEach((t=>{e.pushUInt8(t)}))}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8();for(var t=e.popUInt8(),r=0;r<t;r+=1){var n=e.popUInt8();this.subIndexes.push(n)}}};const oe=class{constructor(e,t){this.TAG="ProtoBuffer",this.id=e,this.sn=parseInt(e.split("-")[0],10),this.level=parseInt(e.split("-")[1],10),this.dataLen=0,this.avgLen=0,this.sliceCount=t,this.slicesMap=new Map,this.downloadFrom="cdn"}destroy(){this.slicesMap=null}setArrayBufferData(e){this.dataLen=e.byteLength,this.avgLen=Math.floor(this.dataLen/this.sliceCount);for(var t=this.sliceCount-1,r=0;r<t;r+=1){var n=e.slice(r*this.avgLen,(r+1)*this.avgLen),s=new ie(this.sn,this.level,r,n);this.slicesMap.set(r,s)}var i=this.sliceCount-1,a=i*this.avgLen,o=e.slice(a),l=new ie(this.sn,this.level,i,o);this.slicesMap.set(i,l)}setSlice(e,t){this.slicesMap.get(e)||(this.dataLen+=t.dataByteLength,this.slicesMap.set(e,t))}getSlice(e){return this.slicesMap.get(e)}complete(){return this.slicesMap.size===this.sliceCount}arrayBuffer(){if(this.complete()){this.avgLen=Math.floor(this.dataLen/this.sliceCount);var e=new Uint8Array(this.dataLen);return this.slicesMap.forEach((t=>{e.set(new Uint8Array(t.arrayBufferData),t.index*this.avgLen)})),e.buffer}return!1}bufferInfo(){var e=new ae;return e.sn=this.sn,e.level=this.level,this.slicesMap.forEach((t=>{e.subIndexes.push(t.index)})),e}getP2PStorageType(){if(this.slicesMap.size){var e=this.slicesMap.get(0);if(e)return e.getP2PStorageType()}}};const le=class{constructor(){this.TAG="BaseModule",this.registerEvents=""}destroy(){throw Error("需要实现")}init(){throw Error("需要实现")}};var he="connected",ce="conn_try",ue="conn_try_total",de="conn_suc",pe="conn_suc_total",fe="conn_reject",ge="conn_reject_total",ve="conn_kick",me="conn_dc_err",_e="conn_dc_open_cnt",ye="conn_dc_closed",be="conn_init_timeout",we="conn_htbt_timeout",Re="conn_conflict_ignore",Te="conn_conflict_reset",Ce="peer_rtt",Se="request",Ie="loadok_t",ke="confok_t",Ee="stuck_count",Pe="cdn_bytes",xe="p2p_bytes",Le="lrs_p2p_bytes",Ae="p2p_recv_bytes",De="exit_reason",Me="play_started",Oe="play_time",qe="session_time",Ue="ts_cdn_info",Be="played_bytes",Ne="p2p_upload_bytes",Fe="p2p_download_bytes",$e="bitrate_change",je="bitrate",He="buffer_length",Ge="range_ok",Ve="paused",ze="cdn_domain",We="req_level_0",Xe="req_level_1",Ke="req_level_2",Ye="req_level_3",Je="req_level_4",Qe="cdn_cost_ms",Ze="p2p_first_ms",et="p2p_costs",tt="p2p_req_costs",rt="p2p_first_recv_depth",nt="p2p_timeout_depth",st="p2p_first_timeout_cnt",it="p2p_dwn_timeout_cnt",at="cdn_cost_avg",ot="player_req_cnt",lt="p2p_pre_cnt",ht="pre_req_cnt",ct="abort_pre_cnt",ut="cancel_pre_cnt",dt="cdn_req_cnt",pt="hit_p2p_cnt",ft="hit_cdn_cnt",gt="cdn_succ_cnt",vt="cdn_timeout_cnt",mt="cdn_err_cnt",_t="cdn_range_cnt",yt="cdn_range_bytes",bt="parent_c",wt="children_c",Rt="subscribe_request_c",Tt="subscribe_timeout_c",Ct="subscribe_success_c",St="subscribe_failure_c",It="nop2p_peer",kt="p2p_sub_cnt",Et="drop_peer_by_cycle",Pt="drop_peer_by_blacklist",xt="drop_peer_by_bitrate",Lt="subscribe_range_c",At="p2p_retry_cnt",Dt="p2p_retry_miss_cnt",Mt="p2p_retry_by_disconnect",Ot="p2p_retry_by_circle",qt="p2p_retry_by_refuse",Ut="refused_by_cycle",Bt="refused_by_diff_bitrate",Nt="refused_by_full_load",Ft="refused_by_too_depth",$t="refused_by_sn_range",jt="back_cdn_peer_disconn",Ht="back_cdn_res_circle",Gt="back_cdn_depth_limit",Vt="back_cdn_req_refused",zt="back_cdn_upward",Wt="back_cdn_req_total",Xt="back_cdn_low_buffer",Kt="lls_trigger_upward",Yt="ignore_cdn_has_buffer",Jt="ignore_cdn_small_sn",Qt="ignore_cdn_miss_level",Zt="back_cdn_req_exist",er="back_cdn_make_req",tr="send_parent_total",rr="send_parent_new_child",nr="send_parent_accept",sr="send_parent_pass",ir="send_parent_reset",ar="player_req_delay",or="player_req_low_buffer",lr="ws_state",hr="duplicate_bytes",cr="lr_upload_bytes",ur="total_play_cnt",dr="total_duration",pr="frag_cnt",fr="meta_req",gr="meta_404",vr="meta_403",mr="meta_succ",_r="meta_err",yr="meta_cost",br="verify_total",wr="verify_p2p_fail",Rr="verify_p2p_not_ready",Tr="verify_cdn_fail",Cr="validate_enable",Sr="sw_reg",Ir="sw_reg_succ",kr="sw_reg_fail",Er="sw_recv_req",Pr="sw_resp_ok",xr="sw_resp_err",Lr="sw_resp_timeout",Ar="sw_resp_403",Dr="sw_recv_m3u8",Mr="sw_recv_m3u8_403",Or="sw_recv_m3u8_total",qr="sw_enable",Ur="sw_version",Br="sw_buildtime",Nr="sw_commit";const Fr=class{static encrypt(e){for(var t=new ArrayBuffer(e.length),r=new Uint8Array(t),n=[99,117,105],s=0;s<e.length;s+=1)r[s]=e.codePointAt(s)^n[s%n.length];return r}static decrypt(e){for(var t="",r=[99,117,105],n=0;n<e.length;n+=1){var s=e[n].codePointAt(0)^r[n%r.length];t+=String.fromCodePoint(s)}return JSON.parse(t)}};const $r=class{constructor(){this._list=new Map}init(){this._reset()}destroy(){this._reset()}delete(e){this._list.delete(e)}add(e,t){this._list.has(e),this._list.set(e,t)}_reset(){this._list.forEach((e=>{e.destroy()})),this._list.clear()}};var jr=new class{constructor(){this.TAG="ReportLoader",this.reportCount=null,this._loaderManager=new $r}init(e){this.hlsp2p=e,this.reportCount=0,this._loaderManager.init()}destroy(){this.hlsp2p=null,this.reportCount=0,this._loaderManager.destroy()}onReportLoading(e){var t=e.data,r=e.lastReport,n=Fr.encrypt(JSON.stringify(t));if(r)navigator&&navigator.sendBeacon&&navigator.sendBeacon(l.reportServer,n);else{var s=`report-${this.reportCount}`,i=I.GetRequestConfig();i.method="POST",i.url=l.reportServer,i.postData=n;var a=new K(s,i,this.receiveResp.bind(this));this._loaderManager.add(s,a),a.load()}}receiveResp(e,t,r){t===k.SUCCESS&&this.hlsp2p.trigger(R.REPORT_LOADED,{Data:r.data}),this._loaderManager.delete(e)}};const Hr=jr;var Gr=r(238);const Vr=class{static getLogTime(){var e=new Date;return`${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}.${e.getMilliseconds()}`}static timestamp(){return Date.now()}};var zr="1.6.37",Wr={};class Xr{static supportLocalStorage(){try{return self.localStorage&&(self.localStorage.setItem("_xp2p_test_3kdx","1"),self.localStorage.removeItem("_xp2p_test_3kdx")),!0}catch(e){return!1}}static getItem(e){return Xr.supportLocalStorage()?self.localStorage.getItem(e):Wr[e]}static setItem(e,t){if(Xr.supportLocalStorage())return self.localStorage.setItem(e,t);Wr[e]=t}}var Kr=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),Yr=()=>{var e=Xr.getItem("myUUID");return e&&36===e.length||(e=Kr(),Xr.setItem("myUUID",e)),e},Jr=()=>{var e;try{e=new Gr.UAParser(navigator.userAgent).getResult()}catch(e){}return{service:l.service,platform:l.platform,appid:l.cloudAppId,stream_id:"",module_id:l.moduleId,command:l.command,data_time:Math.round(Vr.timestamp()/1e3),version:zr,build_time:"2023-10-19T03:35:03.746Z",commit_id:"7696c4e",video_type:"",data_type:2,channel:"",partner:"",code:"000",str_video_type:"",src_type:"auto",host:self.location.host,life:Math.round(Vr.timestamp()-l.startTime),url:"",referer:self.location.href,user_agent:self.navigator.userAgent,str_user_id:Yr(),str_play_id:l.randomPlayId,os_name:e&&e.os.name||"",os_version:e&&e.os.version||"",browser_name:e&&e.browser.name||"",browser_version:e&&e.browser.version||"",browser_major:e&&e.browser.major||"",device_vendor:e&&e.device.vendor||"",device_type:e&&e.device.type||"",i:{}}},Qr="destroy",Zr="close";var en=new class{constructor(){this.TAG="ReportController",this._callbacks=[]}init(e){this.hlsp2p=e,Hr.init(e),this.hlsp2p.on(R.NOR_REPORT_START,this._norReportStart.bind(this)),this.onCollectReport=this._collectReport.bind(this),self.addEventListener("beforeunload",this.beforeUnload.bind(this))}registerModule(e,t){this._callbacks.push(t)}destroy(){this._timer&&(clearInterval(this._timer),this._timer=null);var e=D.exitReason||Qr;this._collectReport({[De]:e},!0),Hr.destroy(),this._callbacks=[],this.hlsp2p=null}beforeUnload(){this._collectReport({[De]:Zr},!0)}_collectReport(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.template;this._callbacks.forEach((e=>{var n=e({lastReport:t});n&&Object.assign(r.i,n)})),e&&Object.assign(r.i,e),t&&(r.i[Oe]=Date.now()-l.loadTime),Hr.onReportLoading({data:r,lastReport:t})}_norReportStart(){this._timer=setInterval(this._collectReport.bind(this),l.reportInterval)}get template(){var e=Jr();return e.stream_id=l.channelId,e.channel=l.channelId,e.video_type="LIVE"===l.videoType?"live":"vod",e.str_video_type="LIVE"===l.videoType?"live":"vod",e.partner=l.xp2pAppId,e.url=l.originalUrl,e.i[ze]=l.cdnDomain,e}};const tn=en;function rn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function nn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,s,i,a,o=[],l=!0,h=!1;try{if(i=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;l=!1}else for(;!(l=(n=i.call(r)).done)&&(o.push(n.value),o.length!==t);l=!0);}catch(e){h=!0,s=e}finally{try{if(!l&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(h)throw s}}return o}}(e,t)||function(e,t){if(e){if("string"==typeof e)return rn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?rn(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}class sn{static fromId(e){var t=nn(e.split("-"),2),r=t[0],n=t[1];return new sn({sn:parseInt(r,10),level:parseInt(n,10)})}static fromObj(e){var t=e.sn,r=e.level;return new sn({sn:t,level:r})}constructor(e){var t=e.sn,r=e.level;this.sn=t,this.level=r}toStringId(){return`${this.sn}-${this.level}`}}class an{constructor(){this._cdnBytesTotal=0,this._p2pBytesTotal=0,this._cdnBytes=0,this._p2pBytes=0}reset(){this._cdnBytesTotal=0,this._p2pBytesTotal=0,this._cdnBytes=0,this._p2pBytes=0}addCdnBytes(e){this._cdnBytes+=e,this._cdnBytesTotal+=e}addP2PBytes(e){this._p2pBytes+=e,this._p2pBytesTotal+=e}getStats(){var e={cdnBytesTotal:this._cdnBytesTotal,p2pBytesTotal:this._p2pBytesTotal,cdnBytes:this._cdnBytes,p2pBytes:this._p2pBytes};return this._cdnBytes=0,this._p2pBytes=0,e}}var on=new class extends le{constructor(){super(),this.TAG="BufferController",this.map=new Map,this.stat=new an,this.TSInfoFromCDN=[],this._downloadBytes={},this._loadOkTime=0,this._llsDuplicateBytes=0,this._lrUploadBytes=0}setResStoreProxy(e){this._resStoreProxy=e}init(e){this.hlsp2p=e,this.receiveBufferHandler=this.onReceiveBuffer.bind(this),e.on(R.FRAG_LOADED,this.receiveBufferHandler),this.receiveChunkHandler=this.onReceiveChunk.bind(this),e.on("chunk_buffer_complete",this.receiveChunkHandler),this._downloadBytes.cdnBytes=0,this._downloadBytes.p2pBytes=0,this._downloadBytes.lrsP2PBytes=0,this._downloadBytes.p2pRecvBytes=0,this.stat.reset(),tn.registerModule(this.TAG,this.reportCallback.bind(this)),e.once(R.FRAG_LOADED,(()=>{this._loadOkTime=Date.now()-l.loadTime})),this.onKeepSize=this.keepSize.bind(this),this.keepSizeTimer=setInterval(this.onKeepSize,l.checkBufferInterval)}destroy(){this.reset(),this._clearTimer(),this.hlsp2p.off(R.FRAG_LOADED,this.receiveBufferHandler),this.hlsp2p=null}_clearTimer(){this.keepSizeTimer||(clearInterval(this.keepSizeTimer),this.keepSizeTimer=null)}has(e){var t=this.map.get(e);return!!t&&t.complete()}add(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"cdn";if(!this.has(e)){var n=new oe(e,l.sliceCount);if(n.downloadFrom=r,n.setArrayBufferData(t),this.map.set(e,n),this._resStoreProxy&&l.enableStoreRes){var s=sn.fromId(e);this._resStoreProxy.set({resId:l.channelId,sn:s.sn,level:s.level,data:new Uint8Array(t)})}}}get(e){return this.map.get(e)}reset(){this.TSInfoFromCDN=[],this._downloadBytes={},this.map.forEach((e=>e.destroy())),this.map.clear()}size(){return this.map.size}delete(e){var t=this.get(e);t&&(t.destroy(),this.map.delete(e))}keepSize(){var e=this.size()-l.bufferCount;if(e>0)for(var t=[...this.map.keys()],r=0;r<e;r+=1){var n=t.shift();this.delete(n),this.hlsp2p.trigger("delete_buffer",{id:n})}}getBufferInfo(e){if(!Array.isArray(e))throw Error("bufferController.getSpecifiedBitmap 参数需为数组");var t=new Map;if(e.length)return e.forEach((e=>{var r=this.get(`${e.sn}-${e.level}`);r&&t.set(r.id,r.bufferInfo())})),[...t.values()];if(this.map.forEach((e=>{t.set(e.id,e.bufferInfo())})),this._resStoreProxy&&l.enableStoreRes){var r=this._resStoreProxy.getResMeta(l.channelId);r&&r.getAllMeta().forEach((e=>{var r=`${e.sn}-${e.level}`;if(!t.has(r)){var n=new ae;n.sn=e.sn,n.level=e.level,n.subIndexes=[0],t.set(r,n)}}))}return[...t.values()]}onReceiveSlice(e){var t=e.id.slice(0,e.id.lastIndexOf("-")),r=this.map.get(t);r&&r.complete()||(r||((r=new oe(t,l.sliceCount)).downloadFrom="p2p",this.map.set(t,r)),r.setSlice(e.index,e.slice),r.complete()&&(X.log(`${t} p2p下载完成, byteLength: ${r.dataLen}`),this._downloadBytes.p2pRecvBytes+=r.dataLen,this.hlsp2p.trigger(R.FRAG_LOADED_P2P,{id:t})))}getSlices(e,t,r){var n=this.map.get(`${e}-${t}`);return!!n&&n.getSlice(r)}getSlicesFromAllPlace(e,t){var r=this;return J(Z().mark((function n(){var s,i,a;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!(s=r.getSlices(e,t,0))){n.next=3;break}return n.abrupt("return",s);case 3:if(!r._resStoreProxy||!l.enableStoreRes){n.next=13;break}return n.next=6,r._resStoreProxy.get({resId:l.channelId,sn:e,level:t});case 6:if(!(i=n.sent)){n.next=13;break}return r._lrUploadBytes+=i.data.byteLength,(a=new ie(e,t,0,i.data.buffer)).p2pStoragTypeFlag=ne,n.abrupt("return",a);case 13:return n.abrupt("return",!1);case 14:case"end":return n.stop()}}),n)})))()}onReceiveBuffer(e){var t=e.id,r=e.binaryData,n=e.resp;this.recordResp(t,r,n),this._downloadBytes.cdnBytes+=r.byteLength,this.stat.addCdnBytes(r.byteLength),X.log(`${t} CDN下载ts完成, byteLength: ${r.byteLength}`),this.add(t,r)}onReceiveChunk(e){var t=e.id,r=e.payload,n=e.stats,s=(n.p2pBytes,n.cdnBytes),i=n.duplicateBytes;if(this._downloadBytes.cdnBytes+=s,this.stat.addCdnBytes(s),!this.map.has(t)){var a=Math.max(r.byteLength-s,0);this._downloadBytes.p2pBytes+=a,this.stat.addP2PBytes(a);var o="mix";0===a?o="cdn":0===s&&(o="p2p"),this._llsDuplicateBytes+=i,this.add(t,r.buffer,o),this.hlsp2p.trigger("new_buffer",{id:t})}}genRespFromBuffer(e,t){var r=I.GetResTemplate(),n=this.get(e);if(!n)return!1;r.data=n.arrayBuffer(),r.responseType=t.responseType,r.httpCode=200,r.dataLen=r.data.byteLength,r.timeRequestPerformance=performance.now();var s=D.cdnEstimate.estimateTTFB()||100;r.TTFBPerformance=s+r.timeRequestPerformance;var i=D.cdnEstimate.estimateBandwidth(),a=i?r.dataLen/i:100;return r.timeLoadedPerformance=r.TTFBPerformance+a,r.responseURL=t.url,r.__type="INNER","p2p"!==n.downloadFrom||l.enableLLS||(this._downloadBytes.p2pBytes+=r.dataLen,n.getP2PStorageType()===ne&&(this._downloadBytes.lrsP2PBytes+=r.dataLen),this.stat.addP2PBytes(r.dataLen)),r}recordResp(e,t,r){if(!(this.TSInfoFromCDN.length>100)){var n,s;this.TSInfoFromCDN.push(`v1|${n=r.url,s=new URL(n).pathname.split("/"),s[s.length-1]}|${e}|${t.byteLength}`)}}reportCallback(){var e={};return this._downloadBytes&&(0!==this._downloadBytes.p2pBytes&&(e[xe]=this._downloadBytes.p2pBytes,this._downloadBytes.p2pBytes=0),0!==this._downloadBytes.cdnBytes&&(e[Pe]=this._downloadBytes.cdnBytes,this._downloadBytes.cdnBytes=0),0!==this._downloadBytes.lrsP2PBytes&&(e[Le]=this._downloadBytes.lrsP2PBytes,this._downloadBytes.lrsP2PBytes=0),this._downloadBytes.p2pRecvBytes&&(e[Ae]=this._downloadBytes.p2pRecvBytes,this._downloadBytes.p2pRecvBytes=0),this._llsDuplicateBytes&&(e[hr]=this._llsDuplicateBytes,this._llsDuplicateBytes=0)),this.TSInfoFromCDN.length>0&&(l.enableCDNDetailReport?e[Ue]=this.TSInfoFromCDN:delete e[Ue],this.TSInfoFromCDN=[]),this._loadOkTime&&(e[Ie]=this._loadOkTime,this._loadOkTime=0),this._lrUploadBytes&&(e[cr]=this._lrUploadBytes,this._lrUploadBytes=0),e}get downloadBytes(){return this._downloadBytes}};const ln=on;class hn extends(t()){constructor(){super(),this.TAG="VideoProxy",this._videoElement=null,this._listenEvent=["waiting","canplay","loadedmetadata","loadeddata","stalled","canplaythrough"],this._handler=new Map}init(e){var t=e.videoId;this._genHandler(),this.setVideoById(t)}destroy(){this._videoElement&&(this.releaseVideoElement(),this._videoElement=null),this.removeAllListeners()}setVideoByElement(e){this._videoElement&&this.releaseVideoElement(),this._videoElement=e,this.attachVideoElement()}setVideoById(e){var t=document.getElementById(e);this.setVideoByElement(t)}attachVideoElement(){this._handler.forEach(((e,t)=>{this._videoElement.addEventListener(t,e)}))}releaseVideoElement(){this._handler.forEach(((e,t)=>{this._videoElement.removeEventListener(t,e)})),this._handler.clear()}onWaiting(){this.emit("waiting")}onCanplay(){this.emit("canplay")}onLoadedmetadata(){this.emit("loadedmetadata")}onLoadeddata(){this.emit("loadeddata")}onStalled(){this.emit("stalled")}onCanplaythrough(){this.emit("canplaythrough")}get currentTime(){return this._videoElement.currentTime}set currentTime(e){this._videoElement.currentTime=e}get seeking(){return this._videoElement.seeking}get ended(){return this._videoElement.ended}get video(){return this._videoElement}get buffered(){return this._videoElement.buffered}get bufferLength(){var e=this.buffered,t=0;if(e){var r=e.length;r&&(t=e.end(r-1)-cn.currentTime)}return t}get paused(){return this._videoElement.paused}set playbackRate(e){this._videoElement.playbackRate=e}get playbackRate(){return this._videoElement.playbackRate}get readyState(){return this._videoElement.readyState}static transEventToFunc(e){if(!e)throw new TypeError("Video-Proxy: param event must be a non-empty string");if(e.length<4)throw new Error("Video-Proxy: no such event");return`on${e[0].toUpperCase()}${e.slice(1)}`}_genHandler(){this._listenEvent.forEach((e=>{var t=hn.transEventToFunc(e);if(!this[t])throw new Error("Video-Proxy: no such function");this._handler.set(e,this[t].bind(this))}))}}var cn=new hn;const un=cn;var dn={0:B,1:N,2:F,3:$,4:j};class pn extends G{constructor(){super(),this.logs=[]}destroy(){super.destroy(),this.stop(),this.logs=[]}init(e){this._config=e,this.configure(e),this.stop(),this.logs=[]}setLevel(e){var t=e;return"number"==typeof e&&(t=dn[e]),super.setLevel(t)}start(e){var t=e.reportInterval;this._reportInterval=t,this._startUpload()}stop(){this._clearTimer()}traceCb(e){this._cacheLog(e)}logCb(e){this._cacheLog(e)}infoCb(e){this._cacheLog(e)}warnCb(e){this._cacheLog(e)}errorCb(e){this._cacheLog(e)}_cacheLog(e){this.logs.push(e),this.logs.length>5e3&&this.logs.shift()}_startUpload(){this._reportInterval&&this._config&&(this._clearTimer(),this._uploadTimer=setInterval((()=>{if(this._enable&&this.logs.length){var e=`https://rtlog.qvb.qcloud.com/upload/p2p.log?uuid=${this._config.uuid}&version=${this._config.version}&platform=${this._config.platform}&type=data`;fetch(e,{method:"POST",body:this.logs.join("\r\n")}).catch((e=>{})),this.logs=[]}}),this._reportInterval))}_clearTimer(){this._uploadTimer&&(clearInterval(this._uploadTimer),this._uploadTimer=null)}}const fn=new pn;class gn{constructor(e,t){this.TAG="P2PRequestLoader",this.id=e,this.config=t,this.p2pReqTimeout=t.p2pReqTimeout||3e3,this.enableP2pAutoTimeout=t.enableP2pAutoTimeout||!1,this._aborted=!1,this._succed=!1}init(e,t){this.hlsp2p=e,this._reportData=t}setCDNRequestCallback(e){this.cdnReqCb=e}load(){this._load()}backToCDN(){clearTimeout(this.timeoutTimer),M.delete(this.id),this.cdnReqCb&&this.cdnReqCb()}destroy(){this._aborted||(this.cb=()=>{},this.abort(),this.hlsp2p=null,this._reportData=null)}abort(){this._aborted=!0,clearTimeout(this.timeoutTimer),this._succed||this.hlsp2p.subscriber.cancelChunkRequest(this.id)}_load(){var e=sn.fromId(this.id);this._reportData&&(this._reportData[kt]+=1);var t=this.p2pReqTimeout,r=this.p2pReqTimeout;if(this.enableP2pAutoTimeout&&D.targetDuration){var n=.1*D.targetDuration;if((r=1e3*Math.max(n,un.bufferLength-n))===1e3*n)return this._reportData&&(this._reportData[Xt]+=1),void this.backToCDN()}this.hlsp2p.subscriber.tryToMakeRequest({sn:e.sn,level:e.level,hop:0,url:this.config.url})&&(t=Math.min(r,t),this.actualP2PTimeout=t,this.timeoutTimer=setTimeout(this._timeout.bind(this),t))}_timeout(){this.hlsp2p.subscriber.cancelChunkRequest(this.id,{reason:"cdn_timeout"}),this._reportData&&(this._reportData[Tt]+=1),this.backToCDN()}}class vn{constructor(){this.trequest=performance.now(),this.retry=0,this.tfirst=0,this.loaded=0,this.tload=0,this.total=0,this.aborted=!1,this.retry=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:performance.now(),first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}const mn=class{constructor(e,t,r){this.TAG="ProtoTSResp",this.id="",this.inner=!1,this._context=e,this._callbacks=r,this._response={url:"",data:""},this._httpStatus={code:0,text:""},this._stats=new vn,this._delayHlsjsAbandonTimer=null}enableDelayHLSJSAbandonCheck(){this._delayHlsjsAbandonTimer||(this._delayHlsjsAbandonTimer=setInterval((()=>{this._stats.trequest=performance.now(),this._stats.loading.start=performance.now()}),100))}stopDelayHLSJSAbandonCheck(){this._delayHlsjsAbandonTimer&&(clearInterval(this._delayHlsjsAbandonTimer),this._delayHlsjsAbandonTimer=null)}update(e,t,r){this._context=e,this._callbacks=r,this.id=e.id||`${e.frag.sn}-${e.frag.level}`}set stats(e){return this._stats=e}get stats(){return this._stats}abort(){this._stats.aborted=!0,this.stopDelayHLSJSAbandonCheck()}setResponse(e){this._response.url=e.url,this._response.data=e.data}setStats(e){this._stats.trequest=e.timeRequestPerformance,this._stats.retry=e.retry,this._stats.aborted=e.aborted,this._stats.tfirst=Math.max(e.TTFBPerformance,this._stats.trequest),this._stats.loaded=e.dataLen,this._stats.tload=Math.max(e.timeLoadedPerformance,this._stats.tfirst),this._stats.total=e.dataLen,this._stats.__type=e.__type,this.type=e.__type;var t=performance.now();this._stats.tload=t,this._stats.tfirst=t-this._stats.total/D.cdnEstimate.estimateBandwidth(),this._stats.trequest=this._stats.tfirst-D.cdnEstimate.estimateTTFB(),this._stats.loading.start=this._stats.trequest,this._stats.loading.first=this._stats.tfirst,this._stats.loading.end=this._stats.tload}setHttpStatus(e){this._httpStatus.code=e.httpCode,this._httpStatus.text=e.statusText}setRespAndSend(e,t){switch(e){case k.SUCCESS:this.setResponse(t),this.setStats(t),this.progress(),this.success();break;case k.ERROR:this.setHttpStatus(t),this.error();break;case k.TIMEOUT:this.setStats(t),this.timeout()}this.stopDelayHLSJSAbandonCheck()}success(){setTimeout((()=>{this._callbacks.onSuccess(this._response,this._stats,this._context)}),0)}error(){this._callbacks.onError({code:this._httpStatus.code,text:this._httpStatus.statusText},this._context)}timeout(){this._callbacks.onTimeout(this._stats,this._context,null)}progress(){this._callbacks.onProgress&&this._callbacks.onProgress(this._stats,this._context,this._response.data,null)}};var _n=new class extends le{constructor(){super(),this.TAG="ProcessTSReq",this.preLevel=0}destroy(){P.getRespMap().forEach(((e,t)=>{e.setRespAndSend(k.ERROR,{httpCode:0,statusText:""})})),M.destroy(),P.destroy(),this._totalLoadCnt=0,this.hlsp2p=null}init(e){this._totalLoadCnt=0,this.hlsp2p=e,e.on("chunk_stat",((e,t)=>{var r=P.getResp(e);r&&(r.stats.loaded=t.totalLength)})),e.on("new_buffer",(e=>{var t=e.id,r=P.getResp(t);if(!r||r.inner)return P.delete(t),void M.delete(t);var n=P.getReq(t);this.setRespFromBuffer(t,n.genRequestLoaderConfig())})),e.on("imt_load_cdn",(e=>{var t=e.sn,r=e.level,n=e.url;if(this.hlsp2p){var s=sn.fromObj({sn:t,level:r}).toStringId();if(ln.has(s))this._reportData[Yt]+=1;else if(r===D.curReqLevel&&t<D.curReqSn)this._reportData[Jt]+=1;else if(r===D.curReqLevel)if(M.curTaskId!==s)this._reportData[er]+=1,this._makeLLSCDNRequest(s,{url:n});else{var i=M.get(s);i.backToCDN&&(this._reportData[Zt]+=1,i.backToCDN())}else this._reportData[Qt]+=1}})),tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.initReport(),M.init(),P.init()}load(e,t,r){if(this._totalLoadCnt+=1,this.hlsp2p.trigger("player_level",{level:t.level}),X.log(`播放器请求ts id: ${e} pid_${this.hlsp2p.pid} uuid_${Yr()} url: ${t.url} bufferLen: ${un.bufferLength.toFixed(3)}`),void 0!==this._reportData[`req_level_${t.level}`]&&(this._reportData[`req_level_${t.level}`]+=1),t.level!==this.preLevel&&(this.preLevel=t.level,this._reportData[$e]+=1),this._reportData[ot]+=1,l.enableLLS)this.llsLoad(e,t,r);else{var n=P.getResp(e);n&&n.inner&&(this._reportData[ct]+=1,this.abort(e)),P.addReq(e,t,r),this.receiveReq(e)}}llsLoad(e,t,r){var n=P.getResp(e);n&&n.abort(),P.addReq(e,t,r),M.has(e)||this.receiveReq(e)}loadInnerReq(e,t,r){P.has(e)?this._reportData[ut]+=1:(this._reportData[ht]+=1,X.log(`${e} 内部预请求ts`),r.inner=!0,P.addReq(e,t,r),this.receiveReq(e))}receiveReq(e){var t=P.getReq(e).genRequestLoaderConfig();ln.has(e)?this.setRespFromBuffer(e,t):M.has(e)||(l.enableLLS?this._requestLLS(e,t):this._requestNormalCDN(e,t))}_requestNormalCDN(e,t){var r=new K(e,t,this.onNormalRecvCDNResp.bind(this));this._reportData[dt]+=1,this.hlsp2p.trigger(R.BEFORE_CDN_REQUEST,{loader:r}),M.add(e,r)}_requestLLS(e,t){if(l.lowBufferThreshold&&un.bufferLength<l.lowBufferThreshold)return this._reportData[or]+=1,void this._makeLLSCDNRequest(e,{url:t.url});t.p2pReqTimeout=l.p2pReqTimeout,t.useFetch=!0,t.enableP2pAutoTimeout=l.enableP2pAutoTimeout;var r=new gn(e,t);r.init(this.hlsp2p,this._reportData),r.setCDNRequestCallback(this._makeLLSCDNRequest.bind(this,e,{url:t.url})),M.curTaskId!==e&&(this._reportData[ar]+=1),P.getResp(e).enableDelayHLSJSAbandonCheck(),M.add(e,r)}_makeLLSCDNRequest(e,t){var r=t.url,n=sn.fromId(e),s={onSuccess:()=>{},onError:()=>{},onTimeout:()=>{},onProgress:()=>{}},i={maxRetry:0,maxRetryDelay:64e3,retryDelay:0,timeout:2e4},a={url:r,responseType:"arraybuffer",frag:{sn:n.sn,level:n.level}};if(P.has(e)){P.getResp(e).stopDelayHLSJSAbandonCheck()}else{var o=new E(a,i,s),h=new mn(a,i,s);h.inner=!0,P.addReq(o.id,o,h)}var c=P.getReq(e).genRequestLoaderConfig();if(c.useFetch=!0,this.hlsp2p.chunkMgr){var u=this.hlsp2p.chunkMgr.getRange(e);this.hlsp2p.chunkMgr.getChunks(e)||new Map,this.hlsp2p.chunkMgr.getRangeSeq(e);u&&0!==u.end&&l.enableRange&&(c.useRange=!0,c.range=u,c.headers.Range=`bytes=${u.end}-`,this._reportData[_t]+=1)}this.hlsp2p.trigger("subscribe_report",{seq:e,target:"CDN"});var d=new K(e,c,this.onLLSRecvCDNResp.bind(this));this.hlsp2p.trigger(R.BEFORE_CDN_REQUEST,{loader:d}),M.add(e,d)}onLLSRecvCDNResp(e,t,r){this.onRecvLLSTSRespData(e,t,r),this.statResp(e,t,r),[k.ERROR,k.TIMEOUT].includes(t)&&this.sendRespToPlayer(e,t,r)}onNormalRecvCDNResp(e,t,r){this.statResp(e,t,r);P.getReq(e),r.data&&r.data.byteLength;t===k.SUCCESS&&this.hlsp2p&&this.hlsp2p.trigger(R.FRAG_LOADED,{id:e,binaryData:r.data,resp:r}),this.sendRespToPlayer(e,t,r)}statResp(e,t,r){t!==k.PROGRESS&&(t===k.SUCCESS&&(D.cdnEstimate.recordTTFB(r.TTFBPerformance-r.timeRequestPerformance),D.cdnEstimate.recordBandwidth(r.dataLen,r.timeLoadedPerformance-r.TTFBPerformance),this.recordDownloadCost(r.timeLoadedPerformance-r.timeRequestPerformance),this._reportData[gt]+=1,r.config.useRange&&(this._reportData[yt]+=r.dataLen)),t===k.ERROR&&(this._reportData[mt]+=1),t===k.TIMEOUT&&(this._reportData[vt]+=1))}onRecvLLSTSRespData(e,t,r){if(l.enableLLS&&this.hlsp2p.chunkMgr){if(t===k.STATUS_CODE){var n=r;if(n.config.useRange){if(200===n.statusCode)this._reportData[Ge]=0,this.hlsp2p.chunkMgr.deleteBufFrag(e),this.hlsp2p.chunkMgr.createBufFrag(e,{startByteOffset:0});else if(206===n.statusCode){var s=n.config.range.end;this.hlsp2p.chunkMgr.deleteBufFrag(e),this.hlsp2p.chunkMgr.createBufFrag(e,{startByteOffset:s})}}else 200===n.statusCode&&n.statusCode<=299&&(this.hlsp2p.chunkMgr.deleteBufFrag(e),this.hlsp2p.chunkMgr.createBufFrag(e,{startByteOffset:0}))}var i=r;if(t===k.PROGRESS)return void this.hlsp2p.chunkMgr.addBuf(e,new Uint8Array(i.value));t===k.SUCCESS&&(this.hlsp2p.chunkMgr.completeBufFrag(e),ln.recordResp(e,r.data,r))}}setRespFromBuffer(e,t){if(ln.has(e)){var r=ln.get(e);"cdn"===r.downloadFrom?this._reportData[ft]+=1:"p2p"===r.downloadFrom&&(this._reportData[pt]+=1);var n=ln.genRespFromBuffer(e,t);if(!n)return;X.log(`${e} 命中缓存, download from ${ln.get(e).downloadFrom} len: ${n.data.byteLength}`),this.sendRespToPlayer(e,k.SUCCESS,n)}}sendRespToPlayer(e,t,r){var n=P.getResp(e);n&&(n.inner,n.inner||(this._reportData[Be]+=r.dataLen),n.setRespAndSend(t,r)),P.delete(e),M.delete(e),M.tick()}abort(e){(X.log(`${this.TAG} 播放器触发 abort ${e}`),M.delete(e),P.has(e))&&P.getResp(e).abort();P.delete(e)}recordDownloadCost(e){this._reportData[Qe].length>100||this._reportData[Qe].push(Math.floor(e))}initReport(){this._reportData={[We]:0,[Xe]:0,[Ke]:0,[Ye]:0,[Je]:0,[Qe]:[],[ot]:0,[ht]:0,[ct]:0,[ut]:0,[dt]:0,[ft]:0,[pt]:0,[gt]:0,[yt]:0,[mt]:0,[vt]:0,[Be]:0,[Ge]:1,[$e]:0,[je]:"0",[Yt]:0,[Jt]:0,[Qt]:0,[Zt]:0,[er]:0,[ar]:0,[or]:0,[Tt]:0,[Xt]:0,[kt]:0,[_t]:0}}reportCallback(e){var t=e.lastReport,r=this._reportData,n=this._reportData[Qe];return n&&n.length&&(r[at]=Math.floor(n.reduce(((e,t)=>e+t))/n.length)),r[je]=`${D.curReqLevel}`,t&&(r[ur]=this._totalLoadCnt),this.initReport(),r}};const yn=_n;const bn=class{constructor(){this.TAG="HlsjsFLoader",this.id="",this.resp=new mn,this.stats=this.resp._stats}destroy(){this.abort()}abort(){yn.abort(this.id)}load(e,t,r){var n=new E(e,t,r);this.resp.update(e,t,r),this.id=n.id,this.resp.id=n.id,this.resp.from="player";var s=e.frag,i=s.sn,a=s.level;D.curReqSn=i,D.curReqLevel=a,setTimeout((()=>{yn.load(this.id,n,this.resp)}))}};class wn{setMaxBufferLength(e){}}var Rn=new class extends wn{constructor(){super(),this.TAG="HlsjsAdapter",this.hlsp2p=null,this.hlsjs=null,this.playerOriginalConfig={maxBufferLength:30,maxMaxBufferLength:600}}destroy(){this._detach(),this.hlsp2p=null,this.hlsjs=null}init(e,t){this.hlsp2p=e,this.hlsjs=t,this.onHlsManifestParsed=this.hlsManifestParsed.bind(this),this.onHlsLevelLoaded=this.hlsLevelLoaded.bind(this),this._attach()}reset(){this._attach(),this._detach()}_attach(){this._setVODTimer(),this.playerOriginalConfig.maxBufferLength=this.hlsjs.maxBufferLength,this.playerOriginalConfig.maxMaxBufferLength=this.hlsjs.maxMaxBufferLength,this.hlsjs.config.fLoader=bn,this.hlsjs.on("hlsManifestParsed",this.onHlsManifestParsed),this.hlsjs.on("hlsLevelLoaded",this.onHlsLevelLoaded)}hlsManifestParsed(e,t){this.hlsp2p.trigger(R.HlsManifestParsed,t)}hlsLevelLoaded(e,t){var r=t.details.fragments,n=t.details,s=[];r.forEach((e=>{X.log(`[Hlsjs LevelLoaded] ${e.sn}-${e.level} duration: ${e.duration}`);var t=new S;t.sn=e.sn,t.level=e.level,t.uri=e.relurl,t.baseUrl=e.baseurl,t.duration=Math.round(e.duration),s.push(t)})),this.hlsp2p.trigger(R.LEVEL_LOADED,{level:t.level,playlistType:!0===n.live?"LIVE":"VOD",mediaSequence:n.startSN,targetDuration:n.targetduration,endList:n.endSN,fragments:s,totalDuration:n.totalduration,url:n.url})}setMaxBufferLength(e){D.hlsjs.config.maxBufferLength=e,D.hlsjs.config.maxMaxBufferLength=e}_detach(){this._clearVODTimer(),this.hlsjs.config.maxBufferLength=this.playerOriginalConfig.maxBufferLength,this.hlsjs.config.maxMaxBufferLength=this.playerOriginalConfig.maxMaxBufferLength,this.hlsjs.config.fLoader=void 0,this.hlsjs.off("hlsManifestParsed",this.onHlsManifestParsed),this.hlsjs.off("hlsLevelLoaded",this.onHlsLevelLoaded)}_setVODTimer(){"VOD"===l.videoType&&(this._clearVODTimer(),this._vodTimer=setTimeout((()=>{this._copyVODPlaylistFromHlsjs()}),1e4))}_clearVODTimer(){this._vodTimer&&(clearInterval(this._vodTimer),this._vodTimer=null)}_copyVODPlaylistFromHlsjs(){if(this.hlsjs){var e=this.hlsjs.levels;if(e&&e.length)try{e.forEach((e=>{e.details&&this.hlsLevelLoaded("hlsLevelLoaded",e)}))}catch(e){c().error("error in _copyVODPlaylistFromHlsjs",e)}}}};const Tn=Rn;function Cn(e,t){return Cn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Cn(e,t)}function Sn(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Cn(e,t)}var In=function(){function e(){this.listeners={}}var t=e.prototype;return t.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},t.off=function(e,t){if(!this.listeners[e])return!1;var r=this.listeners[e].indexOf(t);return this.listeners[e]=this.listeners[e].slice(0),this.listeners[e].splice(r,1),r>-1},t.trigger=function(e){var t=this.listeners[e];if(t)if(2===arguments.length)for(var r=t.length,n=0;n<r;++n)t[n].call(this,arguments[1]);else for(var s=Array.prototype.slice.call(arguments,1),i=t.length,a=0;a<i;++a)t[a].apply(this,s)},t.dispose=function(){this.listeners={}},t.pipe=function(e){this.on("data",(function(t){e.push(t)}))},e}();function kn(){return kn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},kn.apply(this,arguments)}var En=r(908),Pn=r.n(En);function xn(e){for(var t,r=(t=e,Pn().atob?Pn().atob(t):Buffer.from(t,"base64").toString("binary")),n=new Uint8Array(r.length),s=0;s<r.length;s++)n[s]=r.charCodeAt(s);return n}
/*! @name m3u8-parser @version 4.8.0 @license Apache-2.0 */
var Ln=function(e){function t(){var t;return(t=e.call(this)||this).buffer="",t}return Sn(t,e),t.prototype.push=function(e){var t;for(this.buffer+=e,t=this.buffer.indexOf("\n");t>-1;t=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,t)),this.buffer=this.buffer.substring(t+1)},t}(In),An=String.fromCharCode(9),Dn=function(e){var t=/([0-9.]*)?@?([0-9.]*)?/.exec(e||""),r={};return t[1]&&(r.length=parseInt(t[1],10)),t[2]&&(r.offset=parseInt(t[2],10)),r},Mn=function(e){for(var t,r=e.split(new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')),n={},s=r.length;s--;)""!==r[s]&&((t=/([^=]*)=(.*)/.exec(r[s]).slice(1))[0]=t[0].replace(/^\s+|\s+$/g,""),t[1]=t[1].replace(/^\s+|\s+$/g,""),t[1]=t[1].replace(/^['"](.*)['"]$/g,"$1"),n[t[0]]=t[1]);return n},On=function(e){function t(){var t;return(t=e.call(this)||this).customParsers=[],t.tagMappers=[],t}Sn(t,e);var r=t.prototype;return r.push=function(e){var t,r,n=this;0!==(e=e.trim()).length&&("#"===e[0]?this.tagMappers.reduce((function(t,r){var n=r(e);return n===e?t:t.concat([n])}),[e]).forEach((function(e){for(var s=0;s<n.customParsers.length;s++)if(n.customParsers[s].call(n,e))return;if(0===e.indexOf("#EXT"))if(e=e.replace("\r",""),t=/^#EXTM3U/.exec(e))n.trigger("data",{type:"tag",tagType:"m3u"});else{if(t=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(e))return r={type:"tag",tagType:"inf"},t[1]&&(r.duration=parseFloat(t[1])),t[2]&&(r.title=t[2]),void n.trigger("data",r);if(t=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(e))return r={type:"tag",tagType:"targetduration"},t[1]&&(r.duration=parseInt(t[1],10)),void n.trigger("data",r);if(t=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(e))return r={type:"tag",tagType:"version"},t[1]&&(r.version=parseInt(t[1],10)),void n.trigger("data",r);if(t=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(e))return r={type:"tag",tagType:"media-sequence"},t[1]&&(r.number=parseInt(t[1],10)),void n.trigger("data",r);if(t=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(e))return r={type:"tag",tagType:"discontinuity-sequence"},t[1]&&(r.number=parseInt(t[1],10)),void n.trigger("data",r);if(t=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(e))return r={type:"tag",tagType:"playlist-type"},t[1]&&(r.playlistType=t[1]),void n.trigger("data",r);if(t=/^#EXT-X-BYTERANGE:?(.*)?$/.exec(e))return r=kn(Dn(t[1]),{type:"tag",tagType:"byterange"}),void n.trigger("data",r);if(t=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(e))return r={type:"tag",tagType:"allow-cache"},t[1]&&(r.allowed=!/NO/.test(t[1])),void n.trigger("data",r);if(t=/^#EXT-X-MAP:?(.*)$/.exec(e)){if(r={type:"tag",tagType:"map"},t[1]){var i=Mn(t[1]);i.URI&&(r.uri=i.URI),i.BYTERANGE&&(r.byterange=Dn(i.BYTERANGE))}n.trigger("data",r)}else if(t=/^#EXT-X-STREAM-INF:?(.*)$/.exec(e)){if(r={type:"tag",tagType:"stream-inf"},t[1]){if(r.attributes=Mn(t[1]),r.attributes.RESOLUTION){var a=r.attributes.RESOLUTION.split("x"),o={};a[0]&&(o.width=parseInt(a[0],10)),a[1]&&(o.height=parseInt(a[1],10)),r.attributes.RESOLUTION=o}r.attributes.BANDWIDTH&&(r.attributes.BANDWIDTH=parseInt(r.attributes.BANDWIDTH,10)),r.attributes["FRAME-RATE"]&&(r.attributes["FRAME-RATE"]=parseFloat(r.attributes["FRAME-RATE"])),r.attributes["PROGRAM-ID"]&&(r.attributes["PROGRAM-ID"]=parseInt(r.attributes["PROGRAM-ID"],10))}n.trigger("data",r)}else{if(t=/^#EXT-X-MEDIA:?(.*)$/.exec(e))return r={type:"tag",tagType:"media"},t[1]&&(r.attributes=Mn(t[1])),void n.trigger("data",r);if(t=/^#EXT-X-ENDLIST/.exec(e))n.trigger("data",{type:"tag",tagType:"endlist"});else if(t=/^#EXT-X-DISCONTINUITY/.exec(e))n.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(t=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(e))return r={type:"tag",tagType:"program-date-time"},t[1]&&(r.dateTimeString=t[1],r.dateTimeObject=new Date(t[1])),void n.trigger("data",r);if(t=/^#EXT-X-KEY:?(.*)$/.exec(e))return r={type:"tag",tagType:"key"},t[1]&&(r.attributes=Mn(t[1]),r.attributes.IV&&("0x"===r.attributes.IV.substring(0,2).toLowerCase()&&(r.attributes.IV=r.attributes.IV.substring(2)),r.attributes.IV=r.attributes.IV.match(/.{8}/g),r.attributes.IV[0]=parseInt(r.attributes.IV[0],16),r.attributes.IV[1]=parseInt(r.attributes.IV[1],16),r.attributes.IV[2]=parseInt(r.attributes.IV[2],16),r.attributes.IV[3]=parseInt(r.attributes.IV[3],16),r.attributes.IV=new Uint32Array(r.attributes.IV))),void n.trigger("data",r);if(t=/^#EXT-X-START:?(.*)$/.exec(e))return r={type:"tag",tagType:"start"},t[1]&&(r.attributes=Mn(t[1]),r.attributes["TIME-OFFSET"]=parseFloat(r.attributes["TIME-OFFSET"]),r.attributes.PRECISE=/YES/.test(r.attributes.PRECISE)),void n.trigger("data",r);if(t=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(e))return r={type:"tag",tagType:"cue-out-cont"},t[1]?r.data=t[1]:r.data="",void n.trigger("data",r);if(t=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(e))return r={type:"tag",tagType:"cue-out"},t[1]?r.data=t[1]:r.data="",void n.trigger("data",r);if(t=/^#EXT-X-CUE-IN:?(.*)?$/.exec(e))return r={type:"tag",tagType:"cue-in"},t[1]?r.data=t[1]:r.data="",void n.trigger("data",r);if((t=/^#EXT-X-SKIP:(.*)$/.exec(e))&&t[1])return(r={type:"tag",tagType:"skip"}).attributes=Mn(t[1]),r.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(r.attributes["SKIPPED-SEGMENTS"]=parseInt(r.attributes["SKIPPED-SEGMENTS"],10)),r.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(r.attributes["RECENTLY-REMOVED-DATERANGES"]=r.attributes["RECENTLY-REMOVED-DATERANGES"].split(An)),void n.trigger("data",r);if((t=/^#EXT-X-PART:(.*)$/.exec(e))&&t[1])return(r={type:"tag",tagType:"part"}).attributes=Mn(t[1]),["DURATION"].forEach((function(e){r.attributes.hasOwnProperty(e)&&(r.attributes[e]=parseFloat(r.attributes[e]))})),["INDEPENDENT","GAP"].forEach((function(e){r.attributes.hasOwnProperty(e)&&(r.attributes[e]=/YES/.test(r.attributes[e]))})),r.attributes.hasOwnProperty("BYTERANGE")&&(r.attributes.byterange=Dn(r.attributes.BYTERANGE)),void n.trigger("data",r);if((t=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(e))&&t[1])return(r={type:"tag",tagType:"server-control"}).attributes=Mn(t[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach((function(e){r.attributes.hasOwnProperty(e)&&(r.attributes[e]=parseFloat(r.attributes[e]))})),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach((function(e){r.attributes.hasOwnProperty(e)&&(r.attributes[e]=/YES/.test(r.attributes[e]))})),void n.trigger("data",r);if((t=/^#EXT-X-PART-INF:(.*)$/.exec(e))&&t[1])return(r={type:"tag",tagType:"part-inf"}).attributes=Mn(t[1]),["PART-TARGET"].forEach((function(e){r.attributes.hasOwnProperty(e)&&(r.attributes[e]=parseFloat(r.attributes[e]))})),void n.trigger("data",r);if((t=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(e))&&t[1])return(r={type:"tag",tagType:"preload-hint"}).attributes=Mn(t[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach((function(e){if(r.attributes.hasOwnProperty(e)){r.attributes[e]=parseInt(r.attributes[e],10);var t="BYTERANGE-LENGTH"===e?"length":"offset";r.attributes.byterange=r.attributes.byterange||{},r.attributes.byterange[t]=r.attributes[e],delete r.attributes[e]}})),void n.trigger("data",r);if((t=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(e))&&t[1])return(r={type:"tag",tagType:"rendition-report"}).attributes=Mn(t[1]),["LAST-MSN","LAST-PART"].forEach((function(e){r.attributes.hasOwnProperty(e)&&(r.attributes[e]=parseInt(r.attributes[e],10))})),void n.trigger("data",r);n.trigger("data",{type:"tag",data:e.slice(4)})}}}else n.trigger("data",{type:"comment",text:e.slice(1)})})):this.trigger("data",{type:"uri",uri:e}))},r.addParser=function(e){var t=this,r=e.expression,n=e.customType,s=e.dataParser,i=e.segment;"function"!=typeof s&&(s=function(e){return e}),this.customParsers.push((function(e){if(r.exec(e))return t.trigger("data",{type:"custom",data:s(e),customType:n,segment:i}),!0}))},r.addTagMapper=function(e){var t=e.expression,r=e.map;this.tagMappers.push((function(e){return t.test(e)?r(e):e}))},t}(In),qn=function(e){var t={};return Object.keys(e).forEach((function(r){var n;t[(n=r,n.toLowerCase().replace(/-(\w)/g,(function(e){return e[1].toUpperCase()})))]=e[r]})),t},Un=function(e){var t=e.serverControl,r=e.targetDuration,n=e.partTargetDuration;if(t){var s="#EXT-X-SERVER-CONTROL",i="holdBack",a="partHoldBack",o=r&&3*r,l=n&&2*n;r&&!t.hasOwnProperty(i)&&(t[i]=o,this.trigger("info",{message:s+" defaulting HOLD-BACK to targetDuration * 3 ("+o+")."})),o&&t[i]<o&&(this.trigger("warn",{message:s+" clamping HOLD-BACK ("+t[i]+") to targetDuration * 3 ("+o+")"}),t[i]=o),n&&!t.hasOwnProperty(a)&&(t[a]=3*n,this.trigger("info",{message:s+" defaulting PART-HOLD-BACK to partTargetDuration * 3 ("+t[a]+")."})),n&&t[a]<l&&(this.trigger("warn",{message:s+" clamping PART-HOLD-BACK ("+t[a]+") to partTargetDuration * 2 ("+l+")."}),t[a]=l)}},Bn=function(e){function t(){var t;(t=e.call(this)||this).lineStream=new Ln,t.parseStream=new On,t.lineStream.pipe(t.parseStream);var r,n,s=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t),i=[],a={},o=!1,l=function(){},h={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},c=0;t.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var u=0,d=0;return t.on("end",(function(){a.uri||!a.parts&&!a.preloadHints||(!a.map&&r&&(a.map=r),!a.key&&n&&(a.key=n),a.timeline||"number"!=typeof c||(a.timeline=c),t.manifest.preloadSegment=a)})),t.parseStream.on("data",(function(e){var t,p;({tag:function(){({version:function(){e.version&&(this.manifest.version=e.version)},"allow-cache":function(){this.manifest.allowCache=e.allowed,"allowed"in e||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var t={};"length"in e&&(a.byterange=t,t.length=e.length,"offset"in e||(e.offset=u)),"offset"in e&&(a.byterange=t,t.offset=e.offset),u=t.offset+t.length},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),e.duration>0&&(a.duration=e.duration),0===e.duration&&(a.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=i},key:function(){if(e.attributes)if("NONE"!==e.attributes.METHOD)if(e.attributes.URI){if("com.apple.streamingkeydelivery"===e.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:e.attributes});if("com.microsoft.playready"===e.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.microsoft.playready"]={uri:e.attributes.URI});if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===e.attributes.KEYFORMAT){return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(e.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===e.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==e.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):e.attributes.KEYID&&"0x"===e.attributes.KEYID.substring(0,2)?(this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:e.attributes.KEYFORMAT,keyId:e.attributes.KEYID.substring(2)},pssh:xn(e.attributes.URI.split(",")[1])})):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}))}e.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),n={method:e.attributes.METHOD||"AES-128",uri:e.attributes.URI},void 0!==e.attributes.IV&&(n.iv=e.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else n=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(e.number)?this.manifest.mediaSequence=e.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+e.number})},"discontinuity-sequence":function(){isFinite(e.number)?(this.manifest.discontinuitySequence=e.number,c=e.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+e.number})},"playlist-type":function(){/VOD|EVENT/.test(e.playlistType)?this.manifest.playlistType=e.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+e.playlist})},map:function(){r={},e.uri&&(r.uri=e.uri),e.byterange&&(r.byterange=e.byterange),n&&(r.key=n)},"stream-inf":function(){this.manifest.playlists=i,this.manifest.mediaGroups=this.manifest.mediaGroups||h,e.attributes?(a.attributes||(a.attributes={}),kn(a.attributes,e.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||h,e.attributes&&e.attributes.TYPE&&e.attributes["GROUP-ID"]&&e.attributes.NAME){var r=this.manifest.mediaGroups[e.attributes.TYPE];r[e.attributes["GROUP-ID"]]=r[e.attributes["GROUP-ID"]]||{},t=r[e.attributes["GROUP-ID"]],(p={default:/yes/i.test(e.attributes.DEFAULT)}).default?p.autoselect=!0:p.autoselect=/yes/i.test(e.attributes.AUTOSELECT),e.attributes.LANGUAGE&&(p.language=e.attributes.LANGUAGE),e.attributes.URI&&(p.uri=e.attributes.URI),e.attributes["INSTREAM-ID"]&&(p.instreamId=e.attributes["INSTREAM-ID"]),e.attributes.CHARACTERISTICS&&(p.characteristics=e.attributes.CHARACTERISTICS),e.attributes.FORCED&&(p.forced=/yes/i.test(e.attributes.FORCED)),t[e.attributes.NAME]=p}else this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){c+=1,a.discontinuity=!0,this.manifest.discontinuityStarts.push(i.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=e.dateTimeString,this.manifest.dateTimeObject=e.dateTimeObject),a.dateTimeString=e.dateTimeString,a.dateTimeObject=e.dateTimeObject},targetduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+e.duration}):(this.manifest.targetDuration=e.duration,Un.call(this,this.manifest))},start:function(){e.attributes&&!isNaN(e.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:e.attributes["TIME-OFFSET"],precise:e.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){a.cueOut=e.data},"cue-out-cont":function(){a.cueOutCont=e.data},"cue-in":function(){a.cueIn=e.data},skip:function(){this.manifest.skip=qn(e.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",e.attributes,["SKIPPED-SEGMENTS"])},part:function(){var t=this;o=!0;var r=this.manifest.segments.length,n=qn(e.attributes);a.parts=a.parts||[],a.parts.push(n),n.byterange&&(n.byterange.hasOwnProperty("offset")||(n.byterange.offset=d),d=n.byterange.offset+n.byterange.length);var s=a.parts.length-1;this.warnOnMissingAttributes_("#EXT-X-PART #"+s+" for segment #"+r,e.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((function(e,r){e.hasOwnProperty("lastPart")||t.trigger("warn",{message:"#EXT-X-RENDITION-REPORT #"+r+" lacks required attribute(s): LAST-PART"})}))},"server-control":function(){var t=this.manifest.serverControl=qn(e.attributes);t.hasOwnProperty("canBlockReload")||(t.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),Un.call(this,this.manifest),t.canSkipDateranges&&!t.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint":function(){var t=this.manifest.segments.length,r=qn(e.attributes),n=r.type&&"PART"===r.type;a.preloadHints=a.preloadHints||[],a.preloadHints.push(r),r.byterange&&(r.byterange.hasOwnProperty("offset")||(r.byterange.offset=n?d:0,n&&(d=r.byterange.offset+r.byterange.length)));var s=a.preloadHints.length-1;if(this.warnOnMissingAttributes_("#EXT-X-PRELOAD-HINT #"+s+" for segment #"+t,e.attributes,["TYPE","URI"]),r.type)for(var i=0;i<a.preloadHints.length-1;i++){var o=a.preloadHints[i];o.type&&(o.type===r.type&&this.trigger("warn",{message:"#EXT-X-PRELOAD-HINT #"+s+" for segment #"+t+" has the same TYPE "+r.type+" as preload hint #"+i}))}},"rendition-report":function(){var t=qn(e.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(t);var r=this.manifest.renditionReports.length-1,n=["LAST-MSN","URI"];o&&n.push("LAST-PART"),this.warnOnMissingAttributes_("#EXT-X-RENDITION-REPORT #"+r,e.attributes,n)},"part-inf":function(){this.manifest.partInf=qn(e.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",e.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),Un.call(this,this.manifest)}}[e.tagType]||l).call(s)},uri:function(){a.uri=e.uri,i.push(a),this.manifest.targetDuration&&!("duration"in a)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),a.duration=this.manifest.targetDuration),n&&(a.key=n),a.timeline=c,r&&(a.map=r),d=0,a={}},comment:function(){},custom:function(){e.segment?(a.custom=a.custom||{},a.custom[e.customType]=e.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[e.customType]=e.data)}})[e.type].call(s)})),t}Sn(t,e);var r=t.prototype;return r.warnOnMissingAttributes_=function(e,t,r){var n=[];r.forEach((function(e){t.hasOwnProperty(e)||n.push(e)})),n.length&&this.trigger("warn",{message:e+" lacks required attribute(s): "+n.join(", ")})},r.push=function(e){this.lineStream.push(e)},r.end=function(){this.lineStream.push("\n"),this.trigger("end")},r.addParser=function(e){this.parseStream.addParser(e)},r.addTagMapper=function(e){this.parseStream.addTagMapper(e)},t}(In);class Nn{constructor(){this.manifest=null}parse(e){var t=new Bn;return t.push(e),t.end(),this.manifest=t.manifest,this}getPlaylist(e,t){var r=this.manifest,n=r.playlistType,s=r.mediaSequence,i=r.targetDuration,a=Nn.getFragments(r,e,t);return{playlistType:n?n.toUpperCase():"LIVE",mediaSequence:s,targetDuration:i,endList:s+a.length,fragments:a,level:t,totalDuration:Nn.getVodTotalDuration(r),url:e}}getPlaylists(e){var t=this.manifest.playlists;if(!t)return[];var r=[];return t.forEach(((t,n)=>{r.push({url:(0,C.buildAbsoluteURL)(e,t.uri),curLevel:n})})),r}static getFragments(e,t,r){var n=e.segments,s=e.mediaSequence,i=[],a=s;return n.forEach((e=>{var n=new S;n.baseUrl=t,n.uri=e.uri,n.level=r,n.sn=a,a+=1,i.push(n)})),i}static getVodTotalDuration(e){var t=e.segments,r=0;return t.forEach((e=>{r+=e.duration})),r}}const Fn=Nn;var $n=new class{constructor(){this.hlsp2p=null}init(e){this.hlsp2p=e}destroy(){this.hlsp2p=null}load(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return J(Z().mark((function n(){var s;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=3,t.download(e);case 3:if(s=n.sent){n.next=6;break}return n.abrupt("return",Promise.reject(null));case 6:t.parseManifestText(e,r,s,t.load.bind(t));case 7:case"end":return n.stop()}}),n)})))()}download(e){var t=this;return J(Z().mark((function r(){var n,s;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,n={requestInfo:new Request(e)},t.hlsp2p.trigger(T.BEFORE_M3U8_REQUEST,n),r.next=5,fetch(n.requestInfo);case 5:if(!(s=r.sent).ok){r.next=8;break}return r.abrupt("return",s.text());case 8:r.next=14;break;case 11:r.prev=11,r.t0=r.catch(0);case 14:return r.abrupt("return","");case 15:case"end":return r.stop()}}),r,null,[[0,11]])})))()}parseManifestText(e,t,r,n){var s=new Fn;s.parse(r);var i=s.getPlaylists(e);if(i.length)i.forEach((e=>{var t=e.url,r=e.curLevel;n(t,r)}));else{var a=s.parse(r).getPlaylist(e,t);this.hlsp2p.trigger(R.LEVEL_LOADED,a)}}};const jn=$n;class Hn{constructor(){this._fullUrlToLevel=new Map,this._levelToUrl=new Map}destroy(){this._fullUrlToLevel.clear(),this._levelToUrl.clear()}ready(){return 0!==this._fullUrlToLevel.size}setM3U8(e,t){this._fullUrlToLevel.set(e,t),this._levelToUrl.set(t,e)}getLevel(e){return this._fullUrlToLevel.get(e)}getM3U8(e){return this._levelToUrl.get(e)}}var Gn=new class{constructor(){this.TAG="PlayList",this.hlsp2p=null,this.m3u8UrlList=new Hn}init(e){this.hlsp2p=e,this._reset(),this.LevelLoaded=this.onLevelLoaded.bind(this),this.hlsp2p.on(R.LEVEL_LOADED,this.LevelLoaded)}destroy(){this._reset(),this.m3u8UrlList.destroy(),this.hlsp2p.off(R.LEVEL_LOADED,this.LevelLoaded),this.hlsp2p=null}_reset(){this.levels=[]}findTSInfo(e){for(var t=0;t<this.levels.length;t+=1){var r=this.levels[t];if(!r)return;if(r.fragments){var n=this.findInfo(r.fragments,e);if(void 0!==n)return n}}}findInfo(e,t){return e.find((e=>e.url===t))}hasTS(e,t){var r=this.levels[e];return r&&r.endList>=t&&r.mediaSequence<=t}getTSInfo(e,t){return this.levels[e].fragments.find((e=>e.sn===t))}onLevelLoaded(e){var t=e.playlistType,r=e.mediaSequence,n=e.targetDuration,s=e.endList,i=e.fragments,a=e.level,o=e.totalDuration,l=e.url,h={};h.playlistType=t,h.mediaSequence=r,h.targetDuration=n,h.endList=s,h.fragments=i,D.targetDuration=n,D.totalDuration=o,this.levels[a]=h,this.m3u8UrlList.setM3U8(l,a),this.hlsp2p.trigger(R.FRAGMENT_UPDATED)}};const Vn=Gn;const zn=class{constructor(e,t){this.id=null,this.events={},this.uri=(document.location.protocol,`wss://${e}`),this.options=t,this.reconnect=0,this.timer=null,this.initWebSocket()}initWebSocket(){WebSocket&&(this.reconnect+=1,this._ws=new WebSocket(this.uri),this._ws.onopen=this.onopen.bind(this),this._ws.onmessage=this.onmessage.bind(this),this._ws.onclose=this.onclose.bind(this),this._ws.onerror=this.onerror.bind(this))}get readyState(){return this._ws?this._ws.readyState:4}on(e,t){"connect"!==e&&"message"!==e&&"open"!==e&&"error"!==e||(this.events[e]=t)}emit(e,t){"message"===e&&this._ws&&1===this._ws.readyState&&this._ws.send(`S ${t.to} ${JSON.stringify(t)}`)}disconnect(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.options.reconnection=!1,this._ws.close()}onopen(e){this.reconnect=0,this.events.open()}onmessage(e){var t=e.data.substring(0,1);if("C"===t)this.id=e.data.substring(2),this.events.connect();else if("S"===t){var r=JSON.parse(e.data.substring(29));this.events.message(r)}}onerror(e){this.events.error(e.toString())}onclose(e){this.options.reconnection&&this.options.reconnectionAttempts>this.reconnect&&(this.timer=setTimeout((()=>{this.initWebSocket()}),this.options.reconnectionDelay+1e3*this.reconnect))}};const Wn=class{constructor(e,t){this._socket=new zn(e.signalServer,{reconnection:!0,reconnectionAttempts:10,reconnectionDelay:2e3,randomizationFactor:.5,timeout:2e4,autoConnect:!0}),this.callback=t,this._initListening()}destroy(){this._disconnect(),this._socket=null,this.callback=null}on(e,t){this._socket.on(e,t)}emit(e,t){this._socket.emit(e,t)}_disconnect(){return this._socket.disconnect()}get socketId(){return this._socket.id}get connection(){return this._socket}set connection(e){this._socket=e}get logTime(){var e=new Date;return`${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}.${e.getMilliseconds()}`}_initListening(){var e=this._socket;e.on("connect",(()=>{this.callback&&this.callback({event:"connect"})})),e.on("open",(()=>{this.callback&&this.callback({event:"open"})})),e.on("error",(e=>{this.callback&&this.callback({event:"error",message:e})})),e.on("connect_timeout",(e=>{})),e.on("disconnect",(e=>{})),e.on("reconnect",(e=>{})),e.on("reconnect_attempt",(e=>{})),e.on("reconnecting",(e=>{})),e.on("reconnect_error",(e=>{})),e.on("reconnect_failed",(()=>{})),e.on("ping",(()=>{})),e.on("pong",(e=>{}))}};const Xn=class{constructor(e){this.TAG="SignalClient",this.hlsp2p=e,tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.signalSending=this.onSignalSending.bind(this),this.hlsp2p.on(R.SIGNAL_SENDING,this.signalSending),this.config=l,this._socketIOConnection=new Wn({signalServer:this.config.signalServer},this.onEvents.bind(this)),this._socketIOConnection.on("message",(e=>{this.hlsp2p.trigger(R.SIGNAL_RECEIVING,e)}))}reportCallback(){var e={};return e[lr]=this._socketIOConnection.connection.readyState,e}onSignalSending(e){this.send(e)}destroy(){this._socketIOConnection.destroy(),this.hlsp2p.off(R.SIGNAL_SENDING,this.signalSending),this.hlsp2p=null}onEvents(e){var t=e.event,r=e.message;switch(t){case"connect":X.info("[signal] connect"),this.hlsp2p.pid=this._socketIOConnection.socketId,this.hlsp2p.trigger(R.SIGNAL_READY,{pid:this._socketIOConnection.socketId});break;case"open":X.info("[signal] open");break;case"error":X.error(`[signal] error: ${r}`)}}send(e){this._socketIOConnection.emit("message",e)}};class Kn{constructor(){this.cache=new Set}destroy(){this.clear()}next(){if(!this.cache.size)return null;var e=this.cache.entries().next();return e.done?null:e.value[0]}removeNext(){var e=this.next();return null===e?null:(this.cache.delete(e),e)}clear(){this.cache.clear()}has(e){return this.cache.has(e)}add(e){return this.cache.add(e)}delete(e){return this.cache.delete(e)}get size(){return this.cache.size}}var Yn=new class{constructor(){this.TAG="TrackerController",this.hlsp2p=null,this.peerCache=null,this._timer=null,this._trackerConnected=!1,this._preTrackerId=""}init(e){this.hlsp2p=e,this.onTrackerLoaded=this._onTrackerLoaded.bind(this),this.onTrackerStarting=this._onTrackerStarting.bind(this),this.onRequestTracker=this._onRequestTracker.bind(this),this.hlsp2p.on(R.TRACKER_LOADED,this.onTrackerLoaded),this.hlsp2p.on(R.TRACKER_STARTING,this.onTrackerStarting),this.peerCache=new Kn}destroy(){this.peerCache.destroy(),this.hlsp2p.off(R.TRACKER_STARTING,this.onTrackerStarting),this.hlsp2p.off(R.TRACKER_LOADED,this.onTrackerLoaded),this.hlsp2p=null,this._clearTimer()}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}nextPeer(){return this.peerCache.removeNext()}_onTrackerLoaded(e){for(var t=e.Data,r=e.trackerChannelId;this.peerCache.size>l.maxPeerCache;)this.peerCache.removeNext();this._preTrackerId&&this._preTrackerId!==r&&(this._preTrackerId=r,this.peerCache.clear());try{var n=JSON.parse(t);if(0===n.ret||"0"===n.ret)this._trackerConnected=!0,n.peers.forEach((e=>{var t=e.pid||e;this.hlsp2p.trigger("find_peer",{pid:t}),this.peerCache.has(t)||this.peerCache.add(t)}))}catch(e){}}_onTrackerStarting(){this._timer=setInterval(this.onRequestTracker,l.trackerInterval),this._onRequestTracker()}_onRequestTracker(){this.hlsp2p.trigger(R.TRACKER_LOADING)}get trackerConnected(){return this._trackerConnected}};const Jn=Yn;var Qn=new class{constructor(){this.TAG="TrackerLoader",this.trackerCount=null,this._loaderManager=new $r,this._trackerChannelId=""}init(e){this._loaderManager.init(),this.hlsp2p=e,this.onTrackerLoading=this._onTrackerLoading.bind(this),this.hlsp2p.on(R.TRACKER_LOADING,this.onTrackerLoading),this.trackerCount=0}destroy(){this._loaderManager.destroy(),this.hlsp2p.off(R.TRACKER_LOADING,this.onTrackerLoading),this.hlsp2p=null,this.trackerCount=null}_onTrackerLoading(){var e=`tracker-${this.trackerCount}`,t=I.GetRequestConfig(),r=Math.floor(un.currentTime||0);if(l.channelId&&this.hlsp2p.localPeerId&&("LIVE"!==l.videoType||!un.paused)){if("LIVE"===l.videoType)this._trackerChannelId=`h5_live_hls_${l.cloudAppId}_${l.levelForTracker}_${l.liveTrackerVersion}_${l.liveModel}_${l.channelId}`,t.url=`${l.liveTrackerServer}/htbt?channel=${this._trackerChannelId}&pid=${this.hlsp2p.localPeerId}&mode=bat`;else{var n=es(l,{currentTime:r,localPeerId:this.hlsp2p.localPeerId,channelId:l.channelId});this._trackerChannelId=n.trackerChannelId,t.url=n.url}var s=new K(e,t,this.receiveResp.bind(this));this._loaderManager.add(e,s),s.load()}}receiveResp(e,t,r){t===k.SUCCESS&&this.hlsp2p.trigger(R.TRACKER_LOADED,{trackerChannelId:this._trackerChannelId,Data:r.data}),this._loaderManager.delete(e)}};const Zn=Qn;var es=(e,t)=>{var r=e.cloudAppId,n=e.vodTrackerVersion,s=e.vodTrackerServer,i=t.currentTime,a=t.localPeerId,o=`h5_vod_hls_${r}_${n}_${t.channelId}`;return{trackerChannelId:o,url:`${s}/htbt?channel=${o}&pid=${a}&maxpos=${i}`}};var ts=new class{constructor(){this.TAG="ConfLoader",this.confCount=null,this._confOkTime=0,this._loaderManager=new $r}init(e){this.hlsp2p=e,tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.onConfLoading=this._onConfLoading.bind(this),this.hlsp2p.on(R.CONF_LOADING,this.onConfLoading),this.confCount=0,this._loaderManager.init()}destroy(){this.hlsp2p.off(R.CONF_LOADING,this.onConfLoading),this._loaderManager.destroy(),this.hlsp2p=null,this.confCount=null}reportCallback(){var e={};return this._confOkTime&&(e[ke]=this._confOkTime,this._confOkTime=0),e}_onConfLoading(){var e=`conf-${this.confCount}`,t=I.GetRequestConfig();t.url=`${l.confBaseUrl}${l.channelId}?domain=${l.domain}&timestamp=${parseInt(Date.now(),10)}`;var r=new K(e,t,this.receiveResp.bind(this));this._loaderManager.add(e,r),r.load()}receiveResp(e,t,r){t===k.SUCCESS&&(this._confOkTime=Date.now()-l.loadTime,this.hlsp2p.trigger(R.CONF_LOADED,{Data:r.data})),this._loaderManager.delete(e)}};const rs=ts;class ns{static selectNearestTargetDuration(e,t){for(var r=0,n=0;n<e.length;n++){if(t<=e[n])return r;r+=1}return r}static selectPropValue(e,t){return e.length<t?0:e[t]}}class ss{destroy(){this.hlsp2p&&this.hlsp2p.off(R.LEVEL_LOADED,this.handler),this.hlsp2p=null}init(e){return this.handler||(this.handler=e=>{this._updateConfigByTargetDuration({targetDuration:e.targetDuration})},e.on(R.LEVEL_LOADED,this.handler),this.hlsp2p=e),this}setAutoConfigFields(e,t){this._autoConfigFields=e,this._autoConfigObj=t}_updateConfigByTargetDuration(e){var t=e.targetDuration;if(l.enableAutoConfig){var r=ns.selectNearestTargetDuration(l.targetDurationTemplate,t);r&&this._autoConfigFields.forEach((e=>{var t=ns.selectPropValue(this._autoConfigObj[e],r);t&&(l[e]=t)}))}}}class is{static config(){l.preloadProbability=0,l.liveMaxBuffer=30,l.liveModel="lls"}}class as{static config(){as.updateTrackerVersionWithPublicIP()}static updateTrackerVersionWithPublicIP(){l.publicIP&&l.enableMultiArea&&X.log(`[detect]外网ip?ip=${l.publicIP}`)}static checkDomain(e){return!!e.configured}}class os{static assignDomainConfig(e,t,r,n){var s=os.getConfigByDomain(e,t);s&&os.assignConfig(s,r,n)}static getConfigByDomain(e,t){var r=t.domain_conf;return r?r[e]:null}static assignConfig(e,t,r){r.forEach((r=>{var n=r[0],s=r[1];new Set(Object.keys(e)).has(s)&&(t[n]=e[s])}))}}class ls{constructor(e){this.hlsp2p=e,this._timer=null}destroy(){this._clearTimer(),this.hlsp2p=null}tryToStartOnce(e){if(0!==e&&!this.started){var t=Math.max(e,3e4);this._timer=setInterval((()=>{this._reqConf()}),t)}}get started(){return null!==this._timer}_reqConf(){this.hlsp2p.trigger(R.CONF_LOADING)}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}}const hs=new class{constructor(){this.TAG="ConfController"}init(e){this.hlsp2p=e,this.autoConfig=new ss,this.periodicConf=new ls(e),this.onConfLoaded=this._onConfLoaded.bind(this),this.onConfStarting=this._onConfStarting.bind(this),this.onRequestConf=this._onRequestConf.bind(this),this.hlsp2p.on(R.CONF_LOADED,this.onConfLoaded),this.hlsp2p.on(R.CONF_STARTING,this.onConfStarting)}destroy(){this.periodicConf.destroy(),this.periodicConf=null,this.autoConfig.destroy(),this.autoConfig=null,this.hlsp2p.off(R.CONF_LOADED,this.onConfLoaded),this.hlsp2p.off(R.CONF_STARTING,this.onConfStarting),this.hlsp2p=null}_onConfLoaded(e){var t=[["peerCacheSize","peer_cache_size"],["trackerInterval","tracker_interval"],["signalServer","signal_server"],["liveTrackerServer","live_tracker_server"],["vodTrackerServer","vod_tracker_server"],["liveTrackerVersion","live_tracker_ver"],["vodTrackerVersion","vod_tracker_ver"],["reportServer","report_server"],["stunServer","h5_stun_server"],["PCHeartInterval","pc_heart_interval"],["maxPCConnecting","max_pc_connecting"],["maxPCConnected","max_pc_connected"],["p2pSliceRequestCount","p2p_slice_req_cnt"],["checkBufferInterval","check_buffer_interval"],["minPCConnected","min_pc_connected"],["maxConnectRequestEachPeriod","max_connect_request_each_period"],["checkPeerInterval","check_peer_interval"],["peerConnWaWeight","peer_conn_wa_weight"],["bitmapInterval","bitmap_interval"],["p2pLimit","p2p_limit"],["preloadProbability","preload_probability"],["enableAegis","enable_aegis"],["aegisId","aegis_id"],["bufferCount","buffer_cnt"],["cdnBWRatio","cdn_bw_ratio"],["cdnCostRatio","cdn_cost_ratio"],["liveMaxBuffer","live_max_buffer"],["vodMaxBuffer","vod_max_buffer"],["p2pEstimateExtra","p2p_estimate_extra"],["cloudAppId","app_id"],["configured","configured"],["enableCDNDetailReport","en_cdn_detail_report"],["enableLLS","enable_lls"],["p2pReqTimeout","p2p_req_timeout"],["enableP2pAutoTimeout","enable_p2p_auto_timeout"],["cdnEstimateRatio","cdn_estimate_ratio"],["maxP2PDepth","max_p2p_depth"],["streamP2PChunkLength","stream_p2p_chunk_len"],["maxSubscribeSize","max_subscribe_size"],["syncNodeInterval","sync_node_interval"],["lowBufferThreshold","low_buf_threshold"],["maxP2PRetryTimes","max_p2p_retry_times"],["enableAutoConfig","enable_auto_config"],["llsAutoConfig","lls_auto_config"],["enableRange","enable_range"],["fixPCConflict","fix_pc_conflict"],["enableExtraPCCnt","enable_extra_pc_cnt"],["enableRTLog","enable_rtlog"],["rtLogLevel","rtlog_level"],["publicIP","ip"],["confInterval","conf_interval"],["enableLRS","enable_lrs"],["lrsMaxPCConnected","lrs_max_pc_connected"],["lrsMaxPCConnecting","lrs_max_pc_connecting"],["lrsServeResCnt","lrs_serve_res_cnt"],["enableStoreRes","enable_store_res"],["maxStoreResCnt","max_store_res_cnt"],["enableStoreTinyRes","enable_store_tiny_res"],["enableStoreAllTinyRes","enable_store_all_tiny_res"],["tinyResMaxDuration","tiny_res_max_duration"],["resModBase","res_mod_base"],["newResEvictProWindow","new_res_evict_prow"],["coldResEvictThreshold","cold_res_evict_threshold"],["maxIndexeddbStoreSize","max_indexeddb_store_size"],["maxStorageAvailableRatio","max_storage_available_ratio"],["enableLLSMinCircle","enable_lls_min_circle"],["enableValidateTS","enable_validate_ts"],["metaServerUrl","meta_srv_url"],["maxMetaReqTimes","max_meta_req_times"],["metaRetryDelay","meta_retry_delay"],["enableServiceWorker","enable_service_worker"],["bbsP2PReqTimeout","bbs_p2p_req_timeout"],["bbsP2PMaxRetry","bbs_p2p_max_retry"]];try{var r=Fr.decrypt(e.Data).pconf;if(t.forEach((e=>{var t=e[1],n=e[0];t in r&&(l[n]=r[t])})),r.p2p||r.emit_rollback)return X.warn("[hlsp2p] 配置下发回退命令, 触发 HLSP2P.Events.Rollback 事件"),window.console.warn("[hlsp2p] 配置下发回退命令, 触发 HLSP2P.Events.Rollback 事件"),D.exitReason="config_rollback",void this.hlsp2p.trigger(Zl.Events.Rollback,{reason:D.exitReason});if(l.confInterval&&this.periodicConf.tryToStartOnce(l.confInterval),os.assignDomainConfig(l.cdnDomain,r,l,t),l.enableLocalNetworkShare){if(!as.checkDomain(r))return X.warn("[hlsp2p] 未配置的的域名, 回退"),D.exitReason="unknown_domain",void this.hlsp2p.trigger(Zl.Events.Rollback,{reason:D.exitReason});l.enableLLS=!0,as.config()}l.enableLLS&&is.config(),l.enableAutoConfig&&(this.autoConfig.init(this.hlsp2p),this.autoConfig.setAutoConfigFields(["p2pReqTimeout"],l.llsAutoConfig));var n="LIVE"===l.videoType?l.liveMaxBuffer:l.vodMaxBuffer;D.curPlayerAdapter&&D.curPlayerAdapter.setMaxBufferLength(n),this.hlsp2p.trigger(R.CONF_PARSED)}catch(e){D.exitReason="conf_parse_error",this.hlsp2p.trigger(Zl.Events.Rollback,{reason:D.exitReason})}}_onConfStarting(){this.onRequestConf()}_onRequestConf(){this.hlsp2p.trigger(R.CONF_LOADING)}};var cs=new class{constructor(){this.TAG="P2PPreload"}init(e){this.hlsp2p=e,this.endList=-1,this.hlsp2p.on(R.FRAGMENT_UPDATED,this.preload.bind(this)),tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.initReport()}destroy(){this.hlsp2p=null,this.endList=-1}preload(){if("VOD"!==l.videoType&&!(Math.random()>l.preloadProbability)){var e=D.curReqLevel,t=Vn.levels[e];if(t){var r=t.endList;if(this.endList!==r){var n=Vn.getTSInfo(e,r);if(n){var s={onSuccess:()=>{},onError:()=>{},onTimeout:()=>{}},i={maxRetry:0,maxRetryDelay:64e3,retryDelay:0,timeout:2e4},a={url:"",responseType:"arraybuffer",frag:{sn:void 0,level:void 0}};a.frag.sn=r,a.frag.level=e,a.url=n.url;var o=new E(a,i,s),h=new mn(a,i,s),c=o.id;h.id=c,yn.loadInnerReq(c,o,h),this._reportData[lt]+=1,this.endList=r}}}}}initReport(){this._reportData={[lt]:0}}reportCallback(){var e=this._reportData;return this.initReport(),e}};const us=cs;class ds{constructor(){this._callbacks=new Map}destroy(){this._callbacks.clear()}onRecv(e,t){var r=this._callbacks.get(t.uri);r&&r(e,t)}registerCb(e,t){this._callbacks.set(e,t)}}class ps{destroy(){this.peerManager=null}setPeerManager(e){this.peerManager=e}sendBinary(e,t){var r=this.peerManager.getComPeer(e);r&&r.send(t)}}class fs{constructor(e){this.length=e||0,this.array=[],this.offset=0}push(e){this.array.push(e),this.length+=e.length}shift(e){var t=e;if(this.array.length<1)return new Uint8Array(0);if(this.offset+t===this.array[0].length){var r=this.array[0].slice(this.offset,this.offset+t);return this.offset=0,this.array.shift(),this.length-=t,r}if(this.offset+t<this.array[0].length){var n=this.array[0].slice(this.offset,this.offset+t);return this.offset+=t,this.length-=t,n}for(var s=new Uint8Array(t),i=0;this.array.length>0&&t>0;){if(this.offset+t<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+t);s.set(a,i),this.offset+=t,this.length-=t,t=0;break}var o=this.array[0].length-this.offset;s.set(this.array[0].slice(this.offset,this.array[0].length),i),this.array.shift(),this.offset=0,i+=o,this.length-=o,t-=o}return s}clear(){this.array=[],this.length=0,this.offset=0}shiftBuffer(){this.array.length>0&&(this.length-=this.array[0].length,this.array.shift(),this.offset=0)}toInt(e,t){for(var r=0,n=this.offset+e;n<this.offset+t+e;)n<this.array[0].length?r=256*r+this.array[0][n]:this.array[1]&&(r=256*r+this.array[1][n-this.array[0].length]),n+=1;return r}}class gs{constructor(){this.uri=ee.P2P_RES_CHUNK,this.sn=0,this.level=0,this.seq=0,this.flag=0,this.payload=new Uint8Array(0)}set id(e){var t=sn.fromId(e);this.sn=t.sn,this.level=t.level}get id(){return sn.fromObj({sn:this.sn,level:this.level}).toStringId()}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt16(this.seq),e.pushUInt8(this.flag),e.pushUint8Array(this.payload),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.seq=e.popUInt16(),this.flag=e.popUInt8(),this.payload=e.popUint8Array()}}var vs=1,ms=4;class _s extends(t()){constructor(e){var t=e.id,r=e.chunkLength,n=e.startByteOffset;super(),this.id=t,this._buffer=new fs,this._currentSeq=0,this._targetChunkLength=r,this._startByteOffset=n,this.lastUpdateTime=Date.now(),this._updateSeqByStartByteOffset()}destroy(){super.removeAllListeners(),this._buffer.clear(),this._currentSeq=0,this.lastUpdateTime=0}_updateSeqByStartByteOffset(){this._currentSeq=this._startByteOffset/this._targetChunkLength}write(e){if(0!==e.byteLength)for(this._buffer.push(e),this.lastUpdateTime=Date.now();this._buffer.length>this._targetChunkLength;)this._createNewChunk()}flush(e){e&&this.write(e);for(var t=Math.ceil(this._buffer.length/this._targetChunkLength),r=0;r<t-1;r++)this._createNewChunk();this._createNewChunk(!0),this.emit("complete",{id:this.id})}_createNewChunk(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._buffer.length<this._targetChunkLength&&!e)return null;var t=new gs,r=sn.fromId(this.id);t.sn=r.sn,t.level=r.level,t.seq=this._currentSeq;var n=e?this._buffer.length:this._targetChunkLength;t.payload=this._buffer.shift(n),e&&(t.flag|=ms),0===this._currentSeq&&(t.flag|=vs),this._currentSeq+=1,this.emit("new_chunk",t)}}var ys=1,bs=2;class ws extends(t()){constructor(e){var t=e.id;super(),this.id=t,this.chunks=new Map,this.endFlag=!1,this.endChunkSeq=0,this.totalLength=0,this.lastUpdateTime=Date.now(),this.stats={p2pBytes:0,cdnBytes:0,duplicateBytes:0}}destroy(){this.chunks.clear(),this.lastUpdateTime=0,super.removeAllListeners()}getChunks(){return this.chunks}getRanges(){for(var e={start:0,end:0},t=0;t<this.chunks.size&&this.chunks.has(t);t++)e.end+=this.chunks.get(t).payload.byteLength;return e}getRangeSeq(){for(var e={start:0,end:-1},t=0;t<this.chunks.size&&this.chunks.has(t);t++)e.end=t;return e}addChunk(e,t){this._statChunk(e,t),this.chunks.has(e.seq)||(this.lastUpdateTime=Date.now(),this.chunks.set(e.seq,e),this.totalLength+=e.payload.byteLength,e.flag&ms&&(this.endFlag=!0,this.endChunkSeq=e.seq),this.emit("new_chunk",e,{totalLength:this.totalLength}),this.ifComplete()&&this.emit("complete",{id:this.id}))}_statChunk(e,t){var r=e.payload.byteLength;t===bs&&(this.stats.cdnBytes+=r),this.chunks.has(e.seq)&&(this.stats.duplicateBytes+=r),this.chunks.has(e.seq)||t!==ys||(this.stats.p2pBytes+=r)}ifComplete(){return this.endFlag&&this.chunks.size===this.endChunkSeq+1}almostComplete(e){return e.flag&ms?this.chunks.size===e.seq:this.endFlag?this.chunks.size===this.endChunkSeq:void 0}binary(){if(!this.ifComplete())return null;for(var e=new Uint8Array(this.totalLength),t=0,r=0;r<=this.endChunkSeq;r++){var n=this.chunks.get(r);if(!n)return null;e.set(n.payload,t),t+=n.payload.byteLength}return e}}class Rs extends(t()){constructor(){super(),this.chunkMap=new Map,this.bufMap=new Map,this._createDeleteTimer()}destroy(){this.chunkMap.forEach((e=>{e.destroy()})),this.chunkMap.clear(),this.bufMap.forEach((e=>{e.destroy()})),this.bufMap.clear(),this._clearTimer(),super.removeAllListeners()}getChunkFrag(e){return this.chunkMap.get(e)}getRange(e){return this.chunkMap.has(e)?this.chunkMap.get(e).getRanges():null}getRangeSeq(e){return this.chunkMap.has(e)?this.chunkMap.get(e).getRangeSeq():null}getChunks(e){var t=this.chunkMap.get(e);return t?t.getChunks():null}createNewChunkFrag(e){if(!this.chunkMap.has(e)){var t=new ws({id:e});t.on("new_chunk",this._onNewChunk.bind(this)),t.on("complete",this._onChunkComplete.bind(this)),this.chunkMap.set(e,t)}}addChunk(e,t){var r=`${e.sn}-${e.level}`;this.chunkMap.has(r)||this.createNewChunkFrag(r);var n=this.chunkMap.get(r);n&&n.addChunk(e,t)}deleteChunkFrag(e){var t=this.chunkMap.get(e);t&&(t.destroy(),this.chunkMap.delete(e))}addP2PChunk(e){this.addChunk(e,ys)}addCDNChunk(e){this.addChunk(e,bs)}createBufFrag(e,t){var r=t.startByteOffset;if(!this.bufMap.has(e)){var n=new _s({id:e,chunkLength:l.streamP2PChunkLength,startByteOffset:r});return n.on("new_chunk",this._onNewChunkFromStream.bind(this)),n.on("complete",this._onStreamChunkComplete.bind(this)),this.bufMap.set(e,n),n}}addBuf(e,t){var r=this.bufMap.get(e);r&&r.write(t)}completeBufFrag(e,t){var r=this.bufMap.get(e);r&&r.flush(t)}deleteBufFrag(e){var t=this.bufMap.get(e);t&&(t.destroy(),this.bufMap.delete(e))}delete(e){this.deleteBufFrag(e),this.deleteChunkFrag(e)}_createDeleteTimer(){this._clearTimer(),this._deleteTimer=setInterval(this._deleteOutDate.bind(this),2e3)}_clearTimer(){this._deleteTimer&&(clearInterval(this._deleteTimer),this._deleteTimer=null)}_deleteOutDate(){this.chunkMap.forEach(((e,t)=>{Date.now()-e.lastUpdateTime>12e4&&this.deleteChunkFrag(t)})),this.bufMap.forEach(((e,t)=>{Date.now()-e.lastUpdateTime>12e4&&this.deleteBufFrag(t)}))}_onNewChunk(e,t){this.emit("chunk",e,t)}_onChunkComplete(e){var t=e.id,r=this.chunkMap.get(t);if(r){var n=r.binary();this.emit("complete",{id:t,payload:n,stats:r.stats}),this.deleteChunkFrag(t)}}_onNewChunkFromStream(e){this.addCDNChunk(e)}_onStreamChunkComplete(e){var t=e.id;this.deleteBufFrag(t)}}var Ts={circle:1,levelMismatching:2,tempParent:3,overLoad:4,disableUpload:5,reachMaxDepth:6,tooMuchDiffSn:7,disconnect:8};class Cs{constructor(){this.uri=ee.P2P_RES_ERR,this.sn=0,this.level=0,this.code=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.code),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.code=e.popUInt8()}}class Ss{constructor(){this.uri=ee.P2P_REQ_CHUNK,this.sn=0,this.level=0,this.hop=0,this.url="",this.startSeq=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.hop),e.pushString(this.url),e.pushUInt32(this.startSeq),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.hop=e.popUInt8(),this.url=e.popString(),this.startSeq=e.popUInt32()}}class Is{constructor(){this.uri=ee.P2P_REQ_CANCEL,this.sn=0,this.level=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8()}}class ks{constructor(){this.uri=ee.P2P_REQ_ACCEPT,this.sn=0,this.level=0,this.parents=[]}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.parents.length),this.parents.forEach((t=>{e.pushString(t)})),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8();for(var t=e.popUInt8(),r=0;r<t;r++)this.parents.push(e.popString())}}class Es{constructor(){this.uri=ee.P2P_RES_PARENT,this.sn=0,this.level=0,this.parents=[]}include(e){return this.parents.indexOf(e)>=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.parents.length),this.parents.forEach((t=>{e.pushString(t)})),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8();for(var t=e.popUInt8(),r=0;r<t;r++)this.parents.push(e.popString())}}var Ps=2,xs=1,Ls=0;class As{constructor(){this.uri=ee.NODE_SYNC,this.currentSn=0,this.currentLevel=0,this.load=0,this.rtt=100,this.currentDepth=100,this.progress=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.currentSn),e.pushUInt8(this.currentLevel),e.pushUInt8(this.load),e.pushUInt8(this.currentDepth),e.pushUInt8(this.progress),e.marshall()}unmarshall(e){this.currentSn=e.popUInt32(),this.currentLevel=e.popUInt8(),this.load=e.popUInt8(),this.currentDepth=e.popUInt8(),this.progress=e.popUInt8()}score(){return D.curReqLevel!==this.currentLevel||this.currentSn<D.curReqSn-50?0:l.enableLocalNetworkShare?100/(this.rtt||100)+5/this.currentDepth+this.progress:100/this.rtt/(this.load+1)}}var Ds=1;class Ms{constructor(){this.uri=ee.P2P_UPWARD,this.sn=0,this.level=0,this.action=0,this.ttl=0}clone(){var e=new Ms;return e.sn=this.sn,e.level=this.level,e.action=this.action,e.ttl=this.ttl,e}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.action),e.pushUInt8(this.ttl),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.action=e.popUInt8(),this.ttl=e.popUInt8()}}class Os{constructor(){this.router=null}destroy(){this.router=null}setRouter(e){return this.router=e,this}setSubscriber(e){return this.subscriber=e,this}setPeerManager(e){return this.peerManager=e,this}setSyncWorker(e){return this.syncWorker=e,this}init(){this.router.registerCb(ee.P2P_REQ_CHUNK,this._onChunkRequest.bind(this)),this.router.registerCb(ee.P2P_REQ_CANCEL,this._onCancelRequestChunk.bind(this)),this.router.registerCb(ee.P2P_REQ_ACCEPT,this._onRequestAccept.bind(this)),this.router.registerCb(ee.P2P_RES_CHUNK,this._onResChunk.bind(this)),this.router.registerCb(ee.P2P_RES_ERR,this._onResErr.bind(this)),this.router.registerCb(ee.P2P_RES_PARENT,this._onResParent.bind(this)),this.router.registerCb(ee.NODE_SYNC,this._onNodeSync.bind(this)),this.router.registerCb(ee.P2P_UPWARD,this._onUpward.bind(this))}_onChunkRequest(e,t){var r=new Ss;r.unmarshall(t),this.subscriber.onChunkRequest(e,r)}_onCancelRequestChunk(e,t){var r=new Is;r.unmarshall(t),this.subscriber.onReqCancel(e,r)}_onRequestAccept(e,t){var r=new ks;r.unmarshall(t),this.subscriber.onReqAccept(e,r)}_onResChunk(e,t){var r=new gs;r.unmarshall(t),this.subscriber.onResponseChunk(e,r)}_onResErr(e,t){var r=new Cs;r.unmarshall(t),this.subscriber.onRefused(e,r)}_onResParent(e,t){var r=new Es;r.unmarshall(t),this.subscriber.onResponseParent(e,r)}_onNodeSync(e,t){var r=new As;r.unmarshall(t),this.syncWorker.onRecvNodeInfo(e,r)}_onUpward(e,t){var r=new Ms;r.unmarshall(t),this.subscriber.onUpward(e,r)}}class qs{constructor(){this.pid=""}}var Us=e=>e?[...e.keys()]:[];class Bs extends Map{constructor(e){var t=e.timeout;super(),this.timeout=t,this.deleteTimer=new Map}set(e,t){return this._deleteTimer(e),this._setDeleteTimer(e),super.set(e,t)}delete(e){return this._deleteTimer(e),super.delete(e)}clear(){return this.deleteTimer.forEach(((e,t)=>{this._deleteTimer(t)})),super.clear()}_setDeleteTimer(e){var t=setTimeout((()=>{this.delete(e),this.deleteTimer.delete(e)}),this.timeout);this.deleteTimer.set(e,t)}_deleteTimer(e){var t=this.deleteTimer.get(e);t&&clearTimeout(t),this.deleteTimer.delete(e)}}class Ns{constructor(){this.TAG="LLSSubscriber",this.child=new Bs({timeout:12e4}),this.parent=new Bs({timeout:12e4}),this.myRequest=new Bs({timeout:12e4}),this.backToCDNRequest=new Bs({timeout:12e4}),this.requsetUrl=new Bs({timeout:12e4}),this.subscribeBlackList=new Bs({timeout:12e4}),this.requestStartSeq=new Bs({timeout:12e4}),this.retryTimes=new Bs({timeout:12e4}),this._peerRecvRecord=new Bs({timeout:12e4}),this._peerReqRecord=new Bs({timeout:12e4}),this._firstRecvRecord=new Bs({timeout:12e4}),tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.initReport()}setChunkMgr(e){return this.chunkMgr=e,this}init(e){this.hlsp2p=e,e.on("delete_buffer",(e=>{var t=e.id;this.child.delete(t),this.parent.delete(t),this.myRequest.delete(t),this.backToCDNRequest.delete(t),this.requsetUrl.delete(t),this.subscribeBlackList.delete(t),this.chunkMgr&&this.chunkMgr.delete(t),this.requestStartSeq.delete(t),this.retryTimes.delete(t),this._peerReqRecord.delete(t),this._peerRecvRecord.delete(t),this._firstRecvRecord.delete(t)})),e.on(R.PEER_REMOVED,(e=>{var t=e.pid;this.child.forEach((e=>{e.delete(t)})),this.myRequest.forEach(((e,r)=>{if(e===t){this.myRequest.delete(r);var n=sn.fromId(r),s=this.requsetUrl.get(r);if(s){if(this._reportData[Mt]+=1,this.cancelChunkRequest(r),this._tryToRetryP2PRequest({sn:n.sn,level:n.level},{errCode:Ts.disconnect,pid:e}))return;this._reportData[jt]+=1,this._clearAndRequestCDN({sn:n.sn,level:n.level,url:s})}}}))})),this.chunkMgr.on("chunk",this._sendChunkToChild.bind(this)),this.chunkMgr.on("complete",(e=>{var t=e.id,r=e.payload,n=e.stats;this.child.delete(t),this.parent.delete(t),this.hlsp2p.trigger("chunk_buffer_complete",{id:t,payload:r,stats:n}),this.myRequest.delete(t),this.backToCDNRequest.has(t)||this._resetParent(t)}))}destroy(){this.hlsp2p&&(this.child.clear(),this.parent.clear(),this.myRequest.clear(),this.backToCDNRequest.clear(),this.requsetUrl.clear(),this.subscribeBlackList.clear(),this._firstRecvRecord.clear(),this._peerRecvRecord.clear(),this._peerReqRecord.clear(),this.chunkMgr=null,this.hlsp2p=null)}setTransport(e){return this.transport=e,this}setPeerManager(e){return this.peerManager=e,this}setSyncWorker(e){return this.syncWorker=e,this.syncWorker.collectInfoCb=()=>{var e=new As;return e.currentSn=D.curReqSn,e.currentLevel=D.curReqLevel,e.load=this._childSize(),ln.getSlices(D.curReqSn,D.curReqLevel,0)?e.progress=Ps:this.chunkMgr.getChunks(`${D.curReqSn}-${D.curReqLevel}`)?e.progress=xs:e.progress=Ls,e},this}requestChunk(e){var t=e.sn,r=e.level,n=e.hop,s=e.url,i=((arguments.length>1&&void 0!==arguments[1]?arguments[1]:{retry:!1}).retry,`${t}-${r}`);if(this.requsetUrl.set(i,s),this.myRequest.has(i))return this.myRequest.get(i);var a=this.findParentToRequest(i);if(a){var o=new Ss;o.sn=t,o.level=r,o.hop=n,o.url=s;var l=this.chunkMgr.getRangeSeq(i);l&&(o.startSeq=l.end+1,l.end>0&&(this._reportData[Lt]+=1)),this._send(a,o),this._peerReqRecord.set(`${i}`,performance.now()),this.myRequest.set(i,a),this._reportData[Rt]+=1}return a}addParent(e,t){var r=this.parent.get(e);r||(r=new Set,this.parent.set(e,r)),r.add(t)}updateParents(e,t){this.backToCDNRequest.has(e)||(fn.trace(`[updateParents] ${e} ${t}`),this.parent.set(e,new Set(t)))}findParentToRequest(e){var t=this.child.get(e),r=0,n="";return this.peerManager.getCandidatesPid({id:e}).forEach((s=>{var i=this.peerManager.getConnectedPeer(s);if(t&&t.has(s))this._reportData[Et]+=1;else if(this.subscribeBlackList.has(e)&&this.subscribeBlackList.get(e).has(s))this._reportData[Pt]+=1;else{var a=sn.fromId(e);i.nodeInfo&&i.nodeInfo.currentLevel!==a.level?this._reportData[xt]+=1:(r||(n=s,r=i.score),i.score>r&&(n=s,r=i.score))}})),n}cancelChunkRequest(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.myRequest.get(e);if(t&&"cdn_timeout"===t.reason&&this._statP2PWhenTimeout(e),r){var n=new Is,s=sn.fromId(e);n.sn=s.sn,n.level=s.level,this._send(r,n),this.myRequest.delete(e),this.parent.has(e)&&this.parent.get(e).delete(r)}}onChunkRequest(e,t){var r=`${t.sn}-${t.level}`;if(this.requsetUrl.set(r,t.url),this._childSize()>l.maxSubscribeSize)return this.sendRefuse(e,t,Ts.overLoad),void(this._reportData[Nt]+=1);if(this._alreadyPartialData({sn:t.sn,level:t.level}))this._createChunkProvider(e,t);else{if(!this.levelCheck(t))return this.sendRefuse(e,t,Ts.levelMismatching),void(this._reportData[Bt]+=1);if(t.sn<D.curReqSn-l.bufferCount-1||t.sn>D.curReqSn+5)return this.sendRefuse(e,t,Ts.tooMuchDiffSn),void(this._reportData[$t]+=1);if(this.circleCheck(e,t))return this.sendRefuse(e,t,Ts.circle),void(this._reportData[Ut]+=1);if(parent&&parent.size>=l.maxP2PDepth-1&&!this.backToCDNRequest.has(r)){var n=new Ms;n.sn=t.sn,n.level=t.level,n.ttl=l.maxP2PDepth-1,n.action|=Ds,this._reportData[Kt]+=1,this.sendUpward(n)}this._createChunkProvider(e,t)||(this.acceptChunkRequest(e,t),this.tryToMakeRequest(t))}}acceptChunkRequest(e,t){this.addChild(e,t),this.sendReqAccept(e,{sn:t.sn,level:t.level})}tryToMakeRequest(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{retry:!1}).retry,r=`${e.sn}-${e.level}`;if(this.backToCDNRequest.has(r))return"";if(this.myRequest.has(r))return this.myRequest.get(r);var n=this.requestChunk({sn:e.sn,level:e.level,hop:e.hop+1,url:e.url},{retry:t});return n||(this._reportData[It]+=1,this._clearAndRequestCDN({sn:e.sn,level:e.level,url:e.url})),n}addChild(e,t){var r=t.sn,n=t.level,s=t.hop,i=`${r}-${n}`,a=this.child.get(i);a||(a=new Map,this.child.set(i,a));var o=new qs;o.hop=s,o.pid=e,a.set(e,o)}sendUpward(e){var t=this._getParent(e);t&&this._send(t,e)}_getParent(e){var t=e.sn,r=e.level;return this.myRequest.get(`${t}-${r}`)||""}sendRefuse(e,t,r){var n=t.sn,s=t.level,i=new Cs;i.sn=n,i.level=s,i.code=r,this._send(e,i)}sendReqAccept(e,t){var r=t.sn,n=t.level,s=new ks;s.sn=r,s.level=n;var i=Us(this.parent.get(sn.fromObj({sn:r,level:n}).toStringId()));i.push(this.peerManager.localPid()),this._reportData[tr]+=1,s.parents=i,this._send(e,s)}circleCheck(e,t){var r=t.sn,n=t.level,s=this.parent.get(`${r}-${n}`);return!!s&&s.has(e)}levelCheck(e){return e.level===D.curReqLevel}depthCheck(e){return e<=l.maxP2PDepth}onUpward(e,t){var r=`${t.sn}-${t.level}`;if(t.action&Ds){if(0===t.ttl){var n=this.requsetUrl.get(r);return this._reportData[zt]+=1,void this._clearAndRequestCDN({sn:t.sn,level:t.level,url:n})}var s=t.clone();s.ttl=t.ttl-1,this.sendUpward(s)}}onReqCancel(e,t){var r=this.child.get(`${t.sn}-${t.level}`);r&&r.delete(e)}onReqAccept(e,t){var r=`${t.sn}-${t.level}`;this.hlsp2p.trigger("subscribe_report",{seq:r,target:e}),this._reportData[Ct]+=1,this.updateParents(r,t.parents);var n=Us(this.child.get(r));this._reportData[nr]+=1,this._sendAllParentToChild(n,{sn:t.sn,level:t.level})}onRefused(e,t){var r=`${t.sn}-${t.level}`;this.myRequest.get(r)===e&&this.myRequest.delete(r),this._reportData[St]+=1,this._reportData[qt]+=1,this.cancelChunkRequest(r),this._tryToRetryP2PRequest({sn:t.sn,level:t.level},{errCode:t.code,pid:e})||(this._reportData[Vt]+=1,this._clearAndRequestCDN({sn:t.sn,level:t.level,url:this.requsetUrl.get(r)}))}_addSubscribeBlackList(e,t){var r=this.subscribeBlackList.get(e);r||(r=new Set,this.subscribeBlackList.set(e,r)),r.add(t)}_tryToRetryP2PRequest(e,t){var r=e.sn,n=e.level,s=t.errCode,i=t.pid,a=`${r}-${n}`;if(this.myRequest.delete(a),this._addSubscribeBlackList(a,i),this._allowRetry(a,s)){var o=this.retryTimes.get(a)||0;this.retryTimes.set(a,o+1);var l=this.tryToMakeRequest({sn:r,level:n,hop:0,url:this.requsetUrl.get(a)},{retry:!0});return l?this._reportData[At]+=1:this._reportData[Dt]+=1,l}return""}_allowRetry(e,t){var r=this.retryTimes.get(e)||0,n=-1!==[Ts.circle,Ts.levelMismatching,Ts.overLoad,Ts.reachMaxDepth,Ts.disconnect,Ts.tooMuchDiffSn].indexOf(t);return r<l.maxP2PRetryTimes&&n}onResponseParent(e,t){var r=`${t.sn}-${t.level}`,n=this.myRequest.get(r);if(e===n&&!this.backToCDNRequest.has(r)){fn.trace(`[onResponseParent] id:${r} parent层数: ${t.parents.length} parent: ${t.parents}  currentParent: ${n}, from: ${e}`);var s=Us(this.child.get(r)),i=Us(this.parent.get(r)),a=!1;if(t.include(this.peerManager.localPid()))if(l.enableLLSMinCircle)Array.from(t.parents).sort()[0]===this.peerManager.localPid()&&(a=!0);else a=!0;if(a){if(!this.depthCheck(t.parents.length))return this._reportData[Ht]+=1,void this._clearAndRequestCDN({sn:t.sn,level:t.level,url:this.requsetUrl.get(r)});if(this._reportData[Ot]+=1,this.cancelChunkRequest(r),this._tryToRetryP2PRequest({sn:t.sn,level:t.level},{pid:n,errCode:Ts.circle}))return;return this._reportData[Ht]+=1,void this._clearAndRequestCDN({sn:t.sn,level:t.level,url:this.requsetUrl.get(r)})}i.toString()!==t.parents.toString()&&(this.updateParents(r,t.parents),this._reportData[sr]+=1,this._sendAllParentToChild(s,t))}}_resetParent(e){this._clearParent(e);var t=Us(this.child.get(e));this._reportData[ir]+=1,this._sendAllParentToChild(t,sn.fromId(e))}_clearParent(e){var t=this.parent.get(e);t&&t.clear()}_deleteChild(e,t){var r=t.sn,n=t.level,s=this.child.get(`${r}-${n}`);s&&s.delete(e)}onResponseChunk(e,t){var r=`${t.sn}-${t.level}`;if(this._reportData[Fe]+=t.payload.byteLength,!this._firstRecvRecord.has(r)&&this._peerReqRecord.has(r)){this._firstRecvRecord.set(r,performance.now());var n=performance.now()-this._peerReqRecord.get(r);this._recordP2PFirstDepth(r),this._recordP2PFirstCost(n)}var s=this.chunkMgr.getChunkFrag(r);if(s&&s.almostComplete(t)){var i=Math.floor(performance.now()-this._firstRecvRecord.get(r)),a=Math.floor(performance.now()-this._peerReqRecord.get(r));this._recordP2PCost(i,a)}this._peerRecvRecord.set(r,!0),this.chunkMgr.addP2PChunk(t)}_alreadyPartialData(e){var t=e.sn,r=e.level,n=`${t}-${r}`;return ln.getSlices(t,r,0)?1:this.chunkMgr.getChunks(n)?2:0}_createChunkProvider(e,t){var r=t.sn,n=t.level,s=t.startSeq,i=`${r}-${n}`,a=this.requestStartSeq.get(i);a||(a=new Map,this.requestStartSeq.set(i,a)),a.set(e,s);var o=ln.getSlices(r,n,0);if(o){this.addChild(e,{sn:r,level:n,hop:0}),this._clearParent(i),this.sendReqAccept(e,{sn:r,level:n});var h=o.arrayBufferData,c=new _s({id:`${r}-${n}`,chunkLength:l.streamP2PChunkLength,startByteOffset:0});return c.on("new_chunk",(t=>{this._necessaryChunk(e,t)&&(t.flag&vs||t.flag,this._send(e,t))})),c.flush(new Uint8Array(h)),this.child.has(i)&&this.child.get(i).delete(e),1}var u=this.chunkMgr.getChunks(i);return u?(this.addChild(e,{sn:r,level:n,hop:0}),this.sendReqAccept(e,{sn:r,level:n}),u.forEach((t=>{this._necessaryChunk(e,t)&&this._send(e,t)})),2):0}_necessaryChunk(e,t){var r=`${t.sn}-${t.level}`,n=this.requestStartSeq.get(r),s=0;return n&&n.has(e)&&(s=n.get(e)),t.seq>=s}_sendAllParentToChild(e,t){var r=t.sn,n=t.level,s=`${r}-${n}`,i=new Es;i.sn=r,i.level=n,i.parents=Us(this.parent.get(s)),i.parents.push(this.peerManager.localPid()),this._reportData[tr]+=1,e.forEach((e=>{this._send(e,i)}))}_sendChunkToChild(e,t){var r=`${e.sn}-${e.level}`;this.hlsp2p.trigger("chunk_stat",r,t);var n=this.child.get(r);if(n){var s=e.marshall();n.forEach(((t,r)=>{this._necessaryChunk(r,e)&&(this._sendBinary(r,s),e.flag&vs||e.flag)}))}}_clearAndRequestCDN(e){var t=e.sn,r=e.level,n=e.url,s=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{resetParent:!0}).resetParent,i=`${t}-${r}`;this.cancelChunkRequest(i),s&&this._resetParent(i),this.backToCDNRequest.has(i)||(this.backToCDNRequest.set(i,i),this._reportData[Wt]+=1,this.hlsp2p.trigger("imt_load_cdn",{sn:t,level:r,url:n}))}_send(e,t){this.transport&&(t.uri===ee.P2P_RES_CHUNK&&(this._reportData[Ne]+=t.payload.byteLength),this.transport.sendBinary(e,t.marshall()))}_sendBinary(e,t){this.transport&&(this._reportData[Ne]+=t.byteLength,this.transport.sendBinary(e,t))}_childSize(){var e=0;return this.child.forEach((t=>{e+=t.size})),e}_recordP2PFirstCost(e){this._reportData[Ze].length>10||this._reportData[Ze].push(Math.floor(e))}_recordP2PFirstDepth(e){var t=this.parent.get(e);t&&this._reportData[rt].length<20&&this._reportData[rt].push(t.size)}_recordP2PCost(e,t){this._reportData[et].length>10||(this._reportData[et].push(e),this._reportData[tt].push(t))}_statP2PWhenTimeout(e){var t=this.parent.get(e);t&&this._reportData[nt].length<20&&this._reportData[nt].push(t.size),this._firstRecvRecord.has(e)||(this._reportData[st]+=1),this._reportData[it]+=1}initReport(){this._reportData={[wt]:0,[bt]:0,[Ct]:0,[St]:0,[Ut]:0,[Bt]:0,[Nt]:0,[Ft]:0,[$t]:0,[Et]:0,[Pt]:0,[xt]:0,[Fe]:0,[Ne]:0,[jt]:0,[Ht]:0,[Gt]:0,[Vt]:0,[It]:0,[Wt]:0,[zt]:0,[Kt]:0,[tr]:0,[rr]:0,[nr]:0,[sr]:0,[ir]:0,[Rt]:0,[Lt]:0,[At]:0,[Dt]:0,[qt]:0,[Ot]:0,[Mt]:0,[Ze]:[],[et]:[],[tt]:[],[rt]:[],[st]:0,[it]:0,[nt]:[]}}reportCallback(){var e=this._reportData;return this.initReport(),e[wt]=this._childSize(),this.myRequest.forEach((()=>{e[bt]+=1})),e}}class Fs{constructor(){this.collectInfoCb=null}setPeerManager(e){return this.peerManager=e,this}setTransport(e){return this.transport=e,this}destroy(){this._clearTimer(),this.peerManager=null,this.transport=null,this.collectInfoCb=null}init(){this._syncNodeTimer=setInterval(this._syncNodeInfo.bind(this),l.syncNodeInterval)}onRecvNodeInfo(e,t){var r=this.peerManager.getConnectedPeer(e);r&&(t.rtt=r.rtt,r.nodeInfo=t)}_syncNodeInfo(){if(this.collectInfoCb){var e=this.collectInfoCb().marshall();this.peerManager.getConnectedPeers().forEach(((t,r)=>{this.transport.sendBinary(r,e)}))}}_clearTimer(){this._syncNodeTimer&&(clearInterval(this._syncNodeTimer),this._syncNodeTimer=null)}}class $s{constructor(){this.chunkMgr=new Rs,this.llsServer=new Os,this.subscriber=new Ns,this.syncWorker=new Fs}setRouter(e){return this.router=e,this}setTransport(e){return this.transport=e,this}setPeerManager(e){return this.peerManager=e,this}init(e){this.hlsp2p=e,this.syncWorker.setTransport(this.transport).setPeerManager(this.peerManager).init(),this.subscriber.setChunkMgr(this.chunkMgr).setTransport(this.transport).setPeerManager(this.peerManager).setSyncWorker(this.syncWorker).init(e),this.llsServer.setSubscriber(this.subscriber).setRouter(this.router).setPeerManager(this.peerManager).setSyncWorker(this.syncWorker).init()}destroy(){this.chunkMgr.destroy(),this.subscriber.destroy(),this.llsServer.destroy(),this.syncWorker.destroy(),this.router=null,this.peerManager=null,this.transport=null,this.hlsp2p=null}}var js="offer",Hs="answer",Gs="iceCandidate",Vs="justStart",zs="connReject",Ws="open",Xs="close",Ks="error",Ys="bufferAmountLow",Js="report";const Qs=class{constructor(e,t,r){this.TAG=`DataChannel_${t.label}`,this.callbacks=r,this.config=t,this.dataChannel=e.createDataChannel(t.label,t),this.dataChannel.binaryType="arraybuffer",this._bindHandler(),this._bufferedAmountLimit=t.bufferedAmountLimit}destroy(){this._removeHandler(),this.dataChannel.close(),this.dataChannel=null,this.callbacks=null}_bindHandler(){var e=this.dataChannel;e.onopen=this.onOpen.bind(this),e.onerror=this.onError.bind(this),e.onclose=this.onClose.bind(this),e.onmessage=this.onMessage.bind(this),e.onbufferedamountlow&&(e.onbufferedamountlow=this.onBufferedAmountLow.bind(this))}_removeHandler(){var e=this.dataChannel;e.onopen=null,e.onerror=null,e.onclose=null,e.onmessage=null,e.onbufferedamountlow=null}send(e){var t=this.dataChannel;t&&"open"===t.readyState&&t.bufferedAmount<=this._bufferedAmountLimit&&t.send(e)}onMessage(e){this.callbacks&&this.callbacks.onDataChannelMessage(e.data)}onOpen(){this.callbacks&&this.callbacks.onDataChannelStateChange({state:Ws})}onClose(){this.callbacks&&this.callbacks.onDataChannelStateChange({state:Xs})}onError(e){var t=e.error;fn.error(`${this.TAG}, Data channel error, id:${this.id} ${t.message}`),this.callbacks&&this.callbacks.onDataChannelStateChange({state:Ks})}onBufferedAmountLow(){this.callbacks.onDataChannelStateChange({state:Ys})}get readyState(){return this.dataChannel.readyState}get bufferedAmount(){return this.dataChannel.bufferedAmount}get label(){return this.dataChannel.label}get id(){return this.dataChannel.id}get bufferedAmountLowThreshold(){return this.dataChannel.bufferedAmountLowThreshold}};const Zs=class{constructor(e,t,r){var n=e.id;this.TAG=`WebRTCPeerConnection_${n}`,this.localId=t.localId,this.remoteId=t.remoteId,this.id=n,this.callbacks=r,this._rtcPeerConnection=new RTCPeerConnection(t.ice),this._bindHandler();var s={label:`${this.remoteId}_${this.id}`,id:0,negotiated:!0,bufferedAmountLimit:t.bufferedAmountLimit},i={onDataChannelMessage:this.onDataChannelMessage.bind(this),onDataChannelStateChange:this.onDataChannelStateChange.bind(this)};this._dataChannel=new Qs(this._rtcPeerConnection,s,i)}destroy(){this._dataChannel.destroy(),this._dataChannel=null,this._rtcPeerConnection.close(),this._rtcPeerConnection=null,this.callbacks=null}send(e){this._dataChannel.send(e)}_bindHandler(){this._rtcPeerConnection.onicecandidate=this.onIceCandidate.bind(this),this._rtcPeerConnection.oniceconnectionstatechange=this.onIceConnectionStateChange.bind(this),this._rtcPeerConnection.onsignalingstatechange=this.onSignalingStateChange.bind(this)}receiveSignal(e){switch(e.type){case Vs:this._createOffer();break;case js:this._receiveOffer(e.msg);break;case Hs:this._receiveAnswer(e.msg);break;case Gs:this._receiveCandidate(e.msg)}}onIceCandidate(e){if(this.callbacks){if(!e||!e.candidate)return;this.callbacks.onSendBySignalChannel({type:Gs,msg:e.candidate,id:this.id})}}onIceConnectionStateChange(e){this.callbacks&&this.callbacks.onStateChange({context:"peerConnection",type:"IceConnectionState",state:e.target.iceConnectionState})}onSignalingStateChange(){this.callbacks&&this.callbacks.onStateChange({context:"peerConnection",type:"SignalingState",state:this._rtcPeerConnection.signalingState})}onDataChannelMessage(e){this.callbacks&&this.callbacks.onMessage(e)}onDataChannelStateChange(e){this.callbacks&&this.callbacks.onStateChange({context:"dataChannel",type:"State",state:e.state,originData:e})}_receiveOffer(e){this._receiveDescription(e,(()=>{this._createAnswer()}))}_receiveAnswer(e){this._receiveDescription(e)}_receiveCandidate(e){var t;try{t=new RTCIceCandidate(e)}catch(e){return}this._rtcPeerConnection.addIceCandidate(t).then((()=>{})).catch((e=>{}))}_createAnswer(){this._rtcPeerConnection.createAnswer().then((e=>this._rtcPeerConnection.setLocalDescription(e))).then((()=>{this.callbacks&&this.callbacks.onSendBySignalChannel({type:Hs,msg:this._rtcPeerConnection.localDescription,id:this.id})})).catch((e=>{}))}_receiveDescription(e,t){this._rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(e)).then((e=>{t&&t()})).catch((e=>{t&&t()}))}_createOffer(){this._rtcPeerConnection.createOffer().then((e=>this._rtcPeerConnection.setLocalDescription(e))).then((()=>{this.callbacks&&this.callbacks.onSendBySignalChannel({type:js,msg:this._rtcPeerConnection.localDescription,streamId:this._dataChannel.id,id:this.id})})).catch((e=>{}))}get iceGatheringState(){return this._rtcPeerConnection.iceGatheringState}get open(){return"open"===this._dataChannel.readyState}};var ei="fail",ti="open",ri="ice",ni="report",si="INIT_TIMEOUT",ii="HEART_TIMEOUT",ai="DC_CLOSED",oi="DC_ERROR";const li=class{constructor(){this.uri=ee.PING,this.time=0,this.sendBytes=0,this.receiveBytes=0}init(e){this.time=e.time,this.sendBytes=e.sendBytes,this.receiveBytes=e.receiveBytes}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.time),e.pushUInt32(this.sendBytes),e.pushUInt32(this.receiveBytes),e.marshall()}unmarshall(e){this.time=e.popUInt32(),this.sendBytes=e.popUInt32(),this.receiveBytes=e.popUInt32()}};const hi=class{constructor(e,t,r){this.alpha=e,this._sendBytesAvg=t,this._receiveBytesAvg=r}sendBytesAvg(e){this._sendBytesAvg=e*(1-this.alpha)+this.alpha*this._sendBytesAvg}receiveBytesAvg(e){this._receiveBytesAvg=e*(1-this.alpha)+this.alpha*this._receiveBytesAvg}getSendBytesAvg(){return this._sendBytesAvg}getReceiveBytesAvg(){return this._receiveBytesAvg}getBytesAvg(){return(this._receiveBytesAvg+this._sendBytesAvg)/2}};const ci=class{constructor(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.view=e,this.pos=0,this.len=0,this.uri=0,this.resCode=0,!0===t&&(this.len=this.popUInt32(),this.uri=this.popUInt32(),this.resCode=this.popUInt16())}bytesAvailable(){return this.view.byteLength-this.pos}popBool(){return 1===this.popUInt8()}popUInt8(){if(this.pos+1>this.view.byteLength)return 0;var e=this.view.getUint8(this.pos);return this.pos+=1,e}popUInt16(){if(this.pos+2>this.view.byteLength)return 0;var e=this.view.getUint16(this.pos,!0);return this.pos+=2,e}popUInt32(){if(this.pos+4>this.view.byteLength)return 0;var e=this.view.getUint32(this.pos,!0);return this.pos+=4,e}popUInt64(){if(this.pos+8>this.view.byteLength)return 0;var e=this.view.getUint32(this.pos,!0);this.pos+=4;var t=this.view.getUint32(this.pos,!0);return this.pos+=4,4294967296*t+e}popUint8Array(){var e=this.popUInt16();if(this.pos+e>this.view.byteLength)return null;var t=new Uint8Array(this.view.buffer,this.pos,e);return this.pos+=e,t.slice()}popUint8Array32(){var e=this.popUInt32();if(this.pos+e>this.view.byteLength)return null;var t=new Uint8Array(this.view.buffer,this.pos,e);return this.pos+=e,t.slice()}popUInt32Vector(){var e=this.popUInt32();if(this.pos+4*e>this.view.byteLength)return null;for(var t=[],r=0;r<e;r+=1)t.push(this.popUInt32());return t}popUInt16Vector(){var e=this.popUInt32();if(this.pos+2*e>this.view.byteLength)return null;for(var t=[],r=0;r<e;r+=1)t.push(this.popUInt16());return t}popString(){var e=this.popUInt16();if(this.pos+e>this.view.byteLength)return null;for(var t=[],r=0;r<e;r+=1)t[r]=String.fromCharCode(this.popUInt8());return t.join("")}};const ui=class{constructor(){this.uri=ee.PONG,this.time=0}init(e){this.time=e.time}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.time),e.marshall()}unmarshall(e){this.time=e.popUInt32()}};const di=class{constructor(e,t){this.TAG="PeerConnection",this.passtive=null,this.localId=e.localId,this.remoteId=e.remoteId,this.callbacks=t,this._receiveBytes=0,this._sendBytes=0,this.nodeInfo=null,this.rtt=100,this._wa=new hi(l.peerConnWaWeight,l.peerConnWaInitSendBytes,l.peerConnWaInitReceiveBytes),this._initConnTimer=setTimeout(this._checkInitConnected.bind(this),l.initConnTimeout),this.pcGroup=this.createPC(),this.sendIndex=0,this.totalPCNum=this.pcGroup.length}createPC(){var e=[],t={localId:this.localId,remoteId:this.remoteId,ice:{iceServers:[]},bufferedAmountLimit:l.bufferedAmountLimit};l.stunServer&&t.ice.iceServers.push({urls:`stun:${l.stunServer}`});var r=new Zs({id:0},t,{onMessage:this.onMessage.bind(this),onStateChange:this.onStateChange.bind(this),onSendBySignalChannel:this.onSendBySignalChannel.bind(this)});if(e.push(r),l.enableExtraPCCnt)for(var n=0;n<l.enableExtraPCCnt;n++){var s=new Zs({id:n+1},t,{onMessage:this.onMessage.bind(this),onStateChange:()=>{},onSendBySignalChannel:this.onSendBySignalChannel.bind(this)});e.push(s)}return e}destroy(){this._clearTimer(),this._clearInitConnTimer(),this.pcGroup.forEach((e=>{e.destroy()})),this.pcGroup=[],this.passtive=null,this._wa=null,this.router=null,this.nodeInfo=null}get score(){return this.nodeInfo?this.nodeInfo.score():this._wa?this._wa.getBytesAvg():0}get numOfOpeningPC(){return this.pcGroup.filter((e=>e.open)).length}setStats(e){this.p2pStats=e}setRouter(e){this.router=e}onStateChange(e){var t=e.context;if("peerConnection"===t){var r=e.type;"IceConnectionState"===r&&this.callbacks.onPeerConnectionState({type:ri,state:e.state})}else if("dataChannel"===t){switch(e.state){case Js:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ni,reason:"report",originData:e.originData});break;case Xs:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ei,reason:ai});break;case Ks:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ei,reason:oi});break;case Ws:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ti,reason:"dataChannelOpen"}),this._clearInitConnTimer(),this._sendHeart(),this._startHeart()}}}receiveSignal(e){var t=e.type,r=e.pcId,n=this.pcGroup[r];switch(t){case Hs:n.receiveSignal({type:Hs,msg:e.payload});break;case js:this.passtive=!0,n.receiveSignal({type:js,msg:e.payload});break;case Gs:n.receiveSignal({type:Gs,msg:e.payload});break;default:this.passtive=!1,this.pcGroup.forEach((e=>{e.receiveSignal({type:Vs})}))}}onSendBySignalChannel(e){var t;switch(e.type){case js:t={from:this.localId,to:this.remoteId,type:js,payload:e.msg,pcId:e.id},this._sendBySignaling(t);break;case Gs:t={from:this.localId,to:this.remoteId,type:Gs,payload:e.msg,pcId:e.id},this._sendBySignaling(t);break;case Hs:t={from:this.localId,to:this.remoteId,type:Hs,payload:e.msg,pcId:e.id},this._sendBySignaling(t)}}_sendBySignaling(e){this.callbacks.onSignaling(e)}_sendHeart(){var e=new li;this._lastPingTime=Math.floor(performance.now()),e.init({time:this._lastPingTime,receiveBytes:this._receiveBytes,sendBytes:this._sendBytes}),this.send(e.marshall())}_startHeart(){this._heartTimer&&(clearInterval(this._heartTimer),this._heartTimer=null),this._lastSyncTime=Vr.timestamp(),this.sendHeart=this._sendHeart.bind(this),this._heartTimer=setInterval(this.sendHeart,l.PCHeartInterval),this._checkAliveTimer=setInterval(this._checkAlive.bind(this),l.PCCheckAliveInterval)}_clearTimer(){this._heartTimer&&(clearInterval(this._heartTimer),this._heartTimer=null),this._checkAliveTimer&&(clearInterval(this._checkAliveTimer),this._checkAliveTimer=null)}onMessage(e){var t=new DataView(e),r=new ci(t);switch(r.uri){case ee.PING:this._onPing(r);break;case ee.PONG:this._onPong(r);break;case ee.SLICE:this._receiveBytes+=r.len;break;default:this.router.onRecv(this.remoteId,r)}}_onPing(e){var t=new li;t.unmarshall(e),this._lastSyncTime=Vr.timestamp(),this._wa.sendBytesAvg(t.receiveBytes),this._wa.receiveBytesAvg(this._receiveBytes),this._receiveBytes=0,this._sendPong(t.time)}_sendPong(e){var t=new ui;t.time=e,this.send(t.marshall())}_onPong(e){var t=new ui;t.unmarshall(e),this._lastPingTime===t.time&&(this.rtt=Math.floor(performance.now()-t.time))}send(e){if(this.p2pStats&&this.p2pStats.addUploadBytes(e.byteLength),e[4]===ee.P2P_RES_CHUNK){var t=this.sendIndex%this.totalPCNum;this.sendIndex+=1;var r=this.pcGroup[t];r.open||(r=this.pcGroup[0]),r.send(e),this.sendIndex>1e7&&(this.sendIndex=0)}else this.pcGroup[0].send(e)}_checkAlive(){Vr.timestamp()-this._lastSyncTime>l.PCHeartTimeout&&this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ei,reason:ii})}_checkInitConnected(){this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ei,reason:si})}_clearInitConnTimer(){this._initConnTimer&&(clearTimeout(this._initConnTimer),this._initConnTimer=null)}};class pi extends e.EventEmitter{static createPeerManagerSignalId(e){return`${R.SIGNAL_DISPATCHING}_${e}`}constructor(e){super(),this.TAG="PeerManager",this.hlsp2p=e,this.resId="default"}localPid(){return this.hlsp2p.localPeerId}init(){return tn.registerModule(this.TAG,this.reportCallback.bind(this)),this._connecting=new Map,this._connected=new Map,this.checkPeers=this._checkPeers.bind(this),this._checkPeerTimer=setInterval(this.checkPeers,l.checkPeerInterval),this._initConnect=!0,this.hlsp2p.on(pi.createPeerManagerSignalId(this.resId),this.receiveSignal.bind(this)),this.initReportData(),this}destroy(){super.removeAllListeners(),this._connecting.forEach((e=>{e.destroy()})),this._connecting.clear(),this._connecting=null,this._connected.forEach((e=>{e.destroy()})),this._connected.clear(),this._connected=null,this._clearTimer(),this.hlsp2p=null,this.router=null,this.transport=null}setResId(e){return this.resId=e,this}getResId(){return this.resId}setRouter(e){return this.router=e,this}setTransport(e){return this.transport=e,this}setP2PStats(e){return this.p2pStats=e,this}get peerConnected(){return this._connected.size}getConnectedPeers(){return this._connected}getConnectedPeer(e){return this._connected.get(e)}getCandidatesPid(e){e.id;return[...this._connected.keys()]}getComPeer(e){return this._connected.get(e)}_clearTimer(){this._checkPeerTimer&&(clearInterval(this._checkPeerTimer),this._checkPeerTimer=null)}sendSignaling(e){this._beforeSendingSignal(e),this._trigger(R.SIGNAL_SENDING,e)}_beforeSendingSignal(e){e.resId=this.getResId()}receiveSignal(e){var t=e.type,r=e.from,n=e.to;if(t===zs)return this._reportData[fe]+=1,void(this._reportData[ge]+=1);if(t===js&&this._connecting.has(r)&&l.fixPCConflict){if(n>r)return void(this._reportData[Re]+=1);var s=this._connecting.get(r);this._connecting.delete(r),s.destroy(),this._reportData[Te]+=1,this.createPeerConnection({localId:n,remoteId:r})}if(t===js&&!this._checkPCExist(r)){if(!this.canConnect(e))return X.log(`[p2p] [receiveSignal] [reject] ${r}`),void this.sendSignaling({from:e.to,to:e.from,pcId:e.pcId,type:zs,payload:""});this.createPeerConnection({localId:n,remoteId:r})}var i=this._connecting.get(r);i&&(this._signalReceived(e),i.receiveSignal(e))}_signalReceived(e){}createPeerConnection(e){this._reportData[ce]+=1,this._reportData[ue]+=1;var t,r={onPeerConnectionMessage:this.onReceiveData.bind(this),onPeerConnectionState:this.onPeerConnectionState.bind(this),onSignaling:this.sendSignaling.bind(this)},n=e.localId,s=e.remoteId;try{t=new di({localId:n,remoteId:s},r),X.log(`[detect][createPeerConnection]?pid=${s}`),this._preparePC(t)}catch(e){X.error(` create PeerConnection Error for the reason ${e.reason}`)}return this._connecting.set(s,t),t}_preparePC(e){e.setStats(this.p2pStats),this.router&&e.setRouter(this.router)}canConnect(e){return this._connected.size<l.maxPCConnected&&this._connecting.size<l.maxPCConnecting}_PCConnected(e){this._reportData[de]+=1,this._reportData[pe]+=1;var t=this._getReadyPCFromCache(e);X.log(`[detect][p2p][peerConnected]?pid=${e}`),t&&(this._connected.set(e,t),this._trigger(R.PEER_CONNECTED,{pid:e}))}_getReadyPCFromCache(e){var t=this._connecting.get(e);return this._connecting.delete(e),t}_handlePCFail(e){switch(this._deletePC(e.remoteId),e.reason){case si:this._reportData[be]+=1,X.log(`[detect][connInitTimeout]?pid=${e.remoteId}`);break;case ai:this._reportData[ye]+=1;break;case oi:this._reportData[me]+=1;break;case ii:this._reportData[we]+=1}}_deletePC(e){var t=this._connected.get(e);t&&(t.destroy(),this._connected.delete(e)),(t=this._connecting.get(e))&&(t.destroy(),this._connecting.delete(e)),this._trigger(R.PEER_REMOVED,{pid:e})}onReceiveData(){throw Error("需要實現")}onPeerConnectionState(e){switch(e.type){case ei:this._handlePCFail(e);break;case ti:this._PCConnected(e.remoteId)}}_checkPCExist(e){return this._connecting.has(e)||this._connected.has(e)}keepEnoughPeers(){var e=0,t=this.hlsp2p.localPeerId;if(!this.canConnect())return!0;this._initConnect&&(this._initConnect=!1);for(var r=this._initConnect?l.maxPCConnected:l.maxConnectRequestEachPeriod;e<r;){var n=this._getNextPeerForConnecting();if(!n)return!1;if(!this._checkPCExist(n)){var s=this.createPeerConnection({localId:t,remoteId:n});s&&s.receiveSignal({type:"init"})}e+=1}return!1}_getNextPeerForConnecting(){return Jn.nextPeer()}kickUselessPeer(){var e;this._connected.size>l.minPCConnected&&this._connected.forEach(((t,r)=>{this._connected.get(e)?this._connected.get(e).score>t.score&&(e=r):e=r})),e&&this._kickPeer(e)}_kickPeer(e){this._reportData[ve]+=1,this._deletePC(e)}_checkPeers(){this.keepEnoughPeers(),this.kickUselessPeer()}_trigger(e,t){this.hlsp2p.trigger(e,t)}_allPcRtt(){var e=this._connected,t=[];return e.forEach((e=>{e&&e.rtt&&(X.log(`[p2p] [rtt] local: ${this.localPid()} remote: ${e.remoteId}, ${e.rtt}`),t.push(e.rtt))})),t.slice(0,10)}initReportData(){this._reportData={[he]:0,[ce]:0,[de]:0,[ue]:0,[pe]:0,[fe]:0,[ge]:0,[ve]:0,[ye]:0,[me]:0,[_e]:[],[we]:0,[be]:0,[Re]:0,[Te]:0,[Ce]:this._allPcRtt()}}reportCallback(){var e=this._reportData;return e[he]=this._connected.size,this.initReportData(),this._reportData[ue]=e[ue],this._reportData[pe]=e[pe],this._reportData[ge]=e[ge],this._connected.forEach((e=>{this._reportData[_e].push(e.numOfOpeningPC)})),e}}const fi=pi;class gi extends fi{constructor(e){super(e),e.on("player_level",(e=>{var t=e.level;l.levelForTracker=t}))}}var vi=1;const mi=class{constructor(){this.uri=ee.SYNC_INFO,this.peerType=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt8(this.peerType),e.marshall()}unmarshall(e){this.peerType=e.popUInt8()}};class _i{setBitmapMgr(e){return this.bitmapMgr=e,this}init(){}destroy(){this.bitmapMgr=null}kickFilter(e){var t=[];return e.forEach((e=>{this._checkBitmap(e)||t.push(e)})),t}_checkBitmap(e){var t=this.bitmapMgr.getBitmap(e);return!t||t.bufferInfo.filter((e=>e.sn>D.curReqSn)).length>0}}var yi="p2p_recv_req",bi="p2p_resp_ok",wi="p2p_resp_miss",Ri="p2p_req_miss",Ti="serve_peer_cnt";const Ci=class extends fi{constructor(e){super(e),this.TAG="VodPeerManager",this._lrsPeer=new Set,this._ignoreLRSPeer=new Set,this._lrsFilter=new _i}setBitmapMgr(e){return this.bitmapMgr=e,this}init(){return this._lrsFilter.setBitmapMgr(this.bitmapMgr).init(),this._lrsPeer.clear(),this.hlsp2p.on(R.PEER_REMOVED,(e=>{var t=e.pid;this._lrsPeer.delete(t)})),super.init()}destroy(){this._lrsPeer.clear(),this._lrsFilter.destroy(),super.destroy()}recvSyncInfo(e,t){var r=new mi;r.unmarshall(t),r.peerType===vi&&this._lrsPeer.add(e)}getAllConnectedPid(){return[...this._connected.keys()]}ignorePeer(e){return this._lrsPeer.has(e)}kickUselessPeer(){if(this._lrsFilter){var e=this._getAllLRSPid();this._lrsFilter.kickFilter(e).forEach((e=>{this._kickPeer(e),this._ignoreLRSPeer.add(e)}))}return super.kickUselessPeer()}_getAllLRSPid(){var e=[];return this._lrsPeer.forEach((t=>{this._connected.has(t)&&e.push(t)})),e}_getNextPeerForConnecting(){for(var e=super._getNextPeerForConnecting();this._ignoreLRSPeer.has(e);)e=super._getNextPeerForConnecting();return e}reportCallback(){return this._reportData[Ti]=this._getAllLRSPid().length,super.reportCallback()}};class Si{constructor(){this.router=null}destroy(){this.router=null,this.packetMgr=null,this.bitmapMgr=null,this.peerMgr=null}setRouter(e){return this.router=e,this}setVodPeerManager(e){return this.peerMgr=e,this}setPacketMgr(e){return this.packetMgr=e,this}setBitmapMgr(e){return this.bitmapMgr=e,this}setBBSSubscriber(e){return this.bbsSubscriber=e,this}init(){return this.router.registerCb(ee.BITMAP,this._onBitmap.bind(this)),this.router.registerCb(ee.SLICE_REQUEST,this._onSliceRequest.bind(this)),this.router.registerCb(ee.PACKET,this._onPacket.bind(this)),this.router.registerCb(ee.SYNC_INFO,this._onSyncInfo.bind(this)),this}_onBitmap(e,t){this.bitmapMgr.recvBitmap(e,t)}_onSliceRequest(e,t){this.bbsSubscriber.onSliceRequest(e,t)}_onPacket(e,t){this.packetMgr.addPacket(t)}_onSyncInfo(e,t){this.peerMgr.recvSyncInfo(e,t)}}const Ii=class{constructor(){this.uri=ee.BITMAP,this.curLevel=255,this.bufferInfo=[]}add(e){this.bufferInfo.push(e)}hasSlice(e){for(var t=0;t<this.bufferInfo.length;t+=1)if(this.bufferInfo[t].sn===e.ReqSn&&this.bufferInfo[t].level===e.ReqLevel&&-1!==this.bufferInfo[t].subIndexes.indexOf(e.idx))return!0;return!1}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt8(this.curLevel),e.pushUInt16(this.bufferInfo.length),this.bufferInfo.forEach((t=>{t.marshall(e)})),e.marshall()}unmarshall(e){this.curLevel=e.popUInt8();for(var t=e.popUInt16(),r=0;r<t;r+=1){var n=new ae;n.unmarshall(e),this.bufferInfo.push(n)}}toString(){var e="";return this.bufferInfo.forEach((t=>{e+=`${t.sn}-${t.level} | `})),e}};class ki{constructor(){this._timers=new Map}clear(){this._timers.forEach((e=>{clearInterval(e)})),this._timers.clear()}add(e,t){clearInterval(this._timers.get(e)),this._timers.set(e,t)}delete(e){clearInterval(this._timers.get(e)),this._timers.delete(e)}}const Ei=class{constructor(e){this.TAG="BitmapMgr",this.hlsp2p=e,this._bitmap=new Map,this._syncTimer=new ki}setTransport(e){return this.transport=e,this}setPeerManager(e){return this.peerManager=e,this}init(){this._bitmap.clear(),this._syncTimer.clear(),this.hlsp2p.on(R.PEER_REMOVED,(e=>{var t=e.pid;this._bitmap.delete(t),this._syncTimer.delete(t)})),this.hlsp2p.on(R.PEER_CONNECTED,(e=>{var t=e.pid,r=setInterval((()=>{this._syncBitmapTo(t)}),l.bitmapInterval);this._syncTimer.add(t,r),this._syncBitmapTo(t)}))}destroy(){this._bitmap.clear(),this._syncTimer.clear(),this.peerManager=null,this.transport=null}recvBitmap(e,t){var r=new Ii;r.unmarshall(t),this._bitmap.set(e,r)}getBitmap(e){return this._bitmap.get(e)}_syncBitmapTo(e){this.peerManager.ignorePeer(e)||this.transport.sendBinary(e,this.createBitmap([]))}createBitmap(e){if(!Array.isArray(e))throw Error(`${this.TAG}.getSpecifiedBitmap 参数需为数组`);var t=new Ii;return ln.getBufferInfo(e).forEach((e=>{t.add(e)})),t.marshall()}};const Pi=class{constructor(){this.uri=ee.SLICE_REQUEST,this.ReqSn=0,this.ReqLevel=0,this.idx=0}init(e){this.ReqSn=e.ReqSn,this.ReqLevel=e.ReqLevel,this.idx=e.idx}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.ReqSn),e.pushUInt32(this.ReqLevel),e.pushUInt32(this.idx),e.marshall()}unmarshall(e){this.ReqSn=e.popUInt32(),this.ReqLevel=e.popUInt32(),this.idx=e.popUInt32()}};const xi=class{constructor(){this.fragMap=new Map,this._timer=null}init(){this._setTimer()}destroy(){this._clearTimer(),this.fragMap.clear()}addPacket(e){var t=new se;t.unmarshall(e);var r=`${t.sn}-${t.level}-${t.sliceIndex}`;if(ln.getSlices(t.sn,t.level,t.sliceIndex))this.fragMap.delete(r);else{var n=this.fragMap.get(r);n||((n=new ie(t.sn,t.level,t.sliceIndex)).id=r,n.packetAmount=t.totalPacket,n.combineCallback=this.combineFinish.bind(this),this.fragMap.set(r,n)),n.addPacket(t),D.p2pEstimate&&D.p2pEstimate.addPacket(r,{totalPacket:t.totalPacket})}}static genPacketsFromSlice(e,t,r){return J(Z().mark((function r(){var n,s;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,ln.getSlicesFromAllPlace(e,t);case 2:if(!(n=r.sent)){r.next=7;break}return s=n.segmentSliceToPacket(),r.abrupt("return",s);case 7:return r.abrupt("return",!1);case 8:case"end":return r.stop()}}),r)})))()}combineFinish(e){var t=this.fragMap.get(e);ln.onReceiveSlice({id:e,index:t.index,slice:t}),this.fragMap.delete(e),M.delete(e),M.tick(),D.p2pEstimate&&D.p2pEstimate.delete(e)}_clearOutDateFrag(){this.fragMap.forEach(((e,t)=>{Date.now()-e.createTime>12e4&&this.fragMap.delete(t)}))}_setTimer(){this._clearTimer(),this._timer=setInterval(this._clearOutDateFrag.bind(this),3e4)}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}};class Li{constructor(){this._retryTimes=new Map,this._updateTime=new Map,this._timer=setInterval((()=>{this._clearOutdated()}),5e3)}destroy(){this._timer&&(clearInterval(this._timer),this._timer=null),this._retryTimes.clear(),this._updateTime.clear()}record(e){var t=this._retryTimes.get(e)||0;return this._retryTimes.set(e,t+1),this._updateTime.set(e,Date.now()),!0}queryReqTimes(e){return this._retryTimes.get(e)||0}_clearOutdated(){this._updateTime.forEach(((e,t)=>{Date.now()-e>12e4&&(this._retryTimes.delete(t),this._updateTime.delete(t))}))}}class Ai{constructor(e){this.TAG="BBSSubscriber",this.hlsp2p=e}setTransport(e){return this.transport=e,this}setBitmapMgr(e){return this.bitmapMgr=e,this}setPeerManager(e){return this.peerManager=e,this}setStats(e){return this._stats=e,this}init(){return this._clearTimer(),this.checkBuffer=this._checkBuffer.bind(this),this._checkBufferTimer=setInterval(this.checkBuffer,l.checkBufferInterval),this._p2pRequestId=new Map,this._reqRecorder=new Li,this}destroy(){this._clearTimer(),this._reqRecorder.destroy(),this._p2pRequestId.clear(),this.bitmapMgr=null,this.transport=null,this.peerManager=null,this.hlsp2p=null}_clearTimer(){this._checkBufferTimer&&(clearInterval(this._checkBufferTimer),this._checkBufferTimer=null)}onSliceRequest(e,t){var r=new Pi;r.unmarshall(t),this._stats[yi]+=1,this._sendPacket(e,r)}_sendPacket(e,t){var r=this;return J(Z().mark((function n(){var s;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,xi.genPacketsFromSlice(t.ReqSn,t.ReqLevel,t.idx);case 2:if(s=n.sent){n.next=7;break}return r._stats[wi]+=1,n.abrupt("return");case 7:r._stats[bi]+=1,s.forEach(((t,n)=>{r.transport.sendBinary(e,t)}));case 9:case"end":return n.stop()}}),n)})))()}_checkBuffer(){if(!M.size()){if(0===this.peerManager.getAllConnectedPid().length)return!1;var e=this._findUnfilledSlice();if(e&&e.length){e.map((e=>`[${e.toString()}]`)).join(",");var t=this._filterExistP2PReq(e);this._sendSliceRequest(t)}}}_filterExistP2PReq(e){var t=[];return this._clearOutdatedP2PRequest(),e.forEach((e=>{this._p2pRequestId.has(e.toString())||this._reqRecorder.queryReqTimes(e.toString())>=l.bbsP2PMaxRetry||t.push(e)})),t}_clearOutdatedP2PRequest(){var e=Date.now();this._p2pRequestId.forEach(((t,r)=>{e-t>l.bbsP2PReqTimeout&&this._p2pRequestId.delete(r)}))}_sendSliceRequest(e){var t=[...this.peerManager.getConnectedPeers().keys()];if(t.length)for(;e.length;){var r=e.shift(),n=this._findPeerForRequestingSlice(t,r);if(n){var s=this._reqRecorder.queryReqTimes(r.toString());0===s?this._stats[kt]+=1:1===s&&(this._stats[At]+=1),this._reqRecorder.record(r.toString()),this._p2pRequestId.set(r.toString(),Date.now());var i=new Pi;i.init(r),this.transport.sendBinary(n,i.marshall())}}}_findPeerForRequestingSlice(e,t){for(var r=0;r<e.length;r++){var n=e[r];if(this._ensurePeerHasSlice(n,t))return e.push(e.splice(r,1)[0]),n;e.length&&(this._stats[Ri]+=1)}return null}_ensurePeerHasSlice(e,t){var r=this.bitmapMgr.getBitmap(e);return!!r&&r.hasSlice(t)}_findUnfilledSlice(){var e=D.curReqSn,t=D.curReqLevel;if(void 0===e||void 0===t)return!1;for(var r=e+l.p2pLimit,n=e+1,s=[];s.length<l.p2pSliceRequestCount&&n<=r&&Vn.hasTS(t,n);){var i=ln.get(new sn({sn:n,level:t}).toStringId());if(i)for(var a=0;a<l.sliceCount;a+=1)!i.getSlice(a)&&s.length<l.p2pSliceRequestCount&&s.push(new Di({ReqSn:n,ReqLevel:t,idx:a}));else for(var o=0;o<l.sliceCount;o+=1)s.length<l.p2pSliceRequestCount&&s.push(new Di({ReqSn:n,ReqLevel:t,idx:o}));n+=1}return s}}class Di{constructor(e){var t=e.ReqSn,r=e.ReqLevel,n=e.idx;this.ReqSn=t,this.ReqLevel=r,this.idx=n}toString(){return`${this.ReqSn}-${this.ReqLevel}`}}const Mi=(e,t)=>t.some((t=>e instanceof t));let Oi,qi;const Ui=new WeakMap,Bi=new WeakMap,Ni=new WeakMap,Fi=new WeakMap,$i=new WeakMap;let ji={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return Bi.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Ni.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return Vi(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function Hi(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(qi||(qi=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(zi(this),t),Vi(Ui.get(this))}:function(...t){return Vi(e.apply(zi(this),t))}:function(t,...r){const n=e.call(zi(this),t,...r);return Ni.set(n,t.sort?t.sort():[t]),Vi(n)}}function Gi(e){return"function"==typeof e?Hi(e):(e instanceof IDBTransaction&&function(e){if(Bi.has(e))return;const t=new Promise(((t,r)=>{const n=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",i),e.removeEventListener("abort",i)},s=()=>{t(),n()},i=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",s),e.addEventListener("error",i),e.addEventListener("abort",i)}));Bi.set(e,t)}(e),Mi(e,Oi||(Oi=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,ji):e)}function Vi(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,r)=>{const n=()=>{e.removeEventListener("success",s),e.removeEventListener("error",i)},s=()=>{t(Vi(e.result)),n()},i=()=>{r(e.error),n()};e.addEventListener("success",s),e.addEventListener("error",i)}));return t.then((t=>{t instanceof IDBCursor&&Ui.set(t,e)})).catch((()=>{})),$i.set(t,e),t}(e);if(Fi.has(e))return Fi.get(e);const t=Gi(e);return t!==e&&(Fi.set(e,t),$i.set(t,e)),t}const zi=e=>$i.get(e);function Wi(e,t,{blocked:r,upgrade:n,blocking:s,terminated:i}={}){const a=indexedDB.open(e,t),o=Vi(a);return n&&a.addEventListener("upgradeneeded",(e=>{n(Vi(a.result),e.oldVersion,e.newVersion,Vi(a.transaction),e)})),r&&a.addEventListener("blocked",(e=>r(e.oldVersion,e.newVersion,e))),o.then((e=>{i&&e.addEventListener("close",(()=>i())),s&&e.addEventListener("versionchange",(e=>s(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),o}function Xi(e,{blocked:t}={}){const r=indexedDB.deleteDatabase(e);return t&&r.addEventListener("blocked",(e=>t(e.oldVersion,e))),Vi(r).then((()=>{}))}const Ki=["get","getKey","getAll","getAllKeys","count"],Yi=["put","add","delete","clear"],Ji=new Map;function Qi(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(Ji.get(t))return Ji.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,s=Yi.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!s&&!Ki.includes(r))return;const i=async function(e,...t){const i=this.transaction(e,s?"readwrite":"readonly");let a=i.store;return n&&(a=a.index(t.shift())),(await Promise.all([a[r](...t),s&&i.done]))[0]};return Ji.set(t,i),i}ji=(e=>({...e,get:(t,r,n)=>Qi(t,r)||e.get(t,r,n),has:(t,r)=>!!Qi(t,r)||e.has(t,r)}))(ji);class Zi extends(t()){constructor(){super(),this._db=null,this._config=null}get db(){return this._db}getTransaction(e,t,r){if(!this._db)return null;try{return this._db.transaction(e,t,r)}catch(e){return null}}getReadonlyTransaction(e){return this.getTransaction(e,"readonly",{durability:"relaxed"})}getWriteTransaction(e){return this.getTransaction(e,"readwrite",{durability:"relaxed"})}getReadStore(e){try{var t=this.getReadonlyTransaction(e);return t?t.objectStore(e):null}catch(e){return null}}getWriteStore(e){try{var t=this.getWriteTransaction(e);return t?t.objectStore(e):null}catch(e){return null}}destroy(){this._db&&(this._db.close(),this._db=null),super.removeAllListeners()}delete(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e._config){t.next=2;break}throw Error("missing idb config, call configure function first");case 2:return t.prev=2,e.destroy(),t.next=6,Xi(e._config.dbName,{blocked:(e,t)=>{}});case 6:t.next=11;break;case 8:t.prev=8,t.t0=t.catch(2);case 11:case"end":return t.stop()}}),t,null,[[2,8]])})))()}configure(e){this._config=e}init(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e._config){t.next=2;break}throw Error("missing idb config, call configure function first");case 2:return t.prev=2,t.next=5,Wi(e._config.dbName,e._config.version,{upgrade:(t,r,n)=>{if(0===r)e._config.allStoreConfig.forEach((e=>{var r=ra(t,e);r&&ta(r,e.allIndexConfig)}))},blocked:(e,t)=>{},blocking:(e,t)=>{},terminated:()=>{}});case 5:e._db=t.sent,e._db.onerror=t=>{e.emit("error",t.target.error)},e._db.onclose=()=>{e.emit("close")},t.next=14;break;case 11:t.prev=11,t.t0=t.catch(2);case 14:case"end":return t.stop()}}),t,null,[[2,11]])})))()}}var ea,ta=(e,t)=>{t.forEach((t=>{try{e.createIndex(t.indexName,t.indexKeyPath,t.options)}catch(e){}}))},ra=(e,t)=>{try{return e.createObjectStore(t.storeName,t.storeOptions)}catch(e){return null}};class na{constructor(e){this.resId=e,this._chunks=new Map,this._maxSn=0}destroy(){this._chunks.clear()}getMaxSn(){return this._maxSn}getAllMeta(){return this._chunks}setResChunkMeta(e){e.sn>this._maxSn&&(this._maxSn=e.sn),this._chunks.set(e.resChunkId,e)}getResChunkMeta(e){return this._chunks.get(`${e.resId}-${e.sn}-${e.level}`)}get hitCnt(){var e=0;return this._chunks.forEach((t=>{e+=t.hitCnt})),e}get latestUpdateTime(){var e=0;return this._chunks.forEach((t=>{t.updateTime>e&&(e=t.updateTime)})),e}get totalSize(){var e=0;return this._chunks.forEach((t=>{e+=t.dataLength})),e}get latestAccessTime(){var e=0;return this._chunks.forEach((t=>{t.accessTime>e&&(e=t.accessTime)})),e}}class sa{constructor(){this._localResourceIndexes=new Map,this._config=null,this._resOperator=null,this._props={totalSize:0},this._ready=!1,this._lastRefreshTime=0}setResourceOperator(e){return this._resOperator=e,this}configure(e){return this._config=e,this}init(){return this}destroy(){this._localResourceIndexes.forEach((e=>{e.destroy()})),this._localResourceIndexes.clear(),this._resOperator=null}ready(){return this._ready}deleteResource(e){this._localResourceIndexes.delete(e),this._reCalculateTotalSize()}getResource(e){return this._localResourceIndexes.get(e)}getAllResourcesMeta(){return[...this._localResourceIndexes.values()]}getResourceChunkMeta(e){var t;return null===(t=this._localResourceIndexes.get(e.resId))||void 0===t?void 0:t.getResChunkMeta(e)}updateResourceChunkMeta(e){var t;null===(t=this._localResourceIndexes.get(e.resId))||void 0===t||t.setResChunkMeta(e)}addResourceChunkMeta(e){var t=this._localResourceIndexes.get(e.resId);t||(t=new na(e.resId),this._localResourceIndexes.set(e.resId,t)),t.getResChunkMeta(e)||(this._props.totalSize+=e.dataLength),t.setResChunkMeta(e)}existsChunk(e){var t;return!(null===(t=this._localResourceIndexes.get(e.resId))||void 0===t||!t.getResChunkMeta(e))}totalSize(){return this._props.totalSize}refresh(){var e=this;return J(Z().mark((function t(){var r;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(Date.now()-e._lastRefreshTime>3e4)){t.next=4;break}e._lastRefreshTime=Date.now(),t.next=5;break;case 4:return t.abrupt("return",!1);case 5:return t.prev=5,t.next=8,e._resOperator.getAllResourceMeta();case 8:if(!(r=t.sent)){t.next=13;break}return e._update(r),e._ready=!0,t.abrupt("return",!0);case 13:t.next=19;break;case 15:return t.prev=15,t.t0=t.catch(5),t.abrupt("return",!1);case 19:case"end":return t.stop()}}),t,null,[[5,15]])})))()}_update(e){this._localResourceIndexes.clear(),e.forEach((e=>{this.addResourceChunkMeta(e)})),this._reCalculateTotalSize()}_reCalculateTotalSize(){this._props.totalSize=0,this._localResourceIndexes.forEach((e=>{this._props.totalSize+=e.totalSize}))}}class ia{static LoadFromDB(e,t){return J(Z().mark((function r(){var n,s;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e){r.next=2;break}return r.abrupt("return",null);case 2:return n=[],r.next=5,e.openCursor(t);case 5:s=r.sent;case 6:if(!s){r.next=13;break}return n.push(s.value),r.next=10,s.continue();case 10:s=r.sent,r.next=6;break;case 13:return r.abrupt("return",n);case 14:case"end":return r.stop()}}),r)})))()}}class aa{constructor(){this._idbProxy=null,this._config=null}setIDB(e){return this._idbProxy=e,this}configure(e){return this._config=e,this}init(){return this}destroy(){this._idbProxy=null}add(e){var t=this;return J(Z().mark((function r(){var n,s,i;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.createChunkId(),n=t.getStoresInSameTransaction()){r.next=4;break}return r.abrupt("return",null);case 4:return s=n.metaStore,i=n.dataStore,r.prev=5,r.next=8,s.add(e.getPlainMetaObj());case 8:return r.next=10,i.add(e.getPlainDataObj());case 10:return r.abrupt("return",e);case 13:return r.prev=13,r.t0=r.catch(5),r.abrupt("return",null);case 17:case"end":return r.stop()}}),r,null,[[5,13]])})))()}updateResourceMeta(e,t){var r=this;return J(Z().mark((function n(){var s,i,a;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,i=t||(null===(s=r._idbProxy)||void 0===s?void 0:s.getWriteStore(r._config.metaStoreName))){n.next=5;break}return n.abrupt("return",null);case 5:return n.next=7,i.put(e);case 7:return a=n.sent,n.abrupt("return",a);case 12:return n.prev=12,n.t0=n.catch(0),n.abrupt("return",null);case 16:case"end":return n.stop()}}),n,null,[[0,12]])})))()}getAllResourceMeta(){var e=this;return J(Z().mark((function t(){var r,n;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=null===(r=e._idbProxy)||void 0===r?void 0:r.getReadStore(e._config.metaStoreName),t.next=3,ia.LoadFromDB(n,null);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t)})))()}getResourceMeta(e,t){var r=this;return J(Z().mark((function n(){var s,i,a;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(s=`${e.resId}-${e.sn}-${e.level}`,n.prev=1,a=t||(null===(i=r._idbProxy)||void 0===i?void 0:i.getReadStore(r._config.metaStoreName))){n.next=5;break}return n.abrupt("return",null);case 5:return n.next=7,a.index("resChunkId").get(s);case 7:if(n.t0=n.sent,n.t0){n.next=10;break}n.t0=null;case 10:return n.abrupt("return",n.t0);case 13:return n.prev=13,n.t1=n.catch(1),n.abrupt("return",null);case 17:case"end":return n.stop()}}),n,null,[[1,13]])})))()}getData(e,t){var r=this;return J(Z().mark((function n(){var s,i,a;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(s=`${e.resId}-${e.sn}-${e.level}`,n.prev=1,a=t||(null===(i=r._idbProxy)||void 0===i?void 0:i.getReadStore(r._config.dataStoreName))){n.next=5;break}return n.abrupt("return",null);case 5:return n.next=7,a.index("resChunkId").get(s);case 7:if(n.t0=n.sent,n.t0){n.next=10;break}n.t0=null;case 10:return n.abrupt("return",n.t0);case 13:return n.prev=13,n.t1=n.catch(1),n.abrupt("return",null);case 17:case"end":return n.stop()}}),n,null,[[1,13]])})))()}delete(e){var t=this;return J(Z().mark((function r(){var n,s,i;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(n=t.getStoresInSameTransaction()){r.next=3;break}return r.abrupt("return",null);case 3:return s=n.metaStore,i=n.dataStore,r.prev=4,r.next=7,t._deleteResourceFromStore("resId",e,s);case 7:return r.next=9,t._deleteResourceFromStore("resId",e,i);case 9:r.next=14;break;case 11:r.prev=11,r.t0=r.catch(4);case 14:case"end":return r.stop()}}),r,null,[[4,11]])})))()}_deleteResourceFromStore(e,t,r){return J(Z().mark((function n(){var s,i;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=r.index(e),n.next=4,s.openCursor(IDBKeyRange.only(t));case 4:i=n.sent;case 5:if(!i){n.next=13;break}return n.next=8,i.delete();case 8:return n.next=10,i.continue();case 10:i=n.sent,n.next=5;break;case 13:case"end":return n.stop()}}),n)})))()}getStoresInSameTransaction(){var e,t=this._config,r=t.metaStoreName,n=t.dataStoreName,s=null===(e=this._idbProxy)||void 0===e?void 0:e.getWriteTransaction([r,n]);if(!s)return null;var i=s.objectStore(r),a=s.objectStore(n);return i&&a?{metaStore:i,dataStore:a}:null}}function oa(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return la(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return la(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw i}}}}function la(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var ha=function(){return(ea=ea||J(Z().mark((function e(){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!self.navigator.storage||!navigator.storage.estimate){e.next=2;break}return e.abrupt("return",self.navigator.storage.estimate());case 2:return e.abrupt("return",null);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)};class ca{constructor(){this._resourceIndexes=null,this._manager=null,this._config=null,this._storageEstimate={result:null,support:!1},this._evicting=!1}setParam(e,t){return this._resourceIndexes=e,this._manager=t,this}configure(e){return this._config=e,this}init(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.estimateQuota();case 2:return t.abrupt("return",e);case 3:case"end":return t.stop()}}),t)})))()}destroy(){}evictResource(){var e=this;return J(Z().mark((function t(){var r;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e._evicting){t.next=2;break}return t.abrupt("return","doing");case 2:if(e._evicting=!0,t.prev=3,r=e._selectResourceForEvicting()){t.next=9;break}return e._evicting=!1,t.abrupt("return","nothing");case 9:return t.next=11,e._manager.deleteRes(r);case 11:return t.next=13,e._manager.refreshMemoryIndex();case 13:return t.next=15,e.estimateQuota();case 15:return e._evicting=!1,t.abrupt("return","success");case 20:return t.prev=20,t.t0=t.catch(3),e._evicting=!1,t.abrupt("return","error");case 25:case"end":return t.stop()}}),t,null,[[3,20]])})))()}quotasAvailable(){if(this._evicting)return null;if(this._storageEstimate.support&&!this._storageEstimate.result)return null;if(!this._resourceIndexes.ready())return null;var e=this._config,t=e.maxStorageAvailableRatio,r=e.maxIndexeddbStoreSize;if(this._resourceIndexes.totalSize()>r*t)return"out_of_config";if(this._storageEstimate.support){var n=this._storageEstimate.result,s=n.quota;if(n.usage>s*t)return"out_of_quota"}return"ok"}estimateQuota(){var e=this;return J(Z().mark((function t(){var r;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ha();case 2:if(r=t.sent){t.next=6;break}return e._storageEstimate.support=!1,t.abrupt("return");case 6:e._storageEstimate.support=!0,e._storageEstimate.result=r;case 8:case"end":return t.stop()}}),t)})))()}getUsedPer(){var e=0,t=this._storageEstimate,r=t.support,n=t.result;r&&n&&n.quota&&(e=n.usage/n.quota);var s=0;return this._config.maxIndexeddbStoreSize&&(s=this._resourceIndexes.totalSize()/this._config.maxIndexeddbStoreSize),Math.round(100*Math.max(e,s))}_selectResourceForEvicting(){var e=this._resourceIndexes.getAllResourcesMeta();if(0===e.length)return"";e.sort(((e,t)=>e.latestAccessTime-t.latestAccessTime));var t,r=oa(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(0===n.latestAccessTime&&Date.now()-n.latestUpdateTime>this._config.newResEvictProWindow||n.latestAccessTime>0&&Date.now()-n.latestAccessTime>this._config.coldResEvictThreshold)return n.resId}}catch(e){r.e(e)}finally{r.f()}e.sort(((e,t)=>e.hitCnt-t.hitCnt));for(var s=e[0],i=0;i<e.length;i++)if(Date.now()-s.latestUpdateTime>this._config.newResEvictProWindow)return s.resId;return""}}class ua{static create(e){return new ua(e)}constructor(e){this.props={resId:e.resId||"",sn:e.sn||0,level:e.level||0,resChunkId:e.resChunkId||"",data:e.data||new Uint8Array(0),dataLength:e.dataLength||0,hitCnt:e.hitCnt||0,updateTime:e.updateTime||0,accessTime:e.accessTime||0,checksum:e.checksum||"",plainChecksum:e.plainChecksum||""}}setup(){return this.props.dataLength=this.props.data.byteLength,this.props.updateTime=this.createCurrentTime(),this.props.resChunkId=this.createChunkId(),this.props.checksum=this.createChecksum(),this.props.plainChecksum=this.createPlainChecksum(),this}getPlainMetaObj(){return{resId:this.props.resId,sn:this.props.sn,level:this.props.level,resChunkId:this.props.resChunkId,dataLength:this.props.dataLength,hitCnt:this.props.hitCnt,updateTime:this.props.updateTime,accessTime:this.props.accessTime,checksum:this.props.checksum,plainChecksum:this.props.plainChecksum}}getPlainDataObj(){return{resId:this.props.resId,sn:this.props.sn,level:this.props.level,resChunkId:this.props.resChunkId,data:this.props.data}}createChecksum(){return""}createPlainChecksum(){return""}createChunkId(){return`${this.props.resId}-${this.props.sn}-${this.props.level}`}createCurrentTime(){return Date.now()}}var da="store_size",pa="store_res_cnt",fa="quota_used_per",ga="idb_quota_exceeded",va="idb_close",ma="res_del_estimate",_a="res_del_config",ya="res_del_max_cnt",ba="res_del_tnt",wa="res_useless_cnt",Ra="res_hit_cnt",Ta="res_add_cnt";class Ca extends(t()){constructor(){super(),this._idb=new Zi,this._resourceIndexes=new sa,this._operator=new aa,this._quotasManager=new ca,this._ready=!1,this._destroyed=!1}configure(e){return this._config=e,this._idb.configure(e),this._resourceIndexes.configure(e),this._operator.configure(e),this._quotasManager.configure(e),this}init(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e._initStats(),t.next=3,e._idb.init();case 3:return e._operator.setIDB(e._idb).init(),e._resourceIndexes.setResourceOperator(e._operator).init(),t.next=7,e._quotasManager.setParam(e._resourceIndexes,e).init();case 7:return e._idb.on("error",(t=>{"QuotaExceededError"===t.name&&(e._stats[ga]+=1,e._quotasManager.evictResource().then((e=>{})))})),e._idb.on("close",(()=>{e._stats[va]+=1})),t.next=11,e._resourceIndexes.refresh();case 11:t.sent&&(e._ready=!0,e.emit("ready"));case 13:case"end":return t.stop()}}),t)})))()}destroy(){this._destroyed=!0,super.removeAllListeners(),this._idb.destroy(),this._resourceIndexes.destroy(),this._quotasManager.destroy(),this._operator.destroy()}add(e){var t=this;return J(Z().mark((function r(){var n,s,i;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t._ready){r.next=3;break}return r.abrupt("return",!1);case 3:if(!t._resourceIndexes.existsChunk(e)){r.next=6;break}return r.abrupt("return",!1);case 6:if(null!==(n=t._quotasManager.quotasAvailable())){r.next=10;break}return r.abrupt("return",!1);case 10:if("ok"===n){r.next=14;break}return t._quotasManager.evictResource().then((e=>{"success"===e&&("out_of_quota"===n&&(t._stats[ma]+=1),"out_of_config"===n&&(t._stats[_a]+=1))})),r.abrupt("return",!1);case 14:if(t._resourceIndexes.getAllResourcesMeta().length>=t._config.maxStoreResCnt&&!t._resourceIndexes.getResource(e.resId)&&t._quotasManager.evictResource().then((e=>{"success"===e&&(t._stats[ya]+=1)})),t._resourceIndexes.getResource(e.resId)||!(t._resourceIndexes.getAllResourcesMeta().length>=t._config.maxStoreResCnt)){r.next=18;break}return r.abrupt("return",!1);case 18:return t._resourceIndexes.getResource(e.resId)||(t._stats[Ta]+=1),s=ua.create(e).setup(),r.next=22,t._operator.add(s);case 22:if(i=r.sent,!t._destroyed){r.next=25;break}return r.abrupt("return",!1);case 25:if(!i){r.next=29;break}return t._resourceIndexes.addResourceChunkMeta(i.getPlainMetaObj()),t._quotasManager.estimateQuota().then((()=>{})),r.abrupt("return",!0);case 29:return r.abrupt("return",!1);case 30:case"end":return r.stop()}}),r)})))()}get(e){var t=this;return J(Z().mark((function r(){var n,s,i,a,o;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t._ready){r.next=3;break}return r.abrupt("return",null);case 3:if(n=t._operator.getStoresInSameTransaction()){r.next=7;break}return r.abrupt("return",null);case 7:return s=n.dataStore,i=n.metaStore,r.prev=8,r.next=11,t._operator.getData(e,s);case 11:a=r.sent,r.next=18;break;case 14:return r.prev=14,r.t0=r.catch(8),r.abrupt("return",null);case 18:if(a){r.next=24;break}if(!t._resourceIndexes.getResourceChunkMeta(e)){r.next=22;break}return r.next=22,t._resourceIndexes.refresh();case 22:case 45:return r.abrupt("return",null);case 24:r.prev=24,o=t._resourceIndexes.getResourceChunkMeta(e),r.next=32;break;case 28:return r.prev=28,r.t1=r.catch(24),r.abrupt("return",null);case 32:if(o){r.next=35;break}return r.abrupt("return",null);case 35:if(!t._destroyed){r.next=37;break}return r.abrupt("return",null);case 37:return o.hitCnt+=1,o.accessTime=Date.now(),r.next=41,t._operator.updateResourceMeta(o,i);case 41:if(!r.sent){r.next=45;break}return t._resourceIndexes.updateResourceChunkMeta(o),r.abrupt("return",Object.assign(a,o));case 47:case"end":return r.stop()}}),r,null,[[8,14],[24,28]])})))()}deleteRes(e){var t=this;return J(Z().mark((function r(){var n,s,i;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t._ready){r.next=3;break}return r.abrupt("return",null);case 3:return t._stats[ba]+=1,(i=t._resourceIndexes.getResource(e))&&(0===i.hitCnt?t._stats[wa]+=1:t._stats[Ra]+=1),r.next=8,null===(n=t._operator)||void 0===n?void 0:n.delete(e);case 8:null===(s=t._resourceIndexes)||void 0===s||s.deleteResource(e);case 9:case"end":return r.stop()}}),r)})))()}refreshMemoryIndex(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e._resourceIndexes.refresh();case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))()}has(e){return!!this._resourceIndexes.getResourceChunkMeta(e)}absolutelyHas(e){var t=this;return J(Z().mark((function r(){var n,s,i,a;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t._operator.getStoresInSameTransaction(),s=t._operator.getResourceMeta(e,n.metaStore),i=t._operator.getResourceMeta(e,n.dataStore),r.next=5,Promise.all([s,i]);case 5:return a=r.sent,r.abrupt("return",a[0]&&a[1]);case 7:case"end":return r.stop()}}),r)})))()}getResIndex(e){var t;return null===(t=this._resourceIndexes)||void 0===t?void 0:t.getResource(e)}getAllResIndex(){return this._resourceIndexes?this._resourceIndexes.getAllResourcesMeta():[]}ready(){return this._ready}getStats(){var e,t=this._stats;return t[da]=null===(e=this._resourceIndexes)||void 0===e?void 0:e.totalSize(),t[pa]=this.getAllResIndex().length,t[fa]=this._quotasManager.getUsedPer(),this._initStats(),t}_initStats(){this._stats={[ga]:0,[va]:0,[ma]:0,[_a]:0,[ya]:0,[ba]:0,[wa]:0,[Ra]:0,[Ta]:0}}}class Sa{setLocalResourceManager(e){return this.lrMgr=e,this}configure(){}init(){tn.registerModule("ResStoreProxy",this.reportCallback.bind(this))}destroy(){}has(e){return this.lrMgr.has(e)}get(e){var t=this;return J(Z().mark((function r(){return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.lrMgr.get(e);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))()}set(e){var t=this;return J(Z().mark((function r(){return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t._allowStore()){r.next=3;break}return r.abrupt("return");case 3:if(t._decideIfStoreRes(e)){r.next=6;break}return r.abrupt("return");case 6:return e.data=e.data.slice(0),r.next=10,t.lrMgr.add(e);case 10:case"end":return r.stop()}}),r)})))()}getResMeta(e){return this.lrMgr.getResIndex(e)}_decideIfStoreRes(e){var t;return this.gid||(this.gid=(t=l.resModBase,Math.floor(Math.random()*t))),!(!Sa.isTinyRes()||!l.enableStoreAllTinyRes)||e.sn%l.resModBase===this.gid}_allowStore(){return"VOD"===l.videoType&&(!!l.enableStoreRes&&(!!D.totalDuration&&(!(!Sa.isTinyRes()||!l.enableStoreTinyRes)||!Sa.isTinyRes())))}static isTinyRes(){return D.totalDuration<l.tinyResMaxDuration}reportCallback(){return this.lrMgr.getStats()}}var Ia={metaStoreName:"meta_store",dataStoreName:"data_store"},ka={dbName:"xp2p_hls_vod_db",version:1,allStoreConfig:[{storeName:Ia.dataStoreName,storeOptions:{keyPath:"resChunkId"},allIndexConfig:[{indexName:"resId",indexKeyPath:"resId",options:{multiEntry:!1,unique:!1}},{indexName:"sn",indexKeyPath:"sn",options:{multiEntry:!1,unique:!1}},{indexName:"level",indexKeyPath:"level",options:{multiEntry:!1,unique:!1}},{indexName:"resChunkId",indexKeyPath:"resChunkId",options:{multiEntry:!1,unique:!0}}]},{storeName:Ia.metaStoreName,storeOptions:{keyPath:"resChunkId"},allIndexConfig:[{indexName:"resId",indexKeyPath:"resId",options:{multiEntry:!1,unique:!1}},{indexName:"sn",indexKeyPath:"sn",options:{multiEntry:!1,unique:!1}},{indexName:"level",indexKeyPath:"level",options:{multiEntry:!1,unique:!1}},{indexName:"resChunkId",indexKeyPath:"resChunkId",options:{multiEntry:!1,unique:!0}},{indexName:"updateTime",indexKeyPath:"updateTime",options:{multiEntry:!1,unique:!1}},{indexName:"accessTime",indexKeyPath:"accessTime",options:{multiEntry:!1,unique:!1}},{indexName:"hitCnt",indexKeyPath:"hitCnt",options:{multiEntry:!1,unique:!1}}]}]},Ea="lrs_p2p_recv_req",Pa="lrs_p2p_resp_ok",xa="lrs_p2p_resp_miss",La="lrs_upload_bytes",Aa="lrs_serv_res",Da="lrs_connected",Ma="lrs_conn_suc",Oa="lrs_conn_reject",qa="lrs_conn_htbt_timeout",Ua="lrs_conn_init_timeout",Ba="lrs_conn_dc_closed";class Na extends fi{constructor(e){super(e),this.TAG="LRSServePeerManager"}setStats(e){return this._stats=e,this}init(){return super.init()}_checkPeers(){}canConnect(){return this._connected.size<l.lrsMaxPCConnected&&this._connecting.size<l.lrsMaxPCConnecting}_trigger(e,t){[R.PEER_REMOVED,R.PEER_CONNECTED].includes(e)?this.emit(e,t):super._trigger(e,t)}_beforeSendingSignal(e){e.resId=this.getResId()}reportCallback(){var e=super.reportCallback(),t=this._stats;return t[Da]+=e[he],t[Ma]+=e[de],t[Oa]+=e[fe],t[qa]+=e[we],t[Ua]+=e[be],t[Ba]+=e[ye],null}}class Fa{constructor(){this.router=null}setRouter(e){return this.router=e,this}setLRSSubscriber(e){return this.lrsSubscriber=e,this}init(){this.router.registerCb(ee.SLICE_REQUEST,this.onSliceRequest.bind(this))}destroy(){this.router=null}onSliceRequest(e,t){this.lrsSubscriber.onSliceRequest(e,t)}}var $a="user_abort",ja="reach_max_retry",Ha="timeout";class Ga{constructor(){this._input=null,this._init={},this._config=null,this._abortController=null,this._props={retryTimes:0}}configure(e,t,r){return this._config=t,this._input=e,this._init=r||{},this}send(){return this._createFetch()}_createFetch(){var e=this;return J(Z().mark((function t(){var r,n;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return self.AbortController&&(e._abortController=new self.AbortController,e._init.signal=e._abortController.signal),r=new Promise(((t,r)=>{setTimeout((()=>{r(new Error(Ha))}),e._config.msTimeout)})),n=self.fetch(e._input,e._init),t.prev=3,t.next=6,Promise.race([r,n]);case 6:case 15:return t.abrupt("return",t.sent);case 9:if(t.prev=9,t.t0=t.catch(3),"AbortError"!==t.t0.name){t.next=13;break}return t.abrupt("return",Promise.reject(t.t0));case 13:return t.next=15,e._retry();case 16:case"end":return t.stop()}}),t,null,[[3,9]])})))()}_retry(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(e._props.retryTimes>=e._config.maxRetryTimes)){t.next=2;break}return t.abrupt("return",Promise.reject(new Error(ja)));case 2:return e._props.retryTimes+=1,t.next=5,e._createFetch();case 5:return t.abrupt("return",t.sent);case 6:case"end":return t.stop()}}),t)})))()}abort(){var e;null===(e=this._abortController)||void 0===e||e.abort(new Error($a)),this._config=null,this._init=null,this._input=null}stats(){return this._props}}class Va{constructor(){this._config=null,this._timer=null,this._fetchIns=null}configure(e){this._config=e}init(){return this}destroy(){this._fetchIns.abort(),this.stop()}start(){this._clearTimer(),this.request(),this._config.requestInterval&&(this._timer=setInterval((()=>{this.request()}),this._config.requestInterval))}stop(){this._clearTimer()}createRequestInput(){return this._config.createFetchInput()}createRequestInit(){if(this._config.createFetchInit)return this._config.createFetchInit()}request(){var e=this.createRequestInput(),t={msTimeout:this._config.timeout,maxRetryTimes:this._config.maxRetryTimes},r=this.createRequestInit(),n=new Ga;this._fetchIns=n;var s=n.configure(e,t,r).send();this.processFetchResp(s)}processFetchResp(e){e.then((e=>e.ok?e:Promise.reject(e))).then((e=>{var t;null===(t=this._config.responseParser)||void 0===t||t.parse(e)})).catch((e=>{var t;null===(t=this._config.responseParser)||void 0===t||t.error(e)}))}_clearTimer(){this._timer&&clearInterval(this._timer)}}class za{constructor(){this._service=new Va}configure(e,t){var r=t.localPeerId,n=t.resId,s=t.currentTime;return this._service.configure({timeout:1e4,maxRetryTimes:0,requestInterval:e.requestInterval,createFetchInput:()=>es(e,{currentTime:s(),localPeerId:r,channelId:n}).url,responseParser:{parse:e=>J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.json();case 2:t.sent;case 4:case"end":return t.stop()}}),t)})))(),error(e){}}}),this}init(){this._service.init().start()}destroy(){this._service.destroy()}}class Wa{constructor(){this.TAG="LRSSubscriber",this._destroyed=!1}setLRSServePeerManager(e){return this.peerMgr=e,this}setTransport(e){return this.transport=e,this}setLocalResourceManager(e){return this.localResMgr=e,this}setStats(e){return this._stats=e,this}init(){this.peerMgr.on(R.PEER_CONNECTED,(e=>{var t=e.pid;this._sendBaseInfo(t),this._sendBitmap(t,this.peerMgr.getResId())}))}destroy(){this._destroyed=!0,this.transport=null,this.peerMgr=null}onSliceRequest(e,t){var r=this;return J(Z().mark((function n(){var s;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return(s=new Pi).unmarshall(t),r._stats[Ea]+=1,n.next=6,r._createPacketResponse(e,s);case 6:if(n.sent){n.next=11;break}return r._stats[xa]+=1,n.abrupt("return");case 11:r._stats[Pa]+=1;case 13:case"end":return n.stop()}}),n)})))()}_createPacketResponse(e,t){return this.localResMgr?this.localResMgr.get({resId:this.peerMgr.getResId(),sn:t.ReqSn,level:t.ReqLevel}).then((r=>{if(this._destroyed)return null;if(!r)return null;if(!r.data)return null;this._stats[La]+=r.data.byteLength;var n=new ie(t.ReqSn,t.ReqLevel,0,r.data.buffer);return n.p2pStoragTypeFlag=ne,n.segmentSliceToPacket().forEach((t=>{this.transport.sendBinary(e,t)})),!0})).catch((e=>null)):Promise.reject(null)}_createBitmap(e){if(!this.localResMgr)return null;var t=new Ii,r=this.localResMgr.getResIndex(e);return r?(r.getAllMeta().forEach((e=>{var r=new ae;r.sn=e.sn,r.level=e.level,r.subIndexes.push(0),t.bufferInfo.push(r)})),t.marshall()):t.marshall()}_sendBitmap(e,t){var r=this._createBitmap(t);r&&this.transport.sendBinary(e,r)}_sendBaseInfo(e){var t=new mi;t.peerType=vi,this.transport.sendBinary(e,t.marshall())}}class Xa{constructor(e){this.hlsp2p=e,this.router=new ds,this.transport=new ps,this.peerMgr=new Na(e),this.server=new Fa,this.tracker=new za,this.subscriber=new Wa}setStats(e){return this._stats=e,this}setResId(e){return this.resId=e,this}setLocalResourceManager(e){return this.localResourceMgr=e,this}init(){this.transport.setPeerManager(this.peerMgr),this.peerMgr.setRouter(this.router).setTransport(this.transport).setStats(this._stats).setResId(this.resId).init(),this.server.setRouter(this.router).setLRSSubscriber(this.subscriber).init(),this.subscriber.setTransport(this.transport).setLRSServePeerManager(this.peerMgr).setStats(this._stats).setLocalResourceManager(this.localResourceMgr).init(),this.hlsp2p.localPeerId?this._initTracker(this.hlsp2p.localPeerId):this.hlsp2p.on(T.SIGNAL_READY,(e=>{var t=e.pid;this._initTracker(t)}))}destroy(){this.transport.destroy(),this.peerMgr.destroy(),this.server.destroy(),this.subscriber.destroy(),this.tracker.destroy()}_initTracker(e){this.tracker.configure({vodTrackerServer:l.vodTrackerServer,vodTrackerVersion:l.vodTrackerVersion,cloudAppId:l.cloudAppId,requestInterval:l.trackerInterval},{localPeerId:e,resId:this.resId,currentTime:()=>{if(!this.localResourceMgr)return 0;var e=this.localResourceMgr.getResIndex(this.resId);return e?10*e.getMaxSn():0}}).init()}}class Ka{constructor(e){this.hlsp2p=e,this.lrsModules=new Map,this._reportData={}}init(){if(l.enableStoreRes){tn.registerModule("LRSInitiator",this.reportCallback.bind(this)),this.initReport(),this.localResourceManager=new Ca,this.lrProxy=new Sa,this.lrProxy.setLocalResourceManager(this.localResourceManager).init(),ln.setResStoreProxy(this.lrProxy);var e=Object.assign(ka,Ia,{maxStoreResCnt:l.maxStoreResCnt,maxIndexeddbStoreSize:l.maxIndexeddbStoreSize,maxStorageAvailableRatio:l.maxStorageAvailableRatio,newResEvictProWindow:l.newResEvictProWindow,coldResEvictThreshold:l.coldResEvictThreshold});this.localResourceManager.configure(e).on("ready",(()=>{this.initLRSModule()})).init().catch((e=>{}))}}initLRSModule(){if(l.enableLRS)for(var e=this.localResourceManager.getAllResIndex(),t=0;t<Math.min(e.length,l.maxStoreResCnt);t++){var r=e[t];if(r.resId!==l.channelId){var n=new Xa(this.hlsp2p);n.setLocalResourceManager(this.localResourceManager).setStats(this._reportData).setResId(r.resId).init(),this.lrsModules.set(r.resId,n)}}}destroy(){this.localResourceManager&&(this.localResourceManager.destroy(),this.localResourceManager=null),this.lrsModules&&(this.lrsModules.forEach((e=>{e.destroy()})),this.lrsModules.clear()),this.lrProxy&&(this.lrProxy.destroy(),this.lrProxy=null),this.hlsp2p=null}initReport(){var e=this._reportData;e[Ea]=0,e[Pa]=0,e[xa]=0,e[La]=0,e[Da]=0,e[Ma]=0,e[Oa]=0,e[qa]=0,e[Ua]=0,e[Ba]=0}reportCallback(){var e=JSON.parse(JSON.stringify(this._reportData));return this.lrsModules&&(e[Aa]=this.lrsModules.size),this.initReport(),e}}class Ya{constructor(e){this.hlsp2p=e,this.router=new ds,this.transport=new ps,this.peerManager=new Ci(e),this.bitmapMgr=new Ei(e),this.packetMgr=new xi,this.bbsSubscriber=new Ai(e),this.bbsServer=new Si,this._reportData={}}init(){tn.registerModule("BBSModule",this.reportCallback.bind(this)),this.initReport(),this.transport.setPeerManager(this.peerManager),this.bitmapMgr.setTransport(this.transport).setPeerManager(this.peerManager).init(),this.packetMgr.init(),this.peerManager.setRouter(this.router).setTransport(this.transport).setBitmapMgr(this.bitmapMgr).setP2PStats(this.hlsp2p.p2pStats).setResId(l.channelId).init(),this.bbsSubscriber.setTransport(this.transport).setBitmapMgr(this.bitmapMgr).setPeerManager(this.peerManager).setStats(this._reportData).init(),this.bbsServer.setRouter(this.router).setVodPeerManager(this.peerManager).setPacketMgr(this.packetMgr).setBitmapMgr(this.bitmapMgr).setBBSSubscriber(this.bbsSubscriber).init(),l.enableStoreRes&&(this.lrsInitiator=new Ka(this.hlsp2p),this.lrsInitiator.init())}destroy(){this.router.destroy(),this.router=null,this.transport.destroy(),this.transport=null,this.bitmapMgr.destroy(),this.bitmapMgr=null,this.packetMgr.destroy(),this.packetMgr=null,this.bbsServer.destroy(),this.bbsServer=null,this.bbsSubscriber.destroy(),this.bbsSubscriber=null,this.peerManager.destroy(),this.peerManager=null,this.lrsInitiator&&(this.lrsInitiator.destroy(),this.lrsInitiator=null),this.hlsp2p=null}initReport(){var e=this._reportData;e[yi]=0,e[bi]=0,e[wi]=0,e[Ri]=0,e[kt]=0,e[At]=0}reportCallback(){var e=JSON.parse(JSON.stringify(this._reportData));return this.initReport(),e}}class Ja{constructor(){this.uri=ee.RTT_REQ,this.roundId=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt8(this.roundId),e.marshall()}unmarshall(e){this.roundId=e.popUInt8()}}class Qa{constructor(){this.tasks=new Set}destroy(){this.flushAllTask()}addTask(e){e.setExecCb((e=>{this.tasks.delete(e)})),this.tasks.add(e)}tick(){}getNextTask(){}flushAllTask(){this.tasks.forEach((e=>{e.destroy()})),this.tasks.clear()}}class Za{constructor(e){var t=e.cb;this._done=!1,this._action=t,this._execCb=null}destroy(){this.done(),this._action=null}setExecCb(e){this._execCb=e}done(){this._done=!0}exec(){this._action&&this._action(),this._execCb&&this._execCb(this)}}class eo extends Za{constructor(e){var t=e.cb,r=e.timeout;super({cb:t}),this._setTimeout(r)}destroy(){super.destroy(),this._clearTimeout()}_setTimeout(e){"number"==typeof e&&(this._timer=setTimeout((()=>{this._timer=null,this._done||this.exec()}),e))}_clearTimeout(){this._timer&&(clearTimeout(this._timer),this._timer=null)}}class to{constructor(){this.uri=ee.RTT_RES,this.roundId=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt8(this.roundId),e.marshall()}unmarshall(e){this.roundId=e.popUInt8()}}class ro{constructor(e){var t=e.id,r=e.sampleCount,n=e.finishedCb;this._id=t,this._sampleCount=r,this._cnt=0,this._minRTT=1/0,this._finishedCb=n,this._round=new Map}setMin(e){e<this._minRTT&&(this._minRTT=e),this._cnt+=1,this._cnt===this._sampleCount&&this._finishedCb({id:this._id,rtt:this._minRTT})}start(e){this._round.set(e,performance.now())}end(e,t){if(this._round.has(e)){var r=performance.now()-this._round.get(e)-t;this.setMin(r)}}}class no{constructor(e){this.TAG="RTTDetector",this.hlsp2p=e,this.taskScheduler=new Qa,this.rttRecords=new Map}destroy(){this.taskScheduler.destroy(),this.hlsp2p=null,this._transport=null,this._router=null}setTransport(e){return this._transport=e,this}setRouter(e){return this._router=e,this}init(){this._router.registerCb(ee.RTT_REQ,this._recvPingReq.bind(this)),this._router.registerCb(ee.RTT_RES,this._recvPingRes.bind(this))}ping(e){this.rttRecords.has(e)||this._createPingTask(e).forEach((e=>{this.taskScheduler.addTask(e)}))}_createPingTask(e){for(var t=this,r=[],n=function(n){var s=new eo({timeout:1e3*n,cb:()=>{t._sendPingReq(e,{pingIndex:n+1})}});r.push(s)},s=0;s<4;s++)n(s);return r}_sendPingReq(e,t){var r=t.pingIndex,n=new Ja;this._getRecordByPid(e).start(r),n.roundId=r,this._transport&&this._transport.sendBinary(e,n.marshall())}_recvPingReq(e,t){var r=new Ja;r.unmarshall(t),this._sendPingRes(e,{roundId:r.roundId})}_sendPingRes(e,t){var r=t.roundId,n=new to;n.roundId=r,this._transport&&this._transport.sendBinary(e,n.marshall())}_recvPingRes(e,t){var r=new to;r.unmarshall(t),this._getRecordByPid(e).end(r.roundId,0)}_getRecordByPid(e){var t=this.rttRecords.get(e);return t||(t=new ro({id:e,sampleCount:4,finishedCb:t=>{var r=t.id,n=t.rtt;this.hlsp2p.trigger(R.RTT_GOT,{pid:r,rtt:n}),this.rttRecords.delete(e)}}),this.rttRecords.set(e,t)),t}}class so{constructor(e){this.hlsp2p=e,this.minRTT=new Map,this.rttDetector=new no(this.hlsp2p)}destroy(){this.rttDetector.destroy(),this._transport=null,this._router=null,this.hlsp2p=null}setTransport(e){return this._transport=e,this}setRouter(e){return this._router=e,this}init(){this.rttDetector.setRouter(this._router).setTransport(this._transport).init(),this.hlsp2p.on(R.RTT_GOT,(e=>{var t=e.pid,r=e.rtt;this.minRTT.set(t,r),this._filterByRTT({pid:t,rtt:r})}))}addPeer(e){this.rttDetector.ping(e)}_filterByRTT(e){var t=e.pid,r=e.rtt;this.hlsp2p&&(r<=l.LNSRttThreshold?(X.log(`[p2p] [rtt filter] 节点: ${t} rtt: ${r} 满足局域网rtt筛选`),this.hlsp2p.trigger(R.PEER_FILTER_PASSED,{pid:t})):(X.log(`[p2p] [rtt filter] 节点: ${t} rtt: ${r} 未满足局域网rtt筛选`),this.hlsp2p.trigger(R.PEER_FILTER_BLOCKED,{pid:t})))}}function io(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return ao(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ao(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw i}}}}function ao(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}class oo{static create(e){return e?new oo(e):null}constructor(e){this._strAddr=e}addrArray(){return this._strAddr.split(".").map((e=>parseInt(e,10)))}isValid(){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(this._strAddr)}isPrivate(){this._privateAddrs=[[new oo("10.0.0.0"),new oo("10.255.255.255")],[new oo("100.64.0.0"),new oo("100.127.255.255")],[new oo("172.16.0.0"),new oo("172.31.255.255")],[new oo("192.0.0.0"),new oo("192.0.0.255")],[new oo("192.168.0.0"),new oo("192.168.255.255")],[new oo("198.18.0.0"),new oo("198.19.255.255")]];var e,t=io(this._privateAddrs);try{for(t.s();!(e=t.n()).done;){var r=e.value,n=r[0],s=r[1];if(this.gte(n)&&this.lte(s))return!0}}catch(e){t.e(e)}finally{t.f()}return!1}sameNetworkSegment(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._categoryDefaultCIDR={A:8,B:16,C:24};var r=this.category();if(r!==e.category())return!1;for(var n=this.addrArray(),s=e.addrArray(),i=0;i<(t||this._categoryDefaultCIDR[r])/8;i++)if(n[i]!==s[i])return!1;return!0}gte(e){return this.compare(e)>=0}lte(e){return this.compare(e)<=0}category(){this._category=[{type:"A",range:[new oo("1.0.0.1"),new oo("127.255.255.254")]},{type:"B",range:[new oo("128.0.0.1"),new oo("191.255.255.254")]},{type:"C",range:[new oo("192.0.0.1"),new oo("223.255.255.254")]}];var e,t=io(this._category);try{for(t.s();!(e=t.n()).done;){var r=e.value,n=r.range[0],s=r.range[1];if(this.gte(n)&&this.lte(s))return r.type}}catch(e){t.e(e)}finally{t.f()}return""}compare(e){for(var t=this.addrArray(),r=e.addrArray(),n=0;n<4;n++){if(t[n]>r[n])return 1;if(t[n]<r[n])return-1}return 0}}class lo{constructor(e){this.candidate=new RTCIceCandidate({candidate:e,sdpMLineIndex:0,sdpMid:"0"})}type(){var e=this.candidate.address;return e?-1!==e.indexOf("local")?"mdns":-1!==e.indexOf(":")?"IPv6":"IPv4":null}address(){return this.candidate.address}}function ho(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return co(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return co(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw i}}}}function co(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}class uo{constructor(){this.local=new Map,this.remote=new Map}destroy(){this.local.clear(),this.remote.clear()}addLocal(e){this.hasLocal(e)||this.local.set(e.address(),e)}addRemote(e){this.hasRemote(e)||this.remote.set(e.address(),e)}hasLocal(e){return this.local.has(e.address())}hasRemote(e){return this.remote.has(e.address())}localAddrType(){var e,t=ho(this.local);try{for(t.s();!(e=t.n()).done;){var r=nn(e.value,2)[1];if(r.type())return r.type()}}catch(e){t.e(e)}finally{t.f()}}remoteAddrType(){var e,t=ho(this.remote);try{for(t.s();!(e=t.n()).done;){var r=nn(e.value,2)[1];if(r.type())return r.type()}}catch(e){t.e(e)}finally{t.f()}}}var po="OK",fo="REJECT",go="NEED_MORE_CHECK",vo="MORE_CHECK_UNKNOWN";class mo{constructor(){this.tag="AddressFilter",this._candidatePairs=new Map}destroy(){this._candidatePairs.forEach((e=>{e.destroy()})),this._candidatePairs.clear()}addPeerCandidate(e,t,r){var n=new lo(r);if(n.address()){var s=this._candidatePairs.get(e);s||(s=new uo,this._candidatePairs.set(e,s)),"local"===t?s.addLocal(n):s.addRemote(n)}}deletePeerCandidate(e){this._candidatePairs.delete(e)}check(e){var t=this._candidatePairs.get(e);return t?this.bothMdns(t)?po:this.bothIP(t)?this._checkPairInSameNetworkSegment(t)?po:fo:this.mixedAddr(t)?go:vo:po}bothMdns(e){return"mdns"===e.localAddrType()&&"mdns"===e.remoteAddrType()}bothIP(e){return"IPv4"===e.localAddrType()&&"IPv4"===e.remoteAddrType()}mixedAddr(e){var t=e.localAddrType(),r=e.remoteAddrType();return"mdns"===t&&"IPv4"===r||"IPv4"===t&&"mdns"===r}_checkPairInSameNetworkSegment(e){var t=!1;return e.local.forEach((r=>{e.remote.forEach((e=>{var n=oo.create(r.address()),s=oo.create(e.address());if(!n.isValid()||!s.isValid())return t;n.sameNetworkSegment(s)&&(t=!0)}))})),t}}function _o(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return yo(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return yo(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw i}}}}function yo(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}class bo{constructor(e){this._bucketCount=e.bucketCount||6,this._clearBucketInterval=e.clearBucketInterval||6e4,this._buckets=[];for(var t=0;t<this._bucketCount;t++)this._buckets.push(new Set);this._curBucketIndex=0,this._switchTimer=setInterval(this._switch.bind(this),this._clearBucketInterval/this._bucketCount)}destroy(){this._clearTimer(),this._buckets.forEach((e=>{e.clear()}))}get size(){return this._buckets.reduce(((e,t)=>e+t.size),0)}add(e){this._curBucket().add(e)}delete(e){this._curBucket().delete(e)}has(e){var t,r=_o(this._buckets);try{for(r.s();!(t=r.n()).done;){if(t.value.has(e))return!0}}catch(e){r.e(e)}finally{r.f()}return!1}_switch(){this._curBucketIndex=(this._curBucketIndex+1)%this._buckets.length,this._curBucket().clear()}_curBucket(){return this._buckets[this._curBucketIndex]}_clearTimer(){this._switchTimer&&(clearInterval(this._switchTimer),this._switchTimer=null)}}var wo="filter_addr_reject",Ro="filter_addr_ok",To="filter_addr_more",Co="filter_rtt_ok",So="filter_rtt_reject",Io="inner_ip",ko="public_ip",Eo="black_list_cnt";class Po extends fi{constructor(e){super(e),this.TAG="LocalLivePeerManager",this.hlsp2p=e}init(){super.init(),this._candidates=new Map,this._blackList=new bo({bucketCount:l.bucketCount,clearBucketInterval:l.clearBucketInterval}),this.initLocalReportData()}_initAddressFilter(){this._addressFilter=new mo,this.hlsp2p.on(R.PEER_REMOVED,(e=>{var t=e.pid;this._addressFilter.deletePeerCandidate(t)}))}_beforeSendingSignal(e){if(super._beforeSendingSignal(e),e.type===Gs){var t=new lo(e.payload.candidate);t.address()&&(this._reportData[Io]=t.address()),this.this._addressFilter&&this._addressFilter.addPeerCandidate(e.to,"local",e.payload.candidate)}}_signalReceived(e){this._addressFilter&&e.type===Gs&&this._addressFilter.addPeerCandidate(e.from,"remote",e.payload.candidate)}_initPeerFilter(){this._peerFilter=new so(this.hlsp2p),this._peerFilter.setRouter(this.router).setTransport(this.transport).init(),this.hlsp2p.on(R.PEER_FILTER_PASSED,(e=>{var t=e.pid;super._PCConnected(t),this._localReportData[Co]+=1})),this.hlsp2p.on(R.PEER_FILTER_BLOCKED,(e=>{var t=e.pid;this._localReportData[So]+=1,X.info(`[p2p] [peer] [_blackList] rtt reject, 加入黑名单 ${t}`),this._blackList.add(t),setTimeout((()=>{this.hlsp2p&&this._kickPeer(t)}),1e3)}))}destroy(){super.destroy(),this._blackList.destroy(),this._candidates.clear(),this._addressFilter&&(this._addressFilter.destroy(),this._addressFilter=null),this._peerFilter&&(this._peerFilter.destroy(),this._peerFilter=null)}getComPeer(e){return this._connected.get(e)||this._candidates.get(e)}receiveSignal(e){return e.type===zs&&this._blackList.delete(e.from),super.receiveSignal(e)}canConnect(e){return e&&this._tryToKickForNewPeer(e),this._connected.size<l.maxPCConnected&&this._connecting.size<l.maxPCConnecting&&this._candidates.size<30}sendSignaling(e){e.type===js&&(e.peer={},e.peer.connected=this._connected.size),X.log(`[p2p] [发送信令] ${JSON.stringify(e)}`),super.sendSignaling(e)}_tryToKickForNewPeer(e){if(!(this._connected.size<l.maxPCConnected)&&e.type===js&&0===e.peer.connected){var t=this._pickPidToKick();t&&(X.warn(`[p2p] [peer] [kick] 满连接接收offer from: ${e.from}, 踢掉: ${t}`),this._kickPeer(t))}}_pickPidToKick(){var e=[...this._connected.keys()],t=e[Math.floor(e.length/2)];return t||""}_PCConnected(e){if(!l.enableMultiArea)return super._PCConnected(e);var t=this._connecting.get(e);if(this._connecting.delete(e),this._candidates.set(e,t),this._addressFilter){var r=this._addressFilter.check(e);if(X.info(`[p2p] [address filter] pid: ${e} ret: ${r}`),r===po)return this._localReportData[Ro]+=1,super._PCConnected(e);if(r===fo)return this._localReportData[wo]+=1,X.info(`[p2p] [peer] [_blackList] [address filter] 加入黑名单 pid: ${e} ret: ${r}`),void this._blackList.add(e);this._localReportData[To]+=1}return this._peerFilter?(X.info(`[p2p] [rtt filter] add pid: ${e}`),this._peerFilter.addPeer(e)):super._PCConnected(e)}_handlePCFail(e){super._handlePCFail(e),e.reason===si&&(X.info(`[p2p] [peer] [_blackList]  连接超时, 加入黑名单 pid: ${e.remoteId}`),this._blackList.add(e.remoteId))}_getReadyPCFromCache(e){if(this._candidates.has(e)){var t=this._candidates.get(e);return this._candidates.delete(e),t}return super._getReadyPCFromCache(e)}_getNextPeerForConnecting(){for(var e=Jn.nextPeer();e&&this._blackList.has(e);)X.log(`[p2p] [peer] [_blackList] ${e} 在黑名单中, 不主动连接`),e=Jn.nextPeer();return e}initLocalReportData(){this._localReportData={[Ro]:0,[wo]:0,[To]:0,[Co]:0,[So]:0,[Io]:"",[ko]:l.publicIP||"",[Eo]:this._blackList.size}}reportCallback(){var e=super.reportCallback();return Object.assign(e,this._localReportData),this.initLocalReportData(),e}}class xo extends Po{constructor(e){super(e)}getCandidatesPid(e){var t=e.id,r=sn.fromId(t),n=[];return this._connected.forEach((e=>{var t=e?e.nodeInfo:null;t&&r.level===t.currentLevel&&(r.sn<t.currentSn||r.sn===t.currentSn&&0!==t.progress)&&n.push(e.remoteId)})),n.length?n:super.getCandidatesPid({id:t})}}var Lo=new class{constructor(){this.TAG="P2pController",this.hlsp2p=null}init(e){this.hlsp2p=e,this.initGlobalModule(),this._initedInnterModule=!1,this.hlsp2p.trigger(R.CONF_STARTING),this.initModuleRelyOnConfHandler=this.initModuleRelyOnConf.bind(this),this.hlsp2p.once(R.CONF_PARSED,this.initModuleRelyOnConfHandler)}destroy(){this.destroyGlobalModule(),this.destroyInnerModule(),this.destroyModuleRelyOnConf(),this.hlsp2p=null}initModuleRelyOnConf(){this.signalClient||(this.initInnerModule(),this.hlsp2p.trigger(R.TRACKER_STARTING),this.signalClient=new Xn(this.hlsp2p),this.hlsp2p.on(R.SIGNAL_READY,(e=>{var t=e.pid;X.info(`[p2p] [signal] ready: pid: ${t} uuid: ${Yr()} playId: ${l.randomPlayId}`),this.hlsp2p.localPeerId=t,this.hlsp2p.trigger(R.TRACKER_LOADING)})),this.hlsp2p.on(R.SIGNAL_RECEIVING,this.onSignalReceiving.bind(this)))}destroyModuleRelyOnConf(){this.hlsp2p.off(R.CONF_PARSED,this.initModuleRelyOnConfHandler),this.signalClient&&(this.signalClient.destroy(),this.signalClient=null)}initGlobalModule(){Zn.init(this.hlsp2p),Jn.init(this.hlsp2p),rs.init(this.hlsp2p),hs.init(this.hlsp2p),us.init(this.hlsp2p)}destroyGlobalModule(){Zn.destroy(),Jn.destroy(),rs.destroy(),hs.destroy(),us.destroy()}initInnerModule(){this._initedInnterModule||(this._initedInnterModule=!0,l.enableLocalNetworkShare||l.enableLLS?(this.router=new ds,this.peerManager=l.enableLocalNetworkShare?new xo(this.hlsp2p):new gi(this.hlsp2p),this.transport=new ps,this.peerManager.setRouter(this.router).setTransport(this.transport).setResId(l.channelId).init(),this.transport.setPeerManager(this.peerManager),this.llsController=new $s,this.llsController.setRouter(this.router).setTransport(this.transport).setPeerManager(this.peerManager).init(this.hlsp2p),this.hlsp2p.chunkMgr=this.llsController.chunkMgr,this.hlsp2p.subscriber=this.llsController.subscriber,this.peerManager.setP2PStats(this.hlsp2p.p2pStats)):(this.bbsModule=new Ya(this.hlsp2p),this.bbsModule.init()))}destroyInnerModule(){this._initedInnterModule&&(this._initedInnterModule=!1,l.enableLocalNetworkShare||l.enableLLS?(this.router.destroy(),this.router=null,this.transport.destroy(),this.transport=null,this.llsController.destroy(),this.llsController=null,this.hlsp2p.chunkMgr=null,this.hlsp2p.subscriber=null,this.peerManager.destroy(),this.peerManager=null):(this.bbsModule.destroy(),this.bbsModule=null))}onSignalReceiving(e){this.hlsp2p.trigger(fi.createPeerManagerSignalId(e.resId),e)}get peerConnected(){return this.peerManager?this.peerManager.peerConnected:this.bbsModule?this.bbsModule.peerManager.peerConnected:0}get trackerConnected(){return Jn.trackerConnected}};const Ao=Lo;class Do{constructor(){this._lastReport=Date.now(),this._info={fragCnt:0,totalDuration:0}}init(e){this.resetReportData(),this._lastReport=Date.now(),e.once(T.LEVEL_LOADED,(e=>{"VOD"===l.videoType&&(this._info.totalDuration=Math.floor(e.totalDuration),this._info.fragCnt=e.fragments.length)})),this._reportData[Se]=1}destroy(){this.resetReportData()}resetReportData(){this._reportData={[Me]:Math.floor((Date.now()-l.loadTime)/1e3)}}get reportData(){var e=this._reportData;return e[qe]=Math.floor((Date.now()-this._lastReport)/1e3),e[He]=parseFloat(un.bufferLength.toFixed(2)),e[Ve]=un.paused,"VOD"===l.videoType&&(this._reportData[dr]=this._info.totalDuration,this._reportData[pr]=this._info.fragCnt),this._lastReport=Date.now(),this.resetReportData(),e}}class Mo{constructor(){this.TAG="StallDetector"}init(e){this._resetReportData(),this._started=!1,this._stalling=!1,e.on(R.FRAG_LOADED,(()=>{this._started||un.readyState>=4&&(un.on("waiting",this._onWaiting.bind(this)),this._started=!0)})),un.on("canplaythrough",this._onCanplaythrough.bind(this))}destroy(){this._resetReportData(),this._started=!1,this._stalling=!1}_onWaiting(){this._started?this._stalling?X.warn(`卡顿中, 忽略再次卡顿, 忽略 stuck occur buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`):un.seeking||un.ended?X.warn(`seek or ended, stuck occur buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`):(this._stalling=!0,X.warn(`stuck occur buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`),this._reportData.stuckCount+=1):X.warn(`播放未开始, 忽略 stuck occur buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`)}_onCanplaythrough(){this._stalling=!1,X.warn(`Canplaythrough buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`)}_resetReportData(){this._reportData={stuckCount:0}}get reportData(){var e={[Ee]:this._reportData.stuckCount};return this._resetReportData(),e}}var Oo=new class{constructor(){this.TAG="MediaController"}init(e){tn.registerModule(this.TAG,this.reportCallback.bind(this)),un.init({videoId:l.videoId}),this.mediaInfoCollector=new Do,this.mediaInfoCollector.init(e),this.stallDetector=new Mo,this.stallDetector.init(e)}destroy(){un.destroy(),this.mediaInfoCollector.destroy(),this.mediaInfoCollector=null,this.stallDetector.destroy(),this.stallDetector=null}reportCallback(){var e={},t=this.stallDetector.reportData,r=this.mediaInfoCollector.reportData;return Object.assign(e,t),Object.assign(e,r),e}};const qo=Oo;class Uo{static supportES(){return!(!Uo.supportRestParam()||!Uo.supportArrayFeature())}static supportArrayFeature(){return!(!self.Array.prototype.find||!self.Array.prototype.includes)}static supportRestParam(){try{var e=[1,2,3];[...e].forEach(((t,r)=>t===e[r]))}catch(e){return!1}return!0}static supportMSE(){return!!self.MediaSource}static supportMSEH264Playback(){return!(!self.MediaSource||!self.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'))}static supportP2P(){return Uo.supportWebSocket()&&Uo.supportDataType()&&Uo.supportObjectURL()&&Uo.supportRTCPeerConnection()&&Uo.supportDataChannel()}static supportDataType(){return!("undefined"==typeof ArrayBuffer||"undefined"==typeof Uint8Array||"undefined"==typeof Uint16Array||"undefined"==typeof Uint32Array||"undefined"==typeof DataView)}static supportWebSocket(){return!(!("WebSocket"in self)&&!("MozWebSocket"in self))}static supportRTCPeerConnection(){return!!self.RTCPeerConnection||!!(self.webkitRTCPeerConnection||self.mozRTCPeerConnection||self.msRTCPeerConnection||self.oRTCPeerConnection)}static supportDataChannel(){var e=self.RTCPeerConnection||self.msRTCPeerConnection||self.mozRTCPeerConnection||self.webkitRTCPeerConnection;return function(){var t=!1;try{var r=new e(null);t="createDataChannel"in r,r.close(),r=null}catch(e){}return t}()}static supportObjectURL(){return"URL"in self&&"createObjectURL"in URL}static supportServiceWorker(){return"serviceWorker"in navigator}static supportReadableStream(){return"ReadableStream"in self}static pageVisibility(){var e={hidden:"",visibilityChange:"",pageVisible:"",support:!0};void 0!==document.hidden?(e.hidden="hidden",e.visibilityChange="visibilitychange"):void 0!==document.msHidden?(e.hidden="msHidden",e.visibilityChange="msvisibilitychange"):void 0!==document.webkitHidden?(e.hidden="webkitHidden",e.visibilityChange="webkitvisibilitychange"):e.support=!1;return e.pageVisible=e.support?self.document[e.hidden]?"hidden":"visible":"notSupport",e}static memory(){var e="";if(performance&&performance.memory){var t=performance.memory;e=`${t.jsHeapSizeLimit} | ${t.totalJSHeapSize} | ${t.usedJSHeapSize}`}return e}static isFullScreen(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement)}}var Bo={ES:{arrayFeature:1,restParam:2},p2p:{websocket:256,typeArray:512,objectUrl:1024,peerConnection:2048,datachannel:4096},playback:{mse:65536,h264codec:2<<16}};const No=Uo;var Fo=new class extends wn{abort(e){var t=Vn.findTSInfo(e.url);t&&yn.abort(sn.fromObj(t).toStringId())}loadTs(e,t){if(this._checkParam({requestContext:e,requestCallbacks:t})){var r={url:e.url,responseType:"arraybuffer",frag:{sn:void 0,level:void 0}},n={onSuccess:(e,r)=>{t.onSuccess(e.data,r)},onError:e=>{t.onError(e)},onTimeout:e=>{t.onTimeout(e)}},s=Vn.findTSInfo(r.url);s?(r.frag.sn=s.sn,r.frag.level=s.level):r.id=`ts_id_${Date.now()}`,this._load(r,{maxRetry:0,maxRetryDelay:64e3,retryDelay:0,timeout:2e4},n)}}_load(e,t,r){var n=e.frag,s=n.sn,i=n.level;D.curReqSn=s,D.curReqLevel=i;var a=new E(e,t,r),o=new mn(e,t,r),l=a.id;o.id=l,yn.load(l,a,o)}_checkParam(e){var t=e.requestContext,r=e.requestCallbacks,n=!0;if(t&&t.url||(n=!1,window.console.error("[hlsp2p] ts请求缺少url")),!r)return window.console.error("[hlsp2p] ts请求缺少callbacks参数"),!1;return["onError","onSuccess","onTimeout"].forEach((e=>{r[e]&&"function"==typeof r[e]||(n=!1,window.console.error(`[hlsp2p] ts请求的callbacks参数缺少${e}回调方法`))})),n}};const $o=Fo;var jo=r(114),Ho=r.n(jo);class Go{constructor(){this.ttfbCost=0,this.bandwidth=0,this.costMs=0}recordTTFB(e){this.ttfbCost=this.ttfbCost*(1-l.cdnBWRatio)+e*l.cdnBWRatio}estimateTTFB(){return this.ttfbCost}recordBandwidth(e,t){if(t){var r=e/t;this.bandwidth=this.bandwidth*(1-l.cdnBWRatio)+r*l.cdnBWRatio,this.costMs=this.costMs*(1-l.cdnCostRatio)+t*l.cdnCostRatio}}estimateBandwidth(){return this.bandwidth}estimateCostMs(){return this.costMs*l.cdnEstimateRatio}}class Vo{constructor(e){var t=e.id,r=e.totalPacket;this.totalPacket=r,this.receivedPacket=0,this.costTime=0,this.startTime=Date.now(),this.id=t}recordPacket(){this.receivedPacket+=1,this.costTime=Date.now()-this.startTime}estimateTimeNeeded(){return(this.totalPacket-this.receivedPacket)*this.costTime/this.receivedPacket}}class zo{constructor(){this.records=new Map}destroy(){this.records.clear()}addPacket(e,t){var r=t.totalPacket,n=this.records.get(e);n||(n=new Vo({id:e,totalPacket:r}),this.records.set(e,n)),n.recordPacket()}estimateTimeNeeded(e){var t=this.records.get(e);return t?t.estimateTimeNeeded():0}delete(e){this.records.delete(e)}}function Wo(e){return Wo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Wo(e)}function Xo(e){var t=function(e,t){if("object"!==Wo(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==Wo(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===Wo(t)?t:String(t)}function Ko(e,t,r){return(t=Xo(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Yo extends EventTarget{constructor(){super(),this.readyState=Yo.UNSENT,this.response="",this.responseText="",this.responseType="",this.responseURL="",this.responseXML=null,this.status=0,this.statusText="",this.timeout=0,this.method="",this.url=""}setLoader(e){this.loader=e}abort(){var e={url:this.url};this._changeReadyState(Yo.UNSENT),this.loader.abort(e),this.dispatchEvent(new ProgressEvent("abort",{loaded:0,total:0})),this.dispatchEvent(new ProgressEvent("loadend",{loaded:0,total:0}))}getAllResponseHeaders(){}getResponseHeader(){}open(e,t){this._changeReadyState(Yo.OPENED),this.method=e,this.url=t,this.responseURL=t}send(){var e={url:this.url},t={onSuccess:(e,t)=>{this.response=e.slice(0),this.status=200,this._changeReadyState(Yo.DONE),this.responseType="arraybuffer";var r=this.response.byteLength,n=r;this.requestTime=Date.now()-(t.loading.end-t.loading.start),this.dispatchEvent(new ProgressEvent("progress",{loaded:r,total:n,lengthComputable:!0})),this.dispatchEvent(new ProgressEvent("load",{loaded:r,total:n,lengthComputable:!0})),this.dispatchEvent(new ProgressEvent("loadend",{loaded:r,total:n,lengthComputable:!0}))},onError:e=>{this.response=null,this.status=e.code||502,this.dispatchEvent(new ProgressEvent("error",{loaded:0,total:0})),this.dispatchEvent(new ProgressEvent("loadend",{loaded:0,total:0}))},onTimeout:()=>{this.status=0,this.dispatchEvent(new ProgressEvent("timeout",{loaded:0,total:0})),this.dispatchEvent(new ProgressEvent("loadend",{loaded:0,total:0}))}};this.loader.loadTs(e,t),this.dispatchEvent(new ProgressEvent("loadstart",{loaded:0,total:0}))}setRequestHeader(){}_changeReadyState(e){this.readyState=e,this.dispatchEvent(new Event("readystatechange"))}}Ko(Yo,"DONE",4),Ko(Yo,"LOADING",3),Ko(Yo,"HEADERS_RECEIVED",2),Ko(Yo,"OPENED",1),Ko(Yo,"UNSENT",0);var Jo=function(e,t,r,n){var s,i="arraybuffer"===e.responseType?e.response:e.responseText;!t&&i&&(e.responseTime=Date.now(),e.roundTripTime=e.responseTime-e.requestTime,e.bytesReceived=i.byteLength||i.length,e.bandwidth||(e.bandwidth=Math.floor(e.bytesReceived/e.roundTripTime*8*1e3))),r.headers&&(e.responseHeaders=r.headers),t&&"ETIMEDOUT"===t.code&&(e.timedout=!0),t||e.aborted||200===r.statusCode||206===r.statusCode||0===r.statusCode||(s=new Error(`XHR Failed with a response of: ${e&&(i||e.responseText)}`)),n(s,e)};var Qo=new class extends wn{constructor(){super(),this.TAG="VideojsHttpStreamingAdapter",this._vhsIns=null,this._vhsOriginalXHR=null,this._p2pVhsXhr=null,this._delayAttachTimer=null}destroy(){this._vhsIns&&(this._delayAttachTimer&&(clearTimeout(this._delayAttachTimer),this._delayAttachTimer=null),this._vhsIns.xhr=this._vhsOriginalXHR,this._vhsIns=null,this._vhsOriginalXHR=null,this._p2pVhsXhr=null)}attachVhs(e){return!!e.xhr&&(!this._vhsIns&&(this._vhsIns=e,this._vhsOriginalXHR=e.xhr,this._p2pVhsXhr=(e,t)=>{var r,n;return r=e.uri,n=new URL(r),/\.ts$/.test(n.pathname)&&this._p2pVhsXhr?this._p2pXhrFunction(e,t):this._vhsOriginalXHR(e,t)},this._delayAttachTimer=setTimeout((()=>{this._vhsIns.xhr=this._p2pVhsXhr}),1e3),!0))}_p2pXhrFunction(e,t){var r=this._vhsOriginalXHR.beforeRequest;if(r&&"function"==typeof r){var n=r(e);n&&(e=n)}var s=new Yo;s.setLoader($o);var i=s.abort;s.abort=function(){s.aborted=!0;for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return i.apply(s,t)},s.uri=e.uri,s.requestTime=Date.now(),s.open("GET",e.uri);var a={body:"",headers:{},method:"GET",statusCode:0,url:e.uri,rawRequest:s};return s.addEventListener("timeout",(()=>{a.body=s.response,a.statusCode=200,Jo(s,{code:"ETIMEDOUT"},a,t)})),s.addEventListener("error",(()=>{a.statusCode=s.status,Jo(s,null,a,t)})),s.addEventListener("load",(()=>{Jo(s,null,a,t)})),s.send(),s}};const Zo=Qo;class el{constructor(){this._uploadBytesTotal=0,this.uploadBytes=0}addUploadBytes(e){this._uploadBytesTotal+=e,this._uploadBytes+=e}getStats(){var e={uploadBytesTotal:this._uploadBytesTotal,uploadBytes:this._uploadBytes};return this._uploadBytes=0,e}}class tl{constructor(){this.customClientId="",this.client=null,this._recvCb=null}setCustomClientId(e){return this.customClientId=e,this}setClient(e){return this.client=e,this}setRecvCb(e){return this._recvCb=e,this}init(){return this}destroy(){this._recvCb=null}recvMessage(e){this._recvCb&&this._recvCb(e)}send(e){return e.customClientId!==this.customClientId?new Error("mismatch customClientId"):this.client?void this.client.postMessage(e):new Error("can not found client")}}const rl=2,nl=1,sl=2,il=3,al=5,ol=1,ll=2;class hl{constructor(e,t){this.streamId=e,this.customClientId=t,this._senderCtx={getNextSeq(){return this.lastSeq+=1,this.lastSeq},lastSeq:0,reset(){this.lastSeq=0}},this._receiverCtx={lastEmitSeq:0,getNextEmitSeq(){return this.lastEmitSeq+1},msgCache:new Map,reset(){this.msgCache.clear(),this.lastEmitSeq=0}},this._sendCb=null,this._recvCb=null,this._closeCb=null}destroy(){this._closeCb&&this._closeCb(this),this._receiverCtx.reset(),this._senderCtx.reset(),this._sendCb=null,this._recvCb=null}setRecvCb(e){return this._recvCb=e,this}setCloseCb(e){return this._closeCb=e,this}setSendCb(e){return this._sendCb=e,this}sendInit(){this.send({streamMsgType:nl,seq:0})}send(e){e.xp2pType=rl,e.streamId=this.streamId,e.customClientId=this.customClientId,0!==e.seq&&(e.seq=this._senderCtx.getNextSeq()),this._sendCb(e,this)}close(){const e={streamMsgType:al,seq:0};this.send(e)}recv(e){const t=this._receiverCtx.msgCache;for(t.set(e.seq,e);t.has(this._receiverCtx.getNextEmitSeq());){const e=t.get(this._receiverCtx.getNextEmitSeq());Promise.resolve().then((()=>{this._recvCb(e)})),t.delete(e.seq),this._receiverCtx.lastEmitSeq+=1}}}const cl={[ol]:1,[ll]:2};class ul{constructor(){this._startStreamId=null,this._msgChannel=null,this._streams=new Map}setRole(e){return this._startStreamId=cl[e],this}setOnRecvNewStreamCb(e){return this._recvNewStreamCb=e,this}setMessageChannel(e){return this._msgChannel=e,this}init(){this._msgChannel.setRecvCb((e=>{if(e.streamMsgType===nl)return void this._createRemoteStream(e);if(e.streamMsgType===al)return void Promise.resolve().then((()=>{this.destroySteam(e.streamId)}));const t=this._streams.get(e.streamId);t&&t.recv(e)}))}destroy(){this._streams.forEach((e=>{e.destroy()}))}createLocalStream(){const e=this._createStreamId(),{customClientId:t}=this._msgChannel,r=this._createSteam({streamId:e,customClientId:t});return r.sendInit(),r}_createRemoteStream(e){const t=this._createSteam({streamId:e.streamId,customClientId:e.customClientId});return this._recvNewStreamCb&&this._recvNewStreamCb(t),t}_createSteam({streamId:e,customClientId:t}){if(this._streams.has(e))return null;const r=new hl(e,t);return r.setSendCb((e=>{this._msgChannel.send(e);Error,e.streamMsgType===al&&Promise.resolve().then((()=>{this.destroySteam(r.streamId)}))})),this._streams.set(e,r),r}destroySteam(e){const t=this._streams.get(e);t&&(t.destroy(),this._streams.delete(e))}_createStreamId(){const e=this._startStreamId;return this._startStreamId+=2,e}}class dl{constructor(){this.customClientId=null,this._channel=new tl,this._role=null,this._streamMgr=new ul,this._recvNewStreamCb=null}setCustomClientId(e){return this.customClientId=e,this}setRole(e){return this._role=e,this}setRecvNewStreamCb(e){return this._recvNewStreamCb=e,this}setClient(e){return this._channel.setClient(e),this}init(){this._channel.setCustomClientId(this.customClientId).init(),this._streamMgr.setRole(this._role).setOnRecvNewStreamCb(this._recvNewStreamCb).setMessageChannel(this._channel).init()}destroy(){this._channel.destroy(),this._streamMgr.destroy()}recvMessage(e){this._channel.recvMessage(e)}createStream(){return this._streamMgr.createLocalStream()}get channel(){return this._channel}}new pn,new G;Kr();var pl="1.0.0";var fl=new class extends wn{constructor(){super(),this._ready=!1}init(e){tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.initReportData(),this._xp2pSWTransport=new dl({customClientId:l.randomPlayId,role:ol});var t=()=>{this._xp2pSWTransport.setRole(ol).setCustomClientId(l.randomPlayId).setClient(self.navigator.serviceWorker.controller).setRecvNewStreamCb(this.newStream.bind(this)).init(),this._serviceMessageHandler=e=>{var t=e.data;Object.prototype.hasOwnProperty.call(t,"xp2pType")&&this._xp2pSWTransport.recvMessage(t)},self.navigator.serviceWorker.addEventListener("message",this._serviceMessageHandler),this.registerToSW()};self.navigator.serviceWorker.controller?t():this._waitControllerTimer=setTimeout((()=>{t()}),1e4);var r=e=>{var t=new URL(e);return t.searchParams.set("xfrom","1"),t.toJSON()};e.on(T.BEFORE_CDN_REQUEST,(e=>{var t=e.loader;if(this._ready){var n=t.config.url;n&&(t.config.url=r(n))}})),e.on(T.BEFORE_M3U8_REQUEST,(e=>{var t=e.requestInfo;e.requestInfo=new Request(r(t.url),t)}))}destroy(){this.unregisterFromSW(),this._serviceMessageHandler&&self.navigator.serviceWorker.removeEventListener("message",this._serviceMessageHandler),this._xp2pSWTransport&&this._xp2pSWTransport.destroy(),clearTimeout(this._waitControllerTimer)}registerToSW(){this._reportData[Sr]+=1,self.fetch(`https://sw.xp2p/hello?videoType=${l.videoType}&customClientId=${l.randomPlayId}&protocol=HLS&version=${pl}`).then((e=>e.json())).then((e=>{0===e.code?(this._reportData[Ir]+=1,this._ready=!0):this._reportData[kr]+=1;var t=e.version,r=e.buildTime,n=e.commit;this._reportData[Ur]=t||"unknown",this._reportData[Br]=r||"unknown",this._reportData[Nr]=n||"unknown"})).catch((e=>{this._reportData[kr]+=1}))}unregisterFromSW(){self.fetch(`https://sw.xp2p/bye?videoType=${l.videoType}&customClientId=${l.randomPlayId}&protocol=HLS&version=${pl}`).catch((e=>e))}newStream(e){e.setRecvCb((t=>{if(t.streamMsgType===sl){var r=t.data,n=r.url,s=r.body;if("http://sw.xp2p/hls/request/ts"===n)return void this.recvTSReq(s,e);"http://sw.xp2p/hls/sync/m3u8"===n&&this.recvM3U8Manifest(s)}})),e.setCloseCb((()=>{}))}recvTSReq(e,t){var r=e.url;if(this._reportData[Er]+=1,Vn.findTSInfo(r))$o.loadTs({url:r},{onSuccess:e=>{var n={streamMsgType:il,data:{url:r,status:200,headers:{"Access-Control-Allow-Origin":self.origin},contentType:"video/MP2T",body:e}};this._reportData[Pr]+=1,t.send(n),t.close()},onError:()=>{var e={streamMsgType:il,data:{url:r,status:404}};this._reportData[xr]+=1,t.send(e),t.close()},onTimeout:()=>{var e={streamMsgType:il,data:{url:r,status:404}};this._reportData[Lr]+=1,t.send(e),t.close()}});else{var n={streamMsgType:il,data:{url:"http://sw.xp2p/hls/request/ts",status:403,headers:{},contentType:"json"}};this._reportData[Ar]+=1,t.send(n),t.close()}}recvM3U8Manifest(e){var t=e.url,r=e.text;this._reportData[Or]+=1;var n=Vn.m3u8UrlList;if("VOD"!==l.videoType&&n.ready()){var s=n.getLevel(t);void 0!==s?(this._reportData[Dr]+=1,jn.parseManifestText(t,s,r,(()=>{}))):this._reportData[Mr]+=1}}initReportData(){this._reportData={[Sr]:0,[Ir]:0,[kr]:0,[Er]:0,[Pr]:0,[xr]:0,[Lr]:0,[Ar]:0,[Dr]:0,[Mr]:0,[Or]:0,[qr]:1}}reportCallback(){var e=this._reportData;return this.initReportData(),e}};function gl(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}function vl(e,...t){if(!(e instanceof Uint8Array))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}function ml(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function _l(e,t){vl(e);const r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}const yl=BigInt(2**32-1),bl=BigInt(32);function wl(e,t=!1){return t?{h:Number(e&yl),l:Number(e>>bl&yl)}:{h:0|Number(e>>bl&yl),l:0|Number(e&yl)}}const Rl=e=>e instanceof Uint8Array,Tl=e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4)),Cl=(e,t)=>e<<32-t|e>>>t;if(!(68===new Uint8Array(new Uint32Array([287454020]).buffer)[0]))throw new Error("Non little-endian hardware is not supported");function Sl(e){if("string"==typeof e&&(e=function(e){if("string"!=typeof e)throw new Error("utf8ToBytes expected string, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}(e)),!Rl(e))throw new Error("expected Uint8Array, got "+typeof e);return e}class Il{clone(){return this._cloneInto()}}function kl(e){const t=(t,r)=>e(r).update(Sl(t)).digest(),r=e({});return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=t=>e(t),t}class El extends Il{constructor(e,t,r={},n,s,i){if(super(),this.blockLen=e,this.outputLen=t,this.length=0,this.pos=0,this.finished=!1,this.destroyed=!1,gl(e),gl(t),gl(n),t<0||t>n)throw new Error("outputLen bigger than keyLen");if(void 0!==r.key&&(r.key.length<1||r.key.length>n))throw new Error(`key must be up 1..${n} byte long or undefined`);if(void 0!==r.salt&&r.salt.length!==s)throw new Error(`salt must be ${s} byte long or undefined`);if(void 0!==r.personalization&&r.personalization.length!==i)throw new Error(`personalization must be ${i} byte long or undefined`);this.buffer32=Tl(this.buffer=new Uint8Array(e))}update(e){ml(this);const{blockLen:t,buffer:r,buffer32:n}=this,s=(e=Sl(e)).length,i=e.byteOffset,a=e.buffer;for(let o=0;o<s;){this.pos===t&&(this.compress(n,0,!1),this.pos=0);const l=Math.min(t-this.pos,s-o),h=i+o;if(l!==t||h%4||!(o+l<s))r.set(e.subarray(o,o+l),this.pos),this.pos+=l,this.length+=l,o+=l;else{const e=new Uint32Array(a,h,Math.floor((s-o)/4));for(let r=0;o+t<s;r+=n.length,o+=t)this.length+=t,this.compress(e,r,!1)}}return this}digestInto(e){ml(this),_l(e,this);const{pos:t,buffer32:r}=this;this.finished=!0,this.buffer.subarray(t).fill(0),this.compress(r,0,!0);const n=Tl(e);this.get().forEach(((e,t)=>n[t]=e))}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){const{buffer:t,length:r,finished:n,destroyed:s,outputLen:i,pos:a}=this;return e||(e=new this.constructor({dkLen:i})),e.set(...this.get()),e.length=r,e.finished=n,e.destroyed=s,e.outputLen=i,e.buffer.set(t),e.pos=a,e}}const Pl=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);function xl(e,t,r,n,s){return n=Cl(n^(e=e+t+s|0),16),{a:e,b:t=Cl(t^(r=r+n|0),12),c:r,d:n}}function Ll(e,t,r,n,s){return n=Cl(n^(e=e+t+s|0),8),{a:e,b:t=Cl(t^(r=r+n|0),7),c:r,d:n}}function Al(e,t,r,n,s,i,a,o,l,h,c,u,d,p,f,g,v,m,_,y){let b=0;for(let w=0;w<n;w++)({a:s,b:l,c:d,d:v}=xl(s,l,d,v,r[t+e[b++]])),({a:s,b:l,c:d,d:v}=Ll(s,l,d,v,r[t+e[b++]])),({a:i,b:h,c:p,d:m}=xl(i,h,p,m,r[t+e[b++]])),({a:i,b:h,c:p,d:m}=Ll(i,h,p,m,r[t+e[b++]])),({a,b:c,c:f,d:_}=xl(a,c,f,_,r[t+e[b++]])),({a,b:c,c:f,d:_}=Ll(a,c,f,_,r[t+e[b++]])),({a:o,b:u,c:g,d:y}=xl(o,u,g,y,r[t+e[b++]])),({a:o,b:u,c:g,d:y}=Ll(o,u,g,y,r[t+e[b++]])),({a:s,b:h,c:f,d:y}=xl(s,h,f,y,r[t+e[b++]])),({a:s,b:h,c:f,d:y}=Ll(s,h,f,y,r[t+e[b++]])),({a:i,b:c,c:g,d:v}=xl(i,c,g,v,r[t+e[b++]])),({a:i,b:c,c:g,d:v}=Ll(i,c,g,v,r[t+e[b++]])),({a,b:u,c:d,d:m}=xl(a,u,d,m,r[t+e[b++]])),({a,b:u,c:d,d:m}=Ll(a,u,d,m,r[t+e[b++]])),({a:o,b:l,c:p,d:_}=xl(o,l,p,_,r[t+e[b++]])),({a:o,b:l,c:p,d:_}=Ll(o,l,p,_,r[t+e[b++]]));return{v0:s,v1:i,v2:a,v3:o,v4:l,v5:h,v6:c,v7:u,v8:d,v9:p,v10:f,v11:g,v12:v,v13:m,v14:_,v15:y}}const Dl=(()=>{const e=Array.from({length:16},((e,t)=>t)),t=e=>[2,6,3,10,7,0,4,13,1,11,12,5,9,14,15,8].map((t=>e[t])),r=[];for(let n=0,s=e;n<7;n++,s=t(s))r.push(...s);return Uint8Array.from(r)})();class Ml extends El{constructor(e={},t=0){if(super(64,void 0===e.dkLen?32:e.dkLen,{},Number.MAX_SAFE_INTEGER,0,0),this.flags=0,this.chunkPos=0,this.chunksDone=0,this.stack=[],this.posOut=0,this.bufferOut32=new Uint32Array(16),this.chunkOut=0,this.enableXOF=!0,this.outputLen=void 0===e.dkLen?32:e.dkLen,gl(this.outputLen),void 0!==e.key&&void 0!==e.context)throw new Error("Blake3: only key or context can be specified at same time");if(void 0!==e.key){const r=Sl(e.key).slice();if(32!==r.length)throw new Error("Blake3: key should be 32 byte");this.IV=Tl(r),this.flags=16|t}else if(void 0!==e.context){const r=new Ml({dkLen:32},32).update(e.context).digest();this.IV=Tl(r),this.flags=64|t}else this.IV=Pl.slice(),this.flags=t;var r;this.state=this.IV.slice(),this.bufferOut=(r=this.bufferOut32,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}get(){return[]}set(){}b2Compress(e,t,r,n=0){const{state:s,pos:i}=this,{h:a,l:o}=wl(BigInt(e),!0),{v0:l,v1:h,v2:c,v3:u,v4:d,v5:p,v6:f,v7:g,v8:v,v9:m,v10:_,v11:y,v12:b,v13:w,v14:R,v15:T}=Al(Dl,n,r,7,s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],Pl[0],Pl[1],Pl[2],Pl[3],a,o,i,t);s[0]=l^v,s[1]=h^m,s[2]=c^_,s[3]=u^y,s[4]=d^b,s[5]=p^w,s[6]=f^R,s[7]=g^T}compress(e,t=0,r=!1){let n=this.flags;if(this.chunkPos||(n|=1),(15===this.chunkPos||r)&&(n|=2),r||(this.pos=this.blockLen),this.b2Compress(this.chunksDone,n,e,t),this.chunkPos+=1,16===this.chunkPos||r){let e=this.state;this.state=this.IV.slice();for(let t,n=this.chunksDone+1;(r||!(1&n))&&(t=this.stack.pop());n>>=1)this.buffer32.set(t,0),this.buffer32.set(e,8),this.pos=this.blockLen,this.b2Compress(0,4|this.flags,this.buffer32,0),e=this.state,this.state=this.IV.slice();this.chunksDone++,this.chunkPos=0,this.stack.push(e)}this.pos=0}_cloneInto(e){e=super._cloneInto(e);const{IV:t,flags:r,state:n,chunkPos:s,posOut:i,chunkOut:a,stack:o,chunksDone:l}=this;return e.state.set(n.slice()),e.stack=o.map((e=>Uint32Array.from(e))),e.IV.set(t),e.flags=r,e.chunkPos=s,e.chunksDone=l,e.posOut=i,e.chunkOut=a,e.enableXOF=this.enableXOF,e.bufferOut32.set(this.bufferOut32),e}destroy(){this.destroyed=!0,this.state.fill(0),this.buffer32.fill(0),this.IV.fill(0),this.bufferOut32.fill(0);for(let e of this.stack)e.fill(0)}b2CompressOut(){const{state:e,pos:t,flags:r,buffer32:n,bufferOut32:s}=this,{h:i,l:a}=wl(BigInt(this.chunkOut++)),{v0:o,v1:l,v2:h,v3:c,v4:u,v5:d,v6:p,v7:f,v8:g,v9:v,v10:m,v11:_,v12:y,v13:b,v14:w,v15:R}=Al(Dl,0,n,7,e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],Pl[0],Pl[1],Pl[2],Pl[3],a,i,t,r);s[0]=o^g,s[1]=l^v,s[2]=h^m,s[3]=c^_,s[4]=u^y,s[5]=d^b,s[6]=p^w,s[7]=f^R,s[8]=e[0]^g,s[9]=e[1]^v,s[10]=e[2]^m,s[11]=e[3]^_,s[12]=e[4]^y,s[13]=e[5]^b,s[14]=e[6]^w,s[15]=e[7]^R,this.posOut=0}finish(){if(this.finished)return;this.finished=!0,this.buffer.fill(0,this.pos);let e=8|this.flags;this.stack.length?(e|=4,this.compress(this.buffer32,0,!0),this.chunksDone=0,this.pos=this.blockLen):e|=2|(this.chunkPos?0:1),this.flags=e,this.b2CompressOut()}writeInto(e){ml(this,!1),vl(e),this.finish();const{blockLen:t,bufferOut:r}=this;for(let n=0,s=e.length;n<s;){this.posOut>=t&&this.b2CompressOut();const i=Math.min(t-this.posOut,s-n);e.set(r.subarray(this.posOut,this.posOut+i),n),this.posOut+=i,n+=i}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible after digest call");return this.writeInto(e)}xof(e){return gl(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(_l(e,this),this.finished)throw new Error("digest() was already called");return this.enableXOF=!1,this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}}const Ol=kl((e=>new Ml(e)));var ql=e=>(e=>{var t=[];e.forEach((e=>{t.push(String.fromCharCode(e))}));var r=t.join("");return self.btoa(r)})(Ol(e)),Ul=r(269),Bl=r.n(Ul),Nl=r(10),Fl=r.n(Nl);var $l=(e,t)=>{var r=function(e,t,r,n,s,i){var a=new URL(n),o=s||Date.now(),l=void 0===i?Math.floor(1e9*Math.random()):i,h=`GET ${a.pathname}${a.search} HTTP/1.1\n${o}\n${a.host}\n${r}\n`,c=Fl()(h,t);return{Authorization:`MAC kid=${e} ts=${o} seq-nr=${l} mac=${Bl().stringify(c)} h=host:x-package`,"x-package":r}}(t.xp2pAppId,t.xp2pAppKey,t.xp2pPackage,e),n=new Ga;return n.configure(e,{msTimeout:3e3,maxRetryTimes:1},{headers:r}),n.send()},jl="ok",Hl="not_found",Gl="auth_fail",Vl="other_code",zl="timeout",Wl="error";class Xl{constructor(){this._hashInfo=new Map,this._succReq=new Map}configure(e){this._config=e}destroy(){this._hashInfo.clear(),this._succReq.clear()}validateTs(e,t){var r=this._getTSHashFromMeta(e);if(r){var n=(e=>{for(var t=[],r=131072,n=Math.ceil(e.byteLength/r),s=0;s<n;s++){var i=ql(e.slice(s*r,(s+1)*r));t.push(i)}return ql(t.join(""))})(t);return r===n}}hasMeta(e){return this._succReq.has(e)}requestMeta(e){var t=this,r=e.m3u8Url,n=e.level;return J(Z().mark((function e(){var s,i,a;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t._config){e.next=2;break}return e.abrupt("return","");case 2:if(!t._succReq.has(n)){e.next=4;break}return e.abrupt("return","");case 4:return s=t._createMetaUrl(r),e.prev=5,e.next=8,$l(s,{xp2pAppId:t._config.xp2pAppId,xp2pAppKey:t._config.xp2pAppKey,xp2pPackage:t._config.xp2pPackage});case 8:if(404!==(i=e.sent).status){e.next=11;break}return e.abrupt("return",Hl);case 11:if(403!==i.status){e.next=13;break}return e.abrupt("return",Gl);case 13:if(i.ok){e.next=15;break}return e.abrupt("return",Vl);case 15:return e.next=17,i.json();case 17:if(!(a=e.sent)){e.next=22;break}return t._parseMetaInfo(a),t._succReq.set(n,r),e.abrupt("return",jl);case 22:e.next=28;break;case 24:return e.prev=24,e.t0=e.catch(5),e.abrupt("return",Wl);case 28:case"end":return e.stop()}}),e,null,[[5,24]])})))()}_getTSHashFromMeta(e){var t,r=this._createResId(e);return null===(t=this._hashInfo.get(r))||void 0===t?void 0:t.digest}_parseMetaInfo(e){var t=e.blocks;t&&t.length&&t.forEach((t=>{var r=(0,C.buildAbsoluteURL)(e.path,t.path),n=this._createResId(r);this._hashInfo.set(n,t)}))}_createMetaUrl(e){var t=this._createResId(e);return`${this._config.metaServerUrl}?xresid=${t}&appid=${this._config.xp2pAppId}&path=${self.btoa(e)}`}_createResId(e){var t=this._config,r=t.channelIdIncludeHost;return _(e,{channelIdIncludeSearch:t.channelIdIncludeSearch,channelIdIncludeHost:r})}}var Kl=new class{constructor(){this._validator=new Xl,this._retryTimer=new Map,this._confReady=!1,this._metaReqCtx=new Map}init(e){e.on("player_level",(e=>{var t=e.level;this._isValidateEnable()&&this._confReady&&(this._retryTimer.has(t)||this._requestSingleLevelMeta(t))})),e.on(T.FRAG_LOADED,(e=>{var t=e.id,r=e.binaryData,n=sn.fromId(t);this._isValidateEnable()&&this._validator.hasMeta(n.level)&&this._verifyCDNData(t,new Uint8Array(r))})),e.on(T.FRAG_LOADED_P2P,(e=>{var t=e.id;this._confReady&&this._isValidateEnable()&&this._verifyP2PData(t)})),e.once(T.CONF_PARSED,(()=>{this._confReady=!0,this._isValidateEnable()&&(tn.registerModule("ValidateController",this.reportCallback.bind(this)),this.initReport(),this._validator.configure({xp2pPackage:l.domain,xp2pAppId:l.xp2pAppId,xp2pAppKey:l.xp2pAppKey,channelIdIncludeHost:l.channelIdIncludeHost,channelIdIncludeSearch:l.channelIdIncludeSearch,metaServerUrl:l.metaServerUrl}),this._requestSingleLevelMeta(D.curReqLevel))}))}destroy(){this._retryTimer.forEach((e=>{clearTimeout(e)})),this._retryTimer.clear(),this._metaReqCtx.clear(),this._validator.destroy()}_requestSingleLevelMeta(e){var t=Vn.m3u8UrlList.getM3U8(e);t&&(this._validator.hasMeta(e)||(this._metaReqCtx.set(t,{startTime:Date.now()}),this._reportData[fr]+=1,this._validator.requestMeta({m3u8Url:t,level:e}).then((e=>{e===jl&&this._metaReqCtx.has(t)&&(this._reportData[yr]=Date.now()-this._metaReqCtx.get(t).startTime,this._metaReqCtx.delete(t));var r={[jl]:mr,[Gl]:vr,[Hl]:gr,[Wl]:_r,[zl]:_r,[Vl]:_r}[e];r&&(this._reportData[r]+=1)})),this._createRetryTimer(e)))}_createRetryTimer(e){if(!this._retryTimer.has(e)){var t=setTimeout((()=>{this._requestSingleLevelMeta(e)}),l.metaRetryDelay);this._retryTimer.set(e,t)}}_isValidateEnable(){return"VOD"===l.videoType&&l.enableValidateTS}_verifyP2PData(e){this._reportData[br]+=1;var t=ln.get(e),r=sn.fromId(e),n=Vn.getTSInfo(r.level,r.sn);if(t&&n){var s=t.arrayBuffer(),i=(0,C.buildAbsoluteURL)(n.baseUrl,n.originalUrl);if(!this._validator.validateTs(i,new Uint8Array(s))){var a=this._validator.hasMeta(r.level)?wr:Rr;this._reportData[a]+=1,ln.delete(e)}}}_verifyCDNData(e,t){this._reportData[br]+=1;var r=sn.fromId(e),n=Vn.getTSInfo(r.level,r.sn),s=(0,C.buildAbsoluteURL)(n.baseUrl,n.originalUrl);this._validator.validateTs(s,t)||(this._reportData[Tr]+=1)}initReport(){this._reportData={[fr]:0,[vr]:0,[gr]:0,[mr]:0,[_r]:0,[br]:0,[Tr]:0,[wr]:0,[Rr]:0,[Cr]:this._isValidateEnable()?1:0}}reportCallback(){var e=this._reportData;return this.initReport(),"VOD"===l.videoType?e:{}}};const Yl=Kl;var Jl=e=>{var t=Fr.encrypt(JSON.stringify(e)),r=new XMLHttpRequest;r.open("POST",l.reportServer),r.send(t)};class Ql{static get version(){return zr}static isSupported(e){var t=No.supportMSEH264Playback()&&No.supportP2P()&&No.supportES();if(!t)try{((e,t,r,n)=>{if(e){var s=e.enableReportUnsupportedFeature,i=e.videoType,a=e.xp2pAppId,o=e.url;if(s&&i&&a&&o&&-1!==["LIVE","VOD"].indexOf(i)){var l=function(e,t){var r=0;return e.supportArrayFeature()||(r|=t.ES.arrayFeature),e.supportRestParam()||(r|=t.ES.restParam),e.supportWebSocket()||(r|=t.p2p.websocket),e.supportDataType()||(r|=t.p2p.typeArray),e.supportObjectURL()||(r|=t.p2p.objectUrl),e.supportRTCPeerConnection()||(r|=t.p2p.peerConnection),e.supportDataChannel()||(r|=t.p2p.datachannel),e.supportMSE()||(r|=t.playback.mse),e.supportMSEH264Playback()||(r|=t.playback.h264codec),r}(t,r),h=Jr();h.video_type=i.toLowerCase(),h.str_video_type=i.toLowerCase(),h.url=o,h.partner=a,h.i.unsupported_feature=l,n(h)}}})(e,No,Bo,Jl)}catch(e){window.console.warn("[HLSP2P] unsupported feature report error")}return t}static isSupportedInServiceWorker(){return No.supportP2P()&&No.supportES()&&No.supportReadableStream()&&No.supportServiceWorker()}static get Events(){return{Rollback:"rollback",Log:"log"}}static get uuid(){return Yr()}static create(e,t){var n=Object.assign({},t||{});n.url=e.url,r.g.hlsp2p&&r.g.hlsp2p.destroy();{class e{constructor(){this.liveInfo={domain:"h5hls.live.cntv.com",xp2pAppId:"5fa933e724f48fed55245e05",cloudAppId:1252894780},this.vodInfo={domain:"h5hls.cntv.com",xp2pAppId:"5c8a0fa57a9b23480f6ea0ed",xp2pAppKey:"P9v3R0M4JeMsCtmb",cloudAppId:1252894780,channelIdIncludeHost:!1,channelIdIncludeSearch:!1}}createConfig(e){if("LIVE"===e.videoType)return this.liveInfo.channelId=this.extractLiveChannelId(e.url),this.liveInfo;var t=this.vodInfo,r=t.channelIdIncludeHost,n=t.channelIdIncludeSearch;return this.vodInfo.channelId=_(e.url,{channelIdIncludeHost:r,channelIdIncludeSearch:n}),this.vodInfo}extractLiveChannelId(e){var t=`${e.split("/")[e.split("/").length-2]}_${e.split("/")[e.split("/").length-1].split(".")[0]}`;return`${new URL(e).host.replace(/\./g,"")}_${t}`}}var s=(new e).createConfig(n);Object.assign(n,s)}var i=new Ql(e,n);return r.g.hlsp2p=i,i}static createCommon(e){var t=Object.assign({},e);r.g.hlsp2p&&r.g.hlsp2p.destroy();{class e{constructor(){this.liveInfo={domain:"h5hls.live.cntv.com",xp2pAppId:"5fa933e724f48fed55245e05",cloudAppId:1252894780},this.vodInfo={domain:"h5hls.cntv.com",xp2pAppId:"5c8a0fa57a9b23480f6ea0ed",xp2pAppKey:"P9v3R0M4JeMsCtmb",cloudAppId:1252894780,channelIdIncludeHost:!1,channelIdIncludeSearch:!1}}createConfig(e){if("LIVE"===e.videoType)return this.liveInfo.channelId=this.extractLiveChannelId(e.url),this.liveInfo;var t=this.vodInfo,r=t.channelIdIncludeHost,n=t.channelIdIncludeSearch;return this.vodInfo.channelId=_(e.url,{channelIdIncludeHost:r,channelIdIncludeSearch:n}),this.vodInfo}extractLiveChannelId(e){var t=`${e.split("/")[e.split("/").length-2]}_${e.split("/")[e.split("/").length-1].split(".")[0]}`;return`${new URL(e).host.replace(/\./g,"")}_${t}`}}var n=(new e).createConfig(t);Object.assign(t,n)}var s=new Ql(null,t);return r.g.hlsp2p=s,s}constructor(e,t){this.TAG="HLSP2P",this.initLogger(t.logLevel),c().setLevel(t.loglevel||"warn"),c().info(`[${this.TAG}] init`),o(),A(),D.hlsjs=e,Ql.initConfig(t),this.initCore(),this.initModules(),this.p2pStats=new el,this.trigger(R.NOR_REPORT_START),setTimeout((()=>{X.info(`[初始化], uuid: ${Ql.uuid}, version: ${Ql.version}`)})),this._startP2PModuleTimer=null}destroy(){c().info(`${this.TAG} ### destroy`),X.info(`[destroy], uuid: ${Ql.uuid}`),this._destroyed?c().warn(`${this.TAG} Repeated  destroy`):(X.destroy(),fn.destroy(),this._destroyed=!0,Zo&&Zo.destroy(),this.modules.forEach((e=>{e.destroy()})),this.modules=[],this.core.forEach((e=>{e.destroy()})),this.core=[],l.enableServiceWorker&&fl.destroy(),Ql.aegis&&(Ql.aegis.destroy(),Ql.aegis=null),this._startP2PModuleTimer&&clearTimeout(this._startP2PModuleTimer),o(),A())}static initConfig(e){new b(e).process()}initLogger(e){X.init(this).setLevel(e||""),fn.init({uuid:Ql.uuid,version:Ql.version,logPrefix:"HLSP2P",platform:"H5-HLS"}),fn.enable(),X.setNext(fn)}initCore(){this.core=[];var e=new s;this.on=e.on.bind(e),this.off=e.off.bind(e),this.once=e.once.bind(e),this.trigger=e.trigger.bind(e),this.core.push(e)}initModules(){if(this.modules=[],tn.init(this),this.modules.push(tn),this.modules.push(X),Vn.init(this),D.hlsjs){var e=this.hlsjsAdapter;e.init(this,D.hlsjs),this.modules.push(e)}else jn.init(this),jn.load(l.url).catch((e=>{this._destroyed||jn.load(l.url)})),this.modules.push(jn);this.once(R.CONF_PARSED,(()=>{l.enableServiceWorker&&fl.init(this)})),ln.init(this),yn.init(this),qo.init(this),Yl.init(this),this.modules.push(ln,yn,Vn,qo,Yl),this._startP2PModuleTimer=setTimeout((()=>{this.modules.length&&(Ao.init(this),this.initRTLogger(),this.modules.push(Ao))}),l.p2pStartDelay),D.cdnEstimate=new Go,D.p2pEstimate=new zo}initRTLogger(){this.on(R.CONF_PARSED,(()=>{l.enableRTLog?(fn.setLevel(l.rtLogLevel),fn.start({reportInterval:5e3})):fn.disable()})),this.on(R.CONF_PARSED,(()=>{l.enableAegis&&(Ql.aegis||l.aegisId&&(Ql.aegis=new(Ho())({id:l.aegisId,uin:Yr(),version:Ql.version,onError:!0,webVitals:!1,speedSample:!1,reportApiSpeed:!1,reportAssetSpeed:!1,pagePerformance:!1})))}))}get hlsjsAdapter(){return this._destroyed?(window.console.error("[hlsp2p] sdk已调用destroy, 不可再使用"),null):(D.curPlayerAdapter=Tn,Tn)}get commonLoader(){return D.hlsjs?(window.console.error("[hlsp2p] 初始化已经绑定了hls.js, 不可使用通用loader"),null):this._destroyed?(window.console.error("[hlsp2p] sdk已调用destroy, 不可再使用"),null):(D.curPlayerAdapter=$o,$o)}attachVhsPlayer(e){return this._destroyed?(window.console.error("[hlsp2p] [attachVhsPlayer] sdk已调用destroy, 不可再使用"),!1):e?Zo.attachVhs(e):(window.console.error("[hlsp2p] [attachVhsPlayer] 传入的vhs实例为空"),!1)}get hconfig(){return l}get peerConnected(){return Ao.peerConnected}get downloadBytes(){return ln.downloadBytes}getStats(){return Object.assign(this.p2pStats.getStats(),ln.stat.getStats())}get trackerConnected(){return Ao.trackerConnected}}const Zl=Ql})(),n=n.default})()));
//# sourceMappingURL=hlsp2p_cntv@1.6.37.js.map