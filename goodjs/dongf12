var fundMiniSearch_fundZCGReportDate = ""; var FundMiniSearch = function (json) { if (!window.jQuery) { return null } this.input = json.input; this.el = $(json.input); this.linkfont = json.linkfont || ""; this.searchBoxType = json.searchBoxType || 1; this.infoBoxId = json.infoBoxId || "fundMiniSearchResult"; this.adjustPositionL = json.adjustPositionL || 0; this.adjustPositionT = json.adjustPositionT || 0; this.layer = $("#" + this.infoBoxId); this.bd = $("body"); this.keyboardcontrol = false; this.elv = ""; this.button = $(json.button) || null; this.placehold = json.placeholder || ""; this.form = $(json.form) || null; this.init() }; FundMiniSearch.prototype = { init: function () { var _this = this; this.initParams(); this.el.attr("autocomplete", "off"); this.el.val(this.placehold); this.el.css("color", "#757575"); this.layer.remove(); this.bd.append('<div  id="' + this.infoBoxId + '" style="display:none;width:386px;padding:10px;font-family: simsun;font-size: 12px;position: absolute;padding: 5px; border: 1px solid #ccc;z-index: 9999; background-color: #fff;top: 22px;left: 10px;"><div style="width:100%;height:16px;"><span id="fundMiniSearch_tagName" style="background: url(//j5.dfcfw.com/image/201804/20180425145049.png) no-repeat;padding-left: 23px;background-position: -66px -10px;font-weight: bold;display: inline-block;height: 16px;line-height: 16px;"></span><div id="search_moreSc2" style="float:right"><a  id="search_moreSc" href="javascript:;" target="_blank" style="cursor: pointer;color:#003598;text-decoration: none;">查看更多&gt&gt</a></div></div><div  style="margin-top:10px;min-height:35px" class="result"><table  style="border-collapse: collapse;width: 100%;"><tbody></tbody></table></div></div>'); this.bind(); this.form.attr("action", "//fund.eastmoney.com/data/SearchDirect.aspx"); this.form.append("<input  name=\"url\" style=\"display:none\" />") }, initParams: function () { var arrSeachBoxType = ["fund", "stock", "manager", "fundStock"]; this.apiinterface = this.Configinfo[arrSeachBoxType[this.searchBoxType - 1]].apiUrl || "//fundsuggest.eastmoney.com/FundCodeNew.aspx"; this.linkfont = this.Configinfo[arrSeachBoxType[this.searchBoxType - 1]].linkFont || fundMiniSearch_fundZCGReportDate }, getZCGReportUrl: function () { _this = this; if (_this.searchBoxType == 4 && fundMiniSearch_fundZCGReportDate == "") { $.ajax({ url: "//api.fund.eastmoney.com/JJZCG/GetReportDate?key=9D8893C1EB404C7E99CB9B9B62078C31", dataType: "jsonp", type: "get", success: function (data) { fundMiniSearch_fundZCGReportDate = "http://data.eastmoney.com/zlsj/detail/" + data + "-1-" } }) } }, focus: function (el, _this, e) { this.nowel = el; if (el.val() == this.placehold) { el.val(""); _this.hideInfo() } else { _this.requireInfo(el) } this.el.css("color", "#000"); return false }, blur: function (el) { if (el.val() == "") { el.val(this.placehold); this.el.css("color", "#757575") }; return false }, keyType: function (code) { switch (code) { case 38: return "up"; break; case 40: return "down"; break; case 37: return "left"; break; case 39: return "right"; break; case 13: return "enter"; break } }, keyup: function (e, el) { var _this = this; var el = this.el; var keyState = this.keyType(e.keyCode) || "other"; if (keyState == "up" || keyState == "down" || keyState == "enter") { this.keyboardcontrol = true; var active = $("#" + this.infoBoxId + " tbody tr.on"); var tr = $("#" + this.infoBoxId + " tbody tr"); var index = active.index() <= -1 ? -1 : active.index(); var length = tr.length; active.css("background-color", "#ffffff"); active.removeClass("on"); this.bd.off("mouseover"); switch (keyState) { case "up": index = index < 0 ? length - 1 : index - 1; var funCode = tr.eq(index).data("manager") || tr.eq(index).data("value"); $("#fundJJ_search:focus").attr("data-manager", funCode); break; case "down": index = index >= (length - 1) ? 0 : index + 1; var funCode = tr.eq(index).data("manager") || tr.eq(index).data("value"); $("#fundJJ_search:focus").attr("data-manager", funCode); break; case "enter": index = index < 0 ? 0 : index; el.blur(); this.hideInfo(); if (this.searchBoxType != 2) { var funCode = tr.eq(index).data("manager") || tr.eq(index).data("value"); var urlFont = ""; if (this.searchBoxType == 4) { urlFont = fundMiniSearch_fundZCGReportDate } else if (this.linkfont) { urlFont = this.linkfont + "" } if (!funCode) return; _this.WindowOpenUrl(urlFont + funCode + ".html") } else if (this.searchBoxType == 2) { var funCode = tr.eq(index).data("value"); var stockid = tr.eq(index).data("stockid"); if (!funCode) return; var stockType = tr.eq(index).data("stocktype") || ""; var stockClass = tr.eq(index).data("stockclass") || ""; this.marktypeLink(stockid) } break }var target = tr.eq(index); if (this.searchBoxType == 3) { el.val(target.find("td").eq(1).text()) } else { el.val(target.data("value")) } target.addClass('on'); target.css("background-color", "#FDECE3") } else { this.elv = this.el.val(); el.val(this.CtoH(el.val())); if (el.val() != "") { this.requireInfo(el) } else { this.ifEmpty() } $("#fundJJ_search:focus").attr("data-manager", ""); this.setData($("input:focus")) } return false }, hover: function (_this) { var el = _this.el; var trSelecter = "#" + _this.infoBoxId + " tr"; _this.bd.on("mouseover", trSelecter, function () { var _t = $(this).find("td").eq(1).text(); $("#fundMiniSearchResult table tr").css("background-color", "#ffffff"); $(this).css("background-color", "#FDECE3"); $(this).addClass("on"); if ($(this).find("th").length == 0) { $("input:focus").val(_t); var index = $("#" + _this.infoBoxId + " tbody tr.on").index(); $("#fundJJ_search:focus").attr("data-manager", $(this).data("value")); return false } }) }, bind: function () { var _this = this; var el = this.el; el.on("focus", function () { _this.focus(el, _this) }); el.on("blur", function () { _this.blur(el) }); el.on("keyup", function (e) { _this.keyup(e, el) }); this.bd.on("click", function (e) { var _inp = $("input:focus"); if (!_inp.is(e.target) && (_inp.has(e.target).length === 0)) { _this.hideInfo() } }); this.bd.on("mousemove", function () { if (_this.keyboardcontrol) { _this.hover(_this); _this.keyboardcontrol = false } }); this.bindButtonClik() }, setData: function (el) { el.attr("data-codeIndex", el.val()); var tr = $("#" + this.infoBoxId + " tbody tr"); if (this.nowel) { var fc = tr.eq(0).data("value") || tr.eq(0).text(); this.nowel.attr("data-fcode", fc) } }, requireInfo: function (el) { var _this = this; var sendKey = el.val(); if (!sendKey && sendKey.length == 0) { return } var resultSelect = "#" + this.infoBoxId + " .result"; if ($(resultSelect + " table").length == 0) { $(resultSelect).html('<table style="width:100%;border-collapse: collapse;"><tbody></tbody></table>'); $(resultSelect).width("100%") }; switch (_this.searchBoxType) { case 1: { $.ajax({ type: "get", async: true, url: _this.apiinterface + "?input=" + sendKey + "&count=10", dataType: "jsonp", jsonp: "cb", success: function (json) { _this.injection(json) }, error: function (json) { } }); break } case 4: { if (fundMiniSearch_fundZCGReportDate == "") { $.ajax({ url: "//api.fund.eastmoney.com/JJZCG/GetReportDate?key=9D8893C1EB404C7E99CB9B9B62078C31", dataType: "jsonp", type: "get", success: function (data) { fundMiniSearch_fundZCGReportDate = "http://data.eastmoney.com/zlsj/detail/" + data + "-1-"; var url = _this.apiinterface + "?input=" + encodeURIComponent(sendKey) + "&type=14&markettype=&mktnum=&jys=&classify=AStock,BStock&securitytype=&count=10&token=D2647228E1AF937BC329C93B78B2AA9D&cb=?"; $.getJSON(url, function (data) { if (data && data.QuotationCodeTable) { _this.injection(data.QuotationCodeTable.Data) } }) } }) } else { var url = _this.apiinterface + "?input=" + encodeURIComponent(sendKey) + "&type=14&markettype=&mktnum=&jys=&classify=AStock,BStock&securitytype=&count=10&token=D2647228E1AF937BC329C93B78B2AA9D&cb=?"; $.getJSON(url, function (data) { if (data && data.QuotationCodeTable) { _this.injection(data.QuotationCodeTable.Data) } }) } break } case 2: { var url = _this.apiinterface + "?input=" + encodeURIComponent(sendKey) + "&type=14&markettype=&mktnum=&jys=&classify=&securitytype=&count=10&token=D2647228E1AF937BC329C93B78B2AA9D&cb=?"; $.getJSON(url, function (data) { if (data && data.QuotationCodeTable) { _this.injection(data.QuotationCodeTable.Data) } else { } }); break } case 3: { $.getJSON(_this.apiinterface + "?callback=?&m=7&key=" + sendKey, function (json) { var sdata = json.Datas; _this.injection(sdata) }); break } } }, showInfo: function (e) { var el = this.el; var infoX = el.offset().left; var infoY = el.offset().top + el.outerHeight(); var infoBox = $("#" + this.infoBoxId); infoBox.css({ "left": infoX + this.adjustPositionL, "top": infoY + this.adjustPositionT }).show(); if (this.searchBoxType == 2 || this.searchBoxType == 4) { } else if (this.searchBoxType == 3) { infoBox.find(".hc1").text("姓名"); infoBox.find(".hc2").text("简拼").css({ 'padding-left': 0 }); infoBox.find(".c2").css({ "text-align": "center" }); infoBox.find(".hc2").css({ "text-align": "center" }) } this.hover(this); this.openLink(e) }, hideInfo: function () { var el = this.el; $("#" + this.infoBoxId).hide() }, injection: function (j) { var _this = this; var el = this.el; $("#" + _this.infoBoxId).find("tbody").empty(); var stockType = ''; var stockClass = ''; var arr, fundCode, fundCode2, funNameOriginal, nameJP, typeName, id; var resultSelect = "#" + this.infoBoxId + " .result"; if (j == null || j.length < 1 || (j.length == 1 && j[0] == "")) { $(resultSelect).html("<p style='background: url(//j5.dfcfw.com/image/201804/20180425145049.png) no-repeat;height:35px;width:40px;margin: auto;;background-position: -1px -5px'></p><div style='text-align:center;font-weight:bold;padding:5px;'>未能搜索到符合条件的结果</div>") } else { $.each(j, function (i, c) { if (c == "") return; switch (_this.searchBoxType) { case 1: arr = c.split(","); fundCode = fundCode2 = arr[0]; funNameOriginal = _this.subStr(arr[2]); nameJP = arr[1]; typeName = _this.getTypeName(); break; case 4: case 2: fundCode = fundCode2 = c.Code; funNameOriginal = _this.subStr(c.Name); stockType = c.MarketType; stockClass = c.SecurityType; nameJP = c.PinYin.toUpperCase(); typeName = c.SecurityTypeName; id = c.ID; break; case 3: fundCode = c.MgrId; fundCode2 = c.MgrName; nameJP = funNameOriginal = c.AbbName; stockType = stockClass = "no"; typeName = _this.getTypeName() }var funName = !!funNameOriginal ? funNameOriginal.replace(el.val(), '<span style="color:#EA5404">' + el.val() + '</span>') : el.val(); var funkey = !!fundCode2 ? fundCode2.replace(el.val(), '<span style="color:#EA5404">' + el.val() + '</span>') : el.val(); nameJP = !!nameJP ? nameJP.replace(el.val().toUpperCase(), '<span style="color:#EA5404">' + el.val().toUpperCase() + '</span>') : el.val().toUpperCase(); if (_this.searchBoxType == 3) { $("#" + _this.infoBoxId).find("tbody").append('<tr style="cursor: pointer;" data-value=' + fundCode + ' data-stocktype=' + stockType + ' data-stockclass=' + stockClass + '><td style="color:#8f8f8f; line-height: 20px;height: 20px;padding-left: 5px;text-align: left">' + typeName + '</td><td style="line-height: 20px;height: 20px;padding-left: 5px;text-align: left">' + funkey + '</td><td style="line-height: 20px;height: 20px;padding-left: 5px;text-align: left">' + nameJP + '</td></tr>') } else { $("#" + _this.infoBoxId).find("tbody").append('<tr style="cursor: pointer;" data-value=' + fundCode + ' data-stocktype=' + stockType + ' data-stockId=' + id + '  data-stockclass=' + stockClass + '><td  style="color:#8f8f8f; line-height: 20px;height: 20px;padding-left: 20px;text-align: left">' + typeName + '</td><td style="line-height: 20px;height: 20px;padding-left: 5px; text-align: left">' + funkey + '</td><td style="line-height: 20px;height: 20px;padding-left: 5px; text-align: left">' + funName + '</td><td style="line-height: 20px;height: 20px;padding-left: 5px; text-align: left">' + nameJP + '</td></tr>') } }) } _this.showInfo(); this.setData(el); var searchKey = el.val(); if (_this.searchBoxType == 1) { $("#search_moreSc").attr("href", 'http://fund.eastmoney.com/data/fundsearch.html?spm=search&key=' + (searchKey)) } else if (_this.searchBoxType == 3) { $("#search_moreSc").attr("href", 'http://fund.eastmoney.com/data/fundsearch.html?spm=search&key=' + (searchKey)) } else { $("#search_moreSc").attr("href", "http://quote.eastmoney.com/search.html?stockcode=" + encodeURIComponent(el.val())) } _this.setTagName() }, setTagName: function () { var _this = this; $("#fundMiniSearch_tagName").html(_this.getTagName()) }, CtoH: function (str) { var result = ""; for (var i = 0; i < str.length; i++) { if (str.charCodeAt(i) == 12288) { result += String.fromCharCode(str.charCodeAt(i) - 12256); continue } if (str.charCodeAt(i) > 65280 && str.charCodeAt(i) < 65375) { result += String.fromCharCode(str.charCodeAt(i) - 65248) } else { result += String.fromCharCode(str.charCodeAt(i)) } } return result }, ifEmpty: function () { var resultSelect = "#" + this.infoBoxId + " .result"; if (this.searchBoxType == 3) { $(resultSelect).html("例：输入“'<span style='color:#EA5404'>王宁</span>'”或“'<span  style='color:#EA5404'>wn</span>”") } else { $(resultSelect).html("请在搜索框内输入'<span  style='color:#EA5404'>代码</span>'、'<span  style='color:#EA5404'>名称</span>'或'<span  style='color:#EA5404'>简拼'</span>") } }, openLink: function (e) { var _this = this; var tr = "#" + this.infoBoxId + " tr"; var ol = function () { if ($(this).find("th").length > 0) return; var funCode = $(this).find("td").eq(1).text(); var urlFont = _this.linkfont + ""; var stockType = $(this).data("stocktype") || ""; var stockClass = $(this).data("stockclass") || ""; var stockid = $(this).data("stockid"); var _u; _this.hideInfo(); _this.el.blur(); switch (_this.searchBoxType) { case 1: _this.WindowOpenUrl(urlFont + funCode + ".html"); break; case 2: _this.marktypeLink(stockid); break; case 3: funCode = $(this).data("value"); _this.WindowOpenUrl(urlFont + funCode + ".html?spm=search"); break; case 4: if (fundMiniSearch_fundZCGReportDate && fundMiniSearch_fundZCGReportDate != "") { _this.WindowOpenUrl(fundMiniSearch_fundZCGReportDate + funCode + ".html") } break } }; if (this.linkfont != "" || _this.searchBoxType == 4) { $(tr).on("click", ol) } else { } }, marktypeLink: function (stockid) { if (stockid) { WindowOpenUrl("http://quote.eastmoney.com/web/r/" + stockid) } }, Configinfo: { "fund": { "apiUrl": "//fundsuggest.eastmoney.com/FundCodeNew.aspx", "linkFont": "http://fund.eastmoney.com/" }, "stock": { "apiUrl": "//searchapi.eastmoney.com/api/suggest/get", "linkFont": "http://quote.eastmoney.com/" }, "manager": { "apiUrl": "//fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx", "linkFont": "http://fund.eastmoney.com/manager/" }, "fundStock": { "apiUrl": "//searchapi.eastmoney.com/api/suggest/get", "linkFont": fundMiniSearch_fundZCGReportDate } }, getTypeName: function (stockMarket) { var _this = this; var arrTitle = ["基金", "股票", "基金经理", "股票"]; if (stockMarket) { return "股票" } else { return arrTitle[_this.searchBoxType - 1] } }, getTagName: function () { var _this = this; var arrTagName = ["相关证券", "相关证券", "基金经理", "相关证券"]; return arrTagName[_this.searchBoxType - 1] }, subStr: function (str) { if (str && str.length > 10) { return str.substring(0, 10) + "..." } return str }, bindButtonClik: function () { var _this = this; if (_this.button) { $(_this.button).attr("data-searchType", _this.searchBoxType); _this.button.on("click", function (e) { var dataSearchTpye = $(this).attr("data-searchtype"); var searchKey = _this.el.val().replace(_this.placehold, ""); var openUrl = ""; if (searchKey && searchKey.length > 0) { if (dataSearchTpye == 1) { openUrl = 'http://fund.eastmoney.com/data/fundsearch.html?spm=search&key=' + searchKey } else if (dataSearchTpye == 3) { openUrl = "http://fund.eastmoney.com/data/fundsearch.html?spm=search&key=" + searchKey + "#key" + searchKey } else if (dataSearchTpye == 4) { openUrl = "http://quote.eastmoney.com/search.html?stockcode=" + encodeURIComponent(searchKey) } else { openUrl = "http://fund.eastmoney.com" } } else { if (dataSearchTpye == 1) { openUrl = "http://fund.eastmoney.com/daogou/" } else if (dataSearchTpye == 3) { openUrl = "http://fund.eastmoney.com/manager/default.html" } else if (dataSearchTpye == 4) { openUrl = "http://data.eastmoney.com/zlsj/" } else { openUrl = "http://fund.eastmoney.com" } } _this.WindowOpenUrl(openUrl) }) } }, WindowOpenUrl: function (url) { try { window.open(url) } catch (ex) { } } }