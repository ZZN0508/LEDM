/**
 * @bilibili/bili-mirror 
 *  version:1.5.1. Powered by main-frotend 
 *  bilibili-前端上报、性能、错误监控sdk, 
 *  author:yuguangchao
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).biliMirror={})}(this,(function(e){"use strict";var t=function(){return t=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},t.apply(this,arguments)};function n(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function c(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((r=r.apply(e,t||[])).next())}))}function r(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}"function"==typeof SuppressedError&&SuppressedError;var o,i=!1;function a(){return!1===i&&(i="undefined"!=typeof window),i}var c=function(){if(a())return window}();function s(){if(a())return c.__biliMirror__=c.__biliMirror__||{},c.__biliMirror__}var u=a()&&(null===(o=document.getElementsByTagName("meta").spm_prefix)||void 0===o?void 0:o.content)||"0.0";function l(e,t,n,r){void 0===r&&(r=!1),e.addEventListener(t,n,r)}function f(){return Date.now()}var p=Object.prototype.toString;function d(e){return function(t){return p.call(t)==="[object ".concat(e,"]")}}var m={isNumber:d("Number"),isString:d("String"),isBoolean:d("Boolean"),isNull:d("Null"),isUndefined:d("Undefined"),isSymbol:d("Symbol"),isFunction:d("Function"),isObject:d("Object"),isArray:d("Array"),isProcess:d("process"),isWindow:d("Window")};function v(e){var t=/^[0-9a-zA-Z_-]+$/.test(e);return t||console.warn("字符串:".concat(e,",不符合条件,任意数字,字母、下划线、中划线组成")),t}function h(e,t){void 0===t&&(t=["chrome-extension"]);var n=(null==e?void 0:e.message)||(null==e?void 0:e.fileName)||"";if(!n)return!0;if((n=n.split("?")[0]).includes(location.hostname))return!0;if(!t.length)return!1;for(var r=!1,o=0;o<t.length;o++)if(n.match(t[o])){r=!0;break}return r}function g(e){if("0"===e)return 0;if(m.isNumber(e))return e>10?10:e<=0?1:e;if(m.isString(e)&&!isNaN(e)){var t=parseInt(e);return t>10?10:t<=0?1:t}return console.warn("mirror-kv-[config] sampling rate error,pleace set 1-10"),1}function y(e){return Math.floor(10*Math.random()+1)>e}function b(){return"undefined"==typeof document||null==document.location?"":document.location.href}function R(e){if(!e)return{};var t=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};var n=t[6]||"",r=t[8]||"";return{host:t[4],path:t[5],protocol:t[2],relative:t[5]+n+r}}function w(e,t,n,r){if(void 0===r&&(r=!1),void 0!==e&&(t in e||r)){var o=n(e[t]);"function"==typeof o&&(e[t]=o)}}var E="1.5.1",O="@bilibili/bili-mirror",S=E;function I(){return I=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},I.apply(this,arguments)}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var N,P,_,k=2592e6;!function(e){e[e.NON_STRICT=0]="NON_STRICT",e[e.STRICT=1]="STRICT"}(N||(N={})),function(e){e.KEY="key",e.GROUP="group",e.APP="app"}(P||(P={})),function(e){e.PV="333.1334.kv-init.pv",e.ERROR="333.1334.kv-init.error"}(_||(_={}));var C=new(function(){function e(){this.queue=[],this.reporter=void 0,this.loading=!1}var t=e.prototype;return t.loadScript=function(e,t){try{var n=document;return Promise.resolve(new Promise((function(r,o){var i,a=document.getElementById(e);a&&a.parentElement&&window.ReporterPb?r(""):((a=n.createElement("script")).onload=function(){return r("")},a.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||r("")},a.onerror=function(){return o("load report script error")},a.id=e,a.type="text/JavaScript",a.src=t,null==(i=n.querySelector("head"))||i.appendChild(a))})))}catch(e){return Promise.reject(e)}},t.init=function(){try{var e=this;return Promise.resolve(function(t,n){try{var r=function(){function t(){e.reporter=new window.ReporterPb({spmPrefix:"333.1334",sampleRate:1,autoPv:!1,retry:!1,feature:{tech:!0}}),e.loading=!1,e.reportQueue()}if(!e.reporter&&void 0!==typeof window&&!e.loading){e.loading=!0;var n=function(){if(!window.ReporterPb)return Promise.resolve(e.loadScript("kvReportDb","//s1.hdslb.com/bfs/seed/jinkela/short/reporter-pb/index.js")).then((function(){}))}();return n&&n.then?n.then(t):t()}}()}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}(0,(function(t){e.loading=!1,console.error(t)})))}catch(e){return Promise.reject(e)}},t.reportQueue=function(){if(this.reporter)for(var e,t=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return T(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?T(e,t):void 0}}(e))){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.queue);!(e=t()).done;){var n=e.value;this.report(n.event,n.value)}},t.report=function(e,t){void 0===t&&(t={});try{if(!this.reporter)return this.queue.push({event:e,value:t}),void this.init();var n=I({type:e===_.ERROR?"error":"custom"},t);this.reporter.tech(e,n)}catch(e){console.error(e)}},e}()),L="KV_CONFIG_SDK",A=function(){function e(e){var t=e.appKey,n=e.nscode;this.appKey=void 0,this.appKeyStorageName=void 0,this.appKey=t,this.appKeyStorageName=t+"_"+n,this.checkLocalStorage()}var t=e.prototype;return t.checkLocalStorage=function(){var t=e.getLocalStorage();if(t){for(var n in t){var r=(new Date).getTime();t[n].timestamp+t[n].expires<r&&delete t[n]}Object.keys(t).length>40&&Object.keys(t).sort((function(e,n){return t[e].lastUsed-t[n].lastUsed})).slice(40).forEach((function(e){delete t[e]})),e.setLocalStorage(t)}},t.getAppKey=function(){var t=e.getLocalStorage()||{};return t[this.appKeyStorageName]?(t[this.appKeyStorageName].lastUsed=(new Date).getTime(),e.setLocalStorage(t),t[this.appKeyStorageName]||{}):{}},t.setAppkey=function(t){var n=I({timestamp:(new Date).getTime(),lastUsed:(new Date).getTime()},t),r=e.getLocalStorage()||{};r[this.appKeyStorageName]=n,e.setLocalStorage(r)},e.getLocalStorage=function(){var e;try{(e=localStorage.getItem(L))&&(e=JSON.parse(e))}catch(t){console.error("从本地获取"+L+"的时候异常",t),e=void 0,C.report(_.ERROR,{message:"从本地获取"+L+"的时候异常"+(t.message||"")})}return e},e.setLocalStorage=function(e){try{localStorage.setItem(L,JSON.stringify(e))}catch(e){!function(e){var t=!1;if(e)if(e.code)switch(e.code){case 22:t=!0;break;case 1014:"NS_ERROR_DOM_QUOTA_REACHED"===e.name&&(t=!0)}else-2147024882===e.number&&(t=!0);return t}(e)?(console.log("storage 更新失败",e),C.report(_.ERROR,{message:"storage 更新失败"+(e.message||"")})):(console.log("storage 超出浏览器限制",e),C.report(_.ERROR,{message:"storage 超出浏览器限制"+(e.message||"")}))}},e}();function j(e,t,n){return new Promise((function(r,o){(function(e,t){return new Promise((function(n,r){var o=new XMLHttpRequest;function i(){if(o){var e,t,i=o.responseType,a=(e=o.getAllResponseHeaders().trim().split(/[\r\n]+/),t={},e.forEach((function(e){var n=e.split(": "),r=n.shift(),o=n.join(": ");r&&(t[r]=o)})),t);!o.status||o.status>=200&&o.status<=299?n({data:i&&"text"!==i?o.response:o.responseText,status:o.status,statusText:o.statusText,headers:a}):r(new Error("Request Error: "+o.status+" "+o.statusText)),o=null}}if(o.open((null==t?void 0:t.method)||"GET",e,!0),o.timeout=(null==t?void 0:t.timeout)||2e3,o.responseType=(null==t?void 0:t.responseType)||"json",o.onreadystatechange=function(){o&&4===o.readyState&&(0!==o.status||o.responseURL&&0===o.responseURL.indexOf("file:"))&&setTimeout(i)},o.onabort=function(){o&&(r(new Error("Request aborted: "+e)),o=null)},o.onerror=function(){r(new Error("Network Error: "+e)),o=null},o.ontimeout=function(){r(null!=t&&t.timeout?"Timeout exceeded: "+t.timeout:"Timeout exceeded"),o=null},o.withCredentials=(null==t?void 0:t.withCredentials)||!1,null!=t&&t.headers)for(var a in t.headers)o.setRequestHeader(a,t.headers[a]);o.send((null==t?void 0:t.data)||null)}))})(function(e,t,n){void 0===t&&(t={});var r=t?Object.keys(t).map((function(e){return e+"="+t[e]})).join("&"):"";return""+((null==n?void 0:n.baseURL)||window.location.protocol+"//"+"api.YmlsaWJpbGk=.com".split(".").map((function(e,t){return 1===t?window.atob(e):e})).join("."))+e+(r?"?"+r:"")}(e,t,n),{method:"GET"}).then((function(e){var t=e.data,n=void 0===t?{}:t;0===n.code?r(n):o(n)}),(function(e){o(e)})).catch((function(e){o(e)}))}))}function x(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var K=function(){function e(e){this.options={appKey:"",apiURL:"",nscode:0,expires:k,strict:N.STRICT},this.storage=void 0,this.fetchPromise=void 0,this.flattenValue={},this.nestedValue={};var t=e.appKey,n=e.expires,r=void 0===n?k:n;if(!t)return C.report(_.ERROR,{message:"no appkey passed"}),void console.warn("appKey is required");this.options=I({},this.options,e,{expires:Math.min(r,k)}),this.storage=new A({appKey:t,nscode:this.options.nscode});var o=this.storage.getAppKey(),i=o.versionId;this.updateValue(o.value||{}),(this.options.strict!==N.NON_STRICT||e.autoFetch)&&(this.fetchPromise=this.fetchAppKey(i)),this.report(_.PV)}var t=e.prototype;return t.getAll=function(){try{return Promise.resolve(this.getBase(P.APP))}catch(e){return Promise.reject(e)}},t.getGroup=function(e){try{return Promise.resolve(this.getBase(P.GROUP,e))}catch(e){return Promise.reject(e)}},t.get=function(e){try{return Promise.resolve(this.getBase(P.KEY,e))}catch(e){return Promise.reject(e)}},t.getBase=function(e,t){void 0===t&&(t="");try{var n=this,r=function(){if(e===P.APP)return n.nestedValue;if(e===P.GROUP)return n.nestedValue[t]||{};var r=t.split("."),o=r[0];return n.nestedValue[o]?n.nestedValue[o][r[1]]:""};if(n.options.strict===N.NON_STRICT||!n.options.appKey)return Promise.resolve(r());if(!n.fetchPromise){var o=n.storage.getAppKey();n.fetchPromise=n.fetchAppKey(o.versionId)}return Promise.resolve(n.fetchPromise.then((function(){return r()})))}catch(e){return Promise.reject(e)}},t.fetchAppKey=function(e){try{var t=this,n=t.options,r=n.appKey,o=n.nscode,i=x((function(){return Promise.resolve(j("/x/kv-frontend/namespace/data",{appKey:r,versionId:e,nscode:o},{baseURL:t.options.apiURL})).then((function(e){var n=e.data;t.storage.setAppkey({value:n.data,versionId:n.versionId,appVersionId:n.appVersionId,nscode:o,appKey:t.options.appKey,expires:t.options.expires}),t.updateValue(n.data)}))}),(function(e){-304!==e.code&&t.report(_.ERROR,{message:e.message||e.msg||"获取失败"})}));return Promise.resolve(i&&i.then?i.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},e.updateLocalAppKey=function(e){try{return Promise.resolve(x((function(){var t=e.appKey,n=e.appVersionId,r=e.apiBaseURL,o=A.getLocalStorage();if(o){var i=Object.keys(o).filter((function(e){return o[e].appKey===t&&o[e].appVersionId!==n})).map((function(e){return o[e]}));if(i.length)return Promise.resolve(j("/x/kv-frontend/app/batchupdates",{appKey:t,batches:JSON.stringify(i.map((function(e){return{appVersionId:e.appVersionId,nscode:e.nscode}})))},{baseURL:r})).then((function(e){var n=e.data,r=A.getLocalStorage()||{};n.forEach((function(e){var n=t+"_"+e.nscode;if(e.deleted)delete r[n];else if(e.updated){var o={timestamp:(new Date).getTime(),value:e.data,versionId:e.versionId,appVersionId:e.appVersionId,nscode:e.nscode,appKey:t};r[n]=I({},r[n]||{},o)}})),A.setLocalStorage(r)}))}}),(function(e){-304!==e.code&&console.error(e)})))}catch(e){return Promise.reject(e)}},t.updateValue=function(e){var t=this;this.flattenValue=e;var n={};Object.keys(this.flattenValue).forEach((function(e){var r=e.split("."),o=r[0],i=r[1];n[o]||(n[o]={}),n[o][i]=t.flattenValue[e]})),this.nestedValue=n},t.report=function(e,t){void 0===t&&(t={}),C.report(e,I({appKey:this.options.appKey,nscode:this.options.nscode,sdkVersion:"1.2.7"},t))},e}(),H=s(),D="333.1333",U="bilimirror",M="whitelist",B=function(){function e(){this.origin="bili",this.module="common",this.config={},this._defaultConfigSDK=new K({appKey:D,strict:N.STRICT})}return e.prototype.fetchWhiteListConfig=function(e,t){var n=this;return new Promise((function(r,o){e.get(t).then((function(e){if(e){var t=JSON.parse(e);n.config.white=(null==t?void 0:t.white)||[],n.config["white-retry"]=(null==t?void 0:t.retry)||[],n.config["white-preformance-rate"]=t.performance?g(null==t?void 0:t.performance):1,n.config["poll-time"]=t.poll?g(null==t?void 0:t.poll):5,n.config["tech-pv"]=t.techpv?g(null==t?void 0:t.techpv):5,n.config["user-log"]=(null==t?void 0:t.userLog)||[],r(t)}else o()})).catch((function(e){o(e)}))}))},e.prototype.getConfig=function(){var e=this;return new Promise((function(t){var n,r,o=D,i=U,a=M,c=e.spmId||u;c!==o?(e._configSDK&&c===(null===(r=null===(n=e._configSDK)||void 0===n?void 0:n.options)||void 0===r?void 0:r.appKey)||(delete e._configSDK,e._configSDK=new K({appKey:c,strict:N.STRICT})),e.fetchWhiteListConfig(e._configSDK,"".concat(i,".").concat(a)).then((function(){t()})).catch((function(n){console.warn("bili-mirror:not find ".concat(c," kv-config,using base")),e.fetchWhiteListConfig(e._defaultConfigSDK,"".concat(i,".").concat(a)).then((function(){t()})).catch((function(e){t(),console.warn("bilimirror获取白名单配置失败")}))}))):e.fetchWhiteListConfig(e._defaultConfigSDK,"".concat(i,".").concat(a)).then((function(){t()})).catch((function(e){t(),console.warn("bilimirror获取白名单配置失败")}))}))},e.prototype.bindOptions=function(e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var t,n,o,i,a,c;return r(this,(function(r){switch(r.label){case 0:return H.mirrorVersion=S,t=e.origin,n=e.module,o=e.spmId,i=e.pbOptions,a=e.pbOtherNameIns,c=e.plugins,(null==t?void 0:t.length)&&(this.origin=t),(null==n?void 0:n.length)&&(this.module=n),(null==o?void 0:o.length)&&(this.spmId=o),i&&(this.pbOptions=i),a&&(this.pbOtherNameIns=a),c&&(this._pluginIns=c),[4,this.getConfig()];case 1:return r.sent(),[2,Promise.resolve("ok")]}}))}))},e}();var F=a()?H.options||(H.options=new B):null;function V(e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return a()?[4,F.bindOptions(e)]:[3,2];case 1:return[2,t.sent()];case 2:return[2]}}))}))}var J,W,G,q,$,Y,Q,X,z,Z,ee=-1,te=function(e){addEventListener("pageshow",(function(t){t.persisted&&(ee=t.timeStamp,e(t))}),!0)},ne=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},re=function(){var e=ne();return e&&e.activationStart||0},oe=function(e,t){var n=ne(),r="navigate";return ee>=0?r="back-forward-cache":n&&(document.prerendering||re()>0?r="prerender":document.wasDiscarded?r="restore":n.type&&(r=n.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:r}},ie=function(e,t,n){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var r=new PerformanceObserver((function(e){Promise.resolve().then((function(){t(e.getEntries())}))}));return r.observe(Object.assign({type:e,buffered:!0},n||{})),r}}catch(e){}},ae=function(e,t,n,r){var o,i;return function(a){t.value>=0&&(a||r)&&((i=t.value-(o||0))||void 0===o)&&(o=t.value,t.delta=i,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,n),e(t))}},ce=function(e){requestAnimationFrame((function(){return requestAnimationFrame((function(){return e()}))}))},se=function(e){var t=function(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},ue=function(e){var t=!1;return function(n){t||(e(n),t=!0)}},le=-1,fe=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},pe=function(e){"hidden"===document.visibilityState&&le>-1&&(le="visibilitychange"===e.type?e.timeStamp:0,me())},de=function(){addEventListener("visibilitychange",pe,!0),addEventListener("prerenderingchange",pe,!0)},me=function(){removeEventListener("visibilitychange",pe,!0),removeEventListener("prerenderingchange",pe,!0)},ve=function(){return le<0&&(le=fe(),de(),te((function(){setTimeout((function(){le=fe(),de()}),0)}))),{get firstHiddenTime(){return le}}},he=function(e){document.prerendering?addEventListener("prerenderingchange",(function(){return e()}),!0):e()},ge=[1800,3e3],ye=function(e,t){t=t||{},he((function(){var n,r=ve(),o=oe("FCP"),i=ie("paint",(function(e){e.forEach((function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<r.firstHiddenTime&&(o.value=Math.max(e.startTime-re(),0),o.entries.push(e),n(!0)))}))}));i&&(n=ae(e,o,ge,t.reportAllChanges),te((function(r){o=oe("FCP"),n=ae(e,o,ge,t.reportAllChanges),ce((function(){o.value=performance.now()-r.timeStamp,n(!0)}))})))}))},be=[.1,.25],Re={passive:!0,capture:!0},we=new Date,Ee=function(e,t){J||(J=t,W=e,G=new Date,Ie(removeEventListener),Oe())},Oe=function(){if(W>=0&&W<G-we){var e={entryType:"first-input",name:J.type,target:J.target,cancelable:J.cancelable,startTime:J.timeStamp,processingStart:J.timeStamp+W};q.forEach((function(t){t(e)})),q=[]}},Se=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var n=function(){Ee(e,t),o()},r=function(){o()},o=function(){removeEventListener("pointerup",n,Re),removeEventListener("pointercancel",r,Re)};addEventListener("pointerup",n,Re),addEventListener("pointercancel",r,Re)}(t,e):Ee(t,e)}},Ie=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(t){return e(t,Se,Re)}))},Te=[100,300],Ne=[2500,4e3],Pe={},_e=[800,1800],ke=function e(t){document.prerendering?he((function(){return e(t)})):"complete"!==document.readyState?addEventListener("load",(function(){return e(t)}),!0):setTimeout(t,0)},Ce=function(e,t){t=t||{};var n=oe("TTFB"),r=ae(e,n,_e,t.reportAllChanges);ke((function(){var o=ne();if(o){var i=o.responseStart;if(i<=0||i>performance.now())return;n.value=Math.max(i-re(),0),n.entries=[o],r(!0),te((function(){n=oe("TTFB",0),(r=ae(e,n,_e,t.reportAllChanges))(!0)}))}}))},Le=function(e){return!!a()&&function(){try{return a()&&PerformanceObserver?PerformanceObserver.supportedEntryTypes||[]:null}catch(e){console.error("bili-mirror: supportList 解析异常:",e)}}().includes(e)};function Ae(e){/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)?(function(e){if(Le("first-input")){var t=new PerformanceObserver((function(n){for(var r=0,o=n.getEntries();r<o.length;r++){var i=o[r];t.disconnect();var a=i.processingStart-i.startTime;e({name:"FID",value:a,rating:a<100?"good":a>100&&a<300?"normal":"poor"})}}));t.observe({type:"first-input",buffered:!0})}}((function(t){e(t)})),function(e){if(Le("paint")){var t=new PerformanceObserver((function(n){for(var r=0,o=n.getEntries();r<o.length;r++){var i=o[r];"first-contentful-paint"===i.name&&(t.disconnect(),e({name:"FCP",value:i.startTime,rating:i.startTime<1600?"good":i.startTime>1600&&i.startTime<3e3?"normal":"poor"}))}}));t.observe({type:"paint",buffered:!0})}}((function(t){e(t)})),function(e){if(Le("largest-contentful-paint")){var t=new PerformanceObserver((function(n){for(var r=0,o=n.getEntries();r<o.length;r++){var i=o[r];t.disconnect(),e({name:"LCP",value:i.startTime,rating:i.startTime<1600?"good":i.startTime>1600&&i.startTime<3e3?"normal":"poor"})}}));t.observe({type:"largest-contentful-paint",buffered:!0})}}((function(t){e(t)})),function(e){window.addEventListener("load",(function(){var t=window.performance.timing,n=t.responseStart-t.navigationStart;e({name:"TTFB",value:n,rating:n<200?"good":n>200&&n<500?"normal":"poor"})}))}((function(t){e(t)}))):(!function(e,t){t=t||{},he((function(){var n,r=ve(),o=oe("LCP"),i=function(e){var t=e[e.length-1];t&&t.startTime<r.firstHiddenTime&&(o.value=Math.max(t.startTime-re(),0),o.entries=[t],n())},a=ie("largest-contentful-paint",i);if(a){n=ae(e,o,Ne,t.reportAllChanges);var c=ue((function(){Pe[o.id]||(i(a.takeRecords()),a.disconnect(),Pe[o.id]=!0,n(!0))}));["keydown","click"].forEach((function(e){addEventListener(e,c,!0)})),se(c),te((function(r){o=oe("LCP"),n=ae(e,o,Ne,t.reportAllChanges),ce((function(){o.value=performance.now()-r.timeStamp,Pe[o.id]=!0,n(!0)}))}))}}))}((function(t){e(t)})),function(e,t){t=t||{},he((function(){var n,r=ve(),o=oe("FID"),i=function(e){e.startTime<r.firstHiddenTime&&(o.value=e.processingStart-e.startTime,o.entries.push(e),n(!0))},a=function(e){e.forEach(i)},c=ie("first-input",a);n=ae(e,o,Te,t.reportAllChanges),c&&se(ue((function(){a(c.takeRecords()),c.disconnect()}))),c&&te((function(){var r;o=oe("FID"),n=ae(e,o,Te,t.reportAllChanges),q=[],W=-1,J=null,Ie(addEventListener),r=i,q.push(r),Oe()}))}))}((function(t){e(t)})),function(e,t){t=t||{},ye(ue((function(){var n,r=oe("CLS",0),o=0,i=[],a=function(e){e.forEach((function(e){if(!e.hadRecentInput){var t=i[0],n=i[i.length-1];o&&e.startTime-n.startTime<1e3&&e.startTime-t.startTime<5e3?(o+=e.value,i.push(e)):(o=e.value,i=[e])}})),o>r.value&&(r.value=o,r.entries=i,n())},c=ie("layout-shift",a);c&&(n=ae(e,r,be,t.reportAllChanges),se((function(){a(c.takeRecords()),n(!0)})),te((function(){o=0,r=oe("CLS",0),n=ae(e,r,be,t.reportAllChanges),ce((function(){return n()}))})),setTimeout(n,0))})))}((function(t){e(t)})),ye((function(t){e(t)})),Ce((function(t){e(t)})))}!function(e){e.INIT="init",e.ERROR="error",e.UNHANDLEDREJECTION="unhandledrejection",e.RESOURCE="resource",e.PERFORMANCE="performance",e.WHITESCREEN="whiteScreen",e.BREABCRUMB="breadcrumb"}($||($={})),function(e){e.ERROR="error",e.CLICK="click",e.HISTORY="history",e.HASHCHANGE="hashchange",e.UNHANDLEDREJECTION="unhandledrejection",e.RESOURCE="resource",e.WHITE="white",e.CUSTOM="custom"}(Y||(Y={})),function(e){e.BEFORE="mirrorHandlerBefore",e.AFTER="mirrorHandlerAfter"}(Q||(Q={})),function(e){e.ERROR="error",e.OK="ok"}(X||(X={})),function(e){e.AUTO="auto",e.DEFAULT="default"}(z||(z={})),function(e){e.HISTORY="history",e.HASH="hash",e.DOM="dom",e.JS="js",e.PROMISE="promise",e.RESOURCE="resource",e.WHITE="white"}(Z||(Z={}));var je={isExclusive:1},xe={mirrorPolymer:3},Ke=null,He=null,De=6e4*(null==F?void 0:F.config["poll-time"])||5,Ue="BILI_MIRROR_REPORT_POOL";(null==F?void 0:F.config["poll-time"])||setTimeout((function(){De=6e4*(null==F?void 0:F.config["poll-time"])}),2e3);var Me=function(){function e(){this.timeID=null,this.func=null}return e.prototype.repeat=function(e,t){var n=this;null===this.func&&(this.func=e),this.func===e&&(this.timeID=setTimeout((function(){e(),n.repeat(e,t)}),t))},e.prototype.clear=function(){clearTimeout(this.timeID)},e}(),Be=function(){try{var e=JSON.parse(localStorage.getItem(Ue)||"{}");if(!Object.keys(e).length)return;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];Ke.tech(t,n)})),localStorage.setItem(Ue,"{}")}catch(e){}},Fe=function(){He||((He=new Me).repeat(Be,De),l(c,"beforeunload",(function(){Be(),Ve()})))},Ve=function(){Ke&&Ke.flush&&Ke.flush(),He.clear(),He=null},Je="_BiliGreyResult",We="//s1.hdslb.com/bfs/seed/jinkela/short/reporter-pb/index.js",Ge=function(){if(!a())return{};if(!c[Je])return{};var e=c[Je],t={};return Object.entries(e).forEach((function(e){var n=e[0],r=e[1];t["".concat(Je,"_").concat(n)]=r})),t}(),qe=[],$e=!1,Ye="",Qe=null;function Xe(){if(qe.length&&!$e){$e=!0;var e=qe.shift(),t=e[0],n=e[1],r=e[2],o=e[3];if("middleWare"===n){if(Qe)return $e=!1,nt(r,o),void Xe();t(!0).then((function(e){var t;$e=!1,Ke!==(t=Qe=e)&&(Ke=t),rt(r,o),Xe()}))}else t().then((function(){$e=!1,n&&r&&n(r,o||void 0),Xe()}))}}var ze=function(e){(Ye?window[Ye]:window.__biliMirrorPbInstance__)[(e=at(e)).type](e.otherSpmId?"".concat(e.otherSpmId,".").concat(e.eventId):(null==F?void 0:F.spmId)?"".concat(null==F?void 0:F.spmId,".").concat(e.eventId):"".concat(u,".").concat(e.eventId),e.msg)},Ze=function(e,n){n&&Object.keys(n).length>0&&ot(n);var r="";r=(e=at(e)).diyevent?e.eventId||e.event:"".concat(e.otherSpmId?e.otherSpmId:(null==F?void 0:F.spmId)?null==F?void 0:F.spmId:u,".").concat(e.eventId);var o=Ye?window[Ye]:window.__biliMirrorPbInstance__,i=t(t({type:e.type||"custom",mirrorVersion:E},Ge),e.msg);o.tech(r,i)},et=function(e){qe.push([it,ze,e]),Xe()},tt=function(e,t){qe.push([it,Ze,e,t]),Xe()},nt=function(e,t){!e.msg.message&&e.msg.msg&&(e.msg.message=e.msg.msg),Qe?rt(e,t):(qe.push([it,"middleWare",e,t]),Xe())},rt=function(e,n){n&&void 0!==(null==n?void 0:n.isBatch)||(n=Object.assign(n||{},{isBatch:!1}));var r=((null==n?void 0:n.spmId)||u)+"."+((null==n?void 0:n.origin)||(null==F?void 0:F.origin))+"."+((null==n?void 0:n.module)||(null==F?void 0:F.module));(null==n?void 0:n.isBatch)?function(e,n,r){var o,i=(null===(o=null==n?void 0:n.api)||void 0===o?void 0:o.split("?")[0])||"";try{var a=JSON.parse(localStorage.getItem(Ue)||"{}");a[e]||(a[e]=t(t({},r),xe)),a[e][i]?a[e][i]++:a[e][i]=1,localStorage.setItem(Ue,JSON.stringify(a))}catch(e){}Fe()}(r+(n.eventId||".DATA.successReport"),e.msg,t({type:"custom",mirrorVersion:E},Ge)):Qe.tech(r+(n.eventId||".ERROR.errorReport"),t(t({type:e.type||"custom",mirrorVersion:E},e.msg),Ge))},ot=function(e){void 0===e&&(e={feature:{tech:!0}});window.__biliMirrorPbInstance__.options=Object.assign({feature:{tech:!0}},e)},it=function(e){void 0===e&&(e=!1);try{return new Promise((function(n,r){if(a()||r("not support in server"),e){var o={feature:{tech:!0},autoPv:!1,batch:!1};if(window.ReporterPb){var i=new window.ReporterPb(t({},o));n(i)}else{(s=document.createElement("script")).src=We,document.getElementsByTagName("body")[0].appendChild(s),s.onload=function(){var e=new window.ReporterPb(t({},o));n(e)}}}else{var c=(null==F?void 0:F.pbOtherNameIns)?null==F?void 0:F.pbOtherNameIns:"";if(m.isObject(window[c])&&Object.keys(window[c]).length)Ye=c,console.warn("Is using ".concat(c," to report,Please confirm open [tech] config")),n();else if(window.__biliMirrorPbInstance__)n();else{var s,u={feature:{tech:!0}};if(window.ReporterPb)window.__biliMirrorPbInstance__=new window.ReporterPb(t(t({},u),null==F?void 0:F.pbOptions)),n();else(s=document.createElement("script")).src=We,document.getElementsByTagName("body")[0].appendChild(s),s.onload=function(){window.__biliMirrorPbInstance__=new window.ReporterPb(t(t({},u),null==F?void 0:F.pbOptions)),n()}}}}))}catch(e){console.error("bili-mirror:load pb-report-Error load failed:",e)}};function at(e){return e.event&&!e.eventId&&(e.eventId=e.event),e.eventId.split(".").length<=1&&(e.eventId="".concat(null==F?void 0:F.origin,".").concat(null==F?void 0:F.module,".").concat(e.eventId)),"appear"===e.type&&(e.type="exposure"),e}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function ct(e,t){return e(t={exports:{}},t.exports),t.exports}var st=ct((function(e,t){e.exports=function(){function e(e){return!isNaN(parseFloat(e))&&isFinite(e)}function t(e){return e.charAt(0).toUpperCase()+e.substring(1)}function n(e){return function(){return this[e]}}var r=["isConstructor","isEval","isNative","isToplevel"],o=["columnNumber","lineNumber"],i=["fileName","functionName","source"],a=["args"],c=["evalOrigin"],s=r.concat(o,i,a,c);function u(e){if(e)for(var n=0;n<s.length;n++)void 0!==e[s[n]]&&this["set"+t(s[n])](e[s[n]])}u.prototype={getArgs:function(){return this.args},setArgs:function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw new TypeError("Args must be an Array");this.args=e},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(e){if(e instanceof u)this.evalOrigin=e;else{if(!(e instanceof Object))throw new TypeError("Eval Origin must be an Object or StackFrame");this.evalOrigin=new u(e)}},toString:function(){var e=this.getFileName()||"",t=this.getLineNumber()||"",n=this.getColumnNumber()||"",r=this.getFunctionName()||"";return this.getIsEval()?e?"[eval] ("+e+":"+t+":"+n+")":"[eval]:"+t+":"+n:r?r+" ("+e+":"+t+":"+n+")":e+":"+t+":"+n}},u.fromString=function(e){var t=e.indexOf("("),n=e.lastIndexOf(")"),r=e.substring(0,t),o=e.substring(t+1,n).split(","),i=e.substring(n+1);if(0===i.indexOf("@"))var a=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(i,""),c=a[1],s=a[2],l=a[3];return new u({functionName:r,args:o||void 0,fileName:c,lineNumber:s||void 0,columnNumber:l||void 0})};for(var l=0;l<r.length;l++)u.prototype["get"+t(r[l])]=n(r[l]),u.prototype["set"+t(r[l])]=function(e){return function(t){this[e]=Boolean(t)}}(r[l]);for(var f=0;f<o.length;f++)u.prototype["get"+t(o[f])]=n(o[f]),u.prototype["set"+t(o[f])]=function(t){return function(n){if(!e(n))throw new TypeError(t+" must be a Number");this[t]=Number(n)}}(o[f]);for(var p=0;p<i.length;p++)u.prototype["get"+t(i[p])]=n(i[p]),u.prototype["set"+t(i[p])]=function(e){return function(t){this[e]=String(t)}}(i[p]);return u}()})),ut=ct((function(e,t){var n,r,o,i;e.exports=(n=st,r=/(^|@)\S+:\d+/,o=/^\s*at .*(\S+:\d+|\(native\))/m,i=/^(eval@)?(\[native code])?$/,{parse:function(e){if(void 0!==e.stacktrace||void 0!==e["opera#sourceloc"])return this.parseOpera(e);if(e.stack&&e.stack.match(o))return this.parseV8OrIE(e);if(e.stack)return this.parseFFOrSafari(e);throw new Error("Cannot parse given Error object")},extractLocation:function(e){if(-1===e.indexOf(":"))return[e];var t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(e.replace(/[()]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function(e){return e.stack.split("\n").filter((function(e){return!!e.match(o)}),this).map((function(e){e.indexOf("(eval ")>-1&&(e=e.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var t=e.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),r=t.match(/ (\(.+\)$)/);t=r?t.replace(r[0],""):t;var o=this.extractLocation(r?r[1]:t),i=r&&t||void 0,a=["eval","<anonymous>"].indexOf(o[0])>-1?void 0:o[0];return new n({functionName:i,fileName:a,lineNumber:o[1],columnNumber:o[2],source:e})}),this)},parseFFOrSafari:function(e){return e.stack.split("\n").filter((function(e){return!e.match(i)}),this).map((function(e){if(e.indexOf(" > eval")>-1&&(e=e.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),-1===e.indexOf("@")&&-1===e.indexOf(":"))return new n({functionName:e});var t=/((.*".+"[^@]*)?[^@]*)(?:@)/,r=e.match(t),o=r&&r[1]?r[1]:void 0,i=this.extractLocation(e.replace(t,""));return new n({functionName:o,fileName:i[0],lineNumber:i[1],columnNumber:i[2],source:e})}),this)},parseOpera:function(e){return!e.stacktrace||e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length?this.parseOpera9(e):e.stack?this.parseOpera11(e):this.parseOpera10(e)},parseOpera9:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)/i,r=e.message.split("\n"),o=[],i=2,a=r.length;i<a;i+=2){var c=t.exec(r[i]);c&&o.push(new n({fileName:c[2],lineNumber:c[1],source:r[i]}))}return o},parseOpera10:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,r=e.stacktrace.split("\n"),o=[],i=0,a=r.length;i<a;i+=2){var c=t.exec(r[i]);c&&o.push(new n({functionName:c[3]||void 0,fileName:c[2],lineNumber:c[1],source:r[i]}))}return o},parseOpera11:function(e){return e.stack.split("\n").filter((function(e){return!!e.match(r)&&!e.match(/^Error created at/)}),this).map((function(e){var t,r=e.split("@"),o=this.extractLocation(r.pop()),i=r.shift()||"",a=i.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0;i.match(/\(([^)]*)\)/)&&(t=i.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var c=void 0===t||"[arguments not available]"===t?void 0:t.split(",");return new n({functionName:a,args:c,fileName:o[0],lineNumber:o[1],columnNumber:o[2],source:e})}),this)}})})),lt=function(e){var n=e.target;if(null==n?void 0:n.localName){var r=function(e){return{time:f(),message:e.src||e.href||"",name:e.localName}}(n);return t(t({},r),{type:"resourceError"})}return null},ft=function(e,t){void 0===t&&(t=!0);var n=e.method.toLocaleUpperCase(),r="POST"===n?JSON.stringify(e.data):"",o="GET"===n?function(e){if(!Object.keys(e).length)return"";var t="";for(var n in e)t+="".concat(n,"=").concat(e[n],"&");return t.substring(0,t.length-1)}(e.data):"",i=o?-1!==e.url.indexOf("?")?"".concat(e.url,"&").concat(o):"".concat(e.url,"?").concat(o):e.url;return new Promise((function(o,a){var c=new XMLHttpRequest;if(c.onreadystatechange=function(){if(c.readyState===XMLHttpRequest.DONE)if(200===c.status){var e=null;try{e=JSON.parse(c.responseText)}catch(t){e=c.responseText}o(e)}else{var t=c.getAllResponseHeaders().trim().split(/[\r\n]+/),n={};t.forEach((function(e){var t=e.split(": "),r=t.shift(),o=t.join(": ");n[r]=o})),a({responseText:c.responseText,headers:n,status:c.status})}},c.withCredentials=t,c.open(n,i,!0),"POST"===n&&e.headers&&"object"==typeof e.headers)for(var s in e.headers)c.setRequestHeader(s,e.headers[s]);c.send(r)}))},pt=null,dt=function(){function e(){}return e.prototype.before=function(e,t){return new Promise((function(n){if(F._pluginIns&&F._pluginIns.mirrorHandleBefore)try{F._pluginIns.mirrorHandleBefore(e,t).then((function(e){n(e)}))}catch(e){console.warn("bili-mirror:plugin function before hook error,please check"),n(!0)}else n(!0)}))},e.prototype.after=function(e,t){return new Promise((function(n){if(F._pluginIns&&F._pluginIns.mirrorHandleAfter)try{F._pluginIns.mirrorHandleAfter(e,t).then((function(){n()}))}catch(e){console.warn("bili-mirror:plugin function after hook error,please check"),n()}else n()}))},e}();pt||(pt=new dt);var mt=pt,vt=s(),ht=function(){function e(){this.maxBreadcrumbs=20,this.stack=[]}return e.prototype.push=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,mt.before($.BREABCRUMB,e)];case 1:return t.sent()?(this.immediatePush(e),l(c,"beforeunload",(function(){this.goToReport(this.stack),window.__biliMirrorPbInstance__&&window.__biliMirrorPbInstance__.flush&&window.__biliMirrorPbInstance__.flush()})),[2]):[2]}}))}))},e.prototype.immediatePush=function(e){(e.time||(e.time=f()),this.stack.length>=this.maxBreadcrumbs)&&(this.stack.filter((function(e){return"error"===e.status})).length?(this.goToReport(this.stack),this.clear()):this.clear());this.stack.push(e),this.stack.sort((function(e,t){return e.time-t.time}))},e.prototype.shift=function(){return void 0!==this.stack.shift()},e.prototype.clear=function(){this.stack=[]},e.prototype.getStack=function(){return this.stack},e.prototype.goToReport=function(e){var n={};e.forEach((function(e,t){n["logStep-".concat(t)]=e})),tt({type:"custom",event:"".concat(F.origin,".").concat(F.module,".USERLOG"),msg:t(t({},n),je)}),mt.after($.BREABCRUMB,this.stack)},e}(),gt=vt.breadcrumb||(vt.breadcrumb=new ht),yt=null,bt=function(){function e(){}return e.prototype.handleHistory=function(e){var t=e.from,n=e.to,r=R(t).relative,o=R(n).relative;gt.push({category:Y.HISTORY,status:X.OK,time:f(),msg:{from:r||"/",to:o||"/"}})},e.prototype.handleHashChange=function(e){var t=e.oldURL,n=e.newURL,r=R(t).relative,o=R(n).relative;gt.push({category:Y.HASHCHANGE,status:X.OK,time:f(),msg:{from:r,to:o}})},e.prototype.handleDomClick=function(e){var t=function(e){var t=e.tagName.toLowerCase();if("body"===t)return"";var n=e.classList.value;n=""!==n?" class='".concat(n,"'"):"";var r=e.id?' id="'.concat(e.id,'"'):"",o=e.innerText;return"<".concat(t).concat(r).concat(""!==n?n:"",">").concat(o,"</").concat(t,">")}(e.activeElement);t&&gt.push({category:Y.CLICK,status:X.OK,time:f(),msg:{clickDom:t}})},e.prototype.handleJsError=function(e){gt.push({category:Y.ERROR,status:X.ERROR,time:e.time||f(),msg:{message:e.message}})},e.prototype.handlePromiseError=function(e){gt.push({category:Y.UNHANDLEDREJECTION,status:X.ERROR,time:e.time||f(),msg:{message:e.message}})},e.prototype.handleResourceError=function(e){gt.push({category:Y.RESOURCE,status:X.ERROR,time:e.time||f(),msg:{message:e.message,name:null==e?void 0:e.name}})},e.prototype.handleWhiteScreen=function(){gt.push({category:Y.WHITE,status:X.ERROR,time:f(),msg:{url:location.href}})},e}();yt||(yt=new bt);var Rt=yt,wt=b();function Et(e){var t=(null==F?void 0:F.config["user-log"])||null;return!!t&&t.find((function(t){return t===e}))}var Ot,St={historyReplace:function(){if(Et(Z.HISTORY)&&(e=c.chrome,t=e&&e.app&&e.app.runtime,n="history"in c&&!!c.history.pushState&&!!c.history.replaceState,!t&&n)){var e,t,n,r=c.onpopstate;c.onpopstate=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=b(),o=wt;wt=n,Rt.handleHistory({from:o,to:n}),r&&r.apply(this,e)},w(c.history,"pushState",o),w(c.history,"replaceState",o)}function o(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t.length>2?t[2]:void 0;if(r){var o=wt,i=String(r);wt=i,Rt.handleHistory({from:o,to:i})}return e.apply(this,t)}}},hashChangeeReplace:function(){var e,t;Et(Z.HASH)&&(e=c,t="onhashchange",Object.prototype.hasOwnProperty.call(e,t)&&l(c,"hashchange",(function(e){Rt.handleHashChange(e)})))},domClickReplace:function(){if(Et(Z.DOM)&&"document"in c){var e,t,n,r=(e=Rt.handleDomClick,t=300,n=!0,function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];n&&(e.apply(this,r),n=!1,setTimeout((function(){n=!0}),t))});l(c.document,"click",(function(){r(this)}),!0)}},jsErrorReplace:function(e){Et(Z.JS)&&(null==Rt||Rt.handleJsError(e))},promiseErrorReplace:function(e){Et(Z.PROMISE)&&(null==Rt||Rt.handlePromiseError(e))},resourceErrorReplace:function(e){Et(Z.RESOURCE)&&(null==Rt||Rt.handleResourceError(e))},whiteErrorReplace:function(){Et(Z.WHITE)&&(null==Rt||Rt.handleWhiteScreen())}},It=[],Tt=function(e){var t,n=(t=(null==e?void 0:e.message)||(null==e?void 0:e.fileName),window.btoa(decodeURIComponent(encodeURIComponent(t))));return It.some((function(e){return e===n}))?(console.warn("Duplicate error, not reported,".concat(null==e?void 0:e.message)),!1):(It.push(n),!0)},Nt={},Pt={handleError:function(e){var o,i,a,c,s;return n(this,void 0,void 0,(function(){var u,l,p,d,m,v,g;return r(this,(function(y){switch(y.label){case 0:u=e.target,y.label=1;case 1:return y.trys.push([1,7,,8]),!u||e.target&&!e.target.localName?(l=function(e){var t,n=e.target;if(!n||e.target&&!(null===(t=e.target)||void 0===t?void 0:t.localName)){var r=ut.parse(n?e.error:e)[0],o=r.fileName,i=r.columnNumber,a=r.lineNumber,c=r.source,s=c?JSON.stringify(c.split(" ").join("").split("./")):"";return{type:"error",time:f(),message:e.message,fileName:o,line:a,column:i,stack:s}}return null}(e),p=null===(i=null===(o=null==F?void 0:F.config)||void 0===o?void 0:o.white)||void 0===i?void 0:i.error,h(l,p)?[3,3]:Tt(l)?[4,mt.before($.ERROR,l)]:[2]):[3,3];case 2:if(!y.sent())return[2];tt({type:"error",eventId:"".concat(F.origin,".").concat(F.module,".ERROR.jsError"),msg:l},F.pbOptions||{}),St.jsErrorReplace(l),mt.after($.ERROR,l),y.label=3;case 3:return(null==u?void 0:u.localName)?(d=lt(e),m=null===(c=null===(a=null==F?void 0:F.config)||void 0===a?void 0:a.white)||void 0===c?void 0:c.resource,h(d,m)?[3,6]:[4,(b=d,R=null===(s=null==F?void 0:F.config)||void 0===s?void 0:s["white-retry"],void 0===R&&(R=[]),n(void 0,void 0,void 0,(function(){return r(this,(function(e){return b.message?(void 0===Nt[b.name]&&(Nt[b.name]=2),Nt[b.name]>0?(Nt[b.name]--,h(b,R)?[2,Promise.resolve({retryResult:"whitelist"})]:[2,new Promise((function(e){ft({url:b.message,method:"GET",data:{},headers:{}},!1).then((function(){e({retryResult:"success"})})).catch((function(n){e(t({retryResult:"failed"},n))}))}))]):[2,Promise.resolve({retryResult:"skip"})]):[2,Promise.resolve({retryResult:"skip"})]}))})))]):[3,6];case 4:return v=y.sent(),d=t(t({},d),v),Tt(d)?[4,mt.before($.RESOURCE,d)]:[2];case 5:if(!y.sent())return[2];tt({type:"error",eventId:"".concat(F.origin,".").concat(F.module,".ERROR.resourceError"),msg:t(t({},d),{error_type:"AssetsError",headless:""==navigator.language?"headless":"normal",webdriver:null===navigator||void 0===navigator?void 0:navigator.webdriver})},F.pbOptions||{}),St.resourceErrorReplace(d),mt.after($.RESOURCE,d),y.label=6;case 6:return[3,8];case 7:return g=y.sent(),console.warn("bili-mirror: handleError-Error parsing failed:",g),[3,8];case 8:return[2]}var b,R}))}))},handleUnhandleRejection:function(e){var t,o;return n(this,void 0,void 0,(function(){var n,i,a;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),n=function(e){var t,n=ut.parse(e.reason)[0],r=n.fileName,o=n.columnNumber,i=n.lineNumber,a=n.source,c=a?JSON.stringify(a.split(" ").join("").split("./")):"";return{type:"rejectionError",time:f(),message:(t=e.reason.message||e.reason.stack,m.isString(t)?t:m.isUndefined(t)?"undefined":JSON.stringify(t)),fileName:r,line:i,column:o,stack:c}}(e),i=null===(o=null===(t=null==F?void 0:F.config)||void 0===t?void 0:t.white)||void 0===o?void 0:o.rejection,h(n,i)?[3,2]:Tt(n)?[4,mt.before($.UNHANDLEDREJECTION,n)]:[2];case 1:if(!r.sent())return[2];tt({type:"error",eventId:"".concat(F.origin,".").concat(F.module,".ERROR.rejectionError"),msg:n},F.pbOptions||{}),St.promiseErrorReplace(n),mt.after($.UNHANDLEDREJECTION,n),r.label=2;case 2:return[3,4];case 3:return a=r.sent(),console.warn("bili-mirror: handleUnhandleRejection-Error parsing failed:",a),[3,4];case 4:return[2]}}))}))},handlePerformance:function(){return n(this,void 0,void 0,(function(){var e=this;return r(this,(function(t){try{if(!PerformanceObserver||!(null===PerformanceObserver||void 0===PerformanceObserver?void 0:PerformanceObserver.supportedEntryTypes))return[2];if(y(F.config["white-preformance-rate"]))return[2];Ae((function(t){return n(e,void 0,void 0,(function(){var e,n,o;return r(this,(function(r){switch(r.label){case 0:return e=t.name,n=t.rating,!(o=t.value)||o<0?[2]:[4,mt.before($.PERFORMANCE,t)];case 1:return r.sent()?(tt({type:"performance",eventId:"".concat(F.origin,".").concat(F.module,".PERFORMANCE.").concat(t.name),msg:{name:e,rating:n,value:o}},F.pbOptions||{}),mt.after($.PERFORMANCE,t),[2]):[2]}}))}))}))}catch(e){console.warn("bili-mirror: performance-Error parsing failed:",e)}return[2]}))}))}};function _t(e){var t;if(a()){if(l(c,"error",(function(e){Pt.handleError(e)}),!0),l(c,"unhandledrejection",(function(e){Pt.handleUnhandleRejection(e)})),Pt.handlePerformance(),null==e?void 0:e.whiteScreen)try{!function(e){if(!((null==c?void 0:c.screen.width)<=0||c.screen.height<=0||(null==c?void 0:c.innerWidth)<=0||c.innerHeight<=0)){var t=e.checkNum||3,o=e.maxLoop||9,i=e.elemArry||e.checkDom||["html","body","#app"],a=e.callback||function(){},u=s(),l=0,f=[],p=[];e.isSkeleton?"complete"!=document.readyState&&m():"complete"===document.readyState?m():c.addEventListener("load",m)}function d(t){var n=function(e){return e.id?"#"+e.id:e.className&&"string"==typeof e.className?"."+e.className.split(" ").filter((function(e){return!!e})).join("."):e.nodeName.toLowerCase()}(t);e.isSkeleton&&(l?p.push(n):f.push(n));var r=!1;if(!n||!i)return r;for(var o=0;o<=i.length;o++)if(i[o]&&n.match(i[o])){r=!0;break}return r}function m(){return n(this,void 0,void 0,(function(){var n,i,s,m,h,g,y,b,R,w;return r(this,(function(r){switch(r.label){case 0:return[4,mt.before($.WHITESCREEN)];case 1:if(!r.sent())return[2];for(n=!0,i=1;i<=7;i+=3){if(s=c.innerWidth*i/10,m=c.innerHeight/2,h=c.innerWidth/2,g=c.innerHeight*i/10,y=document.elementsFromPoint(s,m),b=document.elementsFromPoint(h,g),y.length>t)for(R=0;R<y.length;R++)if(d(y[R])){n=!1;break}if(!n)break;if(n&&b.length>t&&5!=i)for(w=0;w<b.length;w++)if(d(b[w])){n=!1;break}if(!n)break}if(n)v();else{if(e.isSkeleton){if(!l)return[2,v()];if(p.join()==f.join())return[2,a({status:Ot.ERROR})]}u._loopTimer&&clearTimeout(u._loopTimer),u._loopTimer=null}return a({status:n?Ot.ERROR:Ot.OK,loop:l}),l>=o&&(tt({type:"error",eventId:"".concat(F.origin,".").concat(F.module,".ERROR.whiteScreen")}),St.whiteErrorReplace()),mt.after($.WHITESCREEN),[2]}}))}))}function v(){l>=o&&u._loopTimer?(clearTimeout(u._loopTimer),u._loopTimer=null):u._loopTimer=setTimeout((function(){l++,e.isSkeleton&&(p=[]),m()}),1e3)}}(e.whiteScreen)}catch(e){console.error("bili-mirror: whiteScreen错误解析异常:",e)}if(null===(t=null==F?void 0:F.config["user-log"])||void 0===t?void 0:t.length)try{St.historyReplace(),St.hashChangeeReplace(),St.domClickReplace()}catch(e){console.error("bili-mirror:user-log记录解析异常",e)}}}!function(e){e.ERROR="error",e.OK="ok"}(Ot||(Ot={}));var kt,Ct=function(e){void 0===e&&(e={});var n=null==F?void 0:F.config["tech-pv"];if(n&&!y(n)){var r="".concat(F.origin,".").concat(F.module,".TECHPV.0.0");tt({eventId:r,type:"custom",msg:t(t({},e),je)})}},Lt=s(),At=function(e){et(e)};function jt(e){var t=this;a()&&(Lt.isInited||(Lt.isInited=!0,Lt.mirrorInitMode||(Lt.mirrorInitMode=z.DEFAULT),V(e).then((function(){return n(t,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,mt.before($.INIT,e)];case 1:return t.sent()?(_t(null==e?void 0:e.config),Ct(),console.info("%c%s","line-height: 30px; color: #FF6699","bili-fe-mirror:".concat(S)),[2]):[2]}}))}))}))))}if(a()){window.__INITIAL_MIRROR__=jt;var xt=window.__MIRROR_CONFIG__,Kt=null===(kt=null==xt?void 0:xt.config)||void 0===kt?void 0:kt.isAutoInit;xt&&m.isObject(xt)&&Kt&&(!Lt.mirrorInitMode&&(Lt.mirrorInitMode=z.AUTO),jt(xt))}var Ht={SDK_NAME:O,SDK_VERSION:S,init:jt,install:function(e,t){void 0===t&&(t={});var n=e.config.errorHandler;e.config.errorHandler=function(e,t,r){Pt.handleError(e),n&&n.apply(null,[e,t,r])},jt(t)},errorBoundary:function(e){Pt.handleError(e)}};e.canBatchTechReport=function(e,t){nt(e,t)},e.changePbOptions=function(e){ot(e)},e.customPerformanceQuota=function(e){if(a()&&v(e.name)){var t="".concat(F.origin,".").concat(F.module,".PERFORMANCE.").concat(e.name);tt({type:"performance",eventId:t,msg:{name:e.name,value:e.value}})}},e.customReport=At,e.customReportPb=At,e.default=Ht,e.exclusiveBisReport=function(e){a()&&v(e.key)&&tt({type:"custom",eventId:e.eventId,diyevent:!0,msg:t(t({exclusiveFrom:(null==e?void 0:e.key)||""},e.msg),je)})},e.pbReportPv=function(e){et({type:"pv",eventId:"0.0",msg:e})},e.techReportPb=function(e){tt(e)},Object.defineProperty(e,"__esModule",{value:!0})}));
