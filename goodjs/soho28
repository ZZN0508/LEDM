define("sjs/matrix/ad/dataspe",["sjs/base/corespe","sjs/data/cookie","sjs/data/json","sjs/matrix/ad/config"],function(t,e,n,s){var a=s._db,i={get:function(t,e){new d(t,e).get()},get_turn:function(t){if(!this.turn){var s=a.COOKIE_ID_PREFIX+"new_turn",i=a.PAGEID||encodeURIComponent(document.location.hostname),d=e(s)||"{}",r=(d=n.parse(d))[i]||parseInt(Math.random()*a.MAX_TURN+1);this.turn=r;var c=r+1;c>a.MAX_TURN&&(c=1),d[i]=c,e(s,n.stringify(d),{path:"/",expires:1})}return t?(this.turn-1)%t+1:this.turn}},d=function(t,e){this.callback=e,this.beans=t,this.data=[]};return d.prototype={get:function(){var t=this.beans;if(t.itemspaceid){var e={};e[t.itemspaceid]=t,t=this.beans=e}for(var n in t){var s,a=t[n],i=201;a.adsrc?i=parseInt(a.adsrc):a.adsrc=i,a.itemspaceid=n,a.status=-1,i>=200&&(s=this.get_from_cpds(a),200===i&&(a.status=0)),200===i||s||(a.adsrc=13,this.get_from_ads(a)),this.data.push(a)}this.check_complete()},get_from_cpds:function(e){var n=1,s=null,d=e.itemspaceid,r=!1,c=window.AD_DATA||{};if(/^\d{4,8}$/.test(d)&&(e.turn||(e.turn=i.get_turn(e.max_turn||1)),n=e.turn-1,s=c[d]&&c[d][n]&&c[d][n].data||{},r=c[d]&&c[d][n]&&c[d][n].isloc,s=r&&(a.IP||a.SOIP)?s[a.IP]||s[a.SOIP.substr(0,6)]||s[a.SOIP.substr(0,4)]||s.DEFAULT:s.DEFAULT))return e.adtype=6,e.status=0,t.extend(e,s),s},get_from_ads:function(e){var n=this,s=e.query||{};if(!(e.itemspaceid&&(e.width&&e.height||e.adps)))return e.status=0;if(s.itemspaceid=e.itemspaceid,!e.adps){var d=(e.height+"").length;e.adps=s.adps=e.width+(1<<(d>=4?0:4-d)).toString(2).substr(1)+e.height}s.adps||(s.adps=e.adps),s.adsrc||(s.adsrc=e.adsrc),s.turn||(s.turn=e.turn||i.get_turn(e.max_turn)),a.TAG&&(s.ic=a.TAG),s.sf=t.sflash(),s.pgid=a.PAGEVIEWID;var r=window.CONFIG.CHANNELID?window.CONFIG.CHANNELID:allnewschn;s.newschn=window.contentData&&window.contentData.adTags?window.contentData.adTags:r,window.multichn?s.multichn=window.multichn:window.CONFIG&&"news-article"==window.CONFIG.PAGEID?"1000800000"!=window.CONFIG.CHANNELID?s.multichn=window.CONFIG.CHANNELID.substr(0,5)+"00000,"+window.CONFIG.CHANNELID:s.multichn=window.CONFIG.CHANNELID:window.CONFIG&&"article"==window.CONFIG.PAGEID.split("-")[1]&&"news-article"!=window.CONFIG.PAGEID&&(s.multichn=window.CONFIG.CHANNELID.substr(0,5)+"00000"),e.needad&&e.needad.length&&(s.needad=e.needad.length),e.start_time=(new Date).getTime(),t.jsonpspe({url:a.URL_ADSERVER,timeout:a.DEFAULT_TIMEOUT,data:s,complete:function(t,s){n.complete(e)},success:function(t,s){n.success(t,e)}})},complete:function(t){t.status=0,this.check_complete()},success:function(e,n){if(e)for(var s=0;s<e.length;s++)e[s].by_server="1",e[s].end_time=(new Date).getTime(),n.needad&&n.needad.length&&(e[s].itemspaceid=n.needad[s]),e[0].form=n.form,t.extend(n,e[s]);n.end_time&&(n.latency=n.end_time-n.start_time)},check_complete:function(){var t=this.beans;for(pro in t)if(-1===t[pro].status)return;this.callback.call(this,this.data)}},i});