(window.HUYA_MAIN_APP_WEBPACK_JSONP=window.HUYA_MAIN_APP_WEBPACK_JSONP||[]).push([[271],{1269:function(e,t,i){var s,r,a,n;function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}n=function(){return function e(t,i,s){function r(n,o){if(!i[n]){if(!t[n]){if(a)return a(n,!0);var u=new Error("Cannot find module '"+n+"'");throw u.code="MODULE_NOT_FOUND",u}var l=i[n]={exports:{}};t[n][0].call(l.exports,(function(e){var i=t[n][1][e];return r(i||e)}),l,l.exports,e,t,i,s)}return i[n].exports}for(var a=!1,n=0;n<s.length;n++)r(s[n]);return r}({1:[function(e,t,i){function s(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(e){return"function"==typeof e}function a(e){return"object"==o(e)&&null!==e}function n(e){return void 0===e}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0,s.defaultMaxListeners=10,s.prototype.setMaxListeners=function(e){if(!function(e){return"number"==typeof e}(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},s.prototype.emit=function(e){var t,i,s,o,u,l;if(this._events||(this._events={}),"error"===e&&(!this._events.error||a(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;throw TypeError('Uncaught, unspecified "error" event.')}if(n(i=this._events[e]))return!1;if(r(i))switch(arguments.length){case 1:i.call(this);break;case 2:i.call(this,arguments[1]);break;case 3:i.call(this,arguments[1],arguments[2]);break;default:for(s=arguments.length,o=new Array(s-1),u=1;u<s;u++)o[u-1]=arguments[u];i.apply(this,o)}else if(a(i)){for(s=arguments.length,o=new Array(s-1),u=1;u<s;u++)o[u-1]=arguments[u];for(s=(l=i.slice()).length,u=0;u<s;u++)l[u].apply(this,o)}return!0},s.prototype.addListener=function(e,t){var i;if(!r(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,r(t.listener)?t.listener:t),this._events[e]?a(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,a(this._events[e])&&!this._events[e].warned&&(i=n(this._maxListeners)?s.defaultMaxListeners:this._maxListeners)&&i>0&&this._events[e].length>i&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},s.prototype.on=s.prototype.addListener,s.prototype.once=function(e,t){function i(){this.removeListener(e,i),s||(s=!0,t.apply(this,arguments))}if(!r(t))throw TypeError("listener must be a function");var s=!1;return i.listener=t,this.on(e,i),this},s.prototype.removeListener=function(e,t){var i,s,n,o;if(!r(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=(i=this._events[e]).length,s=-1,i===t||r(i.listener)&&i.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(a(i)){for(o=n;o-- >0;)if(i[o]===t||i[o].listener&&i[o].listener===t){s=o;break}if(s<0)return this;1===i.length?(i.length=0,delete this._events[e]):i.splice(s,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},s.prototype.removeAllListeners=function(e){var t,i;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r(i=this._events[e]))this.removeListener(e,i);else for(;i.length;)this.removeListener(e,i[i.length-1]);return delete this._events[e],this},s.prototype.listeners=function(e){return this._events&&this._events[e]?r(this._events[e])?[this._events[e]]:this._events[e].slice():[]},s.listenerCount=function(e,t){return e._events&&e._events[t]?r(e._events[t])?1:e._events[t].length:0}},{}],2:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.default={VIDEO_PLAY:"videoplay",VIDEO_STOP:"videostop",MULTI_VIDEOS:"multivideos",ANCHOR_STOP:"anchorstop",NO_VIDEO:"novideo",FLV_URL_UNAVAILABLE:"flvurlunavailable",H5_PLAYER_ERROR:"h5playererror"},t.exports=i.default},{}],3:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0}),s(e("../../utils/logger")),s(e("../../utils/timeUtil"));var r={data:{uid:"0",wyy:"",rel:"jsscene",ref:encodeURIComponent(window.location.href),linetype:"2",paucount:"",paulength:"",bflength:"",sid:"0",subsid:"0",vr:"0",flvip:"",sendcnt:0,httphead:""},img:null,pausedCount:0,pausedLength:0,send:function(e){},getCookie:function(e){var t=new RegExp("(^| )"+e+"=([^;]*)(;|$)"),i=document.cookie.match(t);return i?decodeURIComponent(i[2]):null},getHost:function(e){return e.replace("http://","").split("/")[0]},record:function(e,t,i,s,a){r.data.uid=e,r.pausedCount+=i,r.pausedLength+=s,r.data.bflength=a,t%120==0&&r.send()}};i.default=r,t.exports=i.default},{"../../utils/logger":18,"../../utils/timeUtil":19}],4:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),a=s(e("./hls/hlsMgr.js")),n=s(e("events")),o=s(e("./utils/logger")),u=s(e("./events")),l=(s(e("./yyStrUG/yyConfigKey")),e("./yyStrUG/yyConstDefine")),h=(s(l),e("./utils/timeUtil")),d=s(h),c=function(){function e(){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),d.default.now(),this.setLogLevel(0);var t=this.observer=new n.default;t.trigger=function(e){for(var i=arguments.length,s=Array(i>1?i-1:0),r=1;r<i;r++)s[r-1]=arguments[r];setTimeout((function(){t.emit.apply(t,[e,e].concat(s))}),0)},t.off=function(e){for(var i=arguments.length,s=Array(i>1?i-1:0),r=1;r<i;r++)s[r-1]=arguments[r];t.removeListener.apply(t,[e].concat(s))},this.version=1401820,this.date="2016-11-08 11:30",this.on=t.on.bind(t),this.off=t.off.bind(t),this.trigger=t.trigger.bind(t),this.yyMgr=null,this.hlsMgr=new a.default(this),o.default.warn("SDK version="+this.date+" "+this.version),o.default.warn("UserAgent="+navigator.userAgent),this.volume=1,window.onerror=this.onWindowError.bind(this)}return r(e,null,[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"Events",get:function(){return u.default}}]),r(e,[{key:"onWindowError",value:function(e,t,i){o.default.warn("onWindowError errorMsg="+e+" url="+t)}},{key:"setLogLevel",value:function(e){o.default.setLevel(e)}},{key:"setYYConfig",value:function(e,t,i){this.yyMgrJoin&&this.yyMgrJoin.setConfig(e,t,i)}},{key:"setFlvConfig",value:function(e,t){this.flvMgr&&this.flvMgr.setConfig(e,t)}},{key:"setHlsConfig",value:function(e,t){this.hlsMgr&&this.hlsMgr.setConfig(e,t)}},{key:"setVolume",value:function(e){var t=Number(e);return t>1||t<0?void o.default.warn("H5Player.setVolume error volume="+t):(this.volume=t,void this.hlsMgr.setVolume(t))}},{key:"getVolume",value:function(){return this.volume}},{key:"startYY",value:function(e,t,i){var s=arguments.length<=3||void 0===arguments[3]?201:arguments[3],r=Number(e),a=Number(t),n=Number(i),o=Number(s);this.yyMgr&&this.yyMgr.startYY(r,a,n,o)}},{key:"startYYAudio",value:function(e,t,i){var s=arguments.length<=3||void 0===arguments[3]?201:arguments[3],r=Number(e),a=Number(t),n=Number(i),o=Number(s);this.yyMgr&&this.yyMgr.startYY(r,a,n,o,!0)}},{key:"playChannel",value:function(e){var t=Number(e);return this.yyMgr?this.yyMgr.playChannel(t):2}},{key:"addMuteUid",value:function(e){var t=Number(e);this.yyMgrJoin&&this.yyMgrJoin.addMuteUid(t)}},{key:"removeMuteUid",value:function(e){var t=Number(e);this.yyMgrJoin&&this.yyMgrJoin.removeMuteUid(t,this.getVolume())}},{key:"getMuteArr",value:function(){return this.yyMgrJoin?this.yyMgrJoin.getMuteArr():null}},{key:"stopYY",value:function(){this.yyMgr&&this.yyMgr.stopYY()}},{key:"stopYYAudio",value:function(){this.yyMgr&&this.yyMgr.stopYY()}},{key:"getCurrentChannelId",value:function(){return this.yyMgr?this.yyMgr.getCurrentChannelId():0}},{key:"startFlv",value:function(e){this.flvMgr&&this.flvMgr.startFlv(e)}},{key:"startFlvWs",value:function(e){this.flvMgr&&this.flvMgr.startFlvWs(e)}},{key:"stopFlv",value:function(){this.flvMgr&&this.flvMgr.stopFlv()}},{key:"startHls",value:function(e,t){this.hlsMgr&&this.hlsMgr.startHls(e,t)}},{key:"stopHls",value:function(){this.hlsMgr&&this.hlsMgr.stopHls()}},{key:"getLog",value:function(){return o.default.getLog()}}]),e}();i.default=c,t.exports=i.default},{"./events":2,"./hls/hlsMgr.js":5,"./utils/logger":18,"./utils/timeUtil":19,"./yyStrUG/yyConfigKey":21,"./yyStrUG/yyConstDefine":22,events:1}],5:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),a=s(e("../events")),n=s(e("./hlsPlaylist")),o=s(e("../mse/msePlayer")),u=s(e("../utils/xhr-loader")),l=s(e("../utils/logger")),h=s(e("../utils/timeUtil")),d=s(e("./utils/url")),c=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.config={autoStartLoad:!0,maxBufferLength:30,bs2Delay:3e3,fragLoadingTimeOut:5e3,fragLoadingMaxRetry:1,fragLoadingRetryDelay:1e3,listLoadingTimeOut:3e3,listLoadingMaxRetry:3,listLoadingRetryDelay:1e3,appendErrorMaxRetry:200,minFragBufferNum:3,autoReconnect:!0},this.H5Player=t,this.isLive=null,this.sid=null,this.subsid=null,this.appid=null,this.url=null,this.playtime=null,this.playlist=null,this.player=null,this.timer=null,this.checkTimes=0,this.targetDuration=0,this.isProcessingFrag=!1,this.startTs=0,this.fragLoader=null,this.fragBuffered=0}return r(e,[{key:"destroy",value:function(){this.timer&&(clearInterval(this.timer),this.timer=null),this.player&&(this.player.destroy(),this.player=null),this.playlist&&(this.playlist.destroy(),this.playlist=null),this.fragLoader&&(this.fragLoader.abort(),this.fragLoader=null)}},{key:"setConfig",value:function(e,t){}},{key:"startHls",value:function(e,t){this.stopHls(),this.isLive=t,this.url=e,l.default.log("hlsMgr.startHls isLive="+this.isLive),this.playlist=new n.default(this),this.player=new o.default(this,"ts"),this.playlist.loadManifest(this.url),this.startTs=h.default.now()}},{key:"reset",value:function(){this.isLive=null,this.url=null,this.checkTimes=0,this.targetDuration=0,this.isProcessingFrag=!1,this.startTs=0}},{key:"stopHls",value:function(){this.player&&this.H5Player.trigger(a.default.VIDEO_STOP,{uid:0,video:this.player.getPlayVideo()}),this.destroy(),this.reset()}},{key:"setVolume",value:function(e){this.player&&this.player.setVolume(e)}},{key:"reconnectLive",value:function(){this.destroy(),this.checkTimes=0,this.targetDuration=0,this.isProcessingFrag=!1,this.startHls(this.url,this.isLive)}},{key:"loadFragment",value:function(){if(!this.isProcessingFrag){var e=this.targetDuration||this.config.maxBufferLength,t=this.player.getPlayVideo();if(this.bufferedInfo(t.currentTime,t.buffered).len<e){var i=this.playlist.getNextFrag();if(i){var s=this.config,r=s.bs2Delay+this.targetDuration/3*1e3,a=i.url;this.isProcessingFrag=!0,this.fragLoader=new u.default(s),this.fragLoader.load(a,"arraybuffer",this.loadSuccess.bind(this),this.loadError.bind(this),this.loadTimeout.bind(this),r,s.fragLoadingMaxRetry,s.fragLoadingRetryDelay,null,i),this.fragBuffered++}}}}},{key:"loadSuccess",value:function(e,t){var i=e.currentTarget.response,s=(e.currentTarget.responseURL,this.playlist.currLevel),r=this.playlist.currFrag,a=s.details.totalduration,n=r.start,o=r.level,u=r.sn,l=d.default.getTimeFromUrl(r.url,this.isLive);this.playlist.currFrag.loader=null,this.player.appendTs({data:i,audioCodec:s.audioCodec,videoCodec:s.videoCodec,timeOffset:n,cc:r.cc,level:o,sn:u,duration:a,url:l}),this.timer||(this.timer=setInterval(this.onCheckTimer.bind(this),1e3))}},{key:"loadError",value:function(e){l.default.error("load fragment error:"+e.currentTarget.status),this.config.autoReconnect&&this.startHls(this.url,this.isLive)}},{key:"loadTimeout",value:function(e){l.default.error("load fragment timeout"),this.config.autoReconnect&&this.startHls(this.url,this.isLive)}},{key:"onSBUpdateEnd",value:function(){this.isProcessingFrag=!1}},{key:"onCheckTimer",value:function(){this.timer&&(this.checkTimes++,this.loadFragment(),this.playlist.onCheckTimer(this.checkTimes),this.checkTimes%30==0&&(l.default.log("hlsMgr.onCheckTimer: this.fragBuffered = "+this.fragBuffered),this.fragBuffered=0))}},{key:"bufferedInfo",value:function(e,t){var i=arguments.length<=2||void 0===arguments[2]?.3:arguments[2],s=[],r=[],a=void 0,n=void 0,o=void 0,u=void 0,l=void 0;for(l=0;l<t.length;l++)s.push({start:t.start(l),end:t.end(l)});for(s.sort((function(e,t){var i=e.start-t.start;return i||t.end-e.end})),l=0;l<s.length;l++){var h=r.length;if(h){var d=r[h-1].end;s[l].start-d<i?s[l].end>d&&(r[h-1].end=s[l].end):r.push(s[l])}else r.push(s[l])}for(l=0,a=0,n=o=e;l<r.length;l++){var c=r[l].start,f=r[l].end;e+i>=c&&e<f?(n=c,a=(o=f)-e):e+i<c&&(u=c)}return{len:a,start:n,end:o,nextStart:u}}},{key:"setTargetDuration",value:function(e){this.targetDuration=e}},{key:"onPlayVideo",value:function(e,t,i){e.volume=this.H5Player.getVolume(),0!==this.startTs&&(l.default.warn("HLSMgr.onPlayVideo load time="+(h.default.now()-this.startTs)),this.startTs=0),this.H5Player.trigger(a.default.VIDEO_PLAY,{uid:0,video:e,width:t,height:i,haveVideo:!0})}},{key:"onVideoStop",value:function(e){l.default.log("HLSMgr.onVideoStop"),this.H5Player.trigger(a.default.VIDEO_STOP,{uid:0,video:this.player.getPlayVideo()})}},{key:"onAnchorStop",value:function(){this.H5Player.trigger(a.default.ANCHOR_STOP,{uid:0})}},{key:"onPlayerError",value:function(e){l.default.log("HLSMgr.onPlayerError"),this.H5Player.trigger(a.default.VIDEO_STOP,{uid:0,video:this.player.getPlayVideo()})}},{key:"onPlayPause",value:function(e){}},{key:"onPlayResume",value:function(e){}}]),e}();i.default=c,t.exports=i.default},{"../events":2,"../mse/msePlayer":14,"../utils/logger":18,"../utils/timeUtil":19,"../utils/xhr-loader":20,"./hlsPlaylist":6,"./utils/url":9}],6:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),a=s(e("./utils/seq-gen")),n=s(e("../utils/xhr-loader")),o=s(e("../utils/logger")),u=s(e("./utils/url")),l=s(e("./utils/m3u8Parser")),h=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.hls=t,this.isLive=t.isLive,this.config=t.config,this.seqGener=new a.default,this.m3u8Parser=new l.default(t.isLive),this.currLevelId=0,this.currFrag=null,this.levels=[],this.firstLevelLoaded=!1,this.loader=null}return r(e,[{key:"destroy",value:function(){this.seqGener=null,this.m3u8Parser=null,this.currLevelId=0,this.currFrag=null,this.levels=null,this.firstLevelLoaded=!1,this.loader.abort(),this.loader=null}},{key:"getNextFrag",value:function(){var e=this.currLevelDetails.fragments,t=null,i=0;return e.length>0&&(t=e.shift(),this.currFrag=t,e.forEach((function(e){i+=e.duration})),this.currLevelDetails.totalduration=i,this.currLevelDetails.startSN=t.sn),t}},{key:"loadManifest",value:function(e){this.manifsetUrl=e,this.loader=new n.default(this.config),this.loader.load(e,"",this.onManifestLoaded.bind(this),this.loadManifestError.bind(this),this.loadManifestTimeout.bind(this),this.config.listLoadingTimeOut,this.config.listLoadingMaxRetry,this.config.listLoadingRetryDelay)}},{key:"onManifestLoaded",value:function(e,t){if(404!==e.currentTarget.status&&0!==e.currentTarget.status){var i=e.currentTarget.responseText,s=this.manifsetUrl,r=[],a=void 0,n={};if(0===i.indexOf("#EXTM3U")){(i.indexOf("#EXTINF:")>0?[{url:s}]:this.m3u8Parser.parseMasterPlaylist(i,s)).forEach((function(e){var t=n[e.bitrate];void 0===t?(n[e.bitrate]=r.length,e.url=[e.url],e.urlId=0,r.push(e)):r[t].url.push(e.url)})),a=r[0].bitrate,r.sort((function(e,t){return e.bitrate-t.bitrate})),this.levels=r;for(var u=0;u<r.length;u++)if(r[u].bitrate===a){this._firstLevel=u,o.default.log("manifest loaded,"+r.length+" level(s) found, first bitrate:"+a);break}this.currLevelId=this._firstLevel,this.loadLevel()}}}},{key:"loadManifestError",value:function(e){404!==e.currentTarget.status&&0!==e.currentTarget.status||this.hls.onAnchorStop()}},{key:"loadManifestTimeout",value:function(){this.hls.reset()}},{key:"loadLevel",value:function(){if(this.currLevel){var e=this.currLevel.url;if(!this.isLive&&this.currLevelDetails){var t=this.currLevelDetails.fragments,i=t[t.length-1];i||(o.default.log("hlsPlaylist.loadLevel: fragments run out"),i=this.currFrag),e=t.length<=this.config.minFragBufferNum?this.currLevel.url.replace(/\?btime=\d*$/,"?btime="+i.time):null}e&&(this.loader=new n.default(this.config),this.loader.load(e,"",this.onLevelLoaded.bind(this),this.loadLevelError.bind(this),this.loadLevelTimeout.bind(this),this.config.listLoadingTimeOut,this.config.listLoadingMaxRetry,this.config.listLoadingRetryDelay))}}},{key:"onLevelLoaded",value:function(e,t){if(404!==e.currentTarget.status&&0!==e.currentTarget.status){var i=e.currentTarget.responseText,s=this.currLevel,r=e.currentTarget.responseURL,a=null;if(r&&(s.url=r),0===i.indexOf("#EXTM3U")&&i.indexOf("#EXTINF:")>0){if(a=this.m3u8Parser.parseLevelPlaylist(i,s.url,this.currLevelId),s.details=this.mergeDetails(s.details,a),this.isLive&&s.details.fragments.length>5)return void this.hls.reconnectLive();this.hls.setTargetDuration(3*this.currLevelDetails.targetduration),this.firstLevelLoaded||(this.hls.loadFragment(),this.firstLevelLoaded=!0)}}}},{key:"mergeDetails",value:function(e,t){var i=this;if(!e)return t;var s,r=0;s=e.fragments.length>0?e.fragments[e.fragments.length-1].sn:this.currFrag.sn,t.fragments.forEach((function(t){t.sn>s&&e.fragments.push(t)})),e.endSN=t.endSN;var a=[];return e.fragments.forEach((function(e){r+=e.duration;var t=u.default.getTimeFromUrl(e.url,i.isLive);a.push("sn:"+e.sn+",url:"+t)})),e.totalduration=r,e}},{key:"loadLevelError",value:function(){404!==event.currentTarget.status&&0!==event.currentTarget.status||this.hls.onAnchorStop()}},{key:"loadLevelTimeout",value:function(){this.hls.reset()}},{key:"onCheckTimer",value:function(e){e%5==0&&this.loadLevel()}},{key:"currLevel",get:function(){return this.levels?this.levels[this.currLevelId]:null}},{key:"currLevelDetails",get:function(){return this.currLevel?this.currLevel.details:null}}]),e}();i.default=h,t.exports=i.default},{"../utils/logger":18,"../utils/xhr-loader":20,"./utils/m3u8Parser":7,"./utils/seq-gen":8,"./utils/url":9}],7:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),a=s(e("./url")),n=s(e("../utils/seq-gen")),o=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.isLive=t,this.seqGener=new n.default}return r(e,[{key:"resolve",value:function(e,t){return a.default.buildAbsoluteURL(t,e)}},{key:"parseMasterPlaylist",value:function(e,t){for(var i,s,r,a=[],n={},o=/#EXT-X-STREAM-INF:([^\n\r]*(BAND)WIDTH=(\d+))?([^\n\r]*(CODECS)=\"([^\"\n\r]*)\",?)?([^\n\r]*(RES)OLUTION=(\d+)x(\d+))?([^\n\r]*(NAME)=\"(.*)\")?[^\n\r]*[\r\n]+([^\r\n]+)/g;null!=(i=o.exec(e));){for(i.shift(),i=i.filter((function(e){return void 0!==e})),n.url=this.resolve(i.pop(),t);i.length>0;)switch(i.shift()){case"RES":n.width=parseInt(i.shift()),n.height=parseInt(i.shift());break;case"BAND":n.bitrate=parseInt(i.shift());break;case"NAME":n.name=i.shift();break;case"CODECS":for(s=i.shift().split(",");s.length>0;)-1!==(r=s.shift()).indexOf("avc1")?n.videoCodec=this.avc1toavcoti(r):n.audioCodec=r}a.push(n),n={}}return a}},{key:"avc1toavcoti",value:function(e){var t,i=e.split(".");return i.length>2?(t=i.shift()+".",t+=parseInt(i.shift()).toString(16),t+=("00"+parseInt(i.shift()).toString(16)).substr(-4)):t=e,t}},{key:"parseKeyParamsByRegex",value:function(e,t){var i=t.exec(e);return i&&(i.shift(),2===(i=i.filter((function(e){return void 0!==e}))).length)?i[1]:null}},{key:"cloneObj",value:function(e){return JSON.parse(JSON.stringify(e))}},{key:"parseLevelPlaylist",value:function(e,t,i){var s;this.isLive||(s=this.seqGener.genSnFromM3u8(e));var r,n,o,u,l,h=0,d=0,c={url:t,fragments:[],live:this.isLive,startSN:0},f=0;this.isLive||(c.startSN=s);var v={method:null,key:null,iv:null,uri:null};for(n=/(?:#EXT-X-(MEDIA-SEQUENCE):(\d+))|(?:#EXT-X-(TARGETDURATION):(\d+))|(?:#EXT-X-(KEY):(.*))|(?:#EXT(INF):([\d\.]+)[^\r\n]*([\r\n]+[^#|\r\n]+)?)|(?:#EXT-X-(BYTERANGE):([\d]+[@[\d]*)]*[\r\n]+([^#|\r\n]+)?|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DIS)CONTINUITY))/g;null!==(r=n.exec(e));)switch(r.shift(),(r=r.filter((function(e){return void 0!==e})))[0]){case"MEDIA-SEQUENCE":this.isLive&&(h=c.startSN=parseInt(r[1]));break;case"TARGETDURATION":c.targetduration=parseFloat(r[1]);break;case"ENDLIST":c.live=!1;break;case"DIS":f++;break;case"BYTERANGE":var p=r[1].split("@");l=1===p.length?u:parseInt(p[1]),u=parseInt(p[0])+l,(o=c.fragments.length?c.fragments[c.fragments.length-1]:null)&&!o.url&&(o.byteRangeStartOffset=l,o.byteRangeEndOffset=u,o.url=this.resolve(r[2],t));break;case"INF":var y=parseFloat(r[1]);if(!isNaN(y)){var g,m=h++;if(this.isLive||(m=s++),v.method&&v.uri&&!v.iv){g=this.cloneObj(v);for(var S=new Uint8Array(16),b=12;b<16;b++)S[b]=m>>8*(15-b)&255;g.iv=S}else g=v;c.fragments.push({url:r[2]?this.resolve(r[2],t):null,time:a.default.getTimeFromUrl(r[2],this.isLive),duration:y,start:d,sn:m,level:i,cc:f,byteRangeStartOffset:l,byteRangeEndOffset:u,decryptdata:g}),d+=y,l=null}break;case"KEY":var k=r[1],T=this.parseKeyParamsByRegex(k,/(METHOD)=([^,]*)/),E=this.parseKeyParamsByRegex(k,/(URI)=["]([^,]*)["]/),_=this.parseKeyParamsByRegex(k,/(IV)=([^,]*)/);T&&(v={method:null,key:null,iv:null,uri:null},E&&"AES-128"===T&&(v.method=T,v.uri=this.resolve(E,t),v.key=null,_&&(v.iv=_,"0x"===v.iv.substring(0,2)&&(v.iv=v.iv.substring(2)),v.iv=v.iv.match(/.{8}/g),v.iv[0]=parseInt(v.iv[0],16),v.iv[1]=parseInt(v.iv[1],16),v.iv[2]=parseInt(v.iv[2],16),v.iv[3]=parseInt(v.iv[3],16),v.iv=new Uint32Array(v.iv))))}return c.totalduration=d,c.endSN=h-1,this.isLive||(c.endSN=s-1),c}}]),e}();i.default=o,t.exports=i.default},{"../utils/seq-gen":8,"./url":9}],8:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.startSeq=1e3,this.m3u8Len=0}return s(e,[{key:"genSnFromM3u8",value:function(e){var t=this.convertM3u8ToArray(e);if(void 0===this.pre)this.pre=t;else{var i=this.findSeq(this.pre,t[0],this.startSeq);-1===i&&(i=this.startSeq+this.pre.length),this.pre=t,this.startSeq=i}return this.startSeq}},{key:"convertM3u8ToArray",value:function(e){for(var t=/#EXT(INF):([\d\.]+)[^\r\n]*[\r\n]+([^#|\r\n]+)?/g,i=[],s=void 0;null!==(s=t.exec(e));)s.shift(),"INF"===(s=s.filter((function(e){return void 0!==e})))[0]&&i.push(s[2]),s=[];return i}},{key:"findSeq",value:function(e,t,i){for(var s=e.length-1;s>=0;s--)if(e[s]===t)return i+s;return-1}}]),e}();i.default=r,t.exports=i.default},{}],9:[function(e,t,i){"use strict";var s={buildAbsoluteURL:function(e,t){if(t=t.trim(),/^[a-z]+:/i.test(t))return t;var i=null,r=null,a=/^([^#]*)(.*)$/.exec(t);a&&(r=a[2],t=a[1]);var n=/^([^\?]*)(.*)$/.exec(t);n&&(i=n[2],t=n[1]);var o=/^([^#]*)(.*)$/.exec(e);o&&(e=o[1]);var u=/^([^\?]*)(.*)$/.exec(e);u&&(e=u[1]);var l=/^((([a-z]+):)?\/\/[a-z0-9\.-]+(:[0-9]+)?\/)(.*)$/i.exec(e),h=l[3],d=l[1],c=l[5],f=null;return f=/^\/\//.test(t)?h+"://"+s.buildAbsolutePath("",t.substring(2)):/^\//.test(t)?d+s.buildAbsolutePath("",t.substring(1)):d+s.buildAbsolutePath(c,t),i&&(f+=i),r&&(f+=r),f},buildAbsolutePath:function(e,t){for(var i,s,r=t,a="",n=e.replace(/[^\/]*$/,r.replace(/(\/|^)(?:\.?\/+)+/g,"$1")),o=0;(s=n.indexOf("/../",o))>-1;o=s+i)i=/^\/(?:\.\.\/)*/.exec(n.slice(s))[0].length,a=(a+n.substring(o,s)).replace(new RegExp("(?:\\/+[^\\/]*){0,"+(i-1)/3+"}$"),"/");return a+n.substr(o)},getTimeFromUrl:function(e,t){var i=t?/\d+_(\d+)_\d+.ts?/:/(\d+)_\d+_\d+.ts?/,s=e.match(i);return s?t?s[1]:Math.round(s[1]/1e3):-1},getVodUrl:function(e,t,i,s){return"http://106.38.255.95:9123/xcrs/"+e+"_"+t+"_"+i+".m3u8?btime="+s}};t.exports=s},{}],10:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),r=function(e){return e&&e.__esModule?e:{default:e}}(e("../../utils/logger")),a=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.data=t,this.bytesAvailable=this.data.byteLength,this.word=0,this.bitsAvailable=0}return s(e,[{key:"loadWord",value:function(){var e=this.data.byteLength-this.bytesAvailable,t=new Uint8Array(4),i=Math.min(4,this.bytesAvailable);if(0===i)throw new Error("no bytes available");t.set(this.data.subarray(e,e+i)),this.word=new DataView(t.buffer).getUint32(0),this.bitsAvailable=8*i,this.bytesAvailable-=i}},{key:"skipBits",value:function(e){var t=void 0;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,e-=(t=e>>3)>>3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}},{key:"readBits",value:function(e){var t=Math.min(this.bitsAvailable,e),i=this.word>>>32-t;return e>32&&r.default.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this.bytesAvailable>0&&this.loadWord(),(t=e-t)>0?i<<t|this.readBits(t):i}},{key:"skipLZ",value:function(){var e=void 0;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBoolean",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"skipScalingList",value:function(e){var t=8,i=8,s=void 0;for(s=0;s<e;s++)0!==i&&(i=(t+this.readEG()+256)%256),t=0===i?t:i}},{key:"readSPS",value:function(){var e,t,i,s,r=0,a=0,n=0,o=0,u=void 0,l=void 0,h=void 0;if(this.readUByte(),e=this.readUByte(),this.readBits(5),this.skipBits(3),this.readUByte(),this.skipUEG(),100===e||110===e||122===e||144===e){var d=this.readUEG();if(3===d&&this.skipBits(1),this.skipUEG(),this.skipUEG(),this.skipBits(1),this.readBoolean())for(l=3!==d?8:12,h=0;h<l;h++)this.readBoolean()&&(h<6?this.skipScalingList(16):this.skipScalingList(64))}this.skipUEG();var c=this.readUEG();if(0===c)this.readUEG();else if(1===c)for(this.skipBits(1),this.skipEG(),this.skipEG(),u=this.readUEG(),h=0;h<u;h++)this.skipEG();return this.skipUEG(),this.skipBits(1),t=this.readUEG(),i=this.readUEG(),0===(s=this.readBits(1))&&this.skipBits(1),this.skipBits(1),this.readBoolean()&&(r=this.readUEG(),a=this.readUEG(),n=this.readUEG(),o=this.readUEG()),{width:16*(t+1)-2*r-2*a,height:(2-s)*(i+1)*16-2*n-2*o}}},{key:"readSliceType",value:function(){return this.readUByte(),this.readUEG(),this.readUEG()}}]),e}();i.default=a,t.exports=i.default},{"../../utils/logger":18}],11:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),a=s(e("../../utils/logger")),n=(s(e("../../utils/timeUtil")),e("./flvParser")),o=s(n),u=function(){function e(){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.size=0,this.buffers=[]}return r(e,[{key:"destroy",value:function(){this.reset()}},{key:"reset",value:function(){this.size=0,this.buffers=[]}},{key:"append",value:function(e){0!==e.length&&(this.buffers.push(e),this.size+=e.length)}},{key:"getByte",value:function(e){for(var t=0,i=0;i<this.buffers.length;++i){var s=this.buffers[i];if(t+s.length>e)return s[e-t];t+=s.length}return a.default.warn("FlvCacher.getByte has no offset="+e),0}},{key:"popFront",value:function(){if(0===this.size)return null;if(0===this.buffers.length)return a.default.error("FlvCacher.popFront error no buffers bu size:"+this.size+" not eq 0"),this.reset(),null;if(this.size<=o.default.FLV_TAG_HEADER_LEN+o.default.FLV_PREV_TAG_SIZE_LEN)return null;var e=(this.getByte(1)<<16)+(this.getByte(2)<<8)+this.getByte(3),t=o.default.FLV_TAG_HEADER_LEN+e+o.default.FLV_PREV_TAG_SIZE_LEN;if(this.size<t)return null;if(1===this.buffers.length){if(this.buffers[0].length===t){var i=this.buffers[0];return this.buffers.shift(),this.size-=t,i}var s=this.buffers[0].slice(0,t);return this.buffers[0]=this.buffers[0].slice(t),this.size-=t,s}for(var r=new Uint8Array(t),n=0,u=0;n<t;){var l=t-n;if(this.buffers[0].length>l){r.set(this.buffers[0].slice(0,l),u),u+=l,n+=l,this.buffers[0]=this.buffers[0].slice(l),this.size-=l;break}r.set(this.buffers[0].slice(),u),u+=this.buffers[0].length,n+=this.buffers[0].length,this.size-=this.buffers[0].length,this.buffers.shift()}return r}}]),e}();i.default=u,t.exports=i.default},{"../../utils/logger":18,"../../utils/timeUtil":19,"./flvParser":12}],12:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),a=s(e("../../utils/logger")),n=s(e("../../utils/aacFrame")),o=s(e("./exp-golomb")),u=s(e("../../utils/timeUtil")),l=s(e("./flvCacher")),h=function(){function e(t,i,s){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.printTs=0,this.mse=t,this.videoType=s,this.flvCacher=new l.default,this.DEFAULT_GOP=200,this.bufLen=400,this.pushGop=i,this.parseFlvHead=!1,this.lengthSizeMinusOne=0,this.audioConfig=[43,138,8,0],this.audioSampleRate=22500,this.aacTimeLen=1024e3/this.audioSampleRate,this.audioChannelCount=1,this.spsUnit=null,this.ppsUnit=null,this.vpsUnit=null,this.hasCtsZero=!1,this.paused=!1,this.nextAacDts=-1,this.playVideoFrameCnt=0,this.playVideoLength=0,this.playAudioFrameCnt=0,this.playAudioLength=0,this.playEmptyAudioFrameCnt=0,this.reset()}return r(e,[{key:"destroy",value:function(){this.reset()}},{key:"reset",value:function(){this.avcTrack={type:"video",id:1,sequenceNumber:0,samples:[],len:0,nbNalu:0,duration:0,startDts:-1,endDts:0},this.aacTrack={type:"audio",id:2,sequenceNumber:0,samples:[],len:0,duration:0,startDts:-1,endDts:0},this.aacTrack.config=this.audioConfig,this.aacTrack.audiosamplerate=this.audioSampleRate,this.aacTrack.channelCount=this.audioChannelCount,this.aacTrack.codec="mp4a.40.5",this.aacTrack.timescale=this.mse.remuxer.timescale,this.avcTrack.isHevc=!1,this.avcTrack.timescale=this.mse.remuxer.timescale,this.bufLen=400,this.nextAacDts=-1,this.hasCtsZero=!1}},{key:"getPlayStat",value:function(){var e={videoFrameCnt:this.playVideoFrameCnt,videoLength:this.playVideoLength,audioFrameCnt:this.playAudioFrameCnt,audioLength:this.playAudioLength,emptyAudioFrameCnt:this.playEmptyAudioFrameCnt};return this.playVideoFrameCnt=0,this.playVideoLength=0,this.playAudioFrameCnt=0,this.playAudioLength=0,this.playEmptyAudioFrameCnt=0,e}},{key:"setPaused",value:function(e){this.paused=e}},{key:"setPushGop",value:function(e){this.pushGop=e,a.default.log("FlvParser.setPushGop val="+e)}},{key:"getParserBufLen",value:function(){return 0!==this.avcTrack.samples.length?this.avcTrack.endDts-this.avcTrack.startDts:0!==this.aacTrack.samples.length?this.aacTrack.endDts-this.aacTrack.startDts:0}},{key:"parseFlv",value:function(t){var i=0,s=t.length;if(u.default.now(),!1===this.parseFlvHead){if(s<e.FLV_HEADER_LEN+e.FLV_PREV_TAG_SIZE_LEN)return void a.default.warn("FlvParser.parseFlv flv has no header len="+s);i+=e.FLV_HEADER_LEN+e.FLV_PREV_TAG_SIZE_LEN,s-=e.FLV_HEADER_LEN+e.FLV_PREV_TAG_SIZE_LEN,this.parseFlvHead=!0,a.default.log("FlvParser.parseFlv flv handle flv header")}0===i?this.flvCacher.append(t):this.flvCacher.append(t.slice(i));for(var r=void 0;null!==(r=this.flvCacher.popFront());)this.parseTag(r,r.length)}},{key:"parseTag",value:function(t){var i,s,r,n=void 0,u=void 0,l=void 0,h=void 0,d=void 0,c=void 0,f=0,v=t.length,p=0,y=void 0,g=[],m=0;if(v<e.FLV_TAG_HEADER_LEN+e.FLV_PREV_TAG_SIZE_LEN)a.default.warn("FlvParser.parseTag flv has no whole tag len="+v+" data="+t);else if(i=t[f++],s=(t[f++]<<16)+(t[f++]<<8)+t[f++],v-(e.FLV_TAG_HEADER_LEN+e.FLV_PREV_TAG_SIZE_LEN)<s)a.default.warn("FlvParser.parseTag flv has no enough data dataLen="+s+" len="+v);else if(0!==s)if(r=(t[f++]<<16)+(t[f++]<<8)+t[f++]+(t[f++]<<24),i===e.VIDEO_TYPE){if(f+=3,s<5)return void a.default.warn("FlvParser.parseTag avc videotag not enough dataLen="+s);if(n=t[f]>>4,t[f++],2===(u=t[f++]))return void a.default.log("FlvParser.parseTag avc_end dataLen="+s);if(5===s)return void a.default.log("FlvParser.parseTag avc_empty frameType="+n+" avcPacketType="+u);if(0===u){var S=[],b=[],k=[],T=!1,E=(f+=3)+s-5;if(this.isHevcNal(t,f)){for(var _=t[f+=4]>>1&63,L=f;f<E;){if(this.isHevcNal(t,f)||f+1===E){switch(_){case e.NAL_VPS:var P={data:t.subarray(L,f),type:_};this.vpsUnit&&this.vpsUnit.data.toString(16)!==P.data.toString(16)&&(a.default.log("FlvParser.parseTag vps changed"),T=!0),this.vpsUnit=P,S.push(P.data);break;case e.NAL_SPS:var A={data:t.subarray(L,f),type:_};this.spsUnit&&this.spsUnit.data.toString(16)!==A.data.toString(16)&&(a.default.log("FlvParser.parseTag sps changed"),T=!0),this.spsUnit=A,b.push(A.data);break;case e.NAL_PPS:var w={data:t.subarray(L,f),type:_};this.ppsUnit&&this.ppsUnit.data.toString(16)!==w.data.toString(16)&&(a.default.log("FlvParser.parseTag pps changed"),T=!0),this.ppsUnit=w,k.push(w.data)}if(f+4<E){_=t[f+=4]>>1&63,L=f;continue}}f++}T&&(this.reset(),this.paused=this.mse.onAvcCfgChange()),this.avcTrack.vps=S,this.avcTrack.sps=b,this.avcTrack.pps=k,this.avcTrack.codec="avc1.4d401f",this.avcTrack.width=this.mse.width,this.avcTrack.height=this.mse.height,this.avcTrack.isHevc=!0,this.hasCtsZero=!0}else{f+=4,this.lengthSizeMinusOne=3&t[f++];for(var M=31&t[f++],x=0,C=0,D="",U=0;U<M;++U){h=(t[f++]<<8)+t[f++],A={data:t.subarray(f,f+h),type:7},this.spsUnit&&this.spsUnit.data.toString(16)!==A.data.toString(16)&&(a.default.log("FlvParser.parseTag sps changed"),T=!0),this.spsUnit=A,f+=h,x=(H=new o.default(A.data).readSPS()).width,C=H.height,b.push(A.data);for(var O=A.data.subarray(1,4),F="avc1.",B=0;B<3;B++){var I=O[B].toString(16);I.length<2&&(I="0"+I),F+=I}D=F}var N=t[f++];for(U=0;U<N;++U)d=(t[f++]<<8)+t[f++],w={data:t.subarray(f,f+d),type:8},this.ppsUnit&&this.ppsUnit.data.toString(16)!==w.data.toString(16)&&(a.default.log("FlvParser.parseTag pps changed"),T=!0),this.ppsUnit=w,f+=d,k.push(w.data);T&&(this.reset(),this.paused=this.mse.onAvcCfgChange()),this.avcTrack.isHevc=!1,this.avcTrack.sps=b,this.avcTrack.pps=k,this.avcTrack.width=x,this.avcTrack.height=C,this.avcTrack.codec=D,this.mse.setResolution(x,C)}a.default.log("FlvParser.parseTag avccfg dataLen="+s+" spsLen="+h+" ppsLen="+d+" w/h="+this.avcTrack.width+"/"+this.avcTrack.height+" codec="+this.avcTrack.codec)}else if(1===u){if(0===(p=(t[f++]<<16)+(t[f++]<<8)+t[f++])?this.hasCtsZero||(a.default.log("FlvParser.parseTag cts has 0"),this.hasCtsZero=!0):p>=8388608?(a.default.warn("FlvParser.parseTag negative cts="+p+" dts="+r),p-=16777216):p>2500&&p<3500?p=0:p>600&&a.default.warn("FlvParser.parseTag large cts="+p+" dts="+r),-1!==this.avcTrack.startDts&&!this.paused){var R=!1;this.pushGop?n===e.IFRAME&&(R=!0):this.hasCtsZero?r>=this.avcTrack.startDts+this.bufLen&&(R=!0):n===e.IFRAME&&(R=!0),R&&(this.avcTrack.endDts=r,this.remux())}if(n===e.IFRAME&&(g.push(this.spsUnit),m+=this.spsUnit.data.length,g.push(this.ppsUnit),m+=this.ppsUnit.data.length),E=f+s-5,this.isHevcNal(t,f))for(_=t[f+=4]>>1&63,L=f;f<E;)(this.isHevcNal(t,f)||f+1===E)&&(y={data:t.subarray(L,f),type:1===n?5:1},g.push(y),m+=y.data.length,f+4<E)?(_=t[f+=4]>>1&63,L=f):f++;else for(var V=s-5;V;){for(c=0,U=0;U<=this.lengthSizeMinusOne;++U)c+=t[f++]<<8*(this.lengthSizeMinusOne-U);if(V-=this.lengthSizeMinusOne+1,0!==c){if(c>V){f+=V;break}V-=c,y={data:t.subarray(f,f+c),type:1===n?5:1},this.isH264Sei(y.data)||(g.push(y),m+=y.data.length),f+=c}}if(m>0){var G={units:{units:g,length:m},pts:90*(r+p),dts:90*r,key:1===n};this.avcTrack.samples.push(G),this.avcTrack.nbNalu+=g.length,this.avcTrack.len+=m,this.playVideoFrameCnt++,this.playVideoLength+=s,-1===this.avcTrack.startDts&&(this.avcTrack.startDts=r),this.avcTrack.endDts=r,r<this.printTs&&a.default.log("FlvParser.parseTag avc dts="+r+" pts="+(r+p)+" dataLen="+s+" naluLen="+c+" unitsLen="+G.units.length+" unitsNum="+G.units.units.length+" frameType="+n)}else a.default.warn("FlvParser.parseTag discard empty nalu dts="+r+" pts="+(r+p)+" dataLen="+s+" naluLen="+c)}else a.default.warn("FlvParser.parseTag error avc packet type="+u)}else if(i===e.AUDIO_TYPE)if(f+=4,0===(l=t[f++]))if(s>=4){var H,z=t[f]>>3,j=((7&t[f])<<1)+((128&t[f+1])>>7);this.audioChannelCount=(120&t[f+1])>>3,(H=this.getAdtsConfig(z,j,this.audioChannelCount)).toString(16)!==this.audioConfig.toString(16)&&a.default.warn("FlvParser.parseTag adts changed old="+this.audioConfig+" new="+H),this.audioConfig=H}else a.default.warn("FlvParser.parseTag adts error dataLen="+s+" ts="+r);else if(1===l){-1!==this.aacTrack.startDts&&r>=this.aacTrack.startDts+this.bufLen&&0===this.avcTrack.samples.length&&(this.aacTrack.endDts=r,this.remux()),-1===this.aacTrack.startDts&&(this.aacTrack.startDts=r);var Y=s-2,q={unit:t.subarray(f,f+Y),pts:90*r,dts:90*r,ts:r};this.aacTrack.samples.push(q),this.aacTrack.endDts=r,this.aacTrack.len+=q.unit.length,r<this.printTs&&a.default.log("FlvParser.parseTag aac dts="+r+" dataLen="+s+" unitLen="+q.unit.length)}else a.default.warn("FlvParser.parseTag error aac packet type="+l);else 18===i?(a.default.log("FlvParser.parseTag script tag len="+s),this.reset(),this.audioConfig=[43,138,8,0],this.audioSampleRate=22500,this.aacTimeLen=1024e3/this.audioSampleRate,this.audioChannelCount=1,this.spsUnit=null,this.ppsUnit=null,this.vpsUnit=null,this.mse.onRestart()):a.default.warn("FlvParser.parseTag discard type="+i+" len="+s);else a.default.warn("FlvParser.parseTag flvtag empty type="+i)}},{key:"remux",value:function(){var e=this.avcTrack,t=this.aacTrack,i=t.samples,s={type:"audio",id:2,sequenceNumber:0,samples:[],len:0,duration:0,startDts:-1,endDts:0};s.config=this.audioConfig,s.audiosamplerate=this.audioSampleRate,s.channelCount=this.audioChannelCount,s.codec="mp4a.40.5",s.timescale=this.mse.remuxer.timescale;var r=e.startDts,o=e.endDts;-1===r&&(r=t.startDts,o=t.endDts);var u=null;i.length>0&&(u=i[0]),-1===this.nextAacDts&&(this.nextAacDts=r,0===this.nextAacDts&&(this.nextAacDts+=this.aacTimeLen));var l=0,h=0;for(l=this.nextAacDts;l<o;l+=this.aacTimeLen)if(h=Math.round(l),u&&u.ts<=h)(u=i.shift()).pts=u.dts=90*h,u.ts=h,s.samples.push(u),s.len+=u.unit.length,this.playAudioFrameCnt++,this.playAudioLength+=u.unit.length,-1===s.startDts&&(s.startDts=u.ts),s.endDts=u.ts,u=i.length>0?i[0]:null;else if("flv"===this.videoType&&22050===this.audioSampleRate){a.default.log("FlvParser.remux aac add empty aacDts="+h);var d={unit:new Uint8Array(n.default.emptyAacFrame),pts:0,dts:0,ts:0};d.pts=d.dts=90*h,d.ts=h,s.samples.push(d),s.len+=d.unit.length,this.playAudioFrameCnt++,this.playEmptyAudioFrameCnt++,this.playAudioLength+=d.unit.length,-1===s.startDts&&(s.startDts=d.ts),s.endDts=d.ts}this.nextAacDts=l,i.length>0?(this.aacTrack.startDts=i[0].ts,this.aacTrack.startDts=i[i.length-1].ts):(this.aacTrack.startDts=-1,this.aacTrack.endDts=0),s.duration=Math.round((s.endDts-s.startDts)*(this.mse.remuxer.timescale/1e3)),e.duration=Math.round((this.avcTrack.endDts-this.avcTrack.startDts)*(this.mse.remuxer.timescale/1e3)),o<this.printTs&&(a.default.log("REMUX aac ts="+s.startDts+"-"+s.endDts+" len="+s.len+" samples="+s.samples.length+" duration="+s.duration),a.default.log("REMUX avc ts="+e.startDts+"-"+e.endDts+" len="+e.len+" samples="+e.samples.length+" nalus="+e.nbNalu+" duration="+e.duration)),this.mse.onGop(o-r),this.mse.remuxer.remux(s,e,0,!1),this.avcTrack={type:"video",id:1,sequenceNumber:0,samples:[],len:0,nbNalu:0,duration:0,startDts:-1,endDts:0},this.bufLen=this.DEFAULT_GOP}},{key:"getAdtsConfig",value:function(e,t,i){var s=0,r=null;return-1!==navigator.userAgent.indexOf("firefox")?t>=6?(e=5,r=new Array(4),s=t-3):(e=2,r=new Array(2),s=t):-1!==navigator.userAgent.indexOf("Android")?-1!==navigator.userAgent.indexOf("MQQBrowser")?(e=2,r=new Array(2),s=t):(e=5,r=new Array(4),s=t):(e=5,r=new Array(4),t>=6?s=t-3:(1===i&&(e=2,r=new Array(2)),s=t)),this.audioSampleRate=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][t],this.aacTimeLen=1024e3/this.audioSampleRate,r[0]=e<<3,r[0]|=(14&t)>>1,r[1]|=(1&t)<<7,r[1]|=i<<3,5===e&&(r[1]|=(14&s)>>1,r[2]=(1&s)<<7,r[2]|=8,r[3]=0),a.default.log("FlvParser.getAdtsConfig type="+e+" index="+t+" channel="+i+" exIndex="+s+" config="+r),r}},{key:"isHevcNal",value:function(e,t){return 0===e[t]&&0===e[t+1]&&0===e[t+2]&&1===e[t+3]}},{key:"isH264Sei",value:function(e){return e[2]===e.length-4&&249===e[3]&&243===e[4]}}]),e}();h.FLV_HEADER_LEN=9,h.FLV_TAG_HEADER_LEN=11,h.FLV_PREV_TAG_SIZE_LEN=4,h.VIDEO_TYPE=9,h.AUDIO_TYPE=8,h.IFRAME=1,h.NAL_VPS=32,h.NAL_SPS=33,h.NAL_PPS=34,i.default=h,t.exports=i.default},{"../../utils/aacFrame":17,"../../utils/logger":18,"../../utils/timeUtil":19,"./exp-golomb":10,"./flvCacher":11}],13:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),a=s(e("../../utils/logger")),n=(s(e("../remux/mp4-remuxer")),e("../demux/exp-golomb")),o=s(n),u=function(){function e(t,i){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.mse=t,this.remuxer=i,this.width=0,this.height=0,this.lastCC=0,this.PES_TIMESCALE=9e4}return r(e,[{key:"probe",value:function(e){return e.length>=564&&71===e[0]&&71===e[188]&&71===e[376]}},{key:"switchLevel",value:function(){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack={type:"video",id:-1,sequenceNumber:0,samples:[],len:0,nbNalu:0},this._aacTrack={type:"audio",id:-1,sequenceNumber:0,samples:[],len:0},this._id3Track={type:"id3",id:-1,sequenceNumber:0,samples:[],len:0},this.remuxer.switchLevel()}},{key:"insertDiscontinuity",value:function(){this.switchLevel(),this.remuxer.insertDiscontinuity()}},{key:"parseTs",value:function(e){var t,i,s,r,n,o,u,l,h=e.data,d=e.audioCodec,c=e.videoCodec,f=e.timeOffset,v=e.cc,p=e.level,y=e.sn,g=e.duration,m=e.url;if(n=(h=new Uint8Array(h)).length,this.probe(h)){this.audioCodec=d,this.videoCodec=c,this.timeOffset=f,this._duration=g,this.contiguous=!1,v!==this.lastCC?(a.default.log("discontinuity detected"),this.insertDiscontinuity(),this.lastCC=v):p!==this.lastLevel?(a.default.log("level switch detected"),this.switchLevel(),this.lastLevel=p):y===this.lastSN+1&&(this.contiguous=!0),this.lastSN=y,this.contiguous||(this.aacOverFlow=null);var S=this.pmtParsed,b=this._avcTrack.id,k=this._aacTrack.id,T=this._id3Track.id;for(r=0;r<n;r+=188)if(71===h[r]){if(o=!!(64&h[r+1]),u=((31&h[r+1])<<8)+h[r+2],(48&h[r+3])>>4>1){if((l=r+5+h[r+4])===r+188)continue}else l=r+4;S?u===b?(o&&(t&&this._parseAVCPES(this._parsePES(t)),t={data:[],size:0}),t&&(t.data.push(h.subarray(l,r+188)),t.size+=r+188-l)):u===k?(o&&(i&&this._parseAACPES(this._parsePES(i)),i={data:[],size:0}),i&&(i.data.push(h.subarray(l,r+188)),i.size+=r+188-l)):u===T&&(o&&(s&&this._parseID3PES(this._parsePES(s)),s={data:[],size:0}),s&&(s.data.push(h.subarray(l,r+188)),s.size+=r+188-l)):(o&&(l+=h[l]+1),0===u?this._parsePAT(h,l):u===this._pmtId&&(this._parsePMT(h,l),S=this.pmtParsed=!0,b=this._avcTrack.id,k=this._aacTrack.id,T=this._id3Track.id))}else a.default.error("tsParser.parseTs ERROR: TS packet did not start with 0x47");t&&this._parseAVCPES(this._parsePES(t)),i&&this._parseAACPES(this._parsePES(i)),s&&this._parseID3PES(this._parsePES(s)),this.remuxer.remux(this._aacTrack,this._avcTrack,this.timeOffset,this.contiguous,m)}}},{key:"destroy",value:function(){this.switchLevel(),this._initPTS=this._initDTS=void 0,this._duration=0}},{key:"_parsePAT",value:function(e,t){this._pmtId=(31&e[t+10])<<8|e[t+11]}},{key:"_parsePMT",value:function(e,t){var i,s;for(i=t+3+((15&e[t+1])<<8|e[t+2])-4,t+=12+((15&e[t+10])<<8|e[t+11]);t<i;){switch(s=(31&e[t+1])<<8|e[t+2],e[t]){case 15:this._aacTrack.id=s;break;case 21:this._id3Track.id=s;break;case 27:this._avcTrack.id=s;break;default:a.default.log("unkown stream type:"+e[t])}t+=5+((15&e[t+3])<<8|e[t+4])}}},{key:"_parsePES",value:function(e){var t,i,s,r,a,n,o,u=0;if(1===((t=e.data[0])[0]<<16)+(t[1]<<8)+t[2]){for(s=(t[4]<<8)+t[5],192&(i=t[7])&&((a=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2)>4294967295&&(a-=8589934592),64&i?(n=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2)>4294967295&&(n-=8589934592):n=a),o=t[8]+9,e.data[0]=e.data[0].subarray(o),e.size-=o,r=new Uint8Array(e.size);e.data.length;)t=e.data.shift(),r.set(t,u),u+=t.byteLength;return{data:r,pts:a,dts:n,len:s}}return null}},{key:"_parseAVCPES",value:function(e){var t,i,s=this._avcTrack,r=s.samples,n=this._parseAVCNALu(e.data),u=[],l=!1,h=0;if(0===n.length&&r.length>0){var d=r[r.length-1],c=d.units.units[d.units.units.length-1],f=new Uint8Array(c.data.byteLength+e.data.byteLength);f.set(c.data,0),f.set(e.data,c.data.byteLength),c.data=f,d.units.length+=e.data.byteLength,s.len+=e.data.byteLength}e.data=null;var v="",p=!1,y=!1,g=!1,m=!0,S=!1,b=void 0;try{for(var k,T=n[Symbol.iterator]();!(m=(k=T.next()).done);m=!0){var E=k.value;switch(E.type){case 1:i=!0;break;case 5:p=!0,i=!0,l=!0;break;case 6:i=!0;break;case 7:if(g=!0,i=!0,!s.sps){var _=new o.default(E.data).readSPS();this.width=s.width=_.width,this.height=s.height=_.height,s.sps=[E.data],s.timescale=this.remuxer.timescale,s.duration=this.remuxer.timescale*this._duration;for(var L=E.data.subarray(1,4),P="avc1.",A=0;A<3;A++){var w=L[A].toString(16);w.length<2&&(w="0"+w),P+=w}s.codec=P}break;case 8:y=!0,i=!0,s.pps||(s.pps=[E.data]);break;case 9:i=!0;break;default:i=!1,v+="unknown NAL "+E.type+" "}i&&(u.push(E),h+=E.data.byteLength)}}catch(e){S=!0,b=e}finally{try{!m&&T.return&&T.return()}finally{if(S)throw b}}v.length&&a.default.log(v),(!0!==g&&!0!==y||!1!==p)&&u.length&&(!0===l||s.sps)&&(t={units:{units:u,length:h},pts:e.pts,dts:e.dts,key:l},r.push(t),s.len+=h,s.nbNalu+=u.length)}},{key:"_parseAVCNALu",value:function(e){for(var t,i,s,r,a,n,o=0,u=e.byteLength,l=0,h=[];o<u;)switch(t=e[o++],l){case 0:0===t&&(l=1);break;case 1:l=0===t?2:0;break;case 2:case 3:if(0===t)l=3;else if(1===t){if(r=31&e[o],a)s={data:e.subarray(a,o-l-1),type:n},h.push(s);else if((i=o-l-1)&&this._avcTrack.samples.length){var d=this._avcTrack.samples[this._avcTrack.samples.length-1],c=d.units.units[d.units.units.length-1],f=new Uint8Array(c.data.byteLength+i);f.set(c.data,0),f.set(e.subarray(0,i),c.data.byteLength),c.data=f,d.units.length+=i,this._avcTrack.len+=i}a=o,n=r,1!==r&&5!==r||(o=u),l=0}else l=0}return a&&(s={data:e.subarray(a,u),type:n},h.push(s)),h}},{key:"_parseAACPES",value:function(e){var t,i,s,r,n,o,u,l,h,d,c=this._aacTrack,f=e.data;if(this.aacOverFlow){var v=new Uint8Array(this.aacOverFlow.byteLength+f.byteLength);v.set(this.aacOverFlow,0),v.set(f,this.aacOverFlow.byteLength),f=v}for(r=0,l=f.length;r<l-1&&(255!==f[r]||240!=(240&f[r+1]));r++);if(!r||(r<l-1?(h="AAC PES did not start with ADTS header,offset:"+r,d=!1):(h="no ADTS header found in AAC PES",d=!0),a.default.error("tsParser._parseAACPES ERROR:"+h),!d)){for(c.audiosamplerate||(i=this._ADTStoAudioConfig(f,r,this.audioCodec),c.config=i.config,c.audiosamplerate=i.samplerate,c.channelCount=i.channelCount,c.codec=i.codec,c.timescale=this.remuxer.timescale,c.duration=this.remuxer.timescale*this._duration,a.default.log("parsed codec:"+c.codec+",rate:"+i.samplerate+",nb channel:"+i.channelCount)),u=0;r+5<l&&(s=(3&f[r+3])<<11,s|=f[r+4]<<3,s|=(224&f[r+5])>>>5,s-=n=1&f[r+1]?7:9,o=Math.round(e.pts+1024*u*this.PES_TIMESCALE/c.audiosamplerate),s>0&&r+n+s<=l);)for(t={unit:f.subarray(r+n,r+n+s),pts:o,dts:o},this._aacTrack.samples.push(t),this._aacTrack.len+=s,r+=s+n,u++;r<l-1&&(255!==f[r]||240!=(240&f[r+1]));r++);this.aacOverFlow=r<l?f.subarray(r,l):null}}},{key:"_ADTStoAudioConfig",value:function(e,t,i){var s,r,n,o,u,l=navigator.userAgent.toLowerCase(),h=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];return s=1+((192&e[t+2])>>>6),(r=(60&e[t+2])>>>2)>h.length-1?void a.default.error("tsParser._ADTStoAudioConfig ERROR:nvalid ADTS sampling index:"+r):(o=(1&e[t+2])<<2,o|=(192&e[t+3])>>>6,a.default.log("manifest codec:"+i+",ADTS data:type:"+s+",sampleingIndex:"+r+"["+h[r]+"kHz],channelConfig:"+o),-1!==l.indexOf("firefox")?r>=6?(s=5,u=new Array(4),n=r-3):(s=2,u=new Array(2),n=r):-1!==l.indexOf("Android")?-1!==navigator.userAgent.indexOf("MQQBrowser")?(s=2,u=new Array(2),n=r):(s=5,u=new Array(4),n=r):(s=5,u=new Array(4),i&&(-1!==i.indexOf("mp4a.40.29")||-1!==i.indexOf("mp4a.40.5"))||!i&&r>=6?n=r-3:(i&&-1!==i.indexOf("mp4a.40.2")&&(r>=6||1===o)&&(s=2,u=new Array(2)),n=r)),u[0]=s<<3,u[0]|=(14&r)>>1,u[1]|=(1&r)<<7,u[1]|=o<<3,5===s&&(u[1]|=(14&n)>>1,u[2]=(1&n)<<7,u[2]|=8,u[3]=0),{config:u,samplerate:h[r],channelCount:o,codec:"mp4a.40."+s})}},{key:"_parseID3PES",value:function(e){this._id3Track.samples.push(e)}}]),e}();i.default=u,t.exports=i.default},{"../../utils/logger":18,"../demux/exp-golomb":10,"../remux/mp4-remuxer":16}],14:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),n=s(e("../utils/logger")),o=s(e("../utils/timeUtil")),u=(s(e("../flv/stat/qaStat")),e("./demux/flvParser")),l=s(u),h=s(e("./remux/mp4-remuxer")),d=s(e("./demux/tsParser")),c=function(){function e(t){var i=arguments.length<=1||void 0===arguments[1]?"flv":arguments[1];r(this,e),this.handler=t,this.remuxer=new h.default(this),this.parser="ts"===i?new d.default(this,this.remuxer):new l.default(this,this.remuxer,i),this.audioSegments=[],this.videoSegments=[],this.playing=!1,this.video=document.createElement("video"),this.lastPlayTime=0,this.lastCheckPlayTime=0,this.paused=!1,this.maxGop=0,this.playStartTime=0,this.mediaSource=new MediaSource,this.onmso=this.onMediaSourceOpen.bind(this),this.onmse=this.onMediaSourceEnded.bind(this),this.onmsc=this.onMediaSourceClose.bind(this),this.mediaSource.addEventListener("sourceopen",this.onmso),this.mediaSource.addEventListener("sourceended",this.onmse),this.mediaSource.addEventListener("sourceclose",this.onmsc),this.onvseeking=this.onMediaSeeking.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),this.onvmetadata=this.onMediaMetadata.bind(this),this.onvended=this.onMediaEnded.bind(this),this.video.src=URL.createObjectURL(this.mediaSource),this.onasbue=this.onAudioSBUpdateEnd.bind(this),this.onvsbue=this.onVideoSBUpdateEnd.bind(this),this.onsbe=this.onSBUpdateError.bind(this),this.audioSourceBuffer=null,this.videoSourceBuffer=null,this.audioCodec=null,this.videoCodec=null,this.width=1280,this.height=720;var s=navigator.userAgent.toLowerCase();this.isAndroid=-1!==s.indexOf("Android"),this.delayReset=!1}return a(e,[{key:"destroy",value:function(){if(n.default.log("MSEPlayer.destroy"),this.handler.onVideoStop(this.video),this.remuxer.destroy(),this.parser.destroy(),this.audioSegments=[],this.videoSegments=[],this.audioSourceBuffer){try{this.mediaSource.removeSourceBuffer(this.audioSourceBuffer),this.audioSourceBuffer.removeEventListener("updateend",this.onasbue),this.audioSourceBuffer.removeEventListener("error",this.onsbe)}catch(e){n.default.warn("MSEPlayer.destroy audio error="+e.message)}this.audioSourceBuffer=null}if(this.videoSourceBuffer){try{this.mediaSource.removeSourceBuffer(this.videoSourceBuffer),this.videoSourceBuffer.removeEventListener("updateend",this.onvsbue),this.videoSourceBuffer.removeEventListener("error",this.onsbe)}catch(e){n.default.warn("MSEPlayer.destroy video error="+e.message)}this.videoSourceBuffer=null}this.onasbue=this.onvsbue=this.onsbe=null,this.mediaSource&&(this.mediaSource.removeEventListener("sourceopen",this.onmso),this.mediaSource.removeEventListener("sourceended",this.onmse),this.mediaSource.removeEventListener("sourceclose",this.onmsc),this.onmso=this.onmse=this.onmsc=null,this.mediaSource=null),this.video&&(this.video.pause(),this.video.removeEventListener("seeking",this.onvseeking),this.video.removeEventListener("seeked",this.onvseeked),this.video.removeEventListener("loadedmetadata",this.onvmetadata),this.video.removeEventListener("ended",this.onvended),this.onvseeking=this.onvseeked=this.onvmetadata=this.onvended=null,this.video=null)}},{key:"reset",value:function(){if(this.handler.onVideoStop(this.video),this.remuxer.destroy(),this.remuxer=new h.default(this),this.audioSegments=[],this.videoSegments=[],this.playing=!1,this.lastPlayTime=0,this.lastCheckPlayTime=0,this.paused&&this.handler.onPlayResume(o.default.now()),this.paused=!1,this.maxGop=0,this.playStartTime=0,this.audioSourceBuffer){try{this.mediaSource.removeSourceBuffer(this.audioSourceBuffer),this.audioSourceBuffer.removeEventListener("updateend",this.onasbue),this.audioSourceBuffer.removeEventListener("error",this.onsbe)}catch(e){n.default.log("MSEPlayer.destroy error 1")}this.audioSourceBuffer=null}if(this.videoSourceBuffer){try{this.mediaSource.removeSourceBuffer(this.videoSourceBuffer),this.videoSourceBuffer.removeEventListener("updateend",this.onvsbue),this.videoSourceBuffer.removeEventListener("error",this.onsbe)}catch(e){n.default.log("MSEPlayer.destroy error 2")}this.videoSourceBuffer=null}this.mediaSource&&(this.mediaSource.removeEventListener("sourceopen",this.onmso),this.mediaSource.removeEventListener("sourceended",this.onmse),this.mediaSource.removeEventListener("sourceclose",this.onmsc)),this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",this.onmso),this.mediaSource.addEventListener("sourceended",this.onmse),this.mediaSource.addEventListener("sourceclose",this.onmsc),this.video&&(this.video.removeEventListener("seeking",this.onvseeking),this.video.removeEventListener("seeked",this.onvseeked),this.video.removeEventListener("loadedmetadata",this.onvmetadata),this.video.removeEventListener("ended",this.onvended)),this.video=document.createElement("video"),this.video.src=URL.createObjectURL(this.mediaSource),this.audioCodec=null,this.videoCodec=null}},{key:"setPushGop",value:function(e){this.parser.setPushGop(e)}},{key:"getPlayStat",value:function(){return this.parser.getPlayStat()}},{key:"getPlayVideo",value:function(){return this.video}},{key:"getBufferLen",value:function(){var e=0;if(this.video){var t=this.video.buffered;t.length>0&&(e=Math.round(1e3*(t.end(t.length-1)-this.video.currentTime)))}return e}},{key:"getParserBufLen",value:function(){return this.parser.getParserBufLen()}},{key:"getCurrentDts",value:function(){return this.remuxer.getInitDts()<0?0:Math.round(1e3*this.video.currentTime)+this.remuxer.getInitDts()}},{key:"getCurrentTime",value:function(){return Math.round(1e3*this.video.currentTime)}},{key:"getMaxGop",value:function(){return this.maxGop}},{key:"appendFlv",value:function(e){var t=o.default.now();this.checkBuffer(t),this.parser.parseFlv(e)}},{key:"checkBuffer",value:function(e){var t=this.video.buffered,i=t.length,s=this.getBufferLen();return 0===this.video.currentTime&&0!==this.lastPlayTime?(n.default.warn("MSEPlayer.checkBuffer onPlayerError(false) lastPlayTime="+this.lastPlayTime+" bufLen="+s),this.handler.onPlayerError(!1),void(this.lastPlayTime=0)):(this.lastPlayTime=this.video.currentTime,0!==this.playStartTime&&e>this.playStartTime+5e3&&(s>5e3||0===s)&&(this.playStartTime=0,0===this.video.currentTime&&!this.isAndroid)?(n.default.warn("MSEPlayer.checkBuffer onPlayerError(true) playTime="+this.video.currentTime+" bufLen="+s),void this.handler.onPlayerError(!0)):(i&&this.video.currentTime-t.start(0)>20&&(this.audioSourceBuffer&&!this.audioSourceBuffer.updating&&this.audioSourceBuffer.remove(0,this.video.currentTime-10),this.videoSourceBuffer&&!this.videoSourceBuffer.updating&&this.videoSourceBuffer.remove(0,this.video.currentTime-10)),void(this.delayReset&&this.getBufferLen()<500&&(n.default.log("MSEPlayer.checkBuffer delay reset"),this.reset(),this.parser.setPaused(!1),this.delayReset=!1))))}},{key:"appendTs",value:function(e){this.checkBuffer(),this.parser.parseTs(e)}},{key:"onAvcCfgChange",value:function(){return n.default.log("MSEPlayer.onAvcCfgChange"),this.getBufferLen()<500?(n.default.log("MSEPlayer.onAvcCfgChange reset player"),this.reset(),this.delayReset=!1,!1):(this.delayReset=!0,!0)}},{key:"onRestart",value:function(){n.default.log("MSEPlayer.onRestart"),this.reset()}},{key:"onGop",value:function(e){this.handler.onGop&&this.handler.onGop(e),e>this.maxGop&&(this.maxGop=e,n.default.log("MSEPlayer.onGop update maxGop="+this.maxGop))}},{key:"setVolume",value:function(e){this.video&&(this.video.volume=e)}},{key:"setResolution",value:function(e,t){n.default.log("MSEPlayer.setResolution w/h="+e+"/"+t),this.width=e,this.height=t}},{key:"getWidth",value:function(){return this.width}},{key:"getHeight",value:function(){return this.height}},{key:"onInitSegment",value:function(e){var t=void 0,i=this.audioCodec=e.audioCodec,s=this.videoCodec=e.videoCodec;i&&!this.audioSourceBuffer&&"open"===this.mediaSource.readyState&&(n.default.log("MSEPlayer.onInitSegment create audio sb codec="+this.audioCodec),(t=this.audioSourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+i)).addEventListener("updateend",this.onasbue),t.addEventListener("error",this.onsbe)),s&&!this.videoSourceBuffer&&"open"===this.mediaSource.readyState&&(n.default.log("MSEPlayer.onInitSegment create video sb codec="+this.videoCodec),(t=this.videoSourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+s)).addEventListener("updateend",this.onvsbue),t.addEventListener("error",this.onsbe)),e.audioMoov&&this.audioSegments.push(e.audioMoov),e.videoMoov&&this.videoSegments.push(e.videoMoov),this.playStartTime=0}},{key:"onFragParsing",value:function(e){"audio"===e.type?(this.audioSegments.push(e.moof),this.audioSegments.push(e.mdat)):"video"===e.type&&(this.videoSegments.push(e.moof),this.videoSegments.push(e.mdat))}},{key:"onFragParsed",value:function(){if(this.audioSourceBuffer&&!1===this.audioSourceBuffer.updating&&this.audioSegments.length>0)try{var e=this.audioSegments.shift();this.audioSourceBuffer.appendBuffer(e)}catch(e){n.default.error("MSEPlayer.onFragParsed audio append err="+e.message),this.handler.onPlayerError()}if(this.videoSourceBuffer&&!1===this.videoSourceBuffer.updating&&this.videoSegments.length>0)try{e=this.videoSegments.shift(),this.videoSourceBuffer.appendBuffer(e)}catch(e){n.default.error("MSEPlayer.onFragParsed video append err="+e.message),this.handler.onPlayerError()}this.playing||"open"!==this.mediaSource.readyState||(this.handler.onPlayVideo(this.video,this.width,this.height),this.playing=!0,this.playStartTime=o.default.now())}},{key:"onMediaSourceOpen",value:function(){this.video.addEventListener("seeking",this.onvseeking),this.video.addEventListener("seeked",this.onvseeked),this.video.addEventListener("loadedmetadata",this.onvmetadata),this.video.addEventListener("ended",this.onvended),this.mediaSource.removeEventListener("sourceopen",this.onmso);var e=null;if(this.audioSegments.length>0||this.videoSegments.length>0){if(this.audioCodec&&!this.audioSourceBuffer){n.default.log("MSEPlayer.onMediaSourceOpen create audio sb codec="+this.audioCodec),(e=this.audioSourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+this.audioCodec)).addEventListener("updateend",this.onasbue),e.addEventListener("error",this.onsbe);try{var t=this.audioSegments.shift();this.audioSourceBuffer.appendBuffer(t)}catch(e){n.default.error("MSEPlayer.onMediaSourceOpen audio append err="+e.message),this.handler.onPlayerError()}}if(this.videoCodec&&!this.videoSourceBuffer){n.default.log("MSEPlayer.onMediaSourceOpen create video sb codec="+this.videoCodec),(e=this.videoSourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+this.videoCodec)).addEventListener("updateend",this.onvsbue),e.addEventListener("error",this.onsbe);try{t=this.videoSegments.shift(),this.videoSourceBuffer.appendBuffer(t)}catch(e){n.default.error("MSEPlayer.onMediaSourceOpen video append err="+e.message),this.handler.onPlayerError()}}this.playing||(this.handler.onPlayVideo(this.video,this.width,this.height),this.playing=!0,this.playStartTime=o.default.now())}}},{key:"onMediaSourceClose",value:function(){n.default.log("MSEPlayer.onMediaSourceClose")}},{key:"onMediaSourceEnded",value:function(){n.default.log("MSEPlayer.onMediaSourceEnded")}},{key:"onMediaSeeking",value:function(){n.default.log("MSEPlayer.onMediaSeeking")}},{key:"onMediaSeeked",value:function(){n.default.log("MSEPlayer.onMediaSeeked")}},{key:"onMediaMetadata",value:function(){n.default.log("MSEPlayer.onMediaMetadata")}},{key:"onMediaEnded",value:function(){n.default.log("MSEPlayer.onMediaEnded")}},{key:"onCheckTimer",value:function(e,t){}},{key:"onCheckFastTimer",value:function(e,t){this.checkSensePause(e)}},{key:"checkSensePause",value:function(e){var t=this.video.currentTime;0!==this.lastCheckPlayTime&&(t===this.lastCheckPlayTime?this.paused||(this.paused=!0,n.default.warn("MSEPlayer.checkSensePause pause now="+e),this.printBuffer(),this.handler.onPlayPause(e)):this.paused&&(this.paused=!1,n.default.warn("MSEPlayer.checkSensePause resume now="+e),this.printBuffer(),this.handler.onPlayResume(e))),this.lastCheckPlayTime=this.video.currentTime}},{key:"printBuffer",value:function(){if(this.video){var e=this.video.buffered;if(e.length>0){for(var t=" buffer=",i=0;i<e.length;i++)t+="i="+i+" ["+e.start(i)+","+e.end(i)+"]\n";n.default.log("buflen="+Math.round(1e3*(e.end(e.length-1)-this.video.currentTime))+t)}}}},{key:"onAudioSBUpdateEnd",value:function(){if(!1===this.audioSourceBuffer.updating&&this.audioSegments.length>0)try{var e=this.audioSegments.shift();this.audioSourceBuffer.appendBuffer(e),this.checkAppendOver()}catch(e){n.default.warn("MSEPlayer.onAudioSBUpdateEnd audio append err="+e.message),this.handler.onPlayerError()}}},{key:"onVideoSBUpdateEnd",value:function(){if(!1===this.videoSourceBuffer.updating&&this.videoSegments.length>0)try{var e=this.videoSegments.shift();this.videoSourceBuffer.appendBuffer(e),this.checkAppendOver()}catch(e){n.default.warn("MSEPlayer.onAudioSBUpdateEnd video append err="+e.message),this.handler.onPlayerError()}}},{key:"checkAppendOver",value:function(){0===this.videoSegments.length&&0===this.audioSegments.length&&this.handler.onSBUpdateEnd&&this.handler.onSBUpdateEnd()}},{key:"onSBUpdateError",value:function(e){n.default.warn("MSEPlayer.onSBUpdateError error:"+e)}}]),e}();i.default=c,t.exports=i.default},{"../flv/stat/qaStat":3,"../utils/logger":18,"../utils/timeUtil":19,"./demux/flvParser":12,"./demux/tsParser":13,"./remux/mp4-remuxer":16}],15:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return s(e,null,[{key:"init",value:function(){var t;for(t in e.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);var i=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);e.HDLR_TYPES={video:i,audio:s};var r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),a=new Uint8Array([0,0,0,0,0,0,0,0]);e.STTS=e.STSC=e.STCO=a,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var n=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),u=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,n,u,n,o),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,r))}},{key:"box",value:function(e){for(var t,i=Array.prototype.slice.call(arguments,1),s=8,r=i.length,a=r;r--;)s+=i[r].byteLength;for((t=new Uint8Array(s))[0]=s>>24&255,t[1]=s>>16&255,t[2]=s>>8&255,t[3]=255&s,t.set(e,4),r=0,s=8;r<a;r++)t.set(i[r],s),s+=i[r].byteLength;return t}},{key:"hdlr",value:function(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])}},{key:"mdat",value:function(t){return e.box(e.types.mdat,t)}},{key:"mdhd",value:function(t,i){return e.box(e.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,85,196,0,0]))}},{key:"mdia",value:function(t){return e.box(e.types.mdia,e.mdhd(t.timescale,t.duration),e.hdlr(t.type),e.minf(t))}},{key:"mfhd",value:function(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}},{key:"minf",value:function(t){return"audio"===t.type?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(t)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(t))}},{key:"moof",value:function(t,i,s){return e.box(e.types.moof,e.mfhd(t),e.traf(s,i))}},{key:"moov",value:function(t){for(var i=t.length,s=[];i--;)s[i]=e.trak(t[i]);return e.box.apply(null,[e.types.moov,e.mvhd(t[0].timescale,t[0].duration)].concat(s).concat(e.mvex(t)))}},{key:"mvex",value:function(t){for(var i=t.length,s=[];i--;)s[i]=e.trex(t[i]);return e.box.apply(null,[e.types.mvex].concat(s))}},{key:"mvhd",value:function(t,i){var s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24&255,i>>16&255,i>>8&255,255&i,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,s)}},{key:"sdtp",value:function(t){var i,s,r=t.samples||[],a=new Uint8Array(4+r.length);for(s=0;s<r.length;s++)i=r[s].flags,a[s+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy;return e.box(e.types.sdtp,a)}},{key:"stbl",value:function(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))}},{key:"avc1",value:function(t){var i,s,r,a=[],n=[];for(i=0;i<t.sps.length;i++)r=(s=t.sps[i]).byteLength,a.push(r>>>8&255),a.push(255&r),a=a.concat(Array.prototype.slice.call(s));for(i=0;i<t.pps.length;i++)r=(s=t.pps[i]).byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(s));var o=e.box(e.types.avcC,new Uint8Array([1,a[3],a[4],a[5],255,224|t.sps.length].concat(a).concat([t.pps.length]).concat(n))),u=t.width,l=t.height;return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,255&u,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]),o,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}},{key:"hvc1",value:function(t){var i,s,r,a=[],n=[],o=[];for(a.push(161),a.push(t.vps.length>>>8&255),a.push(255&t.vps.length),i=0;i<t.vps.length;i++)r=(s=t.vps[i]).byteLength,a.push(r>>>8&255),a.push(255&r),a=a.concat(Array.prototype.slice.call(s));for(n.push(162),n.push(t.sps.length>>>8&255),n.push(255&t.sps.length),i=0;i<t.sps.length;i++)r=(s=t.sps[i]).byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(s));var u=[],l=0;for(i=0;i<n.length;)s=n[i],2!==l||3!==s?(0===s?l++:l=0,u.push(s),++i):(++i,l=0);for(o.push(163),o.push(t.pps.length>>>8&255),o.push(255&t.pps.length),i=0;i<t.pps.length;i++)r=(s=t.pps[i]).byteLength,o.push(r>>>8&255),o.push(255&r),o=o.concat(Array.prototype.slice.call(s));var h=e.box(e.types.hvcC,new Uint8Array([1,u[8],u[9],u[10],u[11],u[12],u[13],u[14],u[15],u[16],u[17],u[18],u[19],240,0,255,253,248,248,0,0,15].concat([3]).concat(a).concat(n).concat(o))),d=t.width,c=t.height;return e.box(e.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,d>>8&255,255&d,c>>8&255,255&c,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]),h,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}},{key:"esds",value:function(e){var t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}},{key:"mp4a",value:function(t){var i=t.audiosamplerate;return e.box(e.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,i>>8&255,255&i,0,0]),e.box(e.types.esds,e.esds(t)))}},{key:"stsd",value:function(t){return"audio"===t.type?e.box(e.types.stsd,e.STSD,e.mp4a(t)):t.isHevc?e.box(e.types.stsd,e.STSD,e.hvc1(t)):e.box(e.types.stsd,e.STSD,e.avc1(t))}},{key:"tkhd",value:function(t){var i=t.id,s=t.duration,r=t.width,a=t.height;return e.box(e.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>24&255,i>>16&255,i>>8&255,255&i,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,a>>8&255,255&a,0,0]))}},{key:"traf",value:function(t,i){var s=e.sdtp(t),r=t.id;return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),e.box(e.types.tfdt,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i])),e.trun(t,s.length+16+16+8+16+8+8),s)}},{key:"trak",value:function(t){return t.duration=t.duration||4294967295,e.box(e.types.trak,e.tkhd(t),e.mdia(t))}},{key:"trex",value:function(t){var i=t.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function(t,i){var s,r,a,n,o,u,l=t.samples||[],h=l.length,d=12+16*h,c=new Uint8Array(d);for(i+=8+d,c.set([0,0,15,1,h>>>24&255,h>>>16&255,h>>>8&255,255&h,i>>>24&255,i>>>16&255,i>>>8&255,255&i],0),s=0;s<h;s++)a=(r=l[s]).duration,n=r.size,o=r.flags,u=r.cts,c.set([a>>>24&255,a>>>16&255,a>>>8&255,255&a,n>>>24&255,n>>>16&255,n>>>8&255,255&n,o.isLeading<<2|o.dependsOn,o.isDependedOn<<6|o.hasRedundancy<<4|o.paddingValue<<1|o.isNonSync,61440&o.degradPrio,15&o.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*s);return e.box(e.types.trun,c)}},{key:"initSegment",value:function(t){e.types||e.init();var i,s=e.moov(t);return(i=new Uint8Array(e.FTYP.byteLength+s.byteLength)).set(e.FTYP),i.set(s,e.FTYP.byteLength),i}}]),e}();i.default=r,t.exports=i.default},{}],16:[function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(i,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),a=s(e("../../utils/logger")),n=s(e("./mp4-generator")),o=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.mse=t,this.ISGenerated=!1,this.PES2MP4SCALEFACTOR=1,this.PES_TIMESCALE=9e4,this.MP4_TIMESCALE=this.PES_TIMESCALE/this.PES2MP4SCALEFACTOR}return r(e,[{key:"destroy",value:function(){this.insertDiscontinuity(),this.ISGenerated=!1}},{key:"insertDiscontinuity",value:function(){this._initPTS=this._initDTS=this.nextAacPts=this.nextAvcDts=void 0}},{key:"getInitDts",value:function(){return void 0!==this._initDTS?this._initDTS/90:-1}},{key:"switchLevel",value:function(){this.ISGenerated=!1}},{key:"remux",value:function(e,t,i,s){this.ISGenerated||this.generateIS(e,t,i),t.samples.length&&this.remuxVideo(t,i,s),e.samples.length&&this.remuxAudio(e,i,s),this.mse.onFragParsed()}},{key:"generateIS",value:function(e,t,i){var s=this.mse,r=null,o=e.samples,u=t.samples,l=o.length,h=u.length,d=this.PES_TIMESCALE;0===l&&0===h?a.default.warn("mp4-remuxer.generateIS have no nbAudio&nbVideo"):0===h?e.config?(r={audioMoov:n.default.initSegment([e]),audioCodec:e.codec,audioChannelCount:e.channelCount},s.onInitSegment(r),this.ISGenerated=!0,void 0===this._initPTS&&(this._initPTS=o[0].pts-d*i,this._initDTS=o[0].dts-d*i)):a.default.warn("mp4-remuxer.generateIS have no sps or pps"):0===l?t.sps&&t.pps?(r={videoMoov:n.default.initSegment([t]),videoCodec:t.codec,videoWidth:t.width,videoHeight:t.height},s.onInitSegment(r),this.ISGenerated=!0,void 0===this._initPTS&&(this._initPTS=u[0].pts-d*i,this._initDTS=u[0].dts-d*i)):a.default.warn("mp4-remuxer.generateIS have no sps or pps"):e.config&&t.sps&&t.pps?(r={audioMoov:n.default.initSegment([e]),audioCodec:e.codec,audioChannelCount:e.channelCount,videoMoov:n.default.initSegment([t]),videoCodec:t.codec,videoWidth:t.width,videoHeight:t.height},s.onInitSegment(r),this.ISGenerated=!0,void 0===this._initPTS&&(this._initPTS=Math.min(u[0].pts,o[0].pts)-d*i,this._initDTS=Math.min(u[0].dts,o[0].dts)-d*i)):a.default.warn("mp4-remuxer.generateIS have no audioConfig or sps or pps")}},{key:"remuxVideo",value:function(e,t,i){var s,r=void 0,o=8,u=this.PES_TIMESCALE,l=this.PES2MP4SCALEFACTOR,h=void 0,d=void 0,c=void 0,f=void 0,v=void 0,p=void 0,y=void 0,g=void 0,m=void 0,S=void 0,b=void 0,k=void 0,T=[];for(v=new Uint8Array(e.len+4*e.nbNalu+8),(r=new DataView(v.buffer)).setUint32(0,v.byteLength),v.set(n.default.types.mdat,4);e.samples.length;){for(h=e.samples.shift(),c=0;h.units.units.length;)f=h.units.units.shift(),r.setUint32(o,f.data.byteLength),o+=4,v.set(f.data,o),o+=f.data.byteLength,c+=4+f.data.byteLength;if(m=h.pts-this._initDTS,S=h.dts-this._initDTS,void 0!==g)b=this._PTSNormalize(m,g),k=this._PTSNormalize(S,g),d.duration=(k-g)/l,d.duration<0&&(a.default.warn("mp4-remuxer.remuxVideo invalid sample duration at pts="+h.pts/90+" dts="+h.dts/90+" duration="+d.duration/90),d.duration=0,k=g);else{var E,_=this.nextAvcDts;b=this._PTSNormalize(m,_),k=this._PTSNormalize(S,_),E=Math.round((k-_)/90),(i||Math.abs(E)<600)&&E&&(E>1?a.default.log("mp4-remuxer.remuxVideo hole="+E+" filling it"):E<-1&&a.default.log("mp4-remuxer.remuxVideo overlapping="+-E+" detected"),k=_,b=Math.max(b-E,k)),p=Math.max(0,b),y=Math.max(0,k)}d={size:c,duration:0,cts:(b-k)/l,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0}},!0===h.key?(d.flags.dependsOn=2,d.flags.isNonSync=0):(d.flags.dependsOn=1,d.flags.isNonSync=1),T.push(d),g=k}void 0!==e.endDts?(d.duration=(90*e.endDts-this._initDTS-k)/l,d.duration<0?(d.duration=0,this.nextAvcDts=k):this.nextAvcDts=90*e.endDts-this._initDTS):(T.length>=2&&(d.duration=T[T.length-2].duration),this.nextAvcDts=k+d.duration*l),e.len=0,e.nbNalu=0,navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(T[0].flags.dependsOn=2,T[0].flags.isNonSync=0),e.samples=T,s=n.default.moof(e.sequenceNumber++,y/l,e),e.samples=[];var L={moof:s,mdat:v,startPTS:p/u,endPTS:(b+l*d.duration)/u,startDTS:y/u,endDTS:(k+l*d.duration)/u,type:"video",nb:T.length};this.mse.onFragParsing(L)}},{key:"remuxAudio",value:function(e,t,i){var s,r=8,o=this.PES_TIMESCALE,u=this.PES2MP4SCALEFACTOR,l=void 0,h=void 0,d=void 0,c=void 0,f=void 0,v=void 0,p=void 0,y=void 0,g=void 0,m=void 0,S=void 0,b=[];for(c=new Uint8Array(e.len+8),new DataView(c.buffer).setUint32(0,c.byteLength),c.set(n.default.types.mdat,4);e.samples.length;){if(d=(l=e.samples.shift()).unit,c.set(d,r),r+=d.byteLength,y=l.pts-this._initDTS,g=l.dts-this._initDTS,void 0!==p)m=this._PTSNormalize(y,p),S=this._PTSNormalize(g,p),h.duration=(S-p)/u,h.duration<0&&(a.default.warn("mp4-remuxer.remuxAudio invalid AAC sample duration at PTS="+l.pts+" duration="+h.duration),h.duration=0,m=S=p);else{var k,T=this.nextAacPts;m=this._PTSNormalize(y,T),S=this._PTSNormalize(g,T),k=Math.round(1e3*(m-T)/o),(i||Math.abs(k)<600)&&k&&(m=S=T),f=Math.max(0,m),v=Math.max(0,S)}h={size:d.byteLength,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},b.push(h),p=S}b.length>=2&&(h.duration=b[b.length-2].duration),this.nextAacPts=m+u*h.duration,e.len=0,e.samples=b,s=n.default.moof(e.sequenceNumber++,v/u,e),e.samples=[];var E={moof:s,mdat:c,startPTS:f/o,endPTS:this.nextAacPts/o,startDTS:v/o,endDTS:(S+u*h.duration)/o,type:"audio",nb:b.length};this.mse.onFragParsing(E)}},{key:"_PTSNormalize",value:function(e,t){var i;if(void 0===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}},{key:"timescale",get:function(){return this.MP4_TIMESCALE}}]),e}();i.default=o,t.exports=i.default},{"../../utils/logger":18,"./mp4-generator":15}],17:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};s.emptyAacFrameAdts=[255,241,92,64,18,64,252,0,208,32,6,238,90,119,128,0,128,0,0,0,0,26,37,65,0,13,237,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,28],s.emptyAacFrame=[0,208,32,6,238,90,119,128,0,128,0,0,0,0,26,37,65,0,13,237,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,28],i.default=s,t.exports=i.default},{}],18:[function(e,t,i){"use strict";function s(){var e=new Date;return"h5 "+e.toLocaleTimeString("en-US",{hour12:!1})+"."+function(e){var t=void 0;switch(e.toString().length){case 1:t="00"+e;break;case 2:t="0"+e;break;default:t=e}return t}(e.getMilliseconds())+":"}Object.defineProperty(i,"__esModule",{value:!0});var r=0,a={_data:[],_length:0,_visible:!1,debug:function(e){r<=-1&&(e=s()+e,a.record(e,"debug"),console.debug(e))},log:function(e){r<=0&&(e=s()+e,a.record(e,"log"),console.log(e))},info:function(e){r<=1&&(e=s()+e,a.record(e,"info"),console.info(e))},warn:function(e){r<=2&&(e=s()+e,a.record(e,"warn"),console.warn(e))},error:function(e){r<=3&&(e=s()+e,a.record(e,"error"),console.error(e))},setLevel:function(e){console.log(s()+"set level from "+r+" to "+e),r=e},record:function(e,t){if(1100===a._length&&(a._data.splice(0,100),a._length=1e3),a._length++,a._data.push(e+" ["+t+"]"),a._visible){var i=document.getElementById("__h5playerLogWin");i.value+=e+"\r\n",i.scrollTop=1e4}},getLog:function(){return a._data},setLogVisible:function(e){a._visible=e;var t=document.getElementById("__h5playerLogWin");if(e){t||((t=document.createElement("textarea")).id="__h5playerLogWin",t.style.display="block",t.style.position="absolute",t.style.top=0,t.style.width="500px",t.style.height="300px",document.body.appendChild(t));for(var i="",s=0;s<a._length;s++)i+=a._data[s]+"\r\n";t.value=i,t.scrollTop=1e4}else t&&(t.style.display="none")}};window._h5playerLogger=a,i.default=a,t.exports=i.default},{}],19:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=0,r={now:function(){0===s&&(s=Date.now());var e=Date.now()-s;return e>4294967295?(s+=4294967295,Date.now()-s):e},utc:function(){return Math.round(Date.now()/1e3)}};i.default=r,t.exports=i.default},{}],20:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),r=function(e){return e&&e.__esModule?e:{default:e}}(e("./logger")),a=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),t&&t.xhrSetup&&(this.xhrSetup=t.xhrSetup)}return s(e,[{key:"destroy",value:function(){this.abort(),this.loader=null}},{key:"abort",value:function(){r.default.log("xhr-loader.abort readyState="+(this.loader?this.loader.readyState:"")),this.loader&&(this.stats.aborted=!0,this.loader.abort()),this.timeoutHandle&&window.clearTimeout(this.timeoutHandle)}},{key:"load",value:function(e,t,i,s,r,a,n,o){var u=arguments.length<=8||void 0===arguments[8]?null:arguments[8];this.url=e,this.responseType=t,this.onSuccess=i,this.onProgress=u,this.onTimeout=r,this.onError=s,this.stats={trequest:performance.now(),retry:0},this.timeout=a,this.maxRetry=n,this.retryDelay=o,this.timeoutHandle=window.setTimeout(this.loadtimeout.bind(this),a),this.loadInternal()}},{key:"loadInternal",value:function(){var e=this.loader=new XMLHttpRequest;e.onload=this.loadsuccess.bind(this),e.onerror=this.loaderror.bind(this),e.onprogress=this.loadprogress.bind(this),e.onloadend=this.loadend.bind(this),e.open("GET",this.url,!0),this.byteRange&&e.setRequestHeader("Range","bytes="+this.byteRange),e.responseType=this.responseType,this.stats.tstart=null,this.stats.loaded=0,this.xhrSetup&&this.xhrSetup(e),this.stats.tstart=performance.now(),e.send()}},{key:"loadsuccess",value:function(e){window.clearTimeout(this.timeoutHandle),this.stats.tload=performance.now(),e.requestURL=this.url,this.onSuccess(e,this.stats)}},{key:"loaderror",value:function(e){return 404===e.currentTarget.status||0===e.currentTarget.status?void this.onError(e):void(this.stats.retry<this.maxRetry?(r.default.warn("xhr-loader.loaderror url="+this.url+" retryDelay="+this.retryDelay),this.destroy(),window.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,64e3),this.stats.retry++):(window.clearTimeout(this.timeoutHandle),r.default.warn("xhr-loader.loaderror reach max retry url="+this.url),this.onError(e)))}},{key:"loadtimeout",value:function(){this.stats.retry<this.maxRetry?(r.default.warn("xhr-loader.loadtimeout url="+this.url+" retryDelay="+this.retryDelay),this.destroy(),window.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,64e3),this.stats.retry++):(window.clearTimeout(this.timeoutHandle),r.default.warn("xhr-loader.loadtimeout max retry url="+this.url),this.onTimeout())}},{key:"loadprogress",value:function(e){var t=this.stats;null===t.tfirst&&(t.tfirst=performance.now()),t.loaded=e.loaded,this.onProgress&&this.onProgress(e,t)}},{key:"loadend",value:function(e){404===e.currentTarget.status&&this.loaderror(e)}}]),e}();i.default=a,t.exports=i.default},{"./logger":18}],21:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.default={VIDEO_ACCESS_MODE:0,AUDIO_ACCESS_MODE:1,VIDEO_JIT_BUFLEN:2,AUDIO_JIT_BUFLEN:3,VIDEO_P2P_MODE:4,AUDIO_PUSH_LEN:5,VIDEO_JIT_MAX_BUFLEN:6,JIT_DOWN_MODE:7,JIT_UP_MODE:8,PUSH_GOP:9,P2P_MAX_SUB_NUM:50},t.exports=i.default},{}],22:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.default={VIDEO_ACCESS_NORMAL:0,VIDEO_ACCESS_PULL:2,AUDIO_ACCESS_NORMAL:0,AUDIO_ACCESS_PUSH:1,VIDEO_P2P_DISABLE:!1,VIDEO_P2P_ENABLE:!0,JIT_DOWN_DISABLE:!1,JIT_DOWN_ENABLE:!0,JIT_UP_DISABLE:!1,JIT_UP_ENABLE:!0,JIT_ADJUST_NORMAL_MODE:0,JIT_ADJUST_LOW_DELAY_MODE:1},t.exports=i.default},{}]},{},[4])(4)},"object"==o(t)&&void 0!==e?e.exports=n():(r=[],void 0===(a="function"==typeof(s=n)?s.apply(t,r):s)||(e.exports=a))}}]);